

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sprit.sprit_streamlit_ui &mdash; sprit 3.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/documentation_options.js?v=acc74ff5"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            sprit
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../sprit.html">sprit package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sprit.sprit_hvsr.html">sprit.sprit_hvsr module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sprit.sprit_utils.html">sprit.sprit_utils module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">sprit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">sprit.sprit_streamlit_ui</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sprit.sprit_streamlit_ui</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;This file contains the code to run the SpRIT app (via streamlit) both locally and on the web.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zoneinfo</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="kn">import</span> <span class="n">scatter</span> <span class="k">as</span> <span class="n">pxScatter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="kn">import</span> <span class="n">timeline</span> <span class="k">as</span> <span class="n">pxTimeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="kn">import</span> <span class="n">Heatmap</span> <span class="k">as</span> <span class="n">goHeatmap</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.graph_objs._figurewidget</span><span class="w"> </span><span class="kn">import</span> <span class="n">FigureWidget</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">streamlit</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">st</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">obspy</span><span class="w"> </span><span class="kn">import</span> <span class="n">UTCDateTime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">obspy.signal.spectral_estimation</span><span class="w"> </span><span class="kn">import</span> <span class="n">PPSD</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">signal</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sprit</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sprit</span><span class="w"> </span><span class="kn">import</span> <span class="n">sprit_hvsr</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sprit</span><span class="w"> </span><span class="kn">import</span> <span class="n">sprit_plot</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">parent_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">parent_dir</span><span class="p">)</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sprit</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sprit</span><span class="w"> </span><span class="kn">import</span> <span class="n">sprit_hvsr</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sprit</span><span class="w"> </span><span class="kn">import</span> <span class="n">sprit_plot</span>
    
<span class="n">VERBOSE</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">RESOURCE_DIR</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s1">&#39;sprit&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">)</span>
<span class="n">SAMPLE_DATA_DIR</span> <span class="o">=</span> <span class="n">RESOURCE_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;sample_data&#39;</span><span class="p">)</span>
<span class="n">SETTINGS_DIR</span> <span class="o">=</span> <span class="n">RESOURCE_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">)</span>

<span class="n">DEFAULT_BAND_LIST</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">DEFAULT_BAND</span><span class="p">)</span>

<span class="n">spritLogoPath</span> <span class="o">=</span> <span class="n">RESOURCE_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;icon&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;SpRITLogo.png&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start of file, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<span class="n">PARAM2PRINT</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="print_param">
<a class="viewcode-back" href="../../sprit.sprit_streamlit_ui.html#sprit.sprit_streamlit_ui.print_param">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">print_param</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">PARAM2PRINT</span><span class="p">,</span> <span class="n">write_key</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="s1">&#39;type:&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">write_key</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="s1">&#39;type:&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">key</span><span class="p">]))</span></div>



<span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../sprit.sprit_streamlit_ui.html#sprit.sprit_streamlit_ui.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>

    <span class="k">if</span> <span class="n">spritLogoPath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">st</span><span class="o">.</span><span class="n">logo</span><span class="p">(</span><span class="n">image</span><span class="o">=</span><span class="n">spritLogoPath</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s1">&#39;large&#39;</span><span class="p">,</span>
                <span class="n">link</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;https://github.com/RJbalikian/SPRIT-HVSR&quot;</span><span class="p">,</span>
                <span class="n">icon_image</span><span class="o">=</span><span class="n">spritLogoPath</span><span class="p">)</span>
        <span class="n">icon</span> <span class="o">=</span> <span class="n">spritLogoPath</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">icon</span> <span class="o">=</span> <span class="s2">&quot;:material/electric_bolt:&quot;</span>
        
    <span class="k">if</span> <span class="s1">&#39;sprit&#39;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sprit</span><span class="p">,</span> <span class="s1">&#39;__version__&#39;</span><span class="p">):</span>
        <span class="n">spritversion</span> <span class="o">=</span> <span class="n">sprit</span><span class="o">.</span><span class="n">__version__</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">spritversion</span> <span class="o">=</span> <span class="s1">&#39;2.0+&#39;</span>
    <span class="n">aboutStr</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    # About SpRIT</span>
<span class="s2">    ### This app uses SpRIT v0.0.0</span>

<span class="s2">    SpRIT is developed by Riley Balikian at the Illinois State Geological Survey.</span>

<span class="s2">    Please visit the following links for any questions:</span>
<span class="s2">    * [App user guide](https://github.com/RJbalikian/sprit-streamlit/wiki)</span>
<span class="s2">    * [API Documentation](https://sprit.readthedocs.io/en/latest/sprit.html)</span>
<span class="s2">    * [Wiki](https://github.com/RJbalikian/SPRIT-HVSR/wiki) </span>
<span class="s2">    * [Pypi Repository](https://pypi.org/project/sprit/)</span>

<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">aboutStr</span> <span class="o">=</span> <span class="n">aboutStr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;0.0.0&#39;</span><span class="p">,</span> <span class="n">spritversion</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start setting up page config, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">st</span><span class="o">.</span><span class="n">set_page_config</span><span class="p">(</span><span class="s1">&#39;SpRIT HVSR&#39;</span><span class="p">,</span>
                        <span class="n">page_icon</span><span class="o">=</span><span class="n">icon</span><span class="p">,</span>
                        <span class="n">layout</span><span class="o">=</span><span class="s1">&#39;wide&#39;</span><span class="p">,</span>
                        <span class="n">menu_items</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Get help&#39;</span><span class="p">:</span> <span class="s1">&#39;https://github.com/RJbalikian/SPRIT-HVSR/wiki&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;Report a bug&#39;</span><span class="p">:</span> <span class="s2">&quot;https://github.com/RJbalikian/SPRIT-HVSR/issues&quot;</span><span class="p">,</span>
                                    <span class="s1">&#39;About&#39;</span><span class="p">:</span> <span class="n">aboutStr</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start setting up constants/variables, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="n">OBSPYFORMATS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AH&#39;</span><span class="p">,</span> <span class="s1">&#39;ALSEP_PSE&#39;</span><span class="p">,</span> <span class="s1">&#39;ALSEP_WTH&#39;</span><span class="p">,</span> <span class="s1">&#39;ALSEP_WTN&#39;</span><span class="p">,</span> <span class="s1">&#39;CSS&#39;</span><span class="p">,</span> <span class="s1">&#39;DMX&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GCF&#39;</span><span class="p">,</span> <span class="s1">&#39;GSE1&#39;</span><span class="p">,</span> <span class="s1">&#39;GSE2&#39;</span><span class="p">,</span> <span class="s1">&#39;KINEMETRICS_EVT&#39;</span><span class="p">,</span> <span class="s1">&#39;KNET&#39;</span><span class="p">,</span> <span class="s1">&#39;MSEED&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;NNSA_KB_CORE&#39;</span><span class="p">,</span> <span class="s1">&#39;PDAS&#39;</span><span class="p">,</span> <span class="s1">&#39;PICKLE&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;REFTEK130&#39;</span><span class="p">,</span> <span class="s1">&#39;RG16&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;SAC&#39;</span><span class="p">,</span> <span class="s1">&#39;SACXY&#39;</span><span class="p">,</span> <span class="s1">&#39;SEG2&#39;</span><span class="p">,</span> <span class="s1">&#39;SEGY&#39;</span><span class="p">,</span> <span class="s1">&#39;SEISAN&#39;</span><span class="p">,</span> <span class="s1">&#39;SH_ASC&#39;</span><span class="p">,</span> <span class="s1">&#39;SLIST&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;SU&#39;</span><span class="p">,</span> <span class="s1">&#39;TRC&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;TSPAIR&#39;</span><span class="p">,</span> <span class="s1">&#39;WAV&#39;</span><span class="p">,</span> <span class="s1">&#39;WIN&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">]</span>
    <span class="n">bandVals</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.07</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.09</span><span class="p">,</span>
                <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>

    <span class="c1"># SETUP KWARGS</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start setting up kwargs dicts, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="n">run_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ip_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fd_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ca_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">rn_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">gpsd_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">phvsr_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">roc_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">cp_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">gr_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">run_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start getting default values, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

    <span class="c1"># Get default values</span>
    <span class="n">funList</span> <span class="o">=</span> <span class="p">[[</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="n">run_kwargs</span><span class="p">],</span> <span class="p">[</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">input_params</span><span class="p">,</span> <span class="n">ip_kwargs</span><span class="p">],</span>
            <span class="p">[</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">,</span> <span class="n">fd_kwargs</span><span class="p">],</span> <span class="p">[</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">calculate_azimuth</span><span class="p">,</span> <span class="n">ca_kwargs</span><span class="p">],</span>
            <span class="p">[</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">remove_noise</span><span class="p">,</span> <span class="n">rn_kwargs</span><span class="p">],</span> <span class="p">[</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">generate_psds</span><span class="p">,</span> <span class="n">gpsd_kwargs</span><span class="p">],</span>
            <span class="p">[</span><span class="n">PPSD</span><span class="p">,</span> <span class="n">gpsd_kwargs</span><span class="p">],</span> <span class="p">[</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">process_hvsr</span><span class="p">,</span> <span class="n">phvsr_kwargs</span><span class="p">],</span>
            <span class="p">[</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">remove_outlier_curves</span><span class="p">,</span> <span class="n">roc_kwargs</span><span class="p">],</span>
            <span class="p">[</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">check_peaks</span><span class="p">,</span> <span class="n">cp_kwargs</span><span class="p">],</span> <span class="p">[</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">get_report</span><span class="p">,</span> <span class="n">gr_kwargs</span><span class="p">]]</span>


    <span class="c1"># Function to initialize session state variables</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">initial_setup_fun</span><span class="p">(</span><span class="n">session_state_key</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">,</span> <span class="n">running_value</span><span class="o">=</span><span class="s1">&#39;Do not use&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">,</span> <span class="n">session_state_key</span><span class="p">):</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">session_state_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_value</span>
        <span class="k">elif</span> <span class="n">running_value</span> <span class="o">!=</span> <span class="s2">&quot;Do not use&quot;</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">session_state_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">running_value</span>

    <span class="c1"># Initialize variables</span>
    <span class="n">initial_setup_fun</span><span class="p">(</span><span class="s1">&#39;initial_setup&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">initial_setup_fun</span><span class="p">(</span><span class="s1">&#39;tabs_setup&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">initial_setup_fun</span><span class="p">(</span><span class="s1">&#39;mainContain_setup&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">setup_session_state</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">initial_setup</span><span class="p">:</span>
            <span class="c1"># &quot;Splash screen&quot; (only shows at initial startup)</span>

            <span class="n">mainContainerInitText</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            # SpRIT HVSR</span>

<span class="s2">            sprit_logo</span>

<span class="s2">            ## About</span>
<span class="s2">            SpRIT HVSR is developed by the Illinois State Geological Survey, part of the Prairie Research Institute at the University of Illinois.</span>
<span class="s2">            </span>

<span class="s2">            ## For help with app usage, please visit the app user guide [here](https://github.com/RJbalikian/sprit-streamlit/wiki).</span>
<span class="s2">            </span>
<span class="s2">            ### Related Links</span>
<span class="s2">            * API Documentation may be accessed here: [ReadtheDocs](https://sprit.readthedocs.io/en/latest/sprit.html) and [Github Pages](https://rjbalikian.github.io/SPRIT-HVSR/main.html)</span>
<span class="s2">            * The Wiki and Tutorials may be accessed here: [https://github.com/RJbalikian/SPRIT-HVSR/wiki](https://github.com/RJbalikian/SPRIT-HVSR/wiki)</span>
<span class="s2">            * Source Code may be accessed here: [https://github.com/RJbalikian/SPRIT-HVSR](https://github.com/RJbalikian/SPRIT-HVSR)</span>
<span class="s2">            * PyPI repository may be accessed here: [https://pypi.org/project/sprit/](https://pypi.org/project/sprit/)</span>
<span class="s2">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">spritLogoPath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="c1">#encodedImage = </span>
                <span class="n">mainContainerInitText</span> <span class="o">=</span> <span class="n">mainContainerInitText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sprit_logo&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;&lt;img src=&#39;data:image/png;base64,</span><span class="si">{</span><span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">spritLogoPath</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; class=&#39;img-fluid&#39;&gt;&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mainContainerInitText</span> <span class="o">=</span> <span class="n">mainContainerInitText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;sprit_logo&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            

            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">mainContainerInitText</span><span class="p">,</span> <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="n">licenseExpander</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;License information&#39;</span><span class="p">)</span>
            <span class="n">licenseInfo</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            ## MIT License</span>
<span class="s2">            SpRIT is licensed under the MIT License:</span>
<span class="s2">            &gt; Permission is hereby granted, free of charge, to any person obtaining a copy </span>
<span class="s2">            &gt; of this software and associated documentation files (the &quot;Software&quot;), to deal</span>
<span class="s2">            &gt; in the Software without restriction, including without limitation the rights</span>
<span class="s2">            &gt; to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="s2">            &gt; copies of the Software, and to permit persons to whom the Software is</span>
<span class="s2">            &gt; furnished to do so, subject to the following conditions:</span>
<span class="s2">            &gt; </span>
<span class="s2">            &gt; The above copyright notice and this permission notice shall be included in all</span>
<span class="s2">            &gt; copies or substantial portions of the Software.</span>
<span class="s2">            &gt; </span>
<span class="s2">            &gt; THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="s2">            &gt; IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="s2">            &gt; FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="s2">            &gt; AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class="s2">            &gt; LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class="s2">            &gt; OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class="s2">            &gt; SOFTWARE.&quot;&quot;&quot;</span>
            <span class="n">licenseExpander</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">licenseInfo</span><span class="p">,</span> <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="n">versionText</span> <span class="o">=</span> <span class="s2">&quot;### This app is using SpRIT v0.0.0&quot;</span>
            <span class="n">versionText</span> <span class="o">=</span> <span class="n">versionText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;0.0.0&#39;</span><span class="p">,</span> <span class="n">spritversion</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">versionText</span><span class="p">)</span>     
                        
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start sig loop, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

            <span class="c1"># Get all function defaults</span>
            <span class="k">for</span> <span class="n">fun</span><span class="p">,</span> <span class="n">funDict</span> <span class="ow">in</span> <span class="n">funList</span><span class="p">:</span>
                <span class="n">funSig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">funSig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">funSig</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">funSig</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span>
                        <span class="n">funDict</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">funSig</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
                        <span class="n">run_kwargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">funSig</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>

            <span class="n">gpsd_kwargs</span><span class="p">[</span><span class="s1">&#39;ppsd_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;ppsd_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="n">gpsd_kwargs</span><span class="p">[</span><span class="s1">&#39;skip_on_gaps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;skip_on_gaps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">gpsd_kwargs</span><span class="p">[</span><span class="s1">&#39;period_step_octaves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;period_step_octaves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.03125</span>
            <span class="n">gpsd_kwargs</span><span class="p">[</span><span class="s1">&#39;period_limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;period_limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="o">/</span><span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
            
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done getting kwargs: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting up session state: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="c1">#st.session_state[&quot;updated_kwargs&quot;] = {}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">run_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;resetting&#39;</span><span class="p">)</span>
                    <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s2">&quot;: &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="c1">#    if key in st.session_state.keys() and (st.session_state[key] != value):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="c1">#listItems = [&#39;source&#39;, &#39;tzone&#39;, &#39;elev_unit&#39;, &#39;data_export_format&#39;, &#39;detrend&#39;, &#39;special_handling&#39;, &#39;peak_selection&#39;, &#39;freq_smooth&#39;, &#39;horizontal_method&#39;, &#39;stalta_thresh&#39;]</span>
            <span class="c1">## Convert items to lists</span>
            <span class="c1">#for arg, value in st.session_state.items():</span>
            <span class="c1">#    if arg in listItems:</span>
            <span class="c1">#        valList = [value]</span>
            <span class="c1">#        st.session_state[arg] = valList</span>
            <span class="c1">#        run_kwargs[arg] = st.session_state[arg]</span>

            <span class="c1"># Convert lists and numbers to strings</span>
            <span class="n">strItems</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">,</span> <span class="s1">&#39;xcoord&#39;</span><span class="p">,</span> <span class="s1">&#39;ycoord&#39;</span><span class="p">,</span> <span class="s1">&#39;elevation&#39;</span><span class="p">,</span> <span class="s1">&#39;detrend_options&#39;</span><span class="p">,</span> <span class="s1">&#39;filter_options&#39;</span><span class="p">,</span> <span class="s1">&#39;horizontal_method&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">strItems</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                        <span class="n">newVal</span> <span class="o">=</span> <span class="s1">&#39;[&#39;</span>
                        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                            <span class="n">newVal</span> <span class="o">=</span> <span class="n">newVal</span><span class="o">+</span><span class="n">item</span><span class="o">+</span><span class="s1">&#39;, &#39;</span>
                        <span class="n">newVal</span> <span class="o">=</span> <span class="n">newVal</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;]&#39;</span>

                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">newVal</span>
                        <span class="n">run_kwargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">newVal</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">run_kwargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

            <span class="c1"># Convert all times to python datetime objects</span>
            <span class="n">dtimeItems</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">,</span> <span class="s1">&#39;starttime&#39;</span><span class="p">,</span> <span class="s1">&#39;endtime&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">dtimeItems</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="n">run_kwargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">arg</span><span class="p">],</span> <span class="n">UTCDateTime</span><span class="p">):</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">datetime</span>
                        <span class="n">run_kwargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">datetime</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="n">run_kwargs</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

            <span class="c1"># Case matching</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_export_format</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;data_export_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_export_format</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">detrend</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;detrend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">detrend</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">azimuth_type</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;azimuth_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">azimuth_type</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">peak_selection</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;peak_selection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">peak_selection</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">freq_smooth</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;freq_smooth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">freq_smooth</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plot_engine</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_engine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plot_engine</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
                
            <span class="c1"># Update Nones</span>
            <span class="c1"># Remove method</span>
            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">remove_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">remove_method</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;remove_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;None&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">remove_method</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;remove_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">remove_method</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>

            <span class="c1"># Other updates</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">azimuth_unit</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;azimuth_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;°&#39;</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plot_engine</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_engine&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Matplotlib&quot;</span>
            

            <span class="c1"># Horizontal_method</span>
            <span class="n">methodDict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;0&#39;</span><span class="p">:</span><span class="s1">&#39;Diffuse Field Assumption&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span><span class="s1">&#39;Arithmetic Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span><span class="s1">&#39;Geometric Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span><span class="s1">&#39;Vector Summation&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">:</span><span class="s1">&#39;Quadratic Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">:</span><span class="s1">&#39;Maximum Horizontal Value&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">:</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">,</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span><span class="s2">&quot;Vector Summation&quot;</span><span class="p">}</span>            
            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">horizontal_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">horizontal_method</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;horizontal_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">methodDict</span><span class="p">[</span><span class="s2">&quot;3&quot;</span><span class="p">]</span>            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">horizontal_method</span> <span class="o">=</span> <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;horizontal_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">methodDict</span><span class="p">[</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">horizontal_method</span><span class="p">]</span>

            <span class="c1"># Set Defaults</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">default_params</span> <span class="o">=</span> <span class="n">run_kwargs</span>

            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">run_kws</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">run_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;session st: &quot;</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="s1">&#39;| rkwargs:&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>


            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done with setup, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;NewSessionState&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">check_if_default</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Checking defaults, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="n">check_if_default</span><span class="p">()</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">text_change</span><span class="p">(</span><span class="n">VERBOSE</span><span class="o">=</span><span class="n">VERBOSE</span><span class="p">):</span>
        <span class="c1">#Just a function to run so something is done when text changes</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TEXTCHange&#39;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">on_file_upload</span><span class="p">():</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">datapath_uploader</span>
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>


    <span class="c1"># Set up main container</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_main_container</span><span class="p">(</span><span class="n">do_setup_tabs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">mainContainer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">container</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">mainContainer</span> <span class="o">=</span> <span class="n">mainContainer</span>

        <span class="k">if</span> <span class="n">do_setup_tabs</span><span class="p">:</span>
            <span class="n">setup_tabs</span><span class="p">(</span><span class="n">mainContainer</span><span class="p">)</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">mainContain_setup</span> <span class="o">=</span> <span class="kc">True</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">initial_setup</span><span class="p">:</span>
        <span class="n">setup_main_container</span><span class="p">(</span><span class="n">do_setup_tabs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


    <span class="c1"># Set up tabs</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">setup_tabs</span><span class="p">(</span><span class="n">mainContainer</span><span class="p">):</span>
        
        <span class="n">resultsTab</span><span class="p">,</span> <span class="n">inputTab</span><span class="p">,</span> <span class="n">outlierTab</span><span class="p">,</span> <span class="n">infoTab</span> <span class="o">=</span> <span class="n">mainContainer</span><span class="o">.</span><span class="n">tabs</span><span class="p">([</span><span class="s1">&#39;Results&#39;</span><span class="p">,</span> <span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="s1">&#39;Outliers&#39;</span><span class="p">,</span> <span class="s1">&#39;Info&#39;</span><span class="p">])</span>
        <span class="n">plotReportTab</span><span class="p">,</span> <span class="n">csvReportTab</span><span class="p">,</span> <span class="n">strReportTab</span> <span class="o">=</span> <span class="n">resultsTab</span><span class="o">.</span><span class="n">tabs</span><span class="p">([</span><span class="s1">&#39;Summary/Plot&#39;</span><span class="p">,</span> <span class="s1">&#39;Results Table&#39;</span><span class="p">,</span> <span class="s1">&#39;Print Report&#39;</span><span class="p">])</span>

        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">inputTab</span> <span class="o">=</span> <span class="n">inputTab</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlierTab</span> <span class="o">=</span> <span class="n">outlierTab</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">infoTab</span> <span class="o">=</span> <span class="n">infoTab</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">resultsTab</span> <span class="o">=</span> <span class="n">resultsTab</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plotReportTab</span> <span class="o">=</span> <span class="n">plotReportTab</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">csvReportTab</span> <span class="o">=</span> <span class="n">csvReportTab</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">strReportTab</span> <span class="o">=</span> <span class="n">strReportTab</span>

        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">tabs_setup</span> <span class="o">=</span> <span class="kc">True</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">on_run_data</span><span class="p">():</span>
        <span class="c1"># Runs sample data if nothing specified</span>
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_data</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="s1">&#39;sample&#39;</span>

        <span class="c1"># Now run the data</span>
        <span class="n">srun</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">run_kws</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">default_params</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">default_params</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                        <span class="n">srun</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;plot_engine&#39;</span><span class="p">:</span>
                <span class="n">srun</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                
        <span class="c1"># Get plots all right</span>
        <span class="c1">#srun[&#39;plot_engine&#39;] = &#39;matplotlib&#39;</span>
        <span class="n">srun</span><span class="p">[</span><span class="s1">&#39;plot_input_stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">srun</span><span class="p">[</span><span class="s1">&#39;show_outlier_plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">srun</span><span class="p">[</span><span class="s1">&#39;show_plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">srun</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#True</span>

        <span class="c1"># Update outputs</span>
        <span class="n">srun</span><span class="p">[</span><span class="s1">&#39;report_export_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">srun</span><span class="p">[</span><span class="s1">&#39;show_pdf_report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">srun</span><span class="p">[</span><span class="s1">&#39;show_print_report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">srun</span><span class="p">[</span><span class="s1">&#39;show_plot_report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SPRIT RUN&#39;</span><span class="p">,</span> <span class="n">srun</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">toast</span><span class="p">(</span><span class="s1">&#39;Data is processing&#39;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;⌛&quot;</span><span class="p">)</span>
        
        <span class="n">setup_main_container</span><span class="p">(</span><span class="n">do_setup_tabs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">mainContainer</span><span class="p">:</span>
            <span class="n">spinnerText</span> <span class="o">=</span> <span class="s1">&#39;## Data is processing with default parameters.&#39;</span>
            <span class="n">excludedKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;plot_engine&#39;</span><span class="p">,</span> <span class="s1">&#39;plot_input_stream&#39;</span><span class="p">,</span> <span class="s1">&#39;show_plot&#39;</span><span class="p">,</span> <span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="s1">&#39;show_outlier_plot&#39;</span><span class="p">]</span>
            <span class="n">NOWTIME</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">secondaryDefaults</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;acq_date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">NOWTIME</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">NOWTIME</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">NOWTIME</span><span class="o">.</span><span class="n">day</span><span class="p">),</span>
                                 <span class="s1">&#39;hvsr_band&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="n">DEFAULT_BAND_LIST</span><span class="p">),</span> <span class="s1">&#39;use_hv_curves&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="s1">&#39;starttime&#39;</span><span class="p">:</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                                 <span class="s1">&#39;endtime&#39;</span><span class="p">:</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                 <span class="s1">&#39;peak_freq_range&#39;</span><span class="p">:</span><span class="nb">tuple</span><span class="p">(</span><span class="n">DEFAULT_BAND_LIST</span><span class="p">),</span>
                                 <span class="s1">&#39;stalta_thresh&#39;</span><span class="p">:(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
                                 <span class="s1">&#39;period_limits&#39;</span><span class="p">:(</span><span class="mi">1</span><span class="o">/</span><span class="n">DEFAULT_BAND_LIST</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="o">/</span><span class="n">DEFAULT_BAND_LIST</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                 <span class="s1">&#39;remove_method&#39;</span><span class="p">:[</span><span class="s1">&#39;None&#39;</span><span class="p">],</span>
                                 <span class="s1">&#39;report_export_format&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="s1">&#39;report_formats&#39;</span><span class="p">:</span>  <span class="p">[</span><span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">]</span> <span class="p">,</span>
                                 <span class="s1">&#39;show_pdf_report&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="s1">&#39;show_print_report&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="s1">&#39;show_plot_report&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="s1">&#39;elev_unit&#39;</span><span class="p">:</span><span class="s1">&#39;m&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;plot_type&#39;</span><span class="p">:</span><span class="s1">&#39;HVSR p ann C+ p ann Spec p&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;suppress_report_outputs&#39;</span><span class="p">:</span><span class="kc">True</span>
                                    <span class="p">}</span>
            
            <span class="n">nonDefaultParams</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">srun</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">]</span>
            <span class="n">srun</span><span class="p">[</span><span class="s1">&#39;suppress_report_outputs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;input_data&#39;</span> <span class="ow">in</span> <span class="n">srun</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">srun</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span>

            <span class="c1"># Display non-default parameters, if applicable</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">srun</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excludedKeys</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">secondaryDefaults</span> <span class="ow">and</span> <span class="n">secondaryDefaults</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">nonDefaultParams</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="n">spinnerDFList</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">nonDefaultParams</span> <span class="o">=</span> <span class="kc">True</span>

                        <span class="k">def</span><span class="w"> </span><span class="nf">_get_centered_text</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">just</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">add_parenth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">:</span>
                                <span class="n">keyText</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)[:</span><span class="n">size</span><span class="o">-</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span> <span class="s1">&#39;...&#39;</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">keyText</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                            
                            <span class="k">if</span> <span class="n">add_parenth</span><span class="p">:</span>
                                <span class="n">keyText</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">keyText</span><span class="si">}</span><span class="s2">)&quot;</span>

                            <span class="k">if</span> <span class="n">just</span><span class="o">==</span><span class="s1">&#39;center&#39;</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">keyText</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">just</span><span class="o">==</span><span class="s1">&#39;right&#39;</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">keyText</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">just</span><span class="o">==</span><span class="s1">&#39;left&#39;</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">keyText</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
                        

                        <span class="n">keyText</span> <span class="o">=</span> <span class="n">_get_centered_text</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">valText</span> <span class="o">=</span> <span class="n">_get_centered_text</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">just</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                        <span class="n">valTypeText</span> <span class="o">=</span> <span class="n">_get_centered_text</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">just</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">add_parenth</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">defValText</span> <span class="o">=</span> <span class="n">_get_centered_text</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">default_params</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">just</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
                        <span class="n">defValTypeText</span> <span class="o">=</span> <span class="n">_get_centered_text</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">default_params</span><span class="p">[</span><span class="n">key</span><span class="p">]),</span> <span class="n">just</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">add_parenth</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                        <span class="n">spinnerText</span> <span class="o">=</span> <span class="n">spinnerText</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">| </span><span class="si">{</span><span class="n">keyText</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">valText</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">valTypeText</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">defValText</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">defValTypeText</span><span class="si">}</span><span class="s2">     |&quot;</span>
                        <span class="n">spinnerDFList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">default_params</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">type</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">default_params</span><span class="p">[</span><span class="n">key</span><span class="p">])])</span>

            <span class="k">if</span> <span class="n">nonDefaultParams</span><span class="p">:</span>
                <span class="n">spinnerText</span> <span class="o">=</span> <span class="n">spinnerText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;the following non-default&#39;</span><span class="p">)</span>
                <span class="n">tableHeader</span> <span class="o">=</span>  <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">|      Parameter       |           Input Value (and type)          |            Default value (and type)           |&quot;</span>
                <span class="n">tableHeader2</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">|----------------------|-------------------------------------------|-----------------------------------------------|</span><span class="se">\n\t</span><span class="s2">&quot;</span>
                <span class="n">spinnerText</span> <span class="o">=</span> <span class="n">spinnerText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tableHeader</span><span class="o">+</span><span class="n">tableHeader2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">spinnerDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">spinnerDFList</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Parameter&#39;</span><span class="p">,</span> <span class="s2">&quot;Value Selected&quot;</span><span class="p">,</span> <span class="s2">&quot;Selected value type&quot;</span><span class="p">,</span> <span class="s1">&#39;Default Value&#39;</span><span class="p">,</span> <span class="s1">&#39;Default value type&#39;</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="n">spinnerText</span><span class="p">,</span> <span class="n">show_time</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">input_data</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_data</span><span class="p">,</span> <span class="o">**</span><span class="n">srun</span><span class="p">)</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">balloons</span><span class="p">()</span>

        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream_edited</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream_edited&#39;</span><span class="p">]</span>
        
        
        <span class="n">display_download_buttons</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">toast</span><span class="p">(</span><span class="s1">&#39;Displaying results (download available)&#39;</span><span class="p">)</span>
        <span class="n">display_results</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">prev_datapath</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_read_data</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;read_button&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">read_button</span><span class="p">:</span>
            <span class="k">return</span>


        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_data</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_data</span> <span class="o">=</span> <span class="s1">&#39;sample&#39;</span>

        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">mainContainer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">container</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">inputTab</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">infoTab</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">mainContainer</span><span class="o">.</span><span class="n">tabs</span><span class="p">([</span><span class="s1">&#39;Raw Seismic Data&#39;</span><span class="p">,</span> <span class="s1">&#39;Info&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_data</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">srun</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">run_kws</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">default_params</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">default_params</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                            <span class="n">srun</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;plot_engine&#39;</span><span class="p">:</span>
                    <span class="n">srun</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        
        <span class="n">ipKwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
        <span class="n">fdKwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>

        <span class="n">st</span><span class="o">.</span><span class="n">toast</span><span class="p">(</span><span class="s1">&#39;Reading data&#39;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;⌛&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">spinner</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reading data: </span><span class="si">{</span><span class="n">ipKwargs</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">inParams</span> <span class="o">=</span> <span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">input_params</span><span class="p">(</span><span class="o">**</span><span class="n">ipKwargs</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">fetch_data</span><span class="p">(</span><span class="n">inParams</span><span class="p">,</span> <span class="o">**</span><span class="n">fdKwargs</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">stream</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="s1">&#39;stream_edited&#39;</span><span class="p">):</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream_edited</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">stream_edited</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream_edited</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">display_read_data</span><span class="p">(</span><span class="n">do_setup_tabs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">do_interactive_display</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">interactive_display</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plot_engine</span> <span class="o">=</span> <span class="s2">&quot;Plotly&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plot_engine</span> <span class="o">=</span> <span class="s2">&quot;Matplotlib&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">display_read_data</span><span class="p">(</span><span class="n">do_setup_tabs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">do_setup_tabs</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">mainContainer</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">container</span><span class="p">()</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">inputTab</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">infoTab</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">mainContainer</span><span class="o">.</span><span class="n">tabs</span><span class="p">([</span><span class="s1">&#39;Raw Seismic Data&#39;</span><span class="p">,</span> <span class="s1">&#39;Info&#39;</span><span class="p">])</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span> <span class="o">=</span> <span class="n">make_input_fig_plotly</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plot_engine</span> <span class="o">==</span> <span class="s1">&#39;Matplotlib&#39;</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span> <span class="o">=</span> <span class="n">make_input_fig_pyplot</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">,</span> <span class="s1">&#39;data_plot&#39;</span><span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_chart_event</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">inputTab</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_plot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">,</span> <span class="s1">&#39;data_plot&#39;</span><span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_chart_event</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">inputTab</span><span class="o">.</span><span class="n">plotly_chart</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span><span class="p">,</span>
                                                <span class="n">on_select</span><span class="o">=</span><span class="n">update_data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data_plot&#39;</span><span class="p">,</span> 
                                                <span class="n">selection_mode</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="s1">&#39;streamlit&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_chart_event</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_plot</span>

            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">inputTab</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Select any time window with the Box Selector (see the top right of chart) to remove it from analysis.&quot;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_selection_mode</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">inputTab</span><span class="o">.</span><span class="n">pills</span><span class="p">(</span><span class="s1">&#39;Window Selection Mode&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="s2">&quot;Delete&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;input_selection_toggle&#39;</span><span class="p">,</span>
                                                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">update_selection_type</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If in &quot;Add&quot; mode, windows for removal will be added at your selection. If &quot;Delete&quot; mode, these windows will be deleted. Currently only &quot;Add&quot; supported&#39;</span><span class="p">)</span>
        

        <span class="c1"># Print information about the data to Info tab</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">infoTab</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Information About Input Data&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">infoTab</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Acquisition Date: </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">recLength</span> <span class="o">=</span> <span class="p">(</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span> <span class="o">-</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">))</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">infoTab</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Record Length: </span><span class="si">{</span><span class="n">recLength</span><span class="o">/</span><span class="mi">60</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> minutes (</span><span class="si">{</span><span class="n">recLength</span><span class="si">}</span><span class="s2"> seconds)&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">infoTab</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;---&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">infoTab</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">))</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">display_buttons_and_results</span><span class="p">():</span>
        <span class="n">display_download_buttons</span><span class="p">()</span>
        <span class="n">display_results</span><span class="p">()</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">display_results</span><span class="p">():</span>
        <span class="c1"># Set up container for output data</span>
        <span class="n">setup_main_container</span><span class="p">(</span><span class="n">do_setup_tabs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">toast</span><span class="p">(</span><span class="s1">&#39;Displaying results&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">interactive_display</span><span class="p">:</span>
           <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plot_engine</span> <span class="o">=</span> <span class="s2">&quot;Plotly&quot;</span>
        
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plot_engine</span> <span class="o">==</span> <span class="s2">&quot;Plotly&quot;</span><span class="p">:</span>
            <span class="c1"># Print main results right away if taking time to plot others</span>
            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">interactive_display</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">mainContainer</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Print_Report&#39;</span><span class="p">],</span>
                                                <span class="n">language</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">mainContainer</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Table_Report&#39;</span><span class="p">])</span>

            <span class="c1"># Input data</span>
            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">interactive_display</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">,</span> <span class="s1">&#39;data_results_toggle&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_results_toggle</span><span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span> <span class="o">=</span> <span class="n">make_input_fig_plotly</span><span class="p">()</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_chart_event</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">inputTab</span><span class="o">.</span><span class="n">plotly_chart</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span><span class="p">,</span>
                                                    <span class="n">on_select</span><span class="o">=</span><span class="n">update_data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data_plot&#39;</span><span class="p">,</span>
                                                    <span class="n">selection_mode</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">theme</span><span class="o">=</span><span class="s1">&#39;streamlit&#39;</span><span class="p">)</span>

                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">inputTab</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Select any time window with the Box Selector (see the top right of chart) to remove it from analysis.&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_selection_mode</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">inputTab</span><span class="o">.</span><span class="n">pills</span><span class="p">(</span><span class="s1">&#39;Window Selection Mode&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="s2">&quot;Delete&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;input_selection_toggle&#39;</span><span class="p">,</span>
                                                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;Add&#39;</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">update_selection_type</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;If in &quot;Add&quot; mode, windows for removal will be added at your selection. If &quot;Delete&quot; mode, these windows will be deleted. Currently only &quot;Add&quot; supported&#39;</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">inputTab</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Display input data stream and windows used&#39;</span><span class="p">,</span>
                                                <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                <span class="n">on_change</span><span class="o">=</span><span class="n">display_buttons_and_results</span><span class="p">,</span>
                                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Toggle on to display interactive chart with input data stream for selecting windows for removal.&#39;</span><span class="p">,</span>
                                                <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data_results_toggle&#39;</span><span class="p">)</span>
                
            <span class="n">write_to_info_tab</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">infoTab</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">interactive_display</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">,</span> <span class="s1">&#39;outlier_toggle&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlier_toggle</span><span class="p">):</span>
                <span class="n">outlier_plot_in_tab</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlierTab</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Display outlier chart&#39;</span><span class="p">,</span>
                                                <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Turn on to display outlier chart (you may need to navigate back to this tab)&#39;</span><span class="p">,</span>
                                                <span class="n">key</span><span class="o">=</span><span class="s1">&#39;outlier_toggle&#39;</span><span class="p">,</span>
                                                <span class="n">on_change</span><span class="o">=</span><span class="n">display_buttons_and_results</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">interactive_display</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plotReportTab</span><span class="o">.</span><span class="n">plotly_chart</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Plot_Report&#39;</span><span class="p">],</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plotReportTab</span><span class="o">.</span><span class="n">html</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s2">&quot;HTML_Report&quot;</span><span class="p">])</span>

            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">csvReportTab</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Table_Report&#39;</span><span class="p">])</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">strReportTab</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Print_Report&#39;</span><span class="p">],</span> <span class="n">language</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Matplotlib</span>
            <span class="c1"># Input plot</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span> <span class="o">=</span> <span class="n">make_input_fig_pyplot</span><span class="p">()</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_chart_event</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">inputTab</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span><span class="p">,</span>
                                                                                 <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Info tab</span>
            <span class="n">write_to_info_tab</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">infoTab</span><span class="p">)</span>

            <span class="c1"># Outlier chart</span>
            <span class="n">outlier_plot_in_tab</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">interactive_display</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plotReportTab</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Plot_Report&#39;</span><span class="p">],</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plotReportTab</span><span class="o">.</span><span class="n">html</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s2">&quot;HTML_Report&quot;</span><span class="p">])</span>
                <span class="c1">#st.session_state.plotReportTab.pyplot(st.session_state.hvsr_data[&#39;Plot_Report&#39;], use_container_width=True)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">csvReportTab</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Table_Report&#39;</span><span class="p">])</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">strReportTab</span><span class="o">.</span><span class="n">code</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Print_Report&#39;</span><span class="p">],</span> <span class="n">language</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="nd">@st</span><span class="o">.</span><span class="n">fragment</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">display_download_buttons</span><span class="p">():</span>
        <span class="c1">##dlText, dlPDFReport, dlStream, dlTable, dlPlot, dlHVSR = st.session_state.mainContainer.columns([0.2, 0.16, 0.16, 0.16, 0.16, 0.16])</span>
        <span class="n">dlText</span><span class="p">,</span> <span class="n">dlStream</span><span class="p">,</span> <span class="n">dlHVSR</span><span class="p">,</span> <span class="n">dlPDFReport</span><span class="p">,</span> <span class="n">dlTable</span><span class="p">,</span> <span class="n">dlPlot</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">])</span>
        <span class="n">st</span><span class="o">.</span><span class="n">divider</span><span class="p">()</span>

        <span class="c1"># Download Buttons</span>
        <span class="c1">##st.session_state.dlText.text(&quot;Download Results: &quot;)</span>
        <span class="n">dlText</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;Download Results: &quot;</span><span class="p">)</span>

        <span class="c1"># Set up variables for download section</span>
        <span class="n">hvData</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span>
        <span class="n">hvID</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvData</span><span class="p">,</span> <span class="s1">&#39;hvsr_id&#39;</span><span class="p">):</span>
            <span class="n">hvID</span> <span class="o">=</span> <span class="n">hvData</span><span class="p">[</span><span class="s1">&#39;hvsr_id&#39;</span><span class="p">]</span>

        <span class="n">nowTimeStr</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># PDF Report download</span>
        <span class="c1">#@st.cache_data</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_convert_pdf_for_download</span><span class="p">(</span><span class="n">_hv_data</span><span class="p">):</span>
            <span class="n">pdfPath</span> <span class="o">=</span> <span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">_generate_pdf_report</span><span class="p">(</span><span class="n">_hv_data</span><span class="p">,</span> <span class="n">return_pdf_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdfPath</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pdf_file</span><span class="p">:</span>
                <span class="n">PDFbyte</span> <span class="o">=</span> <span class="n">pdf_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">PDFbyte</span>

        <span class="n">pdf_byte</span> <span class="o">=</span> <span class="n">_convert_pdf_for_download</span><span class="p">(</span><span class="n">hvData</span><span class="p">)</span>

        <span class="n">dlPDFReport</span><span class="o">.</span><span class="n">download_button</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Report (.pdf)&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">pdf_byte</span><span class="p">,</span>
                    <span class="c1">#on_click=display_results,</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvData</span><span class="o">.</span><span class="n">site</span><span class="si">}</span><span class="s2">_Report_</span><span class="si">{</span><span class="n">hvID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">nowTimeStr</span><span class="si">}</span><span class="s2">.pdf&quot;</span><span class="p">,</span>
                    <span class="n">mime</span><span class="o">=</span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">,</span>
                    <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;:material/summarize:&quot;</span><span class="p">)</span>

        <span class="c1"># Data Stream</span>
        <span class="c1">#@st.cache_data</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_convert_stream_for_download</span><span class="p">(</span><span class="n">_stream</span><span class="p">):</span>
            <span class="n">strm</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="n">_stream</span> <span class="o">=</span> <span class="n">_stream</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">_stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">strm</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;MSEED&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">strm</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">streamBytes</span> <span class="o">=</span> <span class="n">_convert_stream_for_download</span><span class="p">(</span><span class="n">hvData</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span>

        <span class="c1">##st.session_state.dlStream.download_button(</span>
        <span class="n">dlStream</span><span class="o">.</span><span class="n">download_button</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Data (.mseed)&#39;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">streamBytes</span><span class="p">,</span>
            <span class="c1">#on_click=display_results,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvData</span><span class="o">.</span><span class="n">site</span><span class="si">}</span><span class="s2">_Stream_</span><span class="si">{</span><span class="n">hvID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">nowTimeStr</span><span class="si">}</span><span class="s2">.mseed&quot;</span><span class="p">,</span>
            <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;:material/graphic_eq:&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Table download</span>
        <span class="c1">#@st.cache_data</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_convert_table_for_download</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

        <span class="n">csv</span> <span class="o">=</span> <span class="n">_convert_table_for_download</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Table_Report&#39;</span><span class="p">])</span>

        <span class="c1">##st.session_state.dlTable.download_button(</span>
        <span class="n">dlTable</span><span class="o">.</span><span class="n">download_button</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Table (.csv)&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">csv</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvData</span><span class="o">.</span><span class="n">site</span><span class="si">}</span><span class="s2">_TableReport_</span><span class="si">{</span><span class="n">hvID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">nowTimeStr</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span>
            <span class="c1">#on_click=display_results,</span>
            <span class="n">mime</span><span class="o">=</span><span class="s2">&quot;text/csv&quot;</span><span class="p">,</span>
            <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;:material/table:&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Plot</span>
        <span class="c1">#@st.cache_data</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">_convert_plot_for_download</span><span class="p">(</span><span class="n">_HV_Plot</span><span class="p">):</span>            
            <span class="n">_img</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plot_engine</span> <span class="o">==</span> <span class="s1">&#39;Matplotlib&#39;</span><span class="p">:</span>
                <span class="n">_HV_Plot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">_img</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_img</span> <span class="o">=</span> <span class="n">_HV_Plot</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">_img</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">_convert_plot_for_download</span><span class="p">(</span><span class="n">hvData</span><span class="p">[</span><span class="s1">&#39;Plot_Report&#39;</span><span class="p">])</span>

        <span class="c1">##st.session_state.dlPlot.download_button(</span>
        <span class="n">dlPlot</span><span class="o">.</span><span class="n">download_button</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Plot (.png)&quot;</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">img</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvData</span><span class="o">.</span><span class="n">site</span><span class="si">}</span><span class="s2">_HV-Plot_</span><span class="si">{</span><span class="n">hvID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">nowTimeStr</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
            <span class="n">mime</span><span class="o">=</span><span class="s2">&quot;image/png&quot;</span><span class="p">,</span>
            <span class="c1">#on_click=display_results,</span>
            <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;:material/analytics:&quot;</span>
            <span class="p">)</span>


        <span class="c1"># HVSR File</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#@st.cache_data</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">_convert_hvsr_for_download</span><span class="p">(</span><span class="n">_hvsr_data</span><span class="p">):</span>
                <span class="n">hvData</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">_hvsr_data</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">pk</span> <span class="ow">in</span> <span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">PLOT_KEYS</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvData</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
                        <span class="nb">delattr</span><span class="p">(</span><span class="n">hvData</span><span class="p">,</span> <span class="n">pk</span><span class="p">)</span>

                <span class="n">_hvsrPickle</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">hvData</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">_hvsrPickle</span>
    
            <span class="n">hvsrPickle</span> <span class="o">=</span> <span class="n">_convert_hvsr_for_download</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">)</span>

            <span class="c1">##st.session_state.dlHVSR.download_button(</span>
            <span class="n">dlHVSR</span><span class="o">.</span><span class="n">download_button</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Pickled (.hvsr)&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">hvsrPickle</span><span class="p">,</span>
                <span class="n">file_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvData</span><span class="o">.</span><span class="n">site</span><span class="si">}</span><span class="s2">_HVSRData_</span><span class="si">{</span><span class="n">hvID</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">nowTimeStr</span><span class="si">}</span><span class="s2">_pickled_app.hvsr&quot;</span><span class="p">,</span>
                <span class="c1">#on_click=display_results,</span>
                <span class="n">mime</span><span class="o">=</span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">,</span>
                <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;:material/database:&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="c1">##st.session_state.dlHVSR.button(</span>
            <span class="n">dlHVSR</span><span class="o">.</span><span class="n">download_button</span><span class="p">(</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;.hvsr not available&quot;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="s1">&#39;HVSR Data &#39;</span><span class="p">,</span>
                <span class="n">disabled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;:material/database:&quot;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">on_reset</span><span class="p">():</span>
        <span class="n">st</span><span class="o">.</span><span class="n">toast</span><span class="p">(</span><span class="s2">&quot;Session state cleared&quot;</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="s1">&#39;NewSessionState&#39;</span><span class="p">]</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">_get_use_array</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timeWindowArr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psdArr</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">streamEdit</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream_edited</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">earliestStart</span> <span class="o">=</span> <span class="n">UTCDateTime</span><span class="p">(</span><span class="mi">3000</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">streamEdit</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">&lt;</span> <span class="n">earliestStart</span><span class="p">:</span>
                <span class="n">earliestStart</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>

        <span class="n">zList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">eList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">nList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">streamEdit</span> <span class="o">=</span> <span class="n">streamEdit</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">streamEdit</span><span class="p">:</span>
            <span class="n">traceSTime</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
            <span class="n">traceETime</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>

            <span class="k">if</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span>
                <span class="n">zList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">traceSTime</span><span class="p">,</span> <span class="n">traceETime</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span>
                <span class="n">eList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">traceSTime</span><span class="p">,</span> <span class="n">traceETime</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
                <span class="n">nList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">traceSTime</span><span class="p">,</span> <span class="n">traceETime</span><span class="p">])</span>

        <span class="n">gapListUTC</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">currWindow</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zList</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">prevWindow</span> <span class="o">=</span> <span class="n">zList</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">gapListUTC</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">prevWindow</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">currWindow</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="n">gapList</span> <span class="o">=</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">gTimeUTC</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">gTimeUTC</span> <span class="ow">in</span> <span class="n">gap</span><span class="p">]</span> <span class="k">for</span> <span class="n">gap</span> <span class="ow">in</span> <span class="n">gapListUTC</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">):</span>
            <span class="n">hvdf</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_windows_df</span>
            <span class="n">tps</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">hvdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;TimesProcessed_Start&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">hvdf</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="n">hvdf</span><span class="p">[</span><span class="s2">&quot;TimesProcessed_Start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tps</span>
            <span class="n">useArrShape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">useSeriesList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">sTimeSeriesList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">eTimeSeriesList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">useArrShape</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tArr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timeWindowArr</span><span class="p">):</span>
                <span class="n">useSeriesList</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="kc">True</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tArr</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">sTimeSeriesList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tArr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">eTimeSeriesList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tArr</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                
                <span class="n">useArrShape</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psdArr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">useSeries</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">useSeriesList</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Use&#39;</span><span class="p">)</span>
            <span class="n">sTimeSeries</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">sTimeSeriesList</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;TimesProcessed&#39;</span><span class="p">)</span>
            <span class="n">eTimeSeries</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">eTimeSeriesList</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;TimesProcessed_End&#39;</span><span class="p">)</span>

            <span class="n">hvdf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;TimesProcessed&#39;</span><span class="p">:</span><span class="n">sTimeSeries</span><span class="p">,</span>
                                <span class="s1">&#39;TimesProcessed_End&#39;</span><span class="p">:</span><span class="n">eTimeSeries</span><span class="p">,</span>
                                <span class="s1">&#39;Use&#39;</span><span class="p">:</span><span class="n">useSeries</span><span class="p">})</span>

            <span class="n">hvdf</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;TimesProcessed&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_Start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sTimeSeriesList</span>
            

        <span class="k">if</span> <span class="s1">&#39;TimesProcessed_Obspy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hvdf</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_Obspy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">dt64</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt64</span> <span class="ow">in</span> <span class="n">sTimeSeries</span><span class="p">]</span>
            <span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_ObspyEnd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">dt64</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt64</span> <span class="ow">in</span> <span class="n">eTimeSeries</span><span class="p">]</span>

        <span class="c1"># Do processing</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gapListUTC</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">gap</span> <span class="ow">in</span> <span class="n">gapListUTC</span><span class="p">:</span>

                <span class="n">stOutEndIn</span> <span class="o">=</span> <span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_Obspy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">gap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_Obspy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">gap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">stInEndOut</span> <span class="o">=</span> <span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_ObspyEnd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">gap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_ObspyEnd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">gap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">bothIn</span> <span class="o">=</span> <span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_Obspy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">gap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_ObspyEnd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">gap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">bothOut</span> <span class="o">=</span> <span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_Obspy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">gap</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_ObspyEnd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">gap</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="n">hvdf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">hvdf</span><span class="p">[</span><span class="n">stOutEndIn</span> <span class="o">|</span> <span class="n">stInEndOut</span> <span class="o">|</span> <span class="n">bothIn</span> <span class="o">|</span> <span class="n">bothOut</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">hvdf</span><span class="p">,</span> <span class="n">useArrShape</span>


    <span class="nd">@st</span><span class="o">.</span><span class="n">cache_data</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_stream_specgram</span><span class="p">(</span><span class="n">_trace</span><span class="p">):</span>

        <span class="k">return</span> <span class="n">signal</span><span class="o">.</span><span class="n">spectrogram</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">_trace</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">fs</span><span class="o">=</span><span class="n">_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">,</span>
                                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;magnitude&#39;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">make_input_fig_pyplot</span><span class="p">():</span>
        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">stream</span>
        
        <span class="n">inputFig</span> <span class="o">=</span> <span class="n">sprit_plot</span><span class="o">.</span><span class="n">_plot_input_stream_mpl</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
                                                     <span class="n">hv_data</span><span class="o">=</span><span class="n">hvsr_data</span><span class="p">,</span>
                                                     <span class="n">return_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span> <span class="o">=</span> <span class="n">inputFig</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">Input_Plot</span> <span class="o">=</span> <span class="n">inputFig</span>

        <span class="k">return</span> <span class="n">inputFig</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">make_input_fig_plotly</span><span class="p">():</span>
        <span class="n">no_subplots</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">inputFig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">no_subplots</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                        <span class="n">row_heights</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">],</span>
                                        <span class="n">shared_xaxes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">horizontal_spacing</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                        <span class="n">vertical_spacing</span><span class="o">=</span><span class="mf">0.01</span>
                                        <span class="p">)</span>

        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span>

        <span class="c1"># Windows PSD and Used</span>
        <span class="c1">#psdArr = np.flip(hvsr_data.ppsds[&quot;Z&quot;][&#39;psd_values&#39;].T)</span>
        <span class="n">zStream</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span> 
        <span class="n">zTraces</span> <span class="o">=</span> <span class="n">zStream</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">zTrace</span> <span class="o">=</span> <span class="n">zStream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">eStream</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span> 
        <span class="n">eTraces</span> <span class="o">=</span> <span class="n">eStream</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">eTrace</span> <span class="o">=</span> <span class="n">eStream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">nStream</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
        <span class="n">nTraces</span> <span class="o">=</span> <span class="n">nStream</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">nTrace</span> <span class="o">=</span> <span class="n">nStream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">specKey</span> <span class="o">=</span> <span class="s1">&#39;Z&#39;</span>

        <span class="n">xTraceTimesAppZ</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">specTimes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">psdArr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">timeWindowArr</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">sTimeZ</span> <span class="o">=</span> <span class="n">zTraces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
        <span class="n">sTimeE</span> <span class="o">=</span> <span class="n">eTraces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
        <span class="n">sTimeN</span> <span class="o">=</span> <span class="n">nTraces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>        
      
        <span class="c1"># E</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">eTr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eTraces</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xTraceTimesE</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">((</span><span class="n">sTimeE</span> <span class="o">+</span> <span class="n">tT</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">tT</span> <span class="ow">in</span> <span class="n">eTr</span><span class="o">.</span><span class="n">times</span><span class="p">()]</span>
                <span class="n">xTraceTimesAppE</span> <span class="o">=</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">((</span><span class="n">sTimeE</span> <span class="o">+</span> <span class="n">tT</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">tT</span> <span class="ow">in</span> <span class="n">eTr</span><span class="o">.</span><span class="n">times</span><span class="p">()]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xTraceTimesAppE</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">((</span><span class="n">sTimeE</span> <span class="o">+</span> <span class="n">tT</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">tT</span> <span class="ow">in</span> <span class="n">eTr</span><span class="o">.</span><span class="n">times</span><span class="p">()])</span>
                <span class="n">xTraceTimesE</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">((</span><span class="n">sTimeE</span> <span class="o">+</span> <span class="n">tT</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">tT</span> <span class="ow">in</span> <span class="n">eTr</span><span class="o">.</span><span class="n">times</span><span class="p">()])</span>

        <span class="c1"># N</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nTr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nTraces</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xTraceTimesN</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">((</span><span class="n">sTimeN</span> <span class="o">+</span> <span class="n">tT</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">tT</span> <span class="ow">in</span> <span class="n">nTr</span><span class="o">.</span><span class="n">times</span><span class="p">()]</span>
                <span class="n">xTraceTimesAppN</span> <span class="o">=</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">((</span><span class="n">sTimeN</span> <span class="o">+</span> <span class="n">tT</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">tT</span> <span class="ow">in</span> <span class="n">nTr</span><span class="o">.</span><span class="n">times</span><span class="p">()]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xTraceTimesAppN</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">((</span><span class="n">sTimeN</span> <span class="o">+</span> <span class="n">tT</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">tT</span> <span class="ow">in</span> <span class="n">nTr</span><span class="o">.</span><span class="n">times</span><span class="p">()])</span>
                <span class="n">xTraceTimesN</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">((</span><span class="n">sTimeN</span> <span class="o">+</span> <span class="n">tT</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">tT</span> <span class="ow">in</span> <span class="n">nTr</span><span class="o">.</span><span class="n">times</span><span class="p">()])</span>



        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">zTrace</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zTraces</span><span class="p">):</span>
            <span class="n">sTimeZ</span> <span class="o">=</span> <span class="n">zTrace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xTraceTimesZ</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">((</span><span class="n">sTimeZ</span> <span class="o">+</span> <span class="n">tT</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">tT</span> <span class="ow">in</span> <span class="n">zTrace</span><span class="o">.</span><span class="n">times</span><span class="p">()]</span>
                <span class="n">xTraceTimesAppZ</span> <span class="o">=</span> <span class="p">[[</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">((</span><span class="n">sTimeZ</span> <span class="o">+</span> <span class="n">tT</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">tT</span> <span class="ow">in</span> <span class="n">zTrace</span><span class="o">.</span><span class="n">times</span><span class="p">()]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xTraceTimesAppZ</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">((</span><span class="n">sTimeZ</span> <span class="o">+</span> <span class="n">tT</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">tT</span> <span class="ow">in</span> <span class="n">zTrace</span><span class="o">.</span><span class="n">times</span><span class="p">()])</span>
                <span class="n">xTraceTimesZ</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">((</span><span class="n">sTimeZ</span> <span class="o">+</span> <span class="n">tT</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">tT</span> <span class="ow">in</span> <span class="n">zTrace</span><span class="o">.</span><span class="n">times</span><span class="p">()])</span>

            <span class="n">fTemp</span><span class="p">,</span> <span class="n">specTimesTemp</span><span class="p">,</span> <span class="n">psdArrTemp</span> <span class="o">=</span> <span class="n">_generate_stream_specgram</span><span class="p">(</span><span class="n">_trace</span><span class="o">=</span><span class="n">zTrace</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fTemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fTemp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fTemp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span> <span class="c1"># Fix so bottom number is not 0</span>
            <span class="n">f</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fTemp</span><span class="p">)</span>

            <span class="n">specTimesTemp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">specTimesTemp</span><span class="p">)</span>
            <span class="n">specTimesTemp</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">specTimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">specTimesTemp</span><span class="p">)</span>

            <span class="n">timeWindowArr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">((</span><span class="n">sTimeZ</span> <span class="o">+</span> <span class="n">tT</span><span class="p">)</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="k">for</span> <span class="n">tT</span> <span class="ow">in</span> <span class="n">specTimesTemp</span><span class="p">]))</span>
            
            <span class="n">psdArr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psdArrTemp</span><span class="p">)</span>


            <span class="n">minz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">psdArrTemp</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">maxz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">psdArrTemp</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>

            <span class="n">hmap</span> <span class="o">=</span> <span class="n">goHeatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">psdArrTemp</span><span class="p">,</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">timeWindowArr</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">fTemp</span><span class="p">,</span>
                        <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;Turbo&#39;</span><span class="p">,</span> <span class="c1">#opacity=0.8,</span>
                        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;Time [UTC]: %</span><span class="si">{x}</span><span class="s1">&lt;br&gt;Frequency [Hz]: %</span><span class="si">{y:.2f}</span><span class="s1">&lt;br&gt;Spectrogram Magnitude: %</span><span class="si">{z:.2f}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
                        <span class="n">zmin</span><span class="o">=</span><span class="n">minz</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="n">maxz</span><span class="p">,</span> <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">specKey</span><span class="si">}</span><span class="s1"> Component Spectrogram; Trace </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


            <span class="n">inputFig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">hmap</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream_spec_freqs</span> <span class="o">=</span> <span class="n">f</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream_spec_times</span> <span class="o">=</span> <span class="n">specTimes</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">psdArr</span> <span class="o">=</span> <span class="n">psdArr</span>

        <span class="n">hvsrBand</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">]</span>

        <span class="n">inputFig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hvsrBand</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hvsrBand</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inputFig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="sa">f</span><span class="s1">&#39;Spectrogram (</span><span class="si">{</span><span class="n">specKey</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">},</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Get Use Array and hvdf</span>
        <span class="n">hvdf</span><span class="p">,</span> <span class="n">useArrShape</span> <span class="o">=</span> <span class="n">_get_use_array</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">timeWindowArr</span><span class="o">=</span><span class="n">timeWindowArr</span><span class="p">,</span> <span class="n">psdArr</span><span class="o">=</span><span class="n">psdArr</span><span class="p">)</span>

        <span class="n">timelineFig</span> <span class="o">=</span> <span class="n">pxTimeline</span><span class="p">(</span><span class="n">data_frame</span><span class="o">=</span><span class="n">hvdf</span><span class="p">,</span>
                                <span class="n">x_start</span><span class="o">=</span><span class="s1">&#39;TimesProcessed_Start&#39;</span><span class="p">,</span>
                                <span class="n">x_end</span><span class="o">=</span><span class="s1">&#39;TimesProcessed_End&#39;</span><span class="p">,</span>
                                <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Used&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">hvdf</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="c1">#y=&quot;Use&quot;,#range_y=[-20, -10],</span>
                                <span class="n">color</span><span class="o">=</span><span class="s1">&#39;Use&#39;</span><span class="p">,</span>
                                <span class="n">color_discrete_map</span><span class="o">=</span><span class="p">{</span><span class="kc">True</span><span class="p">:</span> <span class="s1">&#39;rgba(0,255,0,1)&#39;</span><span class="p">,</span>
                                                    <span class="kc">False</span><span class="p">:</span> <span class="s1">&#39;rgba(255,0,0,1)&#39;</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">timelineTrace</span> <span class="ow">in</span> <span class="n">timelineFig</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">inputFig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">timelineTrace</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">useArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">hvdf</span><span class="o">.</span><span class="n">Use</span><span class="p">,</span> <span class="p">(</span><span class="n">useArrShape</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">useArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">useArr</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">useArr</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">useArr</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>


        <span class="n">specOverlay</span> <span class="o">=</span> <span class="n">goHeatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">useArr</span><span class="p">,</span>
                            <span class="n">x</span><span class="o">=</span><span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_Start&#39;</span><span class="p">],</span>
                            <span class="n">y</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                            <span class="n">colorscale</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;rgba(0,0,0,0.8)&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;rgba(255,255,255, 0.00001)&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;rgba(255,255,255, 0.00001)&#39;</span><span class="p">]],</span>
                            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="c1">#hovertemplate=&#39;Time [UTC]: %{x}&lt;br&gt;Frequency [Hz]: %{y:.2f}&lt;br&gt;Spectrogram Magnitude: %{z:.2f}&lt;extra&gt;&lt;/extra&gt;&#39;,</span>
                            <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">specKey</span><span class="si">}</span><span class="s1"> Component Spectrogram&#39;</span><span class="p">)</span>
        <span class="n">inputFig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">specOverlay</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">minTraceData</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">zTrace</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">eTrace</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">nTrace</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
        <span class="n">maxTraceData</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">zTrace</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">eTrace</span><span class="o">.</span><span class="n">data</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">nTrace</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

        <span class="n">streamOverlay</span> <span class="o">=</span> <span class="n">goHeatmap</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">useArr</span><span class="p">,</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_Start&#39;</span><span class="p">],</span>
                        <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minTraceData</span><span class="p">,</span> <span class="n">maxTraceData</span><span class="p">,</span> <span class="n">useArr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">colorscale</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;rgba(0,0,0,0.8)&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;rgba(255,255,255, 0.00001)&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;rgba(255,255,255, 0.00001)&#39;</span><span class="p">]],</span>
                        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="c1">#hovertemplate=&#39;Time [UTC]: %{x}&lt;br&gt;Frequency [Hz]: %{y:.2f}&lt;br&gt;Spectrogram Magnitude: %{z:.2f}&lt;extra&gt;&lt;/extra&gt;&#39;,</span>
                        <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">specKey</span><span class="si">}</span><span class="s1"> Component Spectrogram&#39;</span><span class="p">)</span>
        <span class="n">inputFig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">streamOverlay</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inputFig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">streamOverlay</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inputFig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">streamOverlay</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">inputFig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hvsrBand</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hvsrBand</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inputFig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="sa">f</span><span class="s1">&#39;Spectrogram (</span><span class="si">{</span><span class="n">specKey</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">},</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


        <span class="c1"># Data traces</span>
        <span class="c1"># Z Traces</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">zTr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">zTraces</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">zDataFig</span> <span class="o">=</span> <span class="n">pxScatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xTraceTimesAppZ</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">zTr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zTempFig</span> <span class="o">=</span> <span class="n">pxScatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xTraceTimesAppZ</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">zTr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">zFigTrace</span> <span class="ow">in</span> <span class="n">zTempFig</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="n">zDataFig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">zFigTrace</span><span class="p">)</span>
        
        <span class="n">zDataFig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">,</span>
                            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;rgba(0,0,0,1)&#39;</span><span class="p">),</span>
                            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;rgba(0,0,0,1)&#39;</span><span class="p">),</span>
                            <span class="n">selector</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">zTrace</span> <span class="ow">in</span> <span class="n">zDataFig</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">inputFig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">zTrace</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># E Traces</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">eTr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eTraces</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">eDataFig</span> <span class="o">=</span> <span class="n">pxScatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xTraceTimesAppE</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">eTr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eTempFig</span> <span class="o">=</span> <span class="n">pxScatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xTraceTimesAppE</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">eTr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">eFigTrace</span> <span class="ow">in</span> <span class="n">eTempFig</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="n">eDataFig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">eFigTrace</span><span class="p">)</span>
        

        <span class="c1">#eDataFig = pxScatter(x=xTraceTimes, y=eTrace.data)</span>
        <span class="n">eDataFig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">,</span>
                            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;rgba(0,0,255,1)&#39;</span><span class="p">),</span>
                            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;rgba(0,0,255,1)&#39;</span><span class="p">),</span>
                            <span class="n">selector</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">eTrace</span> <span class="ow">in</span> <span class="n">eDataFig</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">inputFig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">eTrace</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># N Traces</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nTr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">nTraces</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">nDataFig</span> <span class="o">=</span> <span class="n">pxScatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xTraceTimesAppN</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">nTr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nTempFig</span> <span class="o">=</span> <span class="n">pxScatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xTraceTimesAppN</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">nTr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">nFigTrace</span> <span class="ow">in</span> <span class="n">nTempFig</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="n">nDataFig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">nFigTrace</span><span class="p">)</span>
        
        <span class="c1">#nDataFig = pxScatter(x=xTraceTimes, y=nTrace.data)</span>
        <span class="n">nDataFig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">,</span>
                            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;rgba(255,0,0,1)&#39;</span><span class="p">),</span>
                            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;rgba(255,0,0,1)&#39;</span><span class="p">),</span>
                            <span class="n">selector</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">nTrace</span> <span class="ow">in</span> <span class="n">nDataFig</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
            <span class="n">inputFig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">nTrace</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>



        <span class="c1">#zDataFig = pxScatter(x=xTraceTimes, y=zTrace.data)</span>
        <span class="c1">#zDataFig.update_traces(mode=&#39;markers+lines&#39;,</span>
        <span class="c1">#                    marker=dict(size=1, color=&#39;rgba(0,0,0,1)&#39;),</span>
        <span class="c1">#                    line=dict(width=1, color=&#39;rgba(0,0,0,1)&#39;),</span>
        <span class="c1">#                    selector=dict(mode=&#39;markers&#39;))</span>
        <span class="c1">#for zTrace in zDataFig.data:</span>
        <span class="c1">#    inputFig.add_trace(zTrace, row=3, col=1)</span>


        <span class="c1">#eDataFig = pxScatter(x=xTraceTimes, y=eTrace.data)</span>
        <span class="c1">#eDataFig.update_traces(mode=&#39;markers+lines&#39;,</span>
        <span class="c1">#                    marker=dict(size=1, color=&#39;rgba(0,0,255,1)&#39;),</span>
        <span class="c1">#                    line=dict(width=1, color=&#39;rgba(0,0,255,1)&#39;),</span>
        <span class="c1">#                    selector=dict(mode=&#39;markers&#39;))</span>
        <span class="c1">#for eTrace in eDataFig.data:</span>
        <span class="c1">#    inputFig.add_trace(eTrace, row=4, col=1)</span>


        <span class="c1">#nDataFig = pxScatter(x=xTraceTimes, y=nTrace.data)</span>
        <span class="c1">#nDataFig.update_traces(mode=&#39;markers+lines&#39;,</span>
        <span class="c1">#                    marker=dict(size=1, color=&#39;rgba(255,0,0,1)&#39;),</span>
        <span class="c1">#                    line=dict(width=1, color=&#39;rgba(255,0,0,1)&#39;),</span>
        <span class="c1">#                    selector=dict(mode=&#39;markers&#39;))</span>
        <span class="c1">#for nTrace in nDataFig.data:</span>
        <span class="c1">#    inputFig.add_trace(nTrace, row=5, col=1)</span>

        <span class="c1">#inputFig.update_yaxes(title=&#39;In Use&#39;, row=5, col=1)</span>
        <span class="c1">#inputFig.update_xaxes(title=&#39;Time&#39;, row=5, col=1,</span>
        <span class="c1">#                      dtick=1000*60,)</span>
        <span class="n">inputFig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Frequency and Data values over time&quot;</span><span class="p">,</span> 
                            <span class="n">height</span><span class="o">=</span><span class="mi">650</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">chartStartT</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xTraceTimesZ</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xTraceTimesE</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xTraceTimesN</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">chartEndT</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xTraceTimesZ</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xTraceTimesE</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">xTraceTimesN</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">inputFig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">chartStartT</span><span class="p">,</span> <span class="n">chartEndT</span><span class="p">])</span>

        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span> <span class="o">=</span> <span class="n">inputFig</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">Input_Plot</span> <span class="o">=</span> <span class="n">inputFig</span>

        <span class="k">return</span> <span class="n">inputFig</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">update_from_data_selection</span><span class="p">():</span>
        <span class="n">st</span><span class="o">.</span><span class="n">toast</span><span class="p">(</span><span class="s2">&quot;Updating H/V Curve statistics&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;PPSDStatus&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">processing_status</span> <span class="ow">and</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">processing_status</span><span class="p">[</span><span class="s1">&#39;PPSDStatus&#39;</span><span class="p">]:</span>
            <span class="n">gpsd_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">generate_psds</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;hvsr_data&#39;</span><span class="p">}</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">generate_psds</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="o">**</span><span class="n">gpsd_kwargs</span><span class="p">)</span>
            

        <span class="n">prochvsr_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">process_hvsr</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;hvsr_data&#39;</span><span class="p">}</span>
        <span class="n">checkPeaks_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">check_peaks</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;hvsr_data&#39;</span><span class="p">}</span>
        <span class="n">getRep_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">get_report</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;hvsr_data&#39;</span><span class="p">}</span>

        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">process_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="o">**</span><span class="n">prochvsr_kwargs</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">check_peaks</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="o">**</span><span class="n">checkPeaks_kwargs</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">get_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="o">**</span><span class="n">getRep_kwargs</span><span class="p">)</span>

        <span class="n">display_results</span><span class="p">()</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">update_data</span><span class="p">():</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_chart_event</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_plot</span>
        <span class="n">specKey</span> <span class="o">=</span> <span class="s1">&#39;Z&#39;</span>
        <span class="n">hvsrBand</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_band</span>
        <span class="c1"># Still figuring stuff out</span>
        
        <span class="c1"># This seems to work well at the moment</span>
        <span class="n">windows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_chart_event</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;box&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">esb</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_chart_event</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;box&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">esb</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>

        <span class="c1"># Reset the variables</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">data_chart_event</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;selection&quot;</span><span class="p">:{</span><span class="s2">&quot;points&quot;</span><span class="p">:[],</span>
                                            <span class="s2">&quot;point_indices&quot;</span><span class="p">:[],</span>
                                            <span class="s1">&#39;box&#39;</span><span class="p">:[],</span>
                                            <span class="s1">&#39;lasso&#39;</span><span class="p">:[]}}</span>

        <span class="k">if</span> <span class="s1">&#39;x_windows_out&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_windows_out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Convert times to obspy.UTCDateTime</span>
        <span class="n">utcdtWin</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">currWin</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
            <span class="n">currUTCWin</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># Get </span>
            <span class="n">stream1</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream_edited</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">stream2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream_edited</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">stream1</span> <span class="o">=</span> <span class="n">stream1</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
            <span class="n">stream2</span> <span class="o">=</span> <span class="n">stream2</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">pdtimestamp</span> <span class="ow">in</span> <span class="n">currWin</span><span class="p">:</span>
                <span class="n">currUTCWin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">pdtimestamp</span><span class="p">))</span>
            <span class="n">utcdtWin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currUTCWin</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_windows_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currUTCWin</span><span class="p">)</span>

            <span class="c1"># Trim data with gap in the middle where we remvoed data</span>
            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_selection_mode</span> <span class="o">==</span> <span class="s1">&#39;Add&#39;</span><span class="p">:</span>
                <span class="n">stream1</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">stream1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="n">currUTCWin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">stream2</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">currUTCWin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">endtime</span><span class="o">=</span><span class="n">stream2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">)</span>

            <span class="c1"># Merge data back</span>
            <span class="n">newStream</span> <span class="o">=</span> <span class="p">(</span><span class="n">stream1</span> <span class="o">+</span> <span class="n">stream2</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream_edited&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newStream</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream_edited</span> <span class="o">=</span> <span class="n">newStream</span>

        <span class="c1"># Use edited data to update location of bars</span>
        <span class="c1"># Update useArr</span>
        <span class="n">hvdf</span><span class="p">,</span> <span class="n">useArrShape</span> <span class="o">=</span> <span class="n">_get_use_array</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">,</span>
                                        <span class="n">f</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream_spec_freqs</span><span class="p">,</span>
                                        <span class="n">timeWindowArr</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream_spec_times</span><span class="p">,</span>
                                        <span class="n">psdArr</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">psdArr</span><span class="p">)</span>
        
        <span class="n">useArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">hvdf</span><span class="o">.</span><span class="n">Use</span><span class="p">,</span> <span class="p">(</span><span class="n">useArrShape</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">useArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">useArr</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">useArr</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">useArr</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">newSpecOverlay</span> <span class="o">=</span> <span class="n">goHeatmap</span><span class="p">(</span><span class="n">z</span> <span class="o">=</span> <span class="n">useArr</span><span class="p">,</span>
                                    <span class="n">x</span> <span class="o">=</span> <span class="n">hvdf</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_Start&#39;</span><span class="p">],</span>
                                    <span class="n">y</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stream_spec_freqs</span><span class="p">,</span>
                                    <span class="n">colorscale</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;rgba(0,0,0,0.8)&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;rgba(255,255,255, 0.00001)&#39;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;rgba(255,255,255, 0.00001)&#39;</span><span class="p">]],</span>
                                    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="c1">#hovertemplate=&#39;Time [UTC]: %{x}&lt;br&gt;Frequency [Hz]: %{y:.2f}&lt;br&gt;Spectrogram Magnitude: %{z:.2f}&lt;extra&gt;&lt;/extra&gt;&#39;,</span>
                                    <span class="n">showscale</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">newSpecOverlay</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hvsrBand</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hvsrBand</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])],</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span><span class="sa">f</span><span class="s1">&#39;Spectrogram (</span><span class="si">{</span><span class="n">specKey</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">},</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">has_attributes</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">attributes</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">)</span>

        <span class="n">procCond1</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;process_hvsr_status&#39;</span><span class="p">]</span>
        <span class="n">procCond2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span>
        <span class="n">procCond3</span> <span class="o">=</span> <span class="n">has_attributes</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="s2">&quot;Plot_Report&quot;</span><span class="p">,</span> <span class="s2">&quot;Print_Report&quot;</span><span class="p">,</span> <span class="s2">&quot;Table_Report&quot;</span><span class="p">)</span>

        <span class="n">readCond1</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;input_params_status&#39;</span><span class="p">]</span>
        <span class="n">readCond2</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;fetch_data_status&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">procCond1</span> <span class="ow">and</span> <span class="n">procCond2</span> <span class="ow">and</span> <span class="n">procCond3</span><span class="p">:</span>
            <span class="n">statusMsg</span> <span class="o">=</span> <span class="s1">&#39;Excluding the following window&#39;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">utcdtWin</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s1">&#39;s&#39;</span>

            <span class="n">updateCol</span><span class="p">,</span> <span class="n">statusCol</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">statusCol</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">statusMsg</span><span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">utcdtWin</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Window Start Time (UTC)&#39;</span><span class="p">,</span> <span class="s1">&#39;Window End Time (UTC)&#39;</span><span class="p">]))</span>
            <span class="n">updateCol</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;Rerun results statistics&quot;</span><span class="p">,</span>
                            <span class="n">on_click</span><span class="o">=</span><span class="n">update_from_data_selection</span><span class="p">,</span>
                            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;:material/update:&quot;</span><span class="p">)</span>
            <span class="c1">#display_results()</span>
            
        <span class="k">elif</span> <span class="n">readCond1</span> <span class="ow">and</span> <span class="n">readCond2</span><span class="p">:</span>
            <span class="n">display_read_data</span><span class="p">(</span><span class="n">do_setup_tabs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For dat that did not process correctly</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">mainContainer</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Data not read or processed correctly&#39;</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">update_selection_type</span><span class="p">():</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_selection_mode</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_selection_toggle</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">write_to_info_tab</span><span class="p">(</span><span class="n">infoTab</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">infoTab</span><span class="p">:</span>
            <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="s2">&quot;# Processing Parameters Used&quot;</span><span class="p">)</span>
            <span class="n">hvsrDataList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="s1">&#39;hvsr_data&#39;</span><span class="p">,</span> <span class="s1">&#39;hvsr_results&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">fun</span><span class="p">,</span> <span class="n">kwargDict</span> <span class="ow">in</span> <span class="n">funList</span><span class="p">:</span>
                <span class="n">funSig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
                <span class="c1"># excludeKeys = [&#39;params&#39;, &#39;hvsr_data&#39;, &#39;hvsr_results&#39;]</span>
                <span class="n">funMD</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">funSig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">arg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hvsrDataList</span><span class="p">:</span>
                        <span class="n">funMD</span> <span class="o">=</span> <span class="n">funMD</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\n</span><span class="s2">    * </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>

                <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">markdown</span><span class="p">(</span><span class="n">funMD</span><span class="p">,</span> <span class="n">unsafe_allow_html</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">update_from_outlier_selection</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This is intended as a callback for updating the main results tab, etc. after updating outlier curves&quot;&quot;&quot;</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">toast</span><span class="p">(</span><span class="s2">&quot;Updating H/V Curve statistics&quot;</span><span class="p">)</span>
        <span class="n">prochvsr_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">process_hvsr</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;hvsr_data&#39;</span><span class="p">}</span>
        <span class="n">checkPeaks_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">check_peaks</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;hvsr_data&#39;</span><span class="p">}</span>
        <span class="n">getRep_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">get_report</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;hvsr_data&#39;</span><span class="p">}</span>

        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">process_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="o">**</span><span class="n">prochvsr_kwargs</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">check_peaks</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="o">**</span><span class="n">checkPeaks_kwargs</span><span class="p">)</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">get_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="o">**</span><span class="n">getRep_kwargs</span><span class="p">)</span>

        <span class="n">display_download_buttons</span><span class="p">()</span>
        <span class="n">display_results</span><span class="p">()</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">update_outlier</span><span class="p">():</span>
        <span class="n">hvDF</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span>
        
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlier_chart_event</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlier_plot</span>
        <span class="n">curves2Remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;curve_number&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlier_chart_event</span><span class="p">[</span><span class="s1">&#39;selection&#39;</span><span class="p">][</span><span class="s1">&#39;points&#39;</span><span class="p">]])</span>
        <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlier_curves_to_remove</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">curves2Remove</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlier_curves_to_remove</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            
            <span class="n">outlierMsgList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">outlierMsgCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Window Number&#39;</span><span class="p">,</span> <span class="s2">&quot;Window Start Time&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">remCurve</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlier_curves_to_remove</span><span class="p">:</span>
                <span class="n">currInd</span> <span class="o">=</span> <span class="n">hvDF</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">remCurve</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="n">outlierMsgList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">remCurve</span><span class="p">,</span> <span class="n">currInd</span><span class="p">])</span>
                <span class="n">hvDF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">currInd</span><span class="p">,</span> <span class="s2">&quot;Use&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">statusMsg</span> <span class="o">=</span> <span class="s2">&quot;Removing specified outlier curve&quot;</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlier_curves_to_remove</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">statusMsg</span> <span class="o">+=</span> <span class="s1">&#39;s&#39;</span>

            <span class="c1">#st.toast(statusMsg)</span>
            <span class="n">updateCol</span><span class="p">,</span> <span class="n">statusCol</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">])</span>
            <span class="k">with</span> <span class="n">statusCol</span><span class="o">.</span><span class="n">status</span><span class="p">(</span><span class="n">statusMsg</span><span class="p">):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">outlierMsgList</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">outlierMsgCols</span><span class="p">))</span>
            <span class="n">updateCol</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s2">&quot;Rerun results statistics&quot;</span><span class="p">,</span> <span class="n">on_click</span><span class="o">=</span><span class="n">update_from_outlier_selection</span><span class="p">,</span>
                            <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;:material/update:&quot;</span><span class="p">)</span>
        <span class="n">display_results</span><span class="p">()</span>


    <span class="k">def</span><span class="w"> </span><span class="nf">outlier_plot_in_tab</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plot_engine</span> <span class="o">==</span> <span class="s1">&#39;Matplotlib&#39;</span><span class="p">:</span>
            <span class="n">outlierFig</span> <span class="o">=</span> <span class="n">sprit_plot</span><span class="o">.</span><span class="n">plot_outlier_curves</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">,</span> 
                                                        <span class="n">plot_engine</span><span class="o">=</span><span class="s1">&#39;Matplotlib&#39;</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlierTab</span><span class="o">.</span><span class="n">pyplot</span><span class="p">(</span><span class="n">outlierFig</span><span class="p">,</span> 
                                               <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlier_plot</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hvDF</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span>
            <span class="n">x_data</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">no_subplots</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">outlierFig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="n">no_subplots</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">shared_xaxes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">horizontal_spacing</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                                <span class="n">vertical_spacing</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

            <span class="n">scatterFig</span> <span class="o">=</span> <span class="n">pxScatter</span><span class="p">()</span>
            <span class="n">scatter_traces</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">line_traces</span> <span class="o">=</span> <span class="p">[]</span>


            <span class="k">for</span> <span class="n">row</span><span class="p">,</span> <span class="n">hvsr_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvDF</span><span class="p">[</span><span class="s1">&#39;HV_Curves&#39;</span><span class="p">]):</span>
                <span class="n">currInd</span> <span class="o">=</span> <span class="n">hvDF</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="k">if</span> <span class="n">hvDF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">currInd</span><span class="p">,</span> <span class="s1">&#39;Use&#39;</span><span class="p">]:</span>  
                    <span class="n">scatterArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">)[::</span><span class="mi">5</span><span class="p">])</span>
                    <span class="n">x_data_Scatter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x_data</span><span class="p">)[::</span><span class="mi">5</span><span class="p">])</span>
                    <span class="n">currFig</span> <span class="o">=</span> <span class="n">pxScatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_data_Scatter</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">scatterArray</span><span class="p">)</span>
                    <span class="n">currFig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">,</span>
                                    <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;rgba(0,0,0,0.1)&#39;</span><span class="p">),</span>
                                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;rgba(0,0,0,0.1)&#39;</span><span class="p">),</span>
                                    <span class="n">selector</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">))</span>
                    
                    <span class="n">scatter_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currFig</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scatterArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">)[::</span><span class="mi">5</span><span class="p">])</span>
                    <span class="n">x_data_Scatter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x_data</span><span class="p">)[::</span><span class="mi">5</span><span class="p">])</span>
                    <span class="n">currFig</span> <span class="o">=</span> <span class="n">pxScatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_data_Scatter</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">scatterArray</span><span class="p">,</span>
                                        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="n">currFig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers+lines&#39;</span><span class="p">,</span>
                                        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;rgba(195,87,0,0.4)&#39;</span><span class="p">),</span>
                                        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;rgba(195,87,0,0.4)&#39;</span><span class="p">),</span>
                                        <span class="n">selector</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">))</span>
                    <span class="n">scatter_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currFig</span><span class="p">)</span>


            <span class="c1"># Add median line</span>
            <span class="n">medArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvDF</span><span class="p">[</span><span class="s1">&#39;HV_Curves&#39;</span><span class="p">][</span><span class="n">hvDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">scatterArray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">medArr</span><span class="p">)[::</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">x_data_Scatter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">x_data</span><span class="p">)[::</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">currFig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_data_Scatter</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">scatterArray</span><span class="p">,</span>
                            <span class="n">color_discrete_sequence</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">])</span>
            <span class="n">currFig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">))</span>
            <span class="n">scatter_traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currFig</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">scatter_traces</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                    <span class="n">outlierFig</span><span class="o">.</span><span class="n">add_traces</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">outlierFig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Frequency [Hz]&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">outlierFig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;H/V Ratio&#39;</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">outlierFig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;H/V Curve Outlier Display &amp; Selection&quot;</span><span class="p">)</span>

            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlierTab</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Select any curve(s) with your cursor or the Box or Lasso Selectors (hover over the top right of chart) to remove from the statistics and analysis of results.&quot;</span><span class="p">)</span>
            <span class="c1"># Output figure to correct tab</span>
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlierTab</span><span class="o">.</span><span class="n">plotly_chart</span><span class="p">(</span><span class="n">outlierFig</span><span class="p">,</span> 
                                    <span class="n">on_select</span><span class="o">=</span><span class="n">update_outlier</span><span class="p">,</span> 
                                    <span class="n">key</span><span class="o">=</span><span class="s1">&#39;outlier_plot&#39;</span><span class="p">,</span> 
                                    <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                    <span class="n">theme</span><span class="o">=</span><span class="s1">&#39;streamlit&#39;</span><span class="p">)</span> 


    <span class="k">def</span><span class="w"> </span><span class="nf">write_to_outlierTab</span><span class="p">():</span>
        <span class="k">pass</span>


    <span class="c1"># Initial setup</span>
    <span class="n">setup_session_state</span><span class="p">()</span>


    <span class="c1"># DEFINE SIDEBAR</span>
    <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;About to start setting up sidebar, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

    <span class="c1"># Set up sidebar</span>
    <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">sidebar</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Start setting up sidebar, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s1">&#39;SpRIT HVSR&#39;</span><span class="p">,</span> <span class="n">divider</span><span class="o">=</span><span class="s1">&#39;rainbow&#39;</span><span class="p">)</span>
        <span class="n">inputDataCol</span><span class="p">,</span> <span class="n">sourceCol</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
        <span class="n">datapathInput</span> <span class="o">=</span> <span class="n">inputDataCol</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s2">&quot;Input Data&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;input_data&#39;</span><span class="p">,</span> 
                                            <span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;Enter data filepath&#39;</span><span class="p">,</span> 
                                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enter a filepath to be read by obspy.read(). On the web app, a temporary copy of this file will be made.&quot;</span><span class="p">)</span>    
        <span class="n">sourceCol</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s1">&#39;Source&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;File&#39;</span><span class="p">,</span> <span class="s1">&#39;Raw&#39;</span><span class="p">,</span> <span class="s1">&#39;Directory&#39;</span><span class="p">,</span> <span class="s2">&quot;Batch&quot;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;source&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;File: a single file for analysis. All the rest are experimental in the web app. Raw is used with Raspberry Shake data to read native file structure. Directory gets all relevant files in a directory. Batch is for loading a .csv file for batch analysis.&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s2">&quot;Click to access data uploader&quot;</span><span class="p">):</span>
            <span class="n">st</span><span class="o">.</span><span class="n">file_uploader</span><span class="p">(</span><span class="s2">&quot;Upload data file(s)&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">OBSPYFORMATS</span><span class="p">,</span> <span class="n">accept_multiple_files</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;datapath_uploader&#39;</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">on_file_upload</span><span class="p">)</span>

        <span class="n">bottom_container</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">container</span><span class="p">()</span>

        <span class="c1"># Create top menu</span>
        <span class="k">with</span> <span class="n">bottom_container</span><span class="p">:</span>
            <span class="n">resetCol</span><span class="p">,</span> <span class="n">readCol</span><span class="p">,</span> <span class="n">runCol</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">])</span>

            <span class="n">runLabel</span> <span class="o">=</span> <span class="s1">&#39;Run&#39;</span>
            <span class="n">readLabel</span> <span class="o">=</span> <span class="s1">&#39;Read&#39;</span>
            <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_data</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">or</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">input_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">runLabel</span> <span class="o">=</span> <span class="s1">&#39;Demo Run&#39;</span>
                <span class="n">readLabel</span> <span class="o">=</span> <span class="s1">&#39;Demo Read&#39;</span>

            <span class="n">resetCol</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="s1">&#39;Reset&#39;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">on_click</span><span class="o">=</span><span class="n">on_reset</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;reset_button&#39;</span><span class="p">)</span>
            <span class="n">readCol</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="n">readLabel</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">on_click</span><span class="o">=</span><span class="n">on_read_data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;read_button&#39;</span><span class="p">)</span>
            <span class="n">runCol</span><span class="o">.</span><span class="n">button</span><span class="p">(</span><span class="n">runLabel</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">,</span>  <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">on_click</span><span class="o">=</span><span class="n">on_run_data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;run_button&#39;</span><span class="p">)</span>
        

        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done setting up bottom container, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

        <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s1">&#39;Settings&#39;</span><span class="p">)</span>
        <span class="n">mainSettings</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">container</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mainSettings</span><span class="p">:</span>

            <span class="n">siteNameCol</span><span class="p">,</span> <span class="n">projCol</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
            <span class="n">siteNameCol</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s2">&quot;Site Name&quot;</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;HVSR Site&#39;</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">text_change</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;site&#39;</span><span class="p">)</span>
            <span class="n">projCol</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s2">&quot;Project/County Name&quot;</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">text_change</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;project&#39;</span><span class="p">)</span>
            <span class="c1">#instCol.text_input(&#39;Instrument&#39;, help=&#39;Raspberry Shake and Tromino are currently the only values with special treatment. If a filepath, can use a .inst instrument file (json format)&#39;, key=&#39;instrument&#39;)</span>

            <span class="n">stationCol</span><span class="p">,</span> <span class="n">instCol</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
            <span class="n">stationCol</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s2">&quot;Station/Partition&quot;</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;RAC84&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;station&#39;</span><span class="p">)</span>
            <span class="n">instCol</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s1">&#39;Instrument&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;instrument&#39;</span><span class="p">,</span>
                            <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Seismometer&#39;</span><span class="p">,</span> <span class="s1">&#39;Raspberry Shake&#39;</span><span class="p">,</span> <span class="s1">&#39;Tromino Yellow&#39;</span><span class="p">,</span> <span class="s1">&#39;Tromino Blue&#39;</span><span class="p">],</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Some instruments require special inputs to read in the data correctly. If not one of the instruments listed, or if reading in an obspy-supported file directly, leave as &quot;Seismometer&quot;&#39;</span><span class="p">)</span>

            <span class="n">xCoordCol</span><span class="p">,</span> <span class="n">yCoordCol</span><span class="p">,</span> <span class="n">inCRSCol</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.3333</span><span class="p">,</span> <span class="mf">0.3333</span><span class="p">,</span> <span class="mf">0.3333</span><span class="p">])</span>
            <span class="n">xCoordCol</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s1">&#39;X Coordinate&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;i.e., Longitude or Easting&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;xcoord&#39;</span><span class="p">)</span>
            <span class="n">yCoordCol</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s1">&#39;Y Coordinate&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;i.e., Latitude or Northing&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;ycoord&#39;</span><span class="p">)</span>
            <span class="n">inCRSCol</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s1">&#39;CRS&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;By default, &quot;EPSG:4326&quot;. Can be EPSG code or anything accepted by pyproj.CRS.from_user_input()&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;input_crs&#39;</span><span class="p">)</span>        
            
            <span class="n">zCoordCol</span><span class="p">,</span> <span class="n">elevUnitCol</span><span class="p">,</span> <span class="n">outCRSCol</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.333</span><span class="p">,</span> <span class="mf">0.333</span><span class="p">,</span> <span class="mf">0.333</span><span class="p">])</span>
            <span class="n">zCoordCol</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s1">&#39;Z Coordinate&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;i.e., Elevation&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;elevation&#39;</span><span class="p">)</span>
            <span class="n">elevUnitCol</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s1">&#39;Elev. (Z) Unit&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;meters&#39;</span><span class="p">,</span> <span class="s1">&#39;feet&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;elev_unit&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;i.e., Elevation unit&#39;</span><span class="p">)</span>
            <span class="n">outCRSCol</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s1">&#39;CRS for Export&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Can be EPSG code or anything accepted by pyproj.CRS.from_user_input()&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;output_crs&#39;</span><span class="p">)</span>

            <span class="c1"># Date/time settings</span>
            <span class="n">dateCol</span><span class="p">,</span> <span class="n">sTimeCol</span><span class="p">,</span> <span class="n">eTimeCol</span><span class="p">,</span> <span class="n">tzoneCol</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.3</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.25</span><span class="p">,</span><span class="mf">0.2</span><span class="p">])</span>

            <span class="n">dateCol</span><span class="o">.</span><span class="n">date_input</span><span class="p">(</span><span class="s1">&#39;Acquisition Date&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;YYYY-MM-DD&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;acq_date&#39;</span><span class="p">)</span>
            <span class="n">sTimeCol</span><span class="o">.</span><span class="n">time_input</span><span class="p">(</span><span class="s1">&#39;Start time&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;starttime&#39;</span><span class="p">)</span>
            <span class="n">eTimeCol</span><span class="o">.</span><span class="n">time_input</span><span class="p">(</span><span class="s1">&#39;End time&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;endtime&#39;</span><span class="p">)</span>

            <span class="n">tZoneList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">zoneinfo</span><span class="o">.</span><span class="n">available_timezones</span><span class="p">())</span>
            <span class="n">tZoneList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">tZoneList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;localtime&quot;</span><span class="p">)</span>
            <span class="n">tZoneList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;US/Pacific&quot;</span><span class="p">)</span>
            <span class="n">tZoneList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;US/Mountain&quot;</span><span class="p">)</span>
            <span class="n">tZoneList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;US/Eastern&quot;</span><span class="p">)</span>
            <span class="n">tZoneList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;US/Central&quot;</span><span class="p">)</span>
            <span class="n">tZoneList</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;UTC&quot;</span><span class="p">)</span>
            <span class="n">tzoneCol</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s1">&#39;Timezone&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">tZoneList</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;tzone&#39;</span><span class="p">)</span>

            <span class="c1"># Processing limits</span>
            <span class="n">pfrDef</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">sprit_hvsr</span><span class="o">.</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;peak_freq_range&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
            
            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">peak_freq_range</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select_slider</span><span class="p">(</span><span class="s1">&#39;Peak Frequency Range&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">bandVals</span><span class="p">,</span>
                            <span class="n">value</span><span class="o">=</span><span class="n">pfrDef</span><span class="p">,</span>
                            <span class="c1">#key=&#39;peak_freq_range&#39;</span>
                            <span class="p">)</span>

            <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_band</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">select_slider</span><span class="p">(</span><span class="s1">&#39;HVSR Band&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">bandVals</span><span class="p">,</span> <span class="c1">#key=&#39;hvsr_band&#39;,</span>
                            <span class="n">value</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsr_band</span>
                            <span class="p">)</span>

            <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Display interactive charts (slower)&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;interactive_display&#39;</span><span class="p">,</span>
                      <span class="n">on_change</span><span class="o">=</span><span class="n">do_interactive_display</span><span class="p">,</span>
                      <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Whether to display interactive charts for the data, outliers, and results charts. Interactive charts take longer to display, but allow graphical editing of the data.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>


        <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s1">&#39;Additional Settings&#39;</span><span class="p">,</span> <span class="n">divider</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">st</span><span class="o">.</span><span class="n">expander</span><span class="p">(</span><span class="s1">&#39;Expand to modify additional settings&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting up sidebar expander, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

            <span class="n">ipSetTab</span><span class="p">,</span> <span class="n">fdSetTab</span><span class="p">,</span> <span class="n">azSetTab</span><span class="p">,</span> <span class="n">rmnocSetTab</span><span class="p">,</span> <span class="n">gpSetTab</span><span class="p">,</span> <span class="n">phvsrSetTab</span><span class="p">,</span> <span class="n">plotSetTab</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">tabs</span><span class="p">([</span><span class="s1">&#39;Instrument&#39;</span><span class="p">,</span> <span class="s1">&#39;Data&#39;</span><span class="p">,</span> <span class="s2">&quot;Azimuths&quot;</span><span class="p">,</span> <span class="s2">&quot;Noise&quot;</span><span class="p">,</span> <span class="s1">&#39;PPSDs&#39;</span><span class="p">,</span> <span class="s1">&#39;H/V&#39;</span><span class="p">,</span> <span class="s1">&#39;Plot&#39;</span><span class="p">])</span>
            
            <span class="c1">#@st.experimental_dialog(&quot;Update Input Parameters&quot;, width=&#39;large&#39;)</span>
            <span class="c1">#def open_ip_dialog():</span>
            <span class="k">with</span> <span class="n">ipSetTab</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting up input tab, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                
                <span class="c1">#with st.expander(&#39;Instrument settings&#39;):</span>
                <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s2">&quot;Network&quot;</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;AM&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;network&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s2">&quot;Location&quot;</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;00&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;loc&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s2">&quot;Channels&quot;</span><span class="p">,</span> <span class="n">placeholder</span><span class="o">=</span><span class="s1">&#39;EHZ, EHE, EHN&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;channels&#39;</span><span class="p">)</span>
        
                <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s1">&#39;Metadata Filepath&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Filepath to instrument response file&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;metadata&#39;</span><span class="p">)</span>

                <span class="c1">#with st.expander(&#39;Primary Input Parameters&#39;, expanded=True):</span>
                <span class="c1">#if &quot;hvsr_band&quot; not in st.session_state:</span>
                <span class="c1">#    st.session_state.hvsr_band = [0.4, 40]</span>


            <span class="c1">#@st.experimental_dialog(&quot;Update Parameters to Fetch Data&quot;, width=&#39;large&#39;)</span>
            <span class="c1">#def open_fd_dialog():</span>
            <span class="k">with</span> <span class="n">fdSetTab</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting up fd tab, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="c1">#source: str = &#39;file&#39;,</span>
                <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s1">&#39;Data export directory&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Directory for exporting raw/trimmed data&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data_export_dir&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s1">&#39;Data export format&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">OBSPYFORMATS</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;data_export_format&#39;</span><span class="p">)</span>

                <span class="c1"># Detrending options</span>
                <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s1">&#39;Detrend Type&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;Simple&#39;</span><span class="p">,</span> <span class="s1">&#39;Linear&#39;</span><span class="p">,</span> <span class="s1">&#39;Constant/Demean&#39;</span><span class="p">,</span> <span class="s1">&#39;Polynomial&#39;</span><span class="p">,</span> <span class="s1">&#39;Spline&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Detrend Type use by `type` parameter of obspy.trace.Trace.detrend()&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;detrend&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s1">&#39;Detrend options&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;order=2&#39;</span><span class="p">,</span> 
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Value(s) to pass to the **options argument of obspy.trace.Trace.detrend()&quot;</span><span class="p">,</span> 
                            <span class="n">key</span><span class="o">=</span><span class="s1">&#39;detrend_options&#39;</span><span class="p">)</span>

                <span class="c1"># Filter options</span>
                <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s1">&#39;Filter Type&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;bandpass&#39;</span><span class="p">,</span> <span class="s1">&#39;bandstop&#39;</span><span class="p">,</span> 
                                                    <span class="s1">&#39;lowpass&#39;</span><span class="p">,</span> <span class="s1">&#39;highpass&#39;</span><span class="p">,</span> 
                                                    <span class="s1">&#39;lowpass_cheby_2&#39;</span><span class="p">,</span> <span class="s1">&#39;lowpass_fir&#39;</span><span class="p">,</span> <span class="s1">&#39;remez_fir&#39;</span><span class="p">],</span> 
                            <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Detrend Type use by `type` parameter of obspy.trace.Trace.filter()&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;filter&#39;</span><span class="p">)</span>
                
                <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s1">&#39;Filter options&#39;</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Value(s) to pass to the **options argument of obspy.trace.Trace.filter()&quot;</span><span class="p">,</span> 
                            <span class="n">key</span><span class="o">=</span><span class="s1">&#39;filter_options&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">azSetTab</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting up az tab, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

                <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;Calculate Azimuths&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to calculate azimuths for data.&#39;</span><span class="p">,</span>
                        <span class="n">key</span><span class="o">=</span><span class="s1">&#39;azimuth_calculation&#39;</span><span class="p">)</span>
                
                <span class="n">az_disabled</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="p">,</span> <span class="s1">&#39;azimuth_calculation&#39;</span><span class="p">):</span>
                    <span class="n">az_disabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">azimuth_calculation</span>
            
                <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s1">&#39;Azimuth type&#39;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">az_disabled</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Multiple&#39;</span><span class="p">,</span> <span class="s1">&#39;Single&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;azimuth_type&#39;</span><span class="p">)</span>

                <span class="n">azAngCol</span><span class="p">,</span> <span class="n">azUnitCol</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.7</span><span class="p">,</span><span class="mf">0.3</span><span class="p">])</span>
                <span class="n">azAngCol</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s2">&quot;Azimuth angle&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;azimuth_angle&#39;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">az_disabled</span><span class="p">)</span>
                <span class="n">azUnitCol</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s1">&#39;Azimuth unit&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;°&#39;</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;azimuth_unit&#39;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">az_disabled</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>
            
            <span class="c1">#@st.experimental_dialog(&quot;Update Parameters to Remove Noise and Outlier Curves&quot;, width=&#39;large&#39;)</span>
            <span class="c1">#def open_outliernoise_dialog():</span>
            <span class="k">with</span> <span class="n">rmnocSetTab</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting up noise tab, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="c1"># Set up toggles and options</span>
                <span class="n">remNoiseCol</span><span class="p">,</span> <span class="n">rawNoiseCol</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.55</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">])</span>
                <span class="n">remNoiseCol</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;Remove Noise&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to remove noise from input data.&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;noise_removal&#39;</span><span class="p">)</span>
                <span class="n">noiseRemDisabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">noise_removal</span>

                <span class="n">rawNoiseCol</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;Raw data&quot;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">noiseRemDisabled</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to use the raw input data to remove noise.&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;remove_raw_noise&#39;</span><span class="p">)</span>

                <span class="n">remNoisePopover</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">popover</span><span class="p">(</span><span class="s1">&#39;Remove Noise options&#39;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">noiseRemDisabled</span><span class="p">,</span>  <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">remNoisePopover</span><span class="p">:</span>
                    <span class="c1"># Auto noise</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;Auto Noise Removal&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">noiseRemDisabled</span><span class="p">,</span> 
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to remove noise from input data.&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;auto_noise_removal&#39;</span><span class="p">)</span>
                                
                    <span class="n">st</span><span class="o">.</span><span class="n">divider</span><span class="p">()</span>

                    <span class="n">do_stalta</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">do_sat</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">do_noise</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">do_stdev</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">do_warm</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">do_cool</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">do_outCurve</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="n">doNoiseRemList</span> <span class="o">=</span> <span class="p">[</span><span class="n">do_stalta</span><span class="p">,</span> <span class="n">do_sat</span><span class="p">,</span> <span class="n">do_noise</span><span class="p">,</span> <span class="n">do_stdev</span><span class="p">,</span> <span class="n">do_warm</span><span class="p">,</span> <span class="n">do_cool</span><span class="p">]</span>
                    <span class="n">autoRemList</span> <span class="o">=</span> <span class="p">[</span><span class="n">do_stdev</span><span class="p">,</span> <span class="n">do_sat</span><span class="p">]</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">noise_removal</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">doNR</span> <span class="ow">in</span> <span class="n">doNoiseRemList</span><span class="p">:</span>
                            <span class="n">doNR</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">auto_noise_removal</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">autoRemList</span><span class="p">):</span>
                        <span class="n">do_stdev</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">do_sat</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># Standard devation ratio</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;StDev Ratio Noise Detection&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">do_stdev</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">noiseRemDisabled</span><span class="p">,</span> 
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to remove noise from input data.&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;stdev_noise_removal&#39;</span><span class="p">)</span>
                    <span class="n">stDevDisabled</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stdev_noise_removal</span><span class="p">)</span> <span class="ow">or</span> <span class="n">noiseRemDisabled</span>
                    <span class="c1">#std_ratio_thresh=2.0, std_window_size=20.0, min_std_win=5.0,</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;Moving StDev. Threshold&#39;</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">100.0</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The threshold value of StDev_Moving / StDev_Total to use as a removal threshold&#39;</span><span class="p">,</span>
                                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.1f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">stDevDisabled</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;std_ratio_thresh&#39;</span><span class="p">)</span>
                    <span class="n">mvStDWinCol</span><span class="p">,</span> <span class="n">minStDWinCol</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
                    <span class="n">mvStDWinCol</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;Moving StDev. Win Size (samples)&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> 
                                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;The size of the window to use to calculate the rolling standard deviation&#39;</span><span class="p">,</span>
                                    <span class="n">disabled</span><span class="o">=</span><span class="n">stDevDisabled</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;std_window_size&#39;</span><span class="p">)</span>
                    <span class="n">minStDWinCol</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;Min. Win. Size (samples)&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The minimum number of samples in a row that exceed the ratio threshold for that window to be removed&quot;</span><span class="p">,</span>
                                    <span class="n">disabled</span><span class="o">=</span><span class="n">stDevDisabled</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;min_std_win&#39;</span><span class="p">)</span>

                    <span class="c1"># Saturation threshold</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;Saturation Threshold Noise Detection&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">do_sat</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">noiseRemDisabled</span><span class="p">,</span> 
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to remove noise from input data.&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;sat_noise_removal&#39;</span><span class="p">)</span>
                    <span class="n">satRemDisabled</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">sat_noise_removal</span><span class="p">)</span> <span class="ow">or</span> <span class="n">noiseRemDisabled</span>


                    <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;Saturation Percent&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">satRemDisabled</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;sat_percent&#39;</span><span class="p">)</span>

                    <span class="c1"># STALTA</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;STALTA Noise Detection&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">do_stalta</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">noiseRemDisabled</span><span class="p">,</span> 
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to remove noise from input data.&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;stalta_noise_removal&#39;</span><span class="p">)</span>
                    <span class="n">staltaDisabled</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stalta_noise_removal</span><span class="p">)</span> <span class="ow">or</span> <span class="n">noiseRemDisabled</span>

                    <span class="n">staCol</span><span class="p">,</span> <span class="n">ltaCol</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">columns</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">])</span>
                    <span class="n">staCol</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;Short Term Average (STA)&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Length of moving window (in seconds) for calculating STA average&#39;</span><span class="p">,</span>
                                    <span class="n">disabled</span><span class="o">=</span><span class="n">staltaDisabled</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;sta&#39;</span><span class="p">)</span>
                    <span class="n">ltaCol</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;Long Term Average (LTA)&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span>
                                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Length of moving window (in seconds) for calculating LTA average&#39;</span><span class="p">,</span>
                                    <span class="n">disabled</span><span class="o">=</span><span class="n">staltaDisabled</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;lta&#39;</span><span class="p">)</span>
                    <span class="n">staltaVals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">select_slider</span><span class="p">(</span><span class="s1">&#39;STA/LTA Thresholds&#39;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">staltaDisabled</span><span class="p">,</span> 
                                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Trigger thresholds for STA/LTA calculation&#39;</span><span class="p">,</span>
                                    <span class="n">value</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">stalta_thresh</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">staltaVals</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;stalta_thresh&#39;</span><span class="p">)</span>

                    <span class="c1"># Noise threshold</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;Noise Threshold Noise Detection&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">do_noise</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">noiseRemDisabled</span><span class="p">,</span> 
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to remove noise from input data.&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;noise_thresh_noise_removal&#39;</span><span class="p">)</span>
                    <span class="n">noiseDisabled</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">noise_thresh_noise_removal</span><span class="p">)</span> <span class="ow">or</span> <span class="n">noiseRemDisabled</span>

                    <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;Noise Percent&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> 
                                    <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.2f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">noiseDisabled</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;noise_percent&#39;</span><span class="p">)</span>

                    <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;Minimum Window Size (samples)&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">disabled</span><span class="o">=</span><span class="n">noiseDisabled</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;min_win_size&#39;</span><span class="p">)</span>


                    <span class="c1"># Warmup</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;Warmup Time Removal&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">do_warm</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">noiseRemDisabled</span><span class="p">,</span> 
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to remove noise from input data.&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;warmup_noise_removal&#39;</span><span class="p">)</span>
                    <span class="n">warmupDisabled</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">warmup_noise_removal</span><span class="p">)</span> <span class="ow">or</span> <span class="n">noiseRemDisabled</span>

                    <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;Warmup Time (seconds)&#39;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">warmupDisabled</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;warmup_time&#39;</span><span class="p">)</span>

                    <span class="c1"># Cooldown</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;Cooldown Time Removal&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">do_cool</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">noiseRemDisabled</span><span class="p">,</span> 
                                <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to remove noise from input data.&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cooldown_noise_removal&#39;</span><span class="p">)</span>
                    <span class="n">cooldownDisabled</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">cooldown_noise_removal</span><span class="p">)</span> <span class="ow">or</span> <span class="n">noiseRemDisabled</span>

                    <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;Cooldown Time (seconds)&#39;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">cooldownDisabled</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;cooldown_time&#39;</span><span class="p">)</span>


                <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s2">&quot;Remove Outlier Curves&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Whether to remove outlier curves from input data.&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;outlier_curves_removal&#39;</span><span class="p">)</span>
                <span class="n">outlierCurveDisabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">outlier_curves_removal</span>

                <span class="c1"># Outlier curves</span>
                <span class="n">remCurvePopover</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">popover</span><span class="p">(</span><span class="s1">&#39;Remove Outlier Curve Options&#39;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">outlierCurveDisabled</span><span class="p">,</span>  <span class="n">use_container_width</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">remCurvePopover</span><span class="p">:</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s2">&quot;Outlier Threshold&quot;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">outlierCurveDisabled</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">98</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;rmse_thresh&#39;</span><span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">radio</span><span class="p">(</span><span class="s1">&#39;Threshold type&#39;</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">outlierCurveDisabled</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Percentile&#39;</span><span class="p">,</span> <span class="s1">&#39;Value&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;threshRadio&#39;</span><span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">use_percentile</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">threshRadio</span><span class="o">==</span><span class="s1">&#39;Percentile&#39;</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">radio</span><span class="p">(</span><span class="s1">&#39;Threshold curve&#39;</span><span class="p">,</span> <span class="n">horizontal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="n">outlierCurveDisabled</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HV Curve&#39;</span><span class="p">,</span> <span class="s1">&#39;Component Curves&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;curveRadio&#39;</span><span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">use_hv_curves</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">curveRadio</span><span class="o">==</span><span class="s1">&#39;HV Curve&#39;</span><span class="p">)</span>



                <span class="c1">#noise_rem_method_list = [&#39;None&#39;, &#39;Auto&#39;, &#39;Manual&#39;, &#39;Stalta&#39;, &#39;Saturation Threshold&#39;, &#39;Noise Threshold&#39;, &#39;Warmup&#39;, &#39;Cooldown&#39;, &#39;Buffer&#39;]</span>
                <span class="c1">#st.multiselect(&quot;Noise Removal Method&quot;,</span>
                <span class="c1">#            options=,</span>
                <span class="c1">#            key=&#39;remove_method&#39;)</span>

                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

            <span class="c1">#@st.experimental_dialog(&quot;Update Parameters to Generate PPSDs&quot;, width=&#39;large&#39;)</span>
            <span class="c1">#def open_ppsd_dialog():</span>
            <span class="k">with</span> <span class="n">gpSetTab</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting up ppsd tab, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">st</span><span class="o">.</span><span class="n">toggle</span><span class="p">(</span><span class="s1">&#39;Skip on gaps&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Determines whether time segments with gaps should be skipped entirely. Select skip_on_gaps=True for not filling gaps with zeros which might result in some data segments shorter than ppsd_length not used in the PPSD.&#39;</span><span class="p">,</span>
                        <span class="n">key</span><span class="o">=</span><span class="s1">&#39;skip_on_gaps&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s2">&quot;Minimum Decibel Value&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">200</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;min_deb&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s2">&quot;Maximum Decibel Value&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=-</span><span class="mi">50</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;max_deb&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s2">&quot;Decibel bin size&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;deb_step&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">db_bins</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">min_deb</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">max_deb</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">deb_step</span><span class="p">)</span>

                <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;PPSD Length (seconds)&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;ppsd_length&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;PPSD Window overlap (%, 0-1)&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;overlap&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;Period Smoothing Width (octaves)&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;period_smoothing_width_octaves&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">number_input</span><span class="p">(</span><span class="s1">&#39;Period Step (octaves)&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%.5f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;period_step_octaves&#39;</span><span class="p">)</span>
                <span class="n">periodVals</span><span class="o">=</span><span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">x</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">bandVals</span><span class="p">]</span>
                <span class="n">periodVals</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

                <span class="n">st</span><span class="o">.</span><span class="n">select_slider</span><span class="p">(</span><span class="s1">&#39;Period Limits (s)&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">periodVals</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">period_limits</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;period_limits&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s2">&quot;Special Handling&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;Ringlaser&#39;</span><span class="p">,</span> <span class="s1">&#39;Hydrophone&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;special_handling&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

            <span class="c1">#@st.experimental_dialog(&quot;Update Parameters to Process HVSR&quot;, width=&#39;large&#39;)</span>
            <span class="c1">#def open_processHVSR_dialog():</span>
            <span class="k">with</span> <span class="n">phvsrSetTab</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting up hvsr tab, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s1">&#39;Peak Selection Method&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Max&#39;</span><span class="p">,</span> <span class="s1">&#39;Scored&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;peak_selection&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s2">&quot;Method to combine hoizontal components&quot;</span><span class="p">,</span> 
                            <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Diffuse Field Assumption&#39;</span><span class="p">,</span> <span class="s1">&#39;Arithmetic Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Geometric Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Vector Summation&#39;</span><span class="p">,</span> <span class="s1">&#39;Quadratic Mean&#39;</span><span class="p">,</span> <span class="s1">&#39;Maximum Horizontal Value&#39;</span><span class="p">,</span> <span class="s1">&#39;Azimuth&#39;</span><span class="p">],</span> 
                            <span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;horizontal_method&#39;</span><span class="p">)</span>
                <span class="n">rList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1001</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">rList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s2">&quot;Curve Smoothing&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="s1">&#39;Savgoy Filter&#39;</span><span class="p">,</span> <span class="s1">&#39;Konno Ohmachi&#39;</span><span class="p">,</span> <span class="s2">&quot;Proportional&quot;</span><span class="p">,</span> <span class="s2">&quot;Constant&quot;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;freq_smooth&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">select_slider</span><span class="p">(</span><span class="s2">&quot;Curve Smoothing Parameter&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">value</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;f_smooth_width&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">select_slider</span><span class="p">(</span><span class="s2">&quot;Resample&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">rList</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;resample&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">select_slider</span><span class="p">(</span><span class="s1">&#39;Outlier Curve Removal&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">rList</span><span class="p">[:</span><span class="mi">100</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;outlier_curve_percentile_threshold&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">update_plot_string</span><span class="p">():</span>
                <span class="n">plotStringDict</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Peak Frequency&#39;</span><span class="p">:</span><span class="s1">&#39; p&#39;</span><span class="p">,</span> <span class="s1">&#39;Peak Amplitude&#39;</span><span class="p">:</span><span class="s1">&#39; pa&#39;</span><span class="p">,</span> <span class="s1">&#39;Annotation&#39;</span><span class="p">:</span><span class="s1">&#39; ann&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Time windows&#39;</span><span class="p">:</span><span class="s1">&#39; t&#39;</span><span class="p">,</span> <span class="s2">&quot;Peaks of Time Windows&quot;</span><span class="p">:</span> <span class="s1">&#39; tp&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;Test 1: Peak &gt; 2x trough below&#39;</span><span class="p">:</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> 
                                <span class="s2">&quot;Test 2: Peak &gt; 2x trough above&quot;</span><span class="p">:</span><span class="s1">&#39;2&#39;</span><span class="p">,</span>
                                <span class="s2">&quot;Test 3: Peak &gt; 2&quot;</span><span class="p">:</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> 
                                <span class="s2">&quot;Test 4&quot;</span><span class="p">:</span><span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s2">&quot;Test 5&quot;</span><span class="p">:</span><span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s2">&quot;Test 6&quot;</span><span class="p">:</span><span class="s1">&#39;6&#39;</span><span class="p">,</span>
                                <span class="p">}</span>
                
                <span class="n">plotString</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">for</span> <span class="n">plot</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plotPlotStr</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">plot</span><span class="o">==</span><span class="s1">&#39;HVSR&#39;</span><span class="p">:</span>
                        <span class="n">plotString</span><span class="o">=</span><span class="n">plotString</span><span class="o">+</span><span class="s1">&#39;HVSR&#39;</span>
                        <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">hvsrPlotStr</span><span class="p">:</span>
                            <span class="k">if</span> <span class="s1">&#39;test&#39;</span> <span class="ow">in</span> <span class="n">pc</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                <span class="k">if</span> <span class="s1">&#39;test&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plotString</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                                    <span class="n">plotString</span> <span class="o">=</span> <span class="n">plotString</span> <span class="o">+</span> <span class="s1">&#39; Test&#39;</span>
                                <span class="n">test_end_index</span> <span class="o">=</span> <span class="n">plotString</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s2">&quot;Test&quot;</span><span class="p">)</span>
                                <span class="n">nextSpaceIndex</span> <span class="o">=</span> <span class="n">plotString</span><span class="p">[</span><span class="n">test_end_index</span><span class="p">:]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">nextSpaceIndex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                                    <span class="n">nextSpaceIndex</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">plotString</span><span class="p">)</span>
                                <span class="n">noString</span> <span class="o">=</span> <span class="n">plotString</span><span class="p">[</span><span class="n">test_end_index</span><span class="p">:</span><span class="n">nextSpaceIndex</span><span class="p">]</span>
                                <span class="n">noString</span> <span class="o">=</span> <span class="n">noString</span> <span class="o">+</span> <span class="n">plotStringDict</span><span class="p">[</span><span class="n">pc</span><span class="p">]</span>

                                <span class="c1"># Order test numbers correctly</span>
                                <span class="n">testNos</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">noString</span><span class="p">))</span>
                                <span class="n">plotString</span> <span class="o">=</span> <span class="n">plotString</span><span class="p">[:</span><span class="n">test_end_index</span><span class="p">]</span> <span class="o">+</span> <span class="n">testNos</span>                             
        
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">plotString</span> <span class="o">=</span> <span class="n">plotString</span> <span class="o">+</span> <span class="n">plotStringDict</span><span class="p">[</span><span class="n">pc</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">plot</span><span class="o">==</span><span class="s1">&#39;Components&#39;</span><span class="p">:</span>
                        <span class="n">plotString</span><span class="o">=</span><span class="n">plotString</span><span class="o">+</span><span class="s1">&#39; C+&#39;</span>
                        <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">compPlotStr</span><span class="p">:</span>
                            <span class="n">plotString</span> <span class="o">=</span> <span class="n">plotString</span> <span class="o">+</span> <span class="n">plotStringDict</span><span class="p">[</span><span class="n">pc</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">plot</span><span class="o">==</span><span class="s1">&#39;Spectrogram&#39;</span><span class="p">:</span>
                        <span class="n">plotString</span><span class="o">=</span><span class="n">plotString</span><span class="o">+</span><span class="s1">&#39; SPEC&#39;</span>
                        <span class="k">for</span> <span class="n">pc</span> <span class="ow">in</span> <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">specPlotStr</span><span class="p">:</span>
                            <span class="n">plotString</span> <span class="o">=</span> <span class="n">plotString</span> <span class="o">+</span> <span class="n">plotStringDict</span><span class="p">[</span><span class="n">pc</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">plot</span><span class="o">==</span><span class="s1">&#39;Azimuth&#39;</span><span class="p">:</span>
                        <span class="n">plotString</span><span class="o">=</span><span class="n">plotString</span><span class="o">+</span><span class="s1">&#39; AZ&#39;</span>    
                <span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">plot_type</span> <span class="o">=</span> <span class="n">plotString</span>


            <span class="c1">#@st.experimental_dialog(&quot;Update Plot Settings&quot;, width=&#39;large&#39;)</span>
            <span class="c1">#def plot_settings_dialog():</span>
            <span class="k">with</span> <span class="n">plotSetTab</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Setting up plot tab, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

                <span class="n">st</span><span class="o">.</span><span class="n">selectbox</span><span class="p">(</span><span class="s2">&quot;Plot Engine&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Plotly&#39;</span><span class="p">,</span> <span class="s2">&quot;Matplotlib&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;plot_engine&#39;</span><span class="p">,</span> <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Currently, interactive plots are only supported in plotly.&quot;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">text_input</span><span class="p">(</span><span class="s2">&quot;Plot type (plot string)&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;HVSR p ann C+ p ann Spec p&#39;</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;plot_type&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">multiselect</span><span class="p">(</span><span class="s2">&quot;Charts to show&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HVSR&#39;</span><span class="p">,</span> <span class="s2">&quot;Components&quot;</span><span class="p">,</span> <span class="s1">&#39;Spectrogram&#39;</span><span class="p">,</span> <span class="s1">&#39;Azimuth&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HVSR&#39;</span><span class="p">,</span> <span class="s1">&#39;Components&#39;</span><span class="p">,</span> <span class="s2">&quot;Spectrogram&quot;</span><span class="p">],</span> 
                                                <span class="n">on_change</span><span class="o">=</span><span class="n">update_plot_string</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;plotPlotStr&#39;</span><span class="p">)</span>
                
                <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;HVSR Chart&quot;</span><span class="p">,</span> <span class="n">divider</span><span class="o">=</span><span class="s1">&#39;rainbow&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">multiselect</span><span class="p">(</span><span class="s1">&#39;Items to plot&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Peak Frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;Peak Amplitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Annotation&#39;</span><span class="p">,</span> <span class="s1">&#39;Time windows&#39;</span><span class="p">,</span> <span class="s2">&quot;Peaks of Time Windows&quot;</span><span class="p">,</span>
                                                        <span class="s1">&#39;Test 1: Peak &gt; 2x trough below&#39;</span> <span class="p">,</span> <span class="s2">&quot;Test 2: Peak &gt; 2x trough above&quot;</span><span class="p">,</span> <span class="s2">&quot;Test 3: Peak &gt; 2&quot;</span><span class="p">,</span> <span class="s2">&quot;Test 4&quot;</span><span class="p">,</span> <span class="s2">&quot;Test 5&quot;</span><span class="p">,</span> <span class="s2">&quot;Test 6&quot;</span><span class="p">],</span>
                                                        <span class="n">on_change</span><span class="o">=</span><span class="n">update_plot_string</span><span class="p">,</span>
                                                        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Peak Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Annotation&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;hvsrPlotStr&#39;</span><span class="p">)</span>

                <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s2">&quot;Component Chart&quot;</span><span class="p">,</span> <span class="n">divider</span><span class="o">=</span><span class="s1">&#39;rainbow&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">multiselect</span><span class="p">(</span><span class="s1">&#39;Items to plot&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Peak Frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;Annotation&#39;</span><span class="p">,</span> <span class="s1">&#39;Time windows&#39;</span><span class="p">],</span> <span class="n">on_change</span><span class="o">=</span><span class="n">update_plot_string</span><span class="p">,</span>
                                                        <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Peak Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Annotation&quot;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;compPlotStr&#39;</span><span class="p">)</span>
                
                <span class="n">st</span><span class="o">.</span><span class="n">header</span><span class="p">(</span><span class="s1">&#39;Spectrogram Chart&#39;</span><span class="p">,</span> <span class="n">divider</span><span class="o">=</span><span class="s1">&#39;rainbow&#39;</span><span class="p">)</span>
                <span class="n">st</span><span class="o">.</span><span class="n">multiselect</span><span class="p">(</span><span class="s1">&#39;Items to plot&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Peak Frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;Annotation&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;specPlotStr&#39;</span><span class="p">,</span> <span class="n">on_change</span><span class="o">=</span><span class="n">update_plot_string</span><span class="p">,</span>
                                                <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Peak Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Annotation&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
                    <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">VERBOSE</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done setting up sidebar, session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Done setting up everything (end of main), session state length: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">session_state</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">print_param</span><span class="p">(</span><span class="n">PARAM2PRINT</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Author.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>