

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>sprit.sprit_hvsr &mdash; sprit 3.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/documentation_options.js?v=08bfcbec"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            sprit
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../sprit.html">sprit package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sprit.sprit_hvsr.html">sprit.sprit_hvsr module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sprit.sprit_utils.html">sprit.sprit_utils module</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">sprit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">sprit.sprit_hvsr</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for sprit.sprit_hvsr</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module is the main SpRIT module that contains all the functions needed to run HVSR analysis.</span>

<span class="sd">The functions defined here are read both by the SpRIT graphical user interface and by the command-line interface to run HVSR analysis on input data.</span>

<span class="sd">See documentation for individual functions for more information.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">base64</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gzip</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pathlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xml.etree.ElementTree</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ET</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">zoneinfo</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">kaleido</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.backend_bases</span><span class="w"> </span><span class="kn">import</span> <span class="n">MouseButton</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">obspy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">obspy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">PPSD</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyproj</span><span class="w"> </span><span class="kn">import</span> <span class="n">CRS</span><span class="p">,</span> <span class="n">Transformer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial.distance</span><span class="w"> </span><span class="kn">import</span> <span class="n">squareform</span><span class="p">,</span> <span class="n">pdist</span>

<span class="k">try</span><span class="p">:</span>  <span class="c1"># For distribution</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sprit</span><span class="w"> </span><span class="kn">import</span> <span class="n">sprit_utils</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sprit</span><span class="w"> </span><span class="kn">import</span> <span class="n">sprit_tkinter_ui</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sprit</span><span class="w"> </span><span class="kn">import</span> <span class="n">sprit_jupyter_UI</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">sprit</span><span class="w"> </span><span class="kn">import</span> <span class="n">sprit_plot</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>  <span class="c1"># For testing</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sprit_utils</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sprit_tkinter_ui</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sprit_jupyter_UI</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sprit_plot</span>

<span class="c1"># Constants, etc</span>
<span class="n">NOWTIME</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">DEFAULT_PLOT_STR</span> <span class="o">=</span> <span class="s2">&quot;HVSR p ann COMP+ p ann SPEC p ann&quot;</span>
<span class="n">OBSPY_FORMATS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AH&#39;</span><span class="p">,</span> <span class="s1">&#39;ALSEP_PSE&#39;</span><span class="p">,</span> <span class="s1">&#39;ALSEP_WTH&#39;</span><span class="p">,</span> <span class="s1">&#39;ALSEP_WTN&#39;</span><span class="p">,</span> <span class="s1">&#39;CSS&#39;</span><span class="p">,</span> <span class="s1">&#39;DMX&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;GCF&#39;</span><span class="p">,</span> <span class="s1">&#39;GSE1&#39;</span><span class="p">,</span> <span class="s1">&#39;GSE2&#39;</span><span class="p">,</span> <span class="s1">&#39;KINEMETRICS_EVT&#39;</span><span class="p">,</span> <span class="s1">&#39;KNET&#39;</span><span class="p">,</span> <span class="s1">&#39;MSEED&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;NNSA_KB_CORE&#39;</span><span class="p">,</span> <span class="s1">&#39;PDAS&#39;</span><span class="p">,</span> <span class="s1">&#39;PICKLE&#39;</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;REFTEK130&#39;</span><span class="p">,</span> <span class="s1">&#39;RG16&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;SAC&#39;</span><span class="p">,</span> <span class="s1">&#39;SACXY&#39;</span><span class="p">,</span> <span class="s1">&#39;SEG2&#39;</span><span class="p">,</span> <span class="s1">&#39;SEGY&#39;</span><span class="p">,</span> <span class="s1">&#39;SEISAN&#39;</span><span class="p">,</span> <span class="s1">&#39;SH_ASC&#39;</span><span class="p">,</span> <span class="s1">&#39;SLIST&#39;</span><span class="p">,</span> <span class="s1">&#39;TRC&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;SU&#39;</span><span class="p">,</span> <span class="s1">&#39;TSPAIR&#39;</span><span class="p">,</span> <span class="s1">&#39;WAV&#39;</span><span class="p">,</span> <span class="s1">&#39;WIN&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">]</span>
<span class="n">DEFAULT_BAND</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<span class="n">PLOT_KEYS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Input_Plot&quot;</span><span class="p">,</span> <span class="s2">&quot;Outlier_Plot&quot;</span><span class="p">,</span> <span class="s2">&quot;Plot_Report&quot;</span><span class="p">,</span> <span class="s2">&quot;Depth_Plot&quot;</span><span class="p">,</span> <span class="s2">&quot;Plot_Report&quot;</span><span class="p">]</span>

<span class="c1"># Resources directory path, and the other paths as well</span>
<span class="n">RESOURCE_DIR</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s1">&#39;sprit&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">)</span>
<span class="n">SAMPLE_DATA_DIR</span> <span class="o">=</span> <span class="n">RESOURCE_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;sample_data&#39;</span><span class="p">)</span>
<span class="n">SETTINGS_DIR</span> <span class="o">=</span> <span class="n">RESOURCE_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">)</span>

<span class="k">global</span> <span class="n">spritApp</span>

<span class="c1"># Predefined variables</span>
<span class="n">max_rank</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">global</span> <span class="n">do_run</span> 
<span class="n">do_run</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">sampleListNos</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">]</span>
<span class="n">SAMPLE_LIST</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span> <span class="s1">&#39;5&#39;</span><span class="p">,</span> <span class="s1">&#39;6&#39;</span><span class="p">,</span> <span class="s1">&#39;7&#39;</span><span class="p">,</span> <span class="s1">&#39;8&#39;</span><span class="p">,</span> <span class="s1">&#39;9&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;sample_batch&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sampleListNos</span><span class="p">:</span>
    <span class="n">SAMPLE_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sample</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">SAMPLE_LIST</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sample_</span><span class="si">{</span><span class="n">s</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">sampleFileKeyMap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;1&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite1_AM.RAC84.00.2023.046_2023-02-15_1704-1734.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;2&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite2_AM.RAC84.00.2023-02-15_2132-2200.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;3&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite3_AM.RAC84.00.2023.199_2023-07-18_1432-1455.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;4&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite4_AM.RAC84.00.2023.199_2023-07-18_1609-1629.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;5&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite5_AM.RAC84.00.2023.199_2023-07-18_2039-2100.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;6&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite6_AM.RAC84.00.2023.192_2023-07-11_1510-1528.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;7&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite7_BNE_4_AM.RAC84.00.2023.191_2023-07-10_2237-2259.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;8&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite8_BNE_6_AM.RAC84.00.2023.191_2023-07-10_1806-1825.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;9&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite9_BNE-2_AM.RAC84.00.2023.192_2023-07-11_0000-0011.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;10&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite10_BNE_4_AM.RAC84.00.2023.191_2023-07-10_2237-2259.MSEED&#39;</span><span class="p">),</span>
                    
                    <span class="s1">&#39;sample1&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite1_AM.RAC84.00.2023.046_2023-02-15_1704-1734.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample2&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite2_AM.RAC84.00.2023-02-15_2132-2200.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample3&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite3_AM.RAC84.00.2023.199_2023-07-18_1432-1455.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample4&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite4_AM.RAC84.00.2023.199_2023-07-18_1609-1629.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample5&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite5_AM.RAC84.00.2023.199_2023-07-18_2039-2100.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample6&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite6_AM.RAC84.00.2023.192_2023-07-11_1510-1528.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample7&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite7_BNE_4_AM.RAC84.00.2023.191_2023-07-10_2237-2259.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample8&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite8_BNE_6_AM.RAC84.00.2023.191_2023-07-10_1806-1825.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample9&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite9_BNE-2_AM.RAC84.00.2023.192_2023-07-11_0000-0011.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample10&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite10_BNE_4_AM.RAC84.00.2023.191_2023-07-10_2237-2259.MSEED&#39;</span><span class="p">),</span>

                    <span class="s1">&#39;sample_1&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite1_AM.RAC84.00.2023.046_2023-02-15_1704-1734.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample_2&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite2_AM.RAC84.00.2023-02-15_2132-2200.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample_3&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite3_AM.RAC84.00.2023.199_2023-07-18_1432-1455.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample_4&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite4_AM.RAC84.00.2023.199_2023-07-18_1609-1629.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample_5&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite5_AM.RAC84.00.2023.199_2023-07-18_2039-2100.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample_6&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite6_AM.RAC84.00.2023.192_2023-07-11_1510-1528.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample_7&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite7_BNE_4_AM.RAC84.00.2023.191_2023-07-10_2237-2259.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample_8&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite8_BNE_6_AM.RAC84.00.2023.191_2023-07-10_1806-1825.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample_9&#39;</span><span class="p">:</span><span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite9_BNE-2_AM.RAC84.00.2023.192_2023-07-11_0000-0011.MSEED&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample_10&#39;</span><span class="p">:</span> <span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite10_BNE_4_AM.RAC84.00.2023.191_2023-07-10_2237-2259.MSEED&#39;</span><span class="p">),</span>
                    
                    <span class="s1">&#39;batch&#39;</span><span class="p">:</span> <span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;Batch_SampleData.csv&#39;</span><span class="p">),</span>
                    <span class="s1">&#39;sample_batch&#39;</span><span class="p">:</span> <span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;Batch_SampleData.csv&#39;</span><span class="p">)}</span>


<span class="c1"># CLASSES</span>
<span class="c1"># Check if the data is already the right class</span>
<span class="c1"># Define a decorator that wraps the __init__ method</span>
<div class="viewcode-block" id="check_instance">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.check_instance">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_instance</span><span class="p">(</span><span class="n">init</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Check if the first argument is an instance of self.__class__</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="c1"># Copy its attributes to self</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Call the original __init__ method</span>
            <span class="n">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span></div>



<span class="c1"># Class for batch data</span>
<div class="viewcode-block" id="HVSRBatch">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRBatch">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HVSRBatch</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HVSRBatch is the data container used for batch processing. </span>
<span class="sd">    It contains several HVSRData objects (one for each site). </span>
<span class="sd">    These can be accessed using their site name, </span>
<span class="sd">    either square brackets (HVSRBatchVariable[&quot;SiteName&quot;]) or the dot (HVSRBatchVariable.SiteName) accessor.</span>
<span class="sd">    </span>
<span class="sd">    The dot accessor may not work if there is a space in the site name.</span>
<span class="sd">    </span>
<span class="sd">    All of the  functions in the sprit package are designed to perform the bulk of their operations iteratively</span>
<span class="sd">    on the individual HVSRData objects contained in the HVSRBatch object, and do little with the HVSRBatch object itself, </span>
<span class="sd">    besides using it determine which sites are contained within it.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@check_instance</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_input</span><span class="p">,</span> <span class="n">batch_ext</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_use</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">df_as_read</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;HVSR Batch initializer</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        batch_input : dict, list, tuple, HVSRData, or filepath(s)</span>
<span class="sd">            If:</span>

<span class="sd">            * dict, dictionary containing Key value pairs with {sitename: HVSRData object}.</span>
<span class="sd">            * list or tuple, assumed to be dicts, HVSRData objects, or filepaths to processed .hvsr files or seismic data to be processed.</span>
<span class="sd">            * HVSRData object, will transform into HVSRBatch object with single HVSRData object. The add() or append() methods, or using square brackes can be used to add additional sites.</span>
<span class="sd">            * filepaths, if:</span>
<span class="sd">                * If directory, will use `batch_ext` as the input to a `glob()` function to get all files in that directory and add them to batch. Defaults to &#39;.hvsr&#39; files if `batch_ext` not specified.</span>
<span class="sd">                * Filepath, will make a HVSRBatch object importing that single file, or if readable by pandas.read_csv() will use in conjunction with `batch_use` (see below)</span>
<span class="sd">        batch_ext : str or None</span>
<span class="sd">            Filepath extension to use in `glob()` function for filetypes to import, if batch_input is a filepath.</span>
<span class="sd">        batch_use : {dict, list, tuple, None}</span>
<span class="sd">            Intended to be used as dict with keys &quot;site&quot;, &quot;filepath&quot;, and &quot;batch&quot;. </span>
<span class="sd">            In this case, should be {&#39;site&#39;:&quot;name_of_df_col_with_sitenames&quot;, &#39;filepath&#39;:&quot;name_of_df_col_with_filepaths_to_data&quot;, &#39;batch&#39;:values_to_include}.</span>
<span class="sd">            values_to_include can be a value (or list of values) in a column called &quot;batch&quot; to specify that that row should be included in the HVSRBatch object or</span>
<span class="sd">            a dictionary where they keys are column names and the values are the values to look for in each column name for inclusion in HVSRBatch object.</span>
<span class="sd">            If not specified, defaults to None and uses all rows in dataframe.</span>

<span class="sd">        df_as_read : {None, pd.DataFrame}</span>
<span class="sd">            Used in various sprit functions to allow original DataFrame used to create HVSRBatch object to be carried through.        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Just return it as-is if it&#39;s already Batch object</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_input</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">batch_input</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_input</span> <span class="o">=</span> <span class="n">batch_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_input</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_input</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_input_df</span> <span class="o">=</span> <span class="n">df_as_read</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input_df</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_input</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,)):</span>
            <span class="c1"># This is for a list/tuple with the following structure:</span>
            <span class="c1"># batch_input = [HVSRData, HVSRData, HVSRData]</span>
            <span class="c1"># or batch_input = [&#39;/file/path1.hvsr&#39;, &#39;/file/path2.hvsr&#39;]</span>
            <span class="c1"># Can also be mixed: [HVSRData, &#39;/file/path3/.hvsr&#39;]</span>
            <span class="n">siteNo</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">zfilldigs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_input</span><span class="p">)))</span>
            
            <span class="k">for</span> <span class="n">hvdata</span> <span class="ow">in</span> <span class="n">batch_input</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvdata</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvdata</span><span class="p">,</span> <span class="s1">&#39;site&#39;</span><span class="p">):</span>
                        <span class="n">sitename</span> <span class="o">=</span> <span class="n">hvdata</span><span class="o">.</span><span class="n">site</span>
                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvdata</span><span class="p">,</span> <span class="s1">&#39;Table_Report&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;Site Name&#39;</span> <span class="ow">in</span> <span class="n">hvdata</span><span class="o">.</span><span class="n">Table_Report</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">sitename</span> <span class="o">=</span> <span class="n">hvdata</span><span class="o">.</span><span class="n">Table_Report</span><span class="p">[</span><span class="s1">&#39;Site Name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sitename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;HVSRSite</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">siteNo</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">zfilldigs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">siteNo</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span><span class="p">[</span><span class="n">sitename</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvdata</span>
                <span class="k">elif</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">hvdata</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">def</span><span class="w"> </span><span class="nf">_get_sitename</span><span class="p">(</span><span class="n">proposed_sitename</span><span class="p">,</span> <span class="n">batch_dict</span><span class="p">):</span>
                        <span class="c1"># Get unique site name based on stem</span>
                        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">proposed_sitename</span> <span class="ow">in</span> <span class="n">batch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="c1"># 100 is limit</span>
                            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">proposed_sitename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="n">index</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">proposed_sitename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                                        <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">proposed_sitename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
                                        <span class="n">sitenameList</span> <span class="o">=</span> <span class="n">proposed_sitename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
                                        <span class="n">sitenameList</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                                        <span class="n">proposed_sitename</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sitenameList</span><span class="p">)</span>
                                        <span class="k">break</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">proposed_sitename</span> <span class="o">=</span> <span class="n">proposed_sitename</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                                        <span class="k">break</span>
                                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">proposed_sitename</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">proposed_sitename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">return</span> <span class="n">proposed_sitename</span>

                    <span class="k">if</span> <span class="s1">&#39;hvsr&#39;</span> <span class="ow">in</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">hvdata</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
                        <span class="n">sitename</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">hvdata</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
                        <span class="n">sitename</span> <span class="o">=</span> <span class="n">_get_sitename</span><span class="p">(</span><span class="n">sitename</span><span class="p">,</span> <span class="n">batch_dict</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span><span class="p">[</span><span class="n">sitename</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvdata</span>
                    <span class="k">elif</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">hvdata</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">upper</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">OBSPY_FORMATS</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Site specified for inclusion in HVSRBatch has not been processed. Processing. (</span><span class="si">{</span><span class="n">hvdata</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                        <span class="n">sitename</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">hvdata</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
                        <span class="n">sitename</span> <span class="o">=</span> <span class="n">_get_sitename</span><span class="p">(</span><span class="n">sitename</span><span class="p">,</span> <span class="n">batch_dict</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span><span class="p">[</span><span class="n">sitename</span><span class="p">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">hvdata</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse Batch input. Excluding from HVSRBatch object: </span><span class="si">{</span><span class="n">hvdata</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_input</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># This is for a dictionary with the following structure:</span>
            <span class="c1"># batch_input = {&quot;SiteName1&quot;:HVSRData, &quot;Sitename2&quot;:HVSRData}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span> <span class="o">=</span> <span class="n">batch_input</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_input</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">):</span>
            <span class="c1"># If iniitializing HVSRBatch with single HVSRData</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span><span class="p">[</span><span class="n">batch_input</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">batch_input</span>
        <span class="k">elif</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">batch_input</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c1"># This is intended for filepaths</span>
            <span class="k">if</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">batch_input</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">batch_ext</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">batchfileglob</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">batch_input</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.&quot;</span><span class="o">+</span><span class="n">batch_ext</span><span class="p">)</span>
                    <span class="n">batchfiledict</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="c1">#if &#39;hvsr&#39; in batch_ext:</span>
                    <span class="k">for</span> <span class="n">hvfile</span> <span class="ow">in</span> <span class="n">batchfileglob</span><span class="p">:</span>
                        <span class="n">currhvfile</span> <span class="o">=</span> <span class="n">import_data</span><span class="p">(</span><span class="n">hvfile</span><span class="p">)</span>
                        <span class="n">batchfiledict</span><span class="p">[</span><span class="n">currhvfile</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">currhvfile</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_dict</span> <span class="o">=</span> <span class="n">batchfiledict</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Assume it is .hvsr file you wish to import</span>
                    <span class="n">batchfileglob</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">batchfiledict</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="n">batchfileglob</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">batch_input</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">hvfile</span> <span class="ow">in</span> <span class="n">batchfileglob</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">hvfile</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;hvsr&#39;</span><span class="p">):</span>
                            <span class="n">currhvfile</span> <span class="o">=</span> <span class="n">import_data</span><span class="p">(</span><span class="n">hvfile</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
                            <span class="n">batchfiledict</span><span class="p">[</span><span class="n">currhvfile</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">currhvfile</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_dict</span> <span class="o">=</span> <span class="n">batchfiledict</span>           
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;.hvsr&#39;</span> <span class="ow">in</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">batch_input</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
                    <span class="c1"># In this case, assume this is alreayd a batch file and import/return it</span>
                    <span class="k">return</span> <span class="n">import_data</span><span class="p">(</span><span class="n">batch_input</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For reading in a csv and specifying column map</span>
                    <span class="n">batch_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">batch_input</span><span class="p">)</span>

                    <span class="c1"># Convert columns to lowercase</span>
                    <span class="n">batch_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">batch_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

                    <span class="c1"># This is for if dictionary mapping is not specified</span>
                    <span class="n">snList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="s1">&#39;sitename&#39;</span><span class="p">,</span> <span class="s1">&#39;sites&#39;</span><span class="p">,</span> <span class="s1">&#39;sitenames&#39;</span><span class="p">,</span> 
                                <span class="s1">&#39;identifier&#39;</span><span class="p">,</span> <span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="s1">&#39;crosssection&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">]</span>
                    <span class="n">pathList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hvsr_export_path&#39;</span><span class="p">,</span> <span class="s1">&#39;import_filepath&#39;</span><span class="p">,</span> <span class="s1">&#39;batch_input&#39;</span><span class="p">,</span> <span class="s1">&#39;filepath&#39;</span><span class="p">,</span> <span class="s1">&#39;input_data&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;path&#39;</span><span class="p">,</span> <span class="s1">&#39;filepath&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="s1">&#39;hvsrdata&#39;</span><span class="p">,</span> <span class="s1">&#39;hvsr&#39;</span><span class="p">,</span> <span class="s1">&#39;data&#39;</span><span class="p">]</span>

                    <span class="n">siteCol</span> <span class="o">=</span> <span class="n">batch_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">sn</span> <span class="ow">in</span> <span class="n">snList</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sn</span> <span class="ow">in</span> <span class="n">snList</span><span class="p">:</span>
                            <span class="n">siteCol</span> <span class="o">=</span> <span class="n">sn</span>
                            <span class="k">break</span>

                    <span class="n">pathCol</span> <span class="o">=</span> <span class="n">batch_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">pa</span> <span class="ow">in</span> <span class="n">pathList</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pa</span> <span class="ow">in</span> <span class="n">pathList</span><span class="p">:</span>
                            <span class="n">pathCol</span> <span class="o">=</span> <span class="n">pa</span>
                            <span class="k">break</span>

                    <span class="k">def</span><span class="w"> </span><span class="nf">_read_data_into_batch</span><span class="p">(</span><span class="n">batch_df_row</span><span class="p">,</span> <span class="n">site_col</span><span class="p">,</span> <span class="n">path_col</span><span class="p">):</span>
                        <span class="k">if</span> <span class="s1">&#39;.hvsr&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_df_row</span><span class="p">[</span><span class="n">path_col</span><span class="p">]):</span>
                            <span class="n">dataObj</span> <span class="o">=</span> <span class="n">import_data</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">batch_df_row</span><span class="p">[</span><span class="n">path_col</span><span class="p">]))</span>
                        <span class="k">elif</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">batch_df_row</span><span class="p">[</span><span class="n">path_col</span><span class="p">])</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">upper</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">OBSPY_FORMATS</span><span class="p">:</span>
                            <span class="n">dataObj</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">batch_df_row</span><span class="p">[</span><span class="n">path_col</span><span class="p">])</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">Warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch input specified as site </span><span class="si">{</span><span class="n">batch_df_row</span><span class="p">[</span><span class="n">site_col</span><span class="p">]</span><span class="si">}</span><span class="s2"> cannot be read, skipping: </span><span class="si">{</span><span class="n">batch_df_row</span><span class="p">[</span><span class="n">path_col</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">dataObj</span> <span class="o">=</span> <span class="kc">None</span>
                        
                        <span class="k">return</span> <span class="n">dataObj</span>

                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_use</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="c1"># Dictionary of {&#39;site&#39;:&quot;site_col&quot;, &#39;filepath&#39;:&#39;path_col&#39;, &#39;batch&#39;:values_in_batch_col_to_include}</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">batch_use</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">warnMsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;batch_use dict should have three keys called &#39;site&#39;, &#39;filepath&#39;, and &#39;batch&#39; (not </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">batch_use</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">batch_use</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">). </span><span class="se">\n\t</span><span class="s2">&#39;batch&#39; may be changed to name of column you are using to specify inclusion in HVSRBatch object, or input DataFrame should have column called &#39;batch&#39;&quot;</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">Warn</span><span class="p">(</span><span class="n">warnMsg</span><span class="p">)</span>

                        <span class="c1"># Should be site and filepath, but just in case</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">batch_use</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">snList</span><span class="p">:</span>
                                <span class="n">siteCol</span> <span class="o">=</span> <span class="n">batch_use</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="n">siteKey</span> <span class="o">=</span> <span class="n">k</span>

                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">pathList</span><span class="p">:</span>
                                <span class="n">pathCol</span> <span class="o">=</span> <span class="n">batch_use</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="n">pathKey</span> <span class="o">=</span> <span class="n">k</span>

                            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">snList</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pathList</span><span class="p">:</span>
                                <span class="n">includeMe</span> <span class="o">=</span> <span class="n">batch_use</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                                <span class="n">batchKey</span> <span class="o">=</span> <span class="n">k</span>
    
                        <span class="c1"># Get subset df with only rows that we want</span>
                        <span class="c1">#includeMe = batchCol#batch_use[batchCol]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">includeMe</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                            <span class="n">sites_df</span> <span class="o">=</span> <span class="n">batch_df</span><span class="p">[</span><span class="n">batch_df</span><span class="p">[</span><span class="n">batchKey</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">includeMe</span><span class="p">)]</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">includeMe</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                            <span class="n">sitesDFList</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">batchCol</span><span class="p">,</span> <span class="n">includeValue</span> <span class="ow">in</span> <span class="n">includeMe</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="n">sitesDFList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_df</span><span class="p">[</span><span class="n">batch_df</span><span class="p">[</span><span class="n">batchCol</span><span class="p">]</span><span class="o">==</span><span class="n">includeValue</span><span class="p">])</span>
                            <span class="n">sites_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">sitesDFList</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sites_df</span> <span class="o">=</span> <span class="n">batch_df</span><span class="p">[</span><span class="n">batch_df</span><span class="p">[</span><span class="n">batchKey</span><span class="p">]</span><span class="o">==</span><span class="n">includeMe</span><span class="p">]</span>

                        <span class="c1"># Import, process, or otherwise read data into batch object</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sites_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                            <span class="n">dataObj</span> <span class="o">=</span> <span class="n">_read_data_into_batch</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">siteCol</span><span class="p">,</span> <span class="n">pathCol</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">dataObj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">siteCol</span><span class="p">])]</span> <span class="o">=</span> <span class="n">dataObj</span>

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_use</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                        <span class="c1"># This should be list/tuples of site names</span>
                        <span class="n">sites_df</span> <span class="o">=</span> <span class="n">batch_df</span><span class="p">[</span><span class="n">batch_df</span><span class="p">[</span><span class="n">siteCol</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">batch_use</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sites_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                            <span class="n">dataObj</span> <span class="o">=</span> <span class="n">_read_data_into_batch</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">siteCol</span><span class="p">,</span> <span class="n">pathCol</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">dataObj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">siteCol</span><span class="p">])]</span> <span class="o">=</span> <span class="n">dataObj</span>
                    
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Use all rows (as possible)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;**NOTE**: All data specified will be read into batch object, from: </span><span class="si">{</span><span class="n">batch_input</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">batch_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                            <span class="n">dataObj</span> <span class="o">=</span> <span class="n">_read_data_into_batch</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">siteCol</span><span class="p">,</span> <span class="n">pathCol</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">dataObj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">siteCol</span><span class="p">])]</span> <span class="o">=</span> <span class="n">dataObj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The batch_input parameter of the HVSRBatch class must be a dict of parameters, list or tuple of HVSRData obejcts, or an HVSRData object itself. </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">batch_input</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_batch_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span>
        <span class="k">for</span> <span class="n">sitename</span><span class="p">,</span> <span class="n">hvsrdata</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sitename</span><span class="p">,</span> <span class="n">hvsrdata</span><span class="p">)</span>
            <span class="bp">self</span><span class="p">[</span><span class="n">sitename</span><span class="p">][</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sites</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>


    <span class="c1"># METHODS</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Not yet implemented, but may allow import/export to json files in the future, rather than just .hvsr pickles</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : filepath object</span>
<span class="sd">            Location to save HVSRBatch object as json</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># open the file with the given filepath</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="c1"># dump the JSON string to the file</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>


<div class="viewcode-block" id="HVSRBatch.add">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRBatch.add">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hvsr_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Function to add HVSRData objects to existing HVSRBatch objects&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">)):</span>
            <span class="n">hvsr_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">hvsr_data</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,)):</span>
            <span class="n">siteNo</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">zfilldigs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">)))</span>

            <span class="k">for</span> <span class="n">hvdata</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">:</span>
                <span class="n">sitename</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;HVSRSite</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">siteNo</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">zfilldigs</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvdata</span><span class="p">,</span> <span class="s1">&#39;site&#39;</span><span class="p">):</span>
                    <span class="n">sitename</span> <span class="o">=</span> <span class="n">hvdata</span><span class="o">.</span><span class="n">site</span>
                <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvdata</span><span class="p">,</span> <span class="s1">&#39;Table_Report&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;Site Name&#39;</span> <span class="ow">in</span> <span class="n">hvdata</span><span class="o">.</span><span class="n">Table_Report</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">sitename</span> <span class="o">=</span> <span class="n">hvdata</span><span class="o">.</span><span class="n">Table_Report</span><span class="p">[</span><span class="s1">&#39;Site Name&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvdata</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;site&#39;</span> <span class="ow">in</span> <span class="n">hvdata</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">sitename</span> <span class="o">=</span> <span class="n">hvdata</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span>

                <span class="bp">self</span><span class="p">[</span><span class="n">sitename</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span></div>

        

<div class="viewcode-block" id="HVSRBatch.append">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRBatch.append">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hvsr_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Alias of add()&quot;&quot;&quot;</span>
        <span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hvsr_data</span><span class="p">)</span></div>

        

<div class="viewcode-block" id="HVSRBatch.export">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRBatch.export">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hvsr_export_path</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;hvsr&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to export HVSRData objects in HVSRBatch container to indivdual .hvsr pickle files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hvsr_export_path : filepath, default=True</span>
<span class="sd">            Filepath to save file. Can be either directory (which will assign a filename based on the HVSRData attributes). By default True. If True, it will first try to save each file to the same directory as input_data, then if that does not work, to the current working directory, then to the user&#39;s home directory, by default True</span>
<span class="sd">        ext : str, optional</span>
<span class="sd">            The extension to use for the output, by default &#39;hvsr&#39;. This is still a pickle file that can be read with pickle.load(), but will have .hvsr extension.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">export_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">hvsr_export_path</span><span class="o">=</span><span class="n">hvsr_export_path</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span></div>



<div class="viewcode-block" id="HVSRBatch.keys">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRBatch.keys">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to return the &quot;keys&quot; of the HVSRBatch object. For HVSRBatch objects, these are the site names. Functions similar to dict.keys().</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict_keys</span>
<span class="sd">            A dict_keys object listing the site names of each of the HVSRData objects contained in the HVSRBatch object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>



<div class="viewcode-block" id="HVSRBatch.items">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRBatch.items">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to return both the site names and the HVSRData object as a set of dict_items tuples. Functions similar to dict.items().</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span></div>



<div class="viewcode-block" id="HVSRBatch.copy">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRBatch.copy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;shallow&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a copy of the HVSRBatch object. Uses python copy module.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        type : str {&#39;shallow&#39;, &#39;deep&#39;}</span>
<span class="sd">            Based on input, creates either a shallow or deep copy of the HVSRBatch object. Shallow is equivalent of copy.copy(). Input of &#39;deep&#39; is equivalent of copy.deepcopy() (still experimental). Defaults to shallow.</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;deep&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HVSRBatch</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_dict</span><span class="p">),</span> <span class="n">df_as_read</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_df</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HVSRBatch</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_dict</span><span class="p">),</span> <span class="n">df_as_read</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_input_df</span><span class="p">)</span></div>



    <span class="c1">#Method wrapper of sprit.plot_hvsr function</span>
<div class="viewcode-block" id="HVSRBatch.plot">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRBatch.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to plot data, based on the sprit.plot_hvsr() function. </span>
<span class="sd">        </span>
<span class="sd">        All the same kwargs and default values apply as plot_hvsr().</span>
<span class="sd">        For return_fig, returns it to the &#39;Plot_Report&#39; attribute of each HVSRData object</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _type_</span>
<span class="sd">            _description_</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        plot_hvsr</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sitename</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;return_fig&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;return_fig&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="p">[</span><span class="n">sitename</span><span class="p">][</span><span class="s1">&#39;Plot_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_hvsr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">sitename</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plot_hvsr</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">sitename</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

    
<div class="viewcode-block" id="HVSRBatch.get_report">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRBatch.get_report">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to get report from processed data, in print, graphical, or tabular format.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Variable</span>
<span class="sd">            May return nothing, pandas.Dataframe, or pyplot Figure, depending on input.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        get_report</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;report_formats&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;table&#39;</span> <span class="o">==</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">sitename</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="n">rowList</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">rowList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">sitename</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">rowList</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="s1">&#39;plot&#39;</span> <span class="o">==</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]:</span>
                <span class="n">plotDict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">sitename</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;return_fig&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;return_fig&#39;</span><span class="p">]:</span>
                        <span class="n">plotDict</span><span class="p">[</span><span class="n">sitename</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">sitename</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">sitename</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">plotDict</span>
            
        <span class="c1">#Only report_formats left is print, doesn&#39;t return anything, so doesn&#39;t matter if defalut or not</span>
        <span class="k">for</span> <span class="n">sitename</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="n">sitename</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="HVSRBatch.report">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRBatch.report">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper of get_report()</span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        get_report</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_report</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="HVSRBatch.export_settings">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRBatch.export_settings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">site_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">export_settings_path</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">export_settings_type</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">include_location</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to export settings from HVSRData object in HVSRBatch object. </span>
<span class="sd">        </span>
<span class="sd">        Simply calls sprit.export_settings() from specified HVSRData object in the HVSRBatch object. </span>
<span class="sd">        See sprit.export_settings() for more details.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        site_name : str, default=None</span>
<span class="sd">            The name of the site whose settings should be exported. If None, will default to the first site, by default None.</span>
<span class="sd">        export_settings_path : str, optional</span>
<span class="sd">            Filepath to output file. If left as &#39;default&#39;, will save as the default value in the resources directory. If that is not possible, will save to home directory, by default &#39;default&#39;</span>
<span class="sd">        export_settings_type : str, {&#39;all&#39;, &#39;instrument&#39;, &#39;processing&#39;}, optional</span>
<span class="sd">            They type of settings to save, by default &#39;all&#39;</span>
<span class="sd">        include_location : bool, optional</span>
<span class="sd">            Whether to include the location information in the instrument settings, if that settings type is selected, by default False</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print output (filepath and settings) to terminal, by default True</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        export_settings</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#If no site name selected, use first site</span>
        <span class="k">if</span> <span class="n">site_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">site_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sites</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
        <span class="n">export_settings</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="bp">self</span><span class="p">[</span><span class="n">site_name</span><span class="p">],</span> 
                        <span class="n">export_settings_path</span><span class="o">=</span><span class="n">export_settings_path</span><span class="p">,</span> <span class="n">export_settings_type</span><span class="o">=</span><span class="n">export_settings_type</span><span class="p">,</span> <span class="n">include_location</span><span class="o">=</span><span class="n">include_location</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_batch_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></div>

    
<span class="c1"># Class for HVSR site data</span>
<div class="viewcode-block" id="HVSRData">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRData">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HVSRData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HVSRData is the basic data class of the sprit package. </span>
<span class="sd">    It contains all the processed data, input parameters, and reports.</span>
<span class="sd">    </span>
<span class="sd">    These attributes and objects can be accessed using square brackets or the dot accessor. For example, to access the site name, HVSRData[&#39;site&#39;] and HVSRData.site will both return the site name.</span>
<span class="sd">    </span>
<span class="sd">    Some of the methods that work on the HVSRData object (e.g., .plot() and .get_report()) are essentially wrappers for some of the main sprit package functions (sprit.plot_hvsr() and sprit.get_report(), respectively)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@check_instance</span>    
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1">#self.tsteps_used = []</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;input_params&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">processing_status</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;input_params_status&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="s1">&#39;fetch_data_status&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="s1">&#39;calculate_azimuths_status&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="s1">&#39;remove_noise_status&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="s1">&#39;generate_psds_status&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="s1">&#39;process_hvsr_status&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="s1">&#39;remove_outlier_curves_status&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                                  <span class="s1">&#39;overall_status&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">attrsToUse</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">,</span> <span class="s1">&#39;site&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;instrument&#39;</span><span class="p">,</span> <span class="s1">&#39;network&#39;</span><span class="p">,</span> <span class="s1">&#39;station&#39;</span><span class="p">,</span> <span class="s1">&#39;location&#39;</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">,</span>
            <span class="s1">&#39;acq_date&#39;</span><span class="p">,</span> <span class="s1">&#39;starttime&#39;</span><span class="p">,</span> <span class="s1">&#39;endtime&#39;</span><span class="p">,</span>
            <span class="s1">&#39;xcoord&#39;</span><span class="p">,</span> <span class="s1">&#39;ycoord&#39;</span><span class="p">,</span> <span class="s1">&#39;input_crs&#39;</span><span class="p">,</span> <span class="s1">&#39;elevation&#39;</span><span class="p">,</span> <span class="s1">&#39;elev_unit&#39;</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">atu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">atu</span> <span class="ow">in</span> <span class="n">attrsToUse</span><span class="p">]):</span>
            <span class="k">return</span> <span class="s1">&#39;String representation cannot be generated. Object not instatianted correctly using sprit.input_params()&#39;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">__get_ip_default</span><span class="p">(</span><span class="n">parameter</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
            <span class="k">elif</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">parameter</span>

        <span class="c1"># Get title lines formatted</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span> <span class="o">==</span> <span class="n">__get_ip_default</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">):</span>
            <span class="n">projStr</span> <span class="o">=</span> <span class="s1">&#39;No project specified&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">projStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span>

        <span class="n">hvsrIDStr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;hvsr_id&#39;</span><span class="p">):</span>
            <span class="n">hvsrIDStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hvsr_id</span>
        <span class="k">elif</span> <span class="s1">&#39;hvsr_id&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">hvsrIDStr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;hvsr_id&#39;</span><span class="p">]</span>

        <span class="n">titleInfoStr</span> <span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SpRIT HVSR DATA INFORMATION</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">titleLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">titleInfoStr</span><span class="p">)</span>
        <span class="n">bigLineBreak</span> <span class="o">=</span> <span class="s2">&quot;—&quot;</span><span class="o">*</span><span class="n">titleLen</span><span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">titleInfoStr</span> <span class="o">+=</span> <span class="n">bigLineBreak</span>
        <span class="n">titleInfoStr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Site Name: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">site</span><span class="si">}</span><span class="se">\n</span><span class="s2">Project: (</span><span class="si">{</span><span class="n">projStr</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">titleInfoStr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">titleInfoStr</span><span class="si">}</span><span class="s2">HVSRID (autogenerated): </span><span class="si">{</span><span class="n">hvsrIDStr</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">titleInfoStr</span> <span class="o">+=</span> <span class="n">bigLineBreak</span>
        
        <span class="c1"># Acquisition instrument information</span>
        <span class="n">instInfoStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">INSTRUMENT INFO</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">instInfoStr</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instInfoStr</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">instStr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Instrument in use: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">instrument</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrument</span> <span class="o">==</span> <span class="n">__get_ip_default</span><span class="p">(</span><span class="s1">&#39;instrument&#39;</span><span class="p">):</span>
            <span class="n">instStr</span> <span class="o">=</span> <span class="s1">&#39;No instrument type specified&#39;</span>

        <span class="n">netStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">network</span>
        <span class="n">staStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">station</span>
        <span class="n">locStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">location</span>
        <span class="n">chaStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span>
        <span class="k">if</span> <span class="n">chaStr</span> <span class="o">==</span> <span class="n">__get_ip_default</span><span class="p">(</span><span class="s1">&#39;channels&#39;</span><span class="p">):</span>
            <span class="n">chaStr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;No channels specified (using </span><span class="si">{</span><span class="n">chaStr</span><span class="si">}</span><span class="s1">)&#39;</span>

        <span class="n">acqInstStr</span> <span class="o">=</span> <span class="n">instInfoStr</span>
        <span class="n">acqInstStr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">instStr</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">acqInstStr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Instrument ID: </span><span class="si">{</span><span class="n">netStr</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">staStr</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">locStr</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">acqInstStr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t\t</span><span class="s2">Channels: </span><span class="si">{</span><span class="n">chaStr</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Acquisition site information</span>
        <span class="n">xcoordINStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xcoord_input</span>
        <span class="n">xcoordStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xcoord</span>
        <span class="n">lonStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">longitude</span>
        <span class="n">ycoordINstr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ycoord_input</span>
        <span class="n">ycoordStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ycoord</span>
        <span class="n">latStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latitude</span>
        <span class="n">inCRSStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_crs</span>
        <span class="n">outCRSStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_crs</span>

        <span class="n">inputLocStr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">xcoordINStr</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ycoordINstr</span><span class="si">}</span><span class="s2"> (as input in </span><span class="si">{</span><span class="n">inCRSStr</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
        
        <span class="n">transLocStr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">inCRSStr</span> <span class="o">!=</span> <span class="n">outCRSStr</span><span class="p">:</span>
            <span class="n">transLocStr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">xcoordStr</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">ycoordstr</span><span class="si">}</span><span class="s2"> (transformed to output_crs: </span><span class="si">{</span><span class="n">outCRSStr</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">wgs84Str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lonStr</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">°, </span><span class="si">{</span><span class="n">latStr</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2">° | Lon/Lat in WGS84 (EPSG:4326)&quot;</span>

        <span class="n">siteLocInfoStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">SITE INFO</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">siteLocInfoStr</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">siteLocInfoStr</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">siteLocInfoStr</span> <span class="o">+=</span> <span class="n">inputLocStr</span> <span class="o">+</span> <span class="n">transLocStr</span> <span class="o">+</span> <span class="n">wgs84Str</span>

        <span class="c1"># Acquistion time information</span>
        <span class="n">acqTimeStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">ACQUISITION TIME</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">acqTimeStr</span> <span class="o">+=</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">acqTimeStr</span><span class="p">)</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="n">aDateStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acq_date</span>
        <span class="n">sTimeStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">starttime</span>
        <span class="n">eTimeStr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endtime</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;stream&#39;</span><span class="p">):</span>
            <span class="n">dataST</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span>
            <span class="n">utcSTime</span> <span class="o">=</span> <span class="n">dataST</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
            <span class="n">utcETime</span> <span class="o">=</span> <span class="n">dataST</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">utcSTime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">starttime</span>
            <span class="n">utcETime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endtime</span>
        
        <span class="n">minDur</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">((</span><span class="n">utcETime</span> <span class="o">-</span> <span class="n">utcSTime</span><span class="p">)</span><span class="o">//</span><span class="mi">60</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">secDur</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">round</span><span class="p">((((</span><span class="n">utcETime</span> <span class="o">-</span> <span class="n">utcSTime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">minDur</span><span class="p">))</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">secDur</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">:</span>
            <span class="n">minDur</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">secDur</span><span class="o">//</span><span class="mi">60</span><span class="p">)</span>
            <span class="n">secDur</span> <span class="o">=</span> <span class="n">secDur</span> <span class="o">-</span> <span class="p">(</span><span class="n">secDur</span><span class="o">//</span><span class="mi">60</span><span class="p">)</span><span class="o">*</span><span class="mi">60</span>

        <span class="n">acqDurStr</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Record duration: </span><span class="si">{</span><span class="n">minDur</span><span class="si">}</span><span class="s1">:</span><span class="si">{</span><span class="n">secDur</span><span class="si">:</span><span class="s1">06.3f</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">utcETime</span><span class="o">-</span><span class="n">utcSTime</span><span class="si">}</span><span class="s1"> seconds)&#39;</span>
        <span class="k">if</span> <span class="n">aDateStr</span> <span class="o">==</span> <span class="n">__get_ip_default</span><span class="p">(</span><span class="s1">&#39;acq_date&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sTimeStr</span> <span class="o">==</span> <span class="n">__get_ip_default</span><span class="p">(</span><span class="s1">&#39;starttime&#39;</span><span class="p">):</span>
            <span class="n">acqTimeStr</span> <span class="o">+=</span> <span class="s1">&#39;No acquisition time specified.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">acqTimeStr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Acquisition Date: </span><span class="si">{</span><span class="n">aDateStr</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">acqTimeStr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Started at: </span><span class="si">{</span><span class="n">sTimeStr</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">acqTimeStr</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Ended at  : </span><span class="si">{</span><span class="n">eTimeStr</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">acqTimeStr</span> <span class="o">+=</span> <span class="n">acqDurStr</span>


        <span class="c1"># PEAK INFORMATION (IF CALCULATED)</span>
        <span class="n">peakInfoStr</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">azimuth</span><span class="o">=</span><span class="s1">&#39;HV&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;BestPeak&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">curvTestsPassed</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;WinLen&#39;</span><span class="p">]</span> <span class="o">+</span>
                                <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;SigCycles&#39;</span><span class="p">]</span><span class="o">+</span>
                                <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowCurveStD&#39;</span><span class="p">])</span>
            <span class="n">curvePass</span> <span class="o">=</span> <span class="n">curvTestsPassed</span> <span class="o">&gt;</span> <span class="mi">2</span>
            
            <span class="c1">#Peak Pass?</span>
            <span class="n">peakTestsPassed</span> <span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;ProminenceLow&#39;</span><span class="p">]</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;ProminenceHi&#39;</span><span class="p">]</span><span class="o">+</span>
                        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;AmpClarity&#39;</span><span class="p">]</span><span class="o">+</span>
                        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;FreqStability&#39;</span><span class="p">]</span><span class="o">+</span>
                        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span><span class="o">+</span>
                        <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">])</span>
            <span class="n">peakPass</span> <span class="o">=</span> <span class="n">peakTestsPassed</span> <span class="o">&gt;=</span> <span class="mi">5</span>

            <span class="n">peakInfoStr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">CALCULATED F₀</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">peakInfoStr</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">peakInfoStr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">peakInfoStr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">{0:.3f}</span><span class="s1"> Hz ± </span><span class="si">{1:.4f}</span><span class="s1"> Hz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s2">&quot;BestPeak&quot;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">curvePass</span> <span class="ow">and</span> <span class="n">peakPass</span><span class="p">:</span>
                <span class="n">peakInfoStr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1"> Peak at </span><span class="si">{}</span><span class="s1"> Hz passed SESAME quality tests! :D&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">(),</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">peakInfoStr</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1"> Peak at </span><span class="si">{}</span><span class="s1"> Hz did NOT pass SESAME quality tests :(&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">(),</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peakInfoStr</span> <span class="o">=</span> <span class="s1">&#39;F₀ not Calculated&#39;</span>

        <span class="n">printList</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">titleInfoStr</span><span class="p">,</span>
                    <span class="n">peakInfoStr</span><span class="p">,</span>
                    <span class="n">acqInstStr</span><span class="p">,</span>
                    <span class="n">siteLocInfoStr</span><span class="p">,</span>
                    <span class="n">acqTimeStr</span>
                    <span class="p">]</span>

        <span class="n">strRep</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="n">ps</span> <span class="ow">in</span> <span class="n">printList</span><span class="p">:</span>
            <span class="n">strRep</span> <span class="o">+=</span> <span class="n">ps</span>
        
        <span class="k">return</span> <span class="n">strRep</span>

        <span class="c1">#try:</span>
            <span class="c1"># Check if running in IPython environment</span>
        <span class="c1">#    from IPython.display import display, HTML</span>
        <span class="c1">#    return f&quot;&lt;b&gt;Person Information:&lt;/b&gt;&lt;br&gt;Name: {self.name}&lt;br&gt;Age: {self.age}&quot;</span>
        <span class="c1">#except ImportError:</span>
            <span class="c1"># Fallback for terminal/console</span>
        <span class="c1">#    return f&quot;Person Information:\nName: {self.name}\nAge: {self.age}&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="c1"># METHODS (many reflect dictionary methods)    </span>
<div class="viewcode-block" id="HVSRData.to_json">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRData.to_json">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">export_json</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_json</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Not yet supported, will export HVSRData object to json&quot;&quot;&quot;</span>

        <span class="n">class_keys_to_convert</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">,</span> 
                             <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">CRS</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Inventory</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">iterative_json_parser</span><span class="p">(</span><span class="n">input_attrib</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
            <span class="n">outValue</span> <span class="o">=</span> <span class="n">input_attrib</span>
            
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_attrib</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># simplified condition for demo</span>
            <span class="c1"># if isinstance(input_attrib, (dict, sprit.HVSRData)):  # use this line instead</span>
                <span class="n">outValue</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_attrib</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                    <span class="n">outKey</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;  &#39;</span><span class="p">]</span><span class="o">*</span><span class="n">level</span><span class="p">),</span> <span class="n">outKey</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outKey</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))):</span>
                        <span class="n">outKey</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">outKey</span><span class="p">)</span>
                    
                    <span class="c1"># Recursively process the value</span>
                    <span class="n">processed_value</span> <span class="o">=</span> <span class="n">iterative_json_parser</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
                    
                    <span class="c1"># Apply string conversion if needed</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processed_value</span><span class="p">,</span> <span class="n">class_keys_to_convert</span><span class="p">):</span>
                        <span class="n">processed_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">processed_value</span><span class="p">)</span>
                    
                    <span class="n">outValue</span><span class="p">[</span><span class="n">outKey</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_value</span>
                
                <span class="k">return</span> <span class="n">outValue</span>
            
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_attrib</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">outValue</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_attrib</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="n">outValue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Recursively process list items</span>
                        <span class="n">outValue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">iterative_json_parser</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">outValue</span>
            
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_attrib</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">outValue</span> <span class="o">=</span> <span class="n">input_attrib</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">outValue</span>
            
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_attrib</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
                <span class="c1"># Convert DataFrame to dict, but then recursively process it</span>
                <span class="n">dict_value</span> <span class="o">=</span> <span class="n">input_attrib</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">iterative_json_parser</span><span class="p">(</span><span class="n">dict_value</span><span class="p">,</span> <span class="n">level</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_attrib</span><span class="p">,</span> <span class="n">class_keys_to_convert</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_attrib</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">input_attrib</span>

        <span class="n">sKeys</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;sort_keys&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">sKeys</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sort_keys&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sort_keys&#39;</span><span class="p">]</span>

        <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">if</span> <span class="s1">&#39;indent&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">indent</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;indent&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">export_json</span> <span class="ow">and</span> <span class="n">json_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">json_filepath</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="c1"># dump the JSON string to the file</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fp</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">iterative_json_parser</span><span class="p">,</span> 
                        <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_json</span> <span class="ow">or</span> <span class="n">json_filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">iterative_json_parser</span><span class="p">,</span>
                              <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="n">indent</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="HVSRData.export">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRData.export">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hvsr_export_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;hvsr&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to export HVSRData objects to .hvsr pickle files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hvsr_export_path : filepath, default=True</span>
<span class="sd">            Filepath to save file. Can be either directory (which will assign a filename based on the HVSRData attributes). </span>
<span class="sd">            By default True. </span>
<span class="sd">            If True, it will first try to save each file to the same directory as input_data, then if that does not work, to the current working directory, then to the user&#39;s home directory, by default True</span>
<span class="sd">        ext : str, optional</span>
<span class="sd">            The extension to use for the output, by default &#39;hvsr&#39;. This is still a pickle file that can be read with pickle.load(), but will have .hvsr extension.</span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        export_hvsr</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">export_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">hvsr_export_path</span><span class="o">=</span><span class="n">hvsr_export_path</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span></div>


<div class="viewcode-block" id="HVSRData.copy">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRData.copy">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">copy_type</span><span class="o">=</span><span class="s1">&#39;shallow&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make a copy of the HVSRData object. Uses python copy module.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        copy_type : str {&#39;shallow&#39;, &#39;deep&#39;}</span>
<span class="sd">            Based on input, creates either a shallow or deep copy of the HVSRData object. </span>
<span class="sd">            Shallow is equivalent of copy.copy(). </span>
<span class="sd">            Input of copy_type=&#39;deep&#39; is equivalent of copy.deepcopy() (still experimental). </span>
<span class="sd">            Defaults to shallow.</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">copy_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;deep&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HVSRData</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">))</span></div>


<div class="viewcode-block" id="HVSRData.export_settings">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRData.export_settings">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">export_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">export_settings_path</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">export_settings_type</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">include_location</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to export settings from HVSRData object. Simply calls sprit.export_settings() from the HVSRData object. See sprit.export_settings() for more details.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        export_settings_path : str, optional</span>
<span class="sd">            Filepath to output file. If left as &#39;default&#39;, will save as the default value in the resources directory. If that is not possible, will save to home directory, by default &#39;default&#39;</span>
<span class="sd">        export_settings_type : str, {&#39;all&#39;, &#39;instrument&#39;, &#39;processing&#39;}, optional</span>
<span class="sd">            They type of settings to save, by default &#39;all&#39;</span>
<span class="sd">        include_location : bool, optional</span>
<span class="sd">            Whether to include the location information in the instrument settings, if that settings type is selected, by default False</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print output (filepath and settings) to terminal, by default True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">export_settings</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> 
                        <span class="n">export_settings_path</span><span class="o">=</span><span class="n">export_settings_path</span><span class="p">,</span> <span class="n">export_settings_type</span><span class="o">=</span><span class="n">export_settings_type</span><span class="p">,</span> <span class="n">include_location</span><span class="o">=</span><span class="n">include_location</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>


<div class="viewcode-block" id="HVSRData.get_report">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRData.get_report">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to get report from processed data, in print, graphical, or tabular format.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Variable</span>
<span class="sd">            May return nothing, pandas.Dataframe, or pyplot Figure, depending on input.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        get_report</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">report_return</span> <span class="o">=</span> <span class="n">get_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">report_return</span></div>


<div class="viewcode-block" id="HVSRData.items">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRData.items">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to return the &quot;items&quot; of the HVSRData object. For HVSRData objects, this is a dict_items object with the keys and values in tuples. Functions similar to dict.items().</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict_items</span>
<span class="sd">            A dict_items object of the HVSRData objects attributes, parameters, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>                
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span></div>


<div class="viewcode-block" id="HVSRData.keys">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRData.keys">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to return the &quot;keys&quot; of the HVSRData object. For HVSRData objects, these are the attributes and parameters of the object. Functions similar to dict.keys().</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict_keys</span>
<span class="sd">            A dict_keys object of the HVSRData objects attributes, parameters, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">keyList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">):</span>
                <span class="n">keyList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">keyList</span>   </div>

        
<div class="viewcode-block" id="HVSRData.plot">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRData.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method to plot data, wrapper of sprit.plot_hvsr()</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        matplotlib.Figure, matplotlib.Axis (if return_fig=True)</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        plot_hvsr</span>
<span class="sd">        plot_azimuth</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;close_figs&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;close_figs&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
        <span class="n">plot_return</span> <span class="o">=</span> <span class="n">plot_hvsr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">plot_return</span></div>


<div class="viewcode-block" id="HVSRData.report">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRData.report">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper of get_report()</span>
<span class="sd">        </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        get_report</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">report_return</span> <span class="o">=</span> <span class="n">get_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">report_return</span></div>

    
<div class="viewcode-block" id="HVSRData.select">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.HVSRData.select">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Wrapper for obspy select method on &#39;stream&#39; attribute of HVSRData object&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;stream&#39;</span><span class="p">):</span>
            <span class="n">stream</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">stream</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">Warn</span><span class="p">(</span><span class="s2">&quot;HVSRData.select() method applied, but &#39;stream&#39; attribute (obspy.Stream object) not found&quot;</span><span class="p">)</span></div>


    <span class="c1"># ATTRIBUTES</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dictionary containing the parameters used to process the data</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary containing the process parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span>

    <span class="nd">@params</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;params must be a dict type, currently passing </span><span class="si">{}</span><span class="s2"> type.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="c1"># batch</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether this HVSRData object is part of an HVSRBatch object. This is used throughout the code to help direct the object into the proper processing pipeline.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if HVSRData object is part of HVSRBatch object, otherwise, False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span>

    <span class="nd">@batch</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;batch must be boolean type&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_batch</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1">#PPSD object from obspy (static)</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ppsds_obspy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The original ppsd information from the obspy.signal.spectral_estimation.PPSD(), so as to keep original if copy is manipulated/changed.&quot;&quot;&quot;</span>        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ppsds_obspy</span>

    <span class="nd">@ppsds_obspy</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ppsds_obspy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks whether the ppsd_obspy is of the proper type before saving as attribute&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">spectral_estimation</span><span class="o">.</span><span class="n">PPSD</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ppsds_obspy must be obspy.PPSD or dict with osbpy.PPSDs&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">obspy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">spectral_estimation</span><span class="o">.</span><span class="n">PPSD</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ppsds_obspy must be obspy.PPSD or dict with osbpy.PPSDs&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ppsds_obspy</span><span class="o">=</span><span class="n">value</span>
                        
    <span class="c1">#PPSD dict, copied from obspy ppsds (dynamic)</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ppsds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dictionary copy of the class object obspy.signal.spectral_estimation.PPSD(). The dictionary copy allows manipulation of the data in PPSD, whereas that data cannot be easily manipulated in the original Obspy object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary copy of the PPSD information from generate_psds()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ppsds</span>

    <span class="nd">@ppsds</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ppsds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ppsds dict with infomration from osbpy.PPSD (created by sprit.generate_psds())&quot;</span><span class="p">)</span>                  
        <span class="bp">self</span><span class="o">.</span><span class="n">_ppsds</span><span class="o">=</span><span class="n">value</span></div>


<span class="c1"># Test guis</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_gui_test</span><span class="p">():</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sprit_tkinter_ui</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">guiFile</span> <span class="o">=</span> <span class="n">sprit_tkinter_ui</span><span class="o">.</span><span class="vm">__file__</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">guiFile</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1"># Launch a gui</span>
<div class="viewcode-block" id="gui">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.gui">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">gui</span><span class="p">(</span><span class="n">kind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;browser&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to open a graphical user interface (gui)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kind : str, optional</span>
<span class="sd">        What type of gui to open: </span>
<span class="sd">        * &quot;browser&quot; or &quot;default&quot; opens browser interface (using streamlit)</span>
<span class="sd">        * &quot;widget&quot; opens jupyter widget (using ipywidgets)</span>
<span class="sd">        * &quot;window&quot; opens windowed gui (using tkinter)</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">browserList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;browser&#39;</span><span class="p">,</span> <span class="s1">&#39;streamlit&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span>
    <span class="n">windowList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;windowed&#39;</span><span class="p">,</span> <span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="s1">&#39;tkinter&#39;</span><span class="p">,</span> <span class="s1">&#39;tk&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">]</span>
    <span class="n">widgetList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;widget&#39;</span><span class="p">,</span> <span class="s1">&#39;jupyter&#39;</span><span class="p">,</span> <span class="s1">&#39;notebook&#39;</span><span class="p">,</span> <span class="s1">&#39;nb&#39;</span><span class="p">]</span>
    <span class="n">liteList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lite&#39;</span><span class="p">,</span> <span class="s1">&#39;light&#39;</span><span class="p">,</span> <span class="s1">&#39;basic&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">browserList</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
        <span class="n">streamlitPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;sprit_streamlit_ui.py&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;streamlit&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">streamlitPath</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()]</span>
        <span class="c1">#subprocess.run(cmd)</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">streamlit.web</span><span class="w"> </span><span class="kn">import</span> <span class="n">cli</span> <span class="k">as</span> <span class="n">stcli</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">streamlit</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>

        <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>

        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">run_streamlit_app</span><span class="p">(</span><span class="n">path_dir</span><span class="p">):</span>
            <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
            <span class="c1"># create a temporary directory</span>
            <span class="n">fpathList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sprit_hvsr.py&#39;</span><span class="p">,</span> <span class="s1">&#39;sprit_tkinter_ui.py&#39;</span><span class="p">,</span> <span class="s1">&#39;sprit_jupyter_ui.py&#39;</span><span class="p">,</span> <span class="s1">&#39;sprit_utils.py&#39;</span><span class="p">,</span> <span class="s1">&#39;sprit_plot.py&#39;</span><span class="p">,</span> <span class="s1">&#39;__init__.py&#39;</span><span class="p">,</span> <span class="s1">&#39;sprit_streamlit_ui.py&#39;</span><span class="p">]</span>
            <span class="n">currDir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">fpath</span> <span class="ow">in</span> <span class="n">fpathList</span><span class="p">:</span>
                <span class="n">temp_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fpath</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">currDir</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">fpath</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cf</span><span class="p">:</span>
                    <span class="n">scriptText</span> <span class="o">=</span> <span class="n">cf</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c1"># write the streamlit app code to a Python script in the temporary directory</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">temp_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">scriptText</span><span class="p">)</span>
            
            <span class="c1"># execute the streamlit app</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># execute the streamlit app</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="p">[</span><span class="s1">&#39;streamlit&#39;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">,</span> <span class="n">temp_file_path</span><span class="p">],</span>
                    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span>
                    <span class="p">)</span>
                
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="c1"># clean up the temporary directory when done</span>
            <span class="n">temp_dir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>
        
        <span class="c1">#with open(streamlitPath.parent.as_posix(), &#39;r&#39;) as file:</span>
        <span class="c1">#    appText = file.read()</span>

        <span class="n">run_streamlit_app</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>

        <span class="c1">#streamlit.web.bootstrap.run(streamlitPath.as_posix(), &#39;&#39;, [], [])</span>
        <span class="c1">#process = subprocess.Popen([&quot;streamlit&quot;, &quot;run&quot;, os.path.join(</span>
        <span class="c1">#            &#39;application&#39;, &#39;main&#39;, &#39;services&#39;, &#39;streamlit_app.py&#39;)])             </span>
    <span class="k">elif</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">windowList</span><span class="p">:</span>
        <span class="c1">#guiPath = pathlib.Path(os.path.realpath(__file__))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sprit.sprit_tkinter_ui</span><span class="w"> </span><span class="kn">import</span> <span class="n">SPRIT_App</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sprit.sprit_tkinter_ui</span><span class="w"> </span><span class="kn">import</span> <span class="n">SPRIT_App</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">tkinter</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">tk</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;linux&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;The SpRIT graphical interface uses tkinter, which ships with python but is not pre-installed on linux machines. Use &quot;apt-get install python-tk&quot; or &quot;apt-get install python3-tk&quot; to install tkinter. You may need to use the sudo command at the start of those commands.&#39;</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">on_gui_closing</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            <span class="n">gui_root</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
            <span class="n">gui_root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;linux&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;/usr/share/doc/python3-tk&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;The SpRIT graphical interface uses tkinter, which ships with python but is not pre-installed on linux machines. Use &quot;apt-get install python-tk&quot; or &quot;apt-get install python3-tk&quot; to install tkinter. You may need to use the sudo command at the start of those commands.&#39;</span><span class="p">)</span>

        <span class="n">gui_root</span> <span class="o">=</span> <span class="n">tk</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">icon_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s1">&#39;sprit&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;icon&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;sprit_icon_alpha.ico&#39;</span><span class="p">)</span> 
                <span class="n">gui_root</span><span class="o">.</span><span class="n">iconbitmap</span><span class="p">(</span><span class="n">icon_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">icon_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s1">&#39;sprit&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;icon&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;sprit_icon.png&#39;</span><span class="p">)</span> 
                <span class="n">gui_root</span><span class="o">.</span><span class="n">iconphoto</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">tk</span><span class="o">.</span><span class="n">PhotoImage</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">icon_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ICON NOT LOADED, still opening GUI&quot;</span><span class="p">)</span>

        <span class="n">gui_root</span><span class="o">.</span><span class="n">resizable</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">spritApp</span> <span class="o">=</span> <span class="n">SPRIT_App</span><span class="p">(</span><span class="n">master</span><span class="o">=</span><span class="n">gui_root</span><span class="p">)</span>  <span class="c1"># Open the app with a tk.Tk root</span>

        <span class="n">gui_root</span><span class="o">.</span><span class="n">protocol</span><span class="p">(</span><span class="s2">&quot;WM_DELETE_WINDOW&quot;</span><span class="p">,</span> <span class="n">on_gui_closing</span><span class="p">)</span>    
        <span class="n">gui_root</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>  <span class="c1"># Run the main loop</span>
    <span class="k">elif</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">widgetList</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sprit_jupyter_UI</span><span class="o">.</span><span class="n">create_jupyter_ui</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">):</span>
                <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">errMsg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">e</span>
            
    <span class="k">elif</span> <span class="n">kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">liteList</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lite GUI is not currently supported&quot;</span><span class="p">)</span></div>


<span class="c1"># FUNCTIONS AND METHODS</span>
<span class="c1"># The run function to rule them all (runs all needed for simply processing HVSR)</span>
<div class="viewcode-block" id="run">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.run">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="n">input_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">azimuth_calculation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">noise_removal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outlier_curves_removal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The sprit.run() is the main function that allows you to do all your HVSR processing in one simple step (sprit.run() is how you would call it in your code, but it may also be called using sprit.sprit_hvsr.run())</span>
<span class="sd">    </span>
<span class="sd">    The input_data parameter of sprit.run() is the only required parameter (if nothing entered, it will run sample data). This can be either a single file, a list of files (one for each component, for example), a directory (in which case, all obspy-readable files will be added to an HVSRBatch instance), a Rasp. Shake raw data directory, or sample data.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The sprit.run() function calls the following functions. This is the recommended order/set of functions to run to process HVSR using SpRIT. See the API documentation for these functions for more information:</span>
<span class="sd">    - input_params(): The input_data parameter of input_params() is the only required variable, though others may also need to be called for your data to process correctly.</span>
<span class="sd">    - fetch_data(): the source parameter of fetch_data() is the only explicit variable in the sprit.run() function aside from input_data and verbose. Everything else gets delivered to the correct function via the kwargs dictionary</span>
<span class="sd">    - remove_noise(): by default, the kind of noise removal is remove_method=&#39;auto&#39;. See the remove_noise() documentation for more information. If remove_method is set to anything other than one of the explicit options in remove_noise, noise removal will not be carried out.</span>
<span class="sd">    - calculate_azimuth(): calculate one or several azimuths. Single azimuth can be a way to combine H components too.</span>
<span class="sd">    - generate_psds(): generates ppsds for each component, which will be combined/used later. Any parameter of obspy.signal.spectral_estimation.PPSD() may also be read into this function.</span>
<span class="sd">    - remove_outlier_curves(): removes any outlier ppsd curves so that the data quality for when curves are combined will be enhanced. See the remove_outlier_curves() documentation for more information.</span>
<span class="sd">    - process_hvsr(): this is the main function processing the hvsr curve and statistics. See process_hvsr() documentation for more details. The hvsr_band parameter sets the frequency spectrum over which these calculations occur.</span>
<span class="sd">    - check_peaks(): this is the main function that will find and &#39;score&#39; peaks to get a best peak. The parameter peak_freq_range can be set to limit the frequencies within which peaks are checked and scored.</span>
<span class="sd">    - get_report(): this is the main function that will print, plot, and/or save the results of the data. See the get_report() API documentation for more information.</span>
<span class="sd">    - export_hvsr(): this function exports the final data output as a pickle file (by default, this pickle object has a .hvsr extension). This can be used to read data back into SpRIT without having to reprocess data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_data : str or filepath object that can be read by obspy</span>
<span class="sd">        Filepath to data to be processed. This may be a file or directory, depending on what kind of data is being processed (this can be specified with the source parameter). </span>
<span class="sd">        For sample data, The following can be specified as the input_data parameter:</span>
<span class="sd">            - Any integer 1-6 (inclusive), or the string (e.g., input_data=&quot;1&quot; or input_data=1 will work)</span>
<span class="sd">            - The word &quot;sample&quot; before any integer (e.g., input_data=&quot;sample1&quot;)</span>
<span class="sd">            - The word &quot;sample&quot; will default to &quot;sample1&quot; if source=&#39;file&#39;. </span>
<span class="sd">            - If source=&#39;batch&#39;, input_data should be input_data=&#39;sample&#39; or input_data=&#39;batch&#39;. In this case, it will read and process all the sample files using the HVSRBatch class. Set verbose=True to see all the information in the sample batch csv file.</span>
<span class="sd">    source : str, optional</span>
<span class="sd">        _description_, by default &#39;file&#39;</span>
<span class="sd">    azimuth_calculation : bool, optional</span>
<span class="sd">        Whether to perform azimuthal analysis, by default False.</span>
<span class="sd">    noise_removal : bool, default=False</span>
<span class="sd">        Whether to remove noise (before processing PPSDs)</span>
<span class="sd">    outlier_curves_removal : bool, default=False</span>
<span class="sd">        Whether to remove outlier curves from HVSR time windows</span>
<span class="sd">    show_plot : bool, default=True</span>
<span class="sd">        Whether to show plots. This does not affect whether the plots are created (and then inserted as an attribute of HVSRData), only whether they are shown.</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        _description_, by default False</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Keyword arguments for the functions listed above. The keyword arguments are unique, so they will get parsed out and passed into the appropriate function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    hvsr_results : sprit.HVSRData or sprit.HVSRBatch object</span>
<span class="sd">        If a single file/data point is being processed, a HVSRData object will be returned. Otherwise, it will be a HVSRBatch object. See their documention for more information.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    input_params</span>
<span class="sd">    fetch_data</span>
<span class="sd">    remove_noise</span>
<span class="sd">    calculate_azimuth</span>
<span class="sd">    generate_psds</span>
<span class="sd">    remove_outlier_curves</span>
<span class="sd">    process_hvsr</span>
<span class="sd">    check_peaks</span>
<span class="sd">    get_report</span>
<span class="sd">    export_hvsr</span>
<span class="sd">        </span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If the input parameter may not be read correctly. This is raised if the input_params() function fails. This raises an error since no other data processing or reading steps will be able to carried out correctly.</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If the data is not read/fetched correctly using fetch_data(), an error will be raised. This is raised if the fetch_data() function fails. This raises an error since no other data processing steps will be able to carried out correctly.</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        If the data being processed is a single file, an error will be raised if generate_psds() does not work correctly. No errors are raised for remove_noise() errors (since that is an optional step) and the process_hvsr() step (since that is the last processing step) .</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">input_data</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">input_data</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;********************* PROCESSING SAMPLE DATA *****************************************&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;To read in your own data, use sprit.run(input_data=&#39;/path/to/your/seismic/data.mseed&#39;)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;See SpRIT Wiki or API documentation for more information:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Wiki: https://github.com/RJbalikian/SPRIT-HVSR/wiki&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> API Documentation: https://sprit.readthedocs.io/en/latest/#&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;**************************************************************************************&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        <span class="n">input_data</span> <span class="o">=</span> <span class="s1">&#39;sample&#39;</span>
    
    <span class="n">orig_args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Get the initial arguments</span>
    <span class="k">global</span> <span class="n">do_run</span>
    <span class="n">do_run</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Using sprit.run() with the following parameters:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">input_data = </span><span class="si">{</span><span class="n">input_data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">azimuth_calculation = </span><span class="si">{</span><span class="n">azimuth_calculation</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">noise_removal = </span><span class="si">{</span><span class="n">noise_removal</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">outlier_curves_removal = </span><span class="si">{</span><span class="n">outlier_curves_removal</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">With the following kwargs: &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="p">{}:</span>
            <span class="nb">print</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{None}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="s1">&#39;hvsr_band&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
    <span class="k">if</span> <span class="s1">&#39;peak_freq_range&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;peak_freq_range&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;peak_freq_range&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Separate out input_params and fetch_data processes based on whether batch has been specified</span>
    <span class="n">batchlist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">,</span> <span class="s1">&#39;bach&#39;</span><span class="p">,</span> <span class="s1">&#39;bath&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">batchlist</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;input_data&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SAMPLE_LIST</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">batch_data_read_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">batch_data_read</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
            <span class="n">hvsrDataIN</span> <span class="o">=</span> <span class="n">batch_data_read</span><span class="p">(</span><span class="n">batch_data</span><span class="o">=</span><span class="n">input_data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">batch_data_read_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Batch data read in was not successful:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Get the input parameters</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">input_params_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">input_params</span><span class="p">(</span><span class="n">input_data</span><span class="o">=</span><span class="n">input_data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">input_params_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">):</span>
                <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR during input_params(): </span><span class="si">{</span><span class="n">errMsg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>        
            <span class="c1"># Even if batch, this is reading in data for all sites so we want to raise error, not just warn</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Input parameters not read correctly, see sprit.input_params() function and parameters&#39;</span><span class="p">)</span>
            <span class="c1"># If input_params fails, initialize params as an HVSRDATA</span>
            <span class="c1">#params = {&#39;processing_status&#39;:{&#39;input_params_status&#39;:False, &#39;overall_status&#39;:False}}</span>
            <span class="c1">#params.update(input_params_kwargs)</span>
            <span class="c1">#params = sprit_utils._make_it_classy(params)</span>

        <span class="c1"># Fetch Data</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fetch_data_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fetch_data</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
            <span class="k">if</span> <span class="s1">&#39;obspy_ppsds&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">fetch_data_kwargs</span><span class="p">[</span><span class="s1">&#39;obspy_ppsds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;obspy_ppsds&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fetch_data_kwargs</span><span class="p">[</span><span class="s1">&#39;obspy_ppsds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">hvsrDataIN</span> <span class="o">=</span> <span class="n">fetch_data</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">fetch_data_kwargs</span><span class="p">)</span>    
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Even if batch, this is reading in data for all sites so we want to raise error, not just warn</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">):</span>
                <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR during fetch_data(): </span><span class="si">{</span><span class="n">errMsg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Data not read correctly, see sprit.fetch_data() function and parameters for more details.&#39;</span><span class="p">)</span>
    
    <span class="c1"># BREAK OUT FOR BATCH PROCESSING</span>
    <span class="n">run_kwargs_for_df</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsrDataIN</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        
        <span class="c1"># Create dictionary that will be used to create HVSRBatch object</span>
        <span class="n">hvsrBatchDict</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Loop through each site and run sprit.run() for each HVSRData object</span>
        <span class="k">for</span> <span class="n">site_name</span><span class="p">,</span> <span class="n">site_data</span> <span class="ow">in</span> <span class="n">hvsrDataIN</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">run_kwargs</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1">#orig_args.copy()  # Make a copy so we don&#39;t accidentally overwrite</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">**PROCESSING DATA FOR SITE </span><span class="si">{</span><span class="n">site_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1">**</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">run_kwargs</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_data</span>
            
            <span class="c1"># Update run kwargs       </span>
            <span class="c1"># First, get processing_parameters per site</span>
            <span class="k">for</span> <span class="n">funname</span><span class="p">,</span> <span class="n">fundict</span> <span class="ow">in</span> <span class="n">site_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">funk</span><span class="p">,</span> <span class="n">funv</span> <span class="ow">in</span> <span class="n">fundict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">run_kwargs</span><span class="p">[</span><span class="n">funk</span><span class="p">]</span> <span class="o">=</span> <span class="n">funv</span>
                                                
            <span class="c1"># Overwrite per-site processing parameters with params passed  to sprit.run() as kwargs</span>
            <span class="k">for</span> <span class="n">paramname</span><span class="p">,</span> <span class="n">paramval</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">paramname</span> <span class="o">!=</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span>  <span class="c1"># Don&#39;t update source for batch data</span>
                    <span class="n">run_kwargs</span><span class="p">[</span><span class="n">paramname</span><span class="p">]</span> <span class="o">=</span> <span class="n">paramval</span>

            <span class="n">dont_update_these_args</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;kwargs&#39;</span><span class="p">]</span>

            <span class="c1"># Overwrite per-site processing parameters with sprit.run()</span>
            <span class="n">run_args</span> <span class="o">=</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">run_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dont_update_these_args</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">run</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
                        <span class="n">run_kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                                   
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hvsrBatchDict</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="o">**</span><span class="n">run_kwargs</span><span class="p">)</span>
                <span class="n">run_kwargs_for_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run_kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">hvsrBatchDict</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">site_data</span>
                <span class="n">hvsrBatchDict</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;Error_Message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_get_error_from_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span>
                                                                                                  <span class="n">print_error_message</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                                                                  <span class="n">return_error_message</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_get_error_from_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing site </span><span class="si">{</span><span class="n">site_name</span><span class="si">}</span><span class="s2">. Continuing processing of remaining sites.&quot;</span><span class="p">)</span>
                
                <span class="n">hvsrBatchDict</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;generate_psds_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">hvsrBatchDict</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>         
        
        <span class="c1"># Create batch object</span>
        <span class="n">hvsrBatchData</span> <span class="o">=</span> <span class="n">HVSRBatch</span><span class="p">(</span><span class="n">hvsrBatchDict</span><span class="p">,</span> <span class="n">df_as_read</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">run_kwargs_for_df</span><span class="p">))</span>
        
        <span class="c1"># Use batch object to get Output Table with all data, including results and inputs</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsrBatchData</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsrBatchData</span><span class="p">[</span><span class="n">site</span><span class="p">],</span> <span class="s1">&#39;Table_Report&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">table_reports</span> <span class="o">=</span> <span class="n">hvsrBatchData</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">.</span><span class="n">Table_Report</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">table_reports</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">table_reports</span><span class="p">,</span> <span class="n">hvsrBatchData</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">.</span><span class="n">Table_Report</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">table_reports</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                
        <span class="n">hvsrBatchData</span><span class="p">[</span><span class="s1">&#39;Table_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">hvsrBatchData</span><span class="o">.</span><span class="n">input_df</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">table_reports</span><span class="p">,</span>
                                                 <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span>
                                                 <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;site&#39;</span><span class="p">,</span> <span class="n">right_on</span><span class="o">=</span><span class="s1">&#39;Site Name&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hvsrBatchData</span>

    <span class="c1"># Calculate azimuths</span>
    <span class="n">hvsr_az</span> <span class="o">=</span> <span class="n">hvsrDataIN</span>
    <span class="n">azimuth_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">calculate_azimuth</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
    
    <span class="n">azList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">,</span> <span class="s1">&#39;single azimuth&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">]</span>
    
    <span class="n">azCond1</span> <span class="o">=</span> <span class="s1">&#39;horizontal_method&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;horizontal_method&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="s1">&#39;8&#39;</span>
    <span class="n">azCond2</span> <span class="o">=</span> <span class="s1">&#39;horizontal_method&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;horizontal_method&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">azList</span>
    <span class="n">azCond3</span> <span class="o">=</span> <span class="n">azimuth_calculation</span>
    <span class="n">azCond4</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">azimuth_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">azCond1</span> <span class="ow">or</span> <span class="n">azCond2</span> <span class="ow">or</span> <span class="n">azCond3</span> <span class="ow">or</span> <span class="n">azCond4</span><span class="p">:</span>
        <span class="n">azimuth_calculation</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;azimuth_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;azimuth_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;single&#39;</span>
        
        <span class="k">if</span> <span class="s1">&#39;azimuth_angle&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;azimuth_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;azimuth_angle&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">45</span>
        
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span>  <span class="c1"># str(kwargs[&#39;azimuth_angle&#39;]).zfill(3)</span>
        
        <span class="k">if</span> <span class="s1">&#39;horizontal_method&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;horizontal_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Single Azimuth&#39;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">hvsr_az</span> <span class="o">=</span> <span class="n">calculate_azimuth</span><span class="p">(</span><span class="n">hvsrDataIN</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">azimuth_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">):</span>
                <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during calculate_azimuth() for </span><span class="si">{</span><span class="n">hvsr_az</span><span class="o">.</span><span class="n">site</span><span class="si">}</span><span class="s2">: </span><span class="se">\n</span><span class="si">{</span><span class="n">errMsg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>            

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_az</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">hvsr_az</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">hvsr_az</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;calculate_azimuths_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hvsr_az</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;calculate_azimuths_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">azimuth_calculation</span> <span class="o">=</span> <span class="kc">False</span>
        
     
    <span class="c1"># Remove Noise</span>
    <span class="n">data_noiseRemoved</span> <span class="o">=</span> <span class="n">hvsr_az</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">remove_noise_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">remove_noise</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
        <span class="k">if</span> <span class="n">noise_removal</span> <span class="ow">or</span> <span class="n">remove_noise_kwargs</span> <span class="o">!=</span> <span class="p">{}:</span>
            <span class="n">remove_noise_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">remove_noise</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_noiseRemoved</span> <span class="o">=</span> <span class="n">remove_noise</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">data_noiseRemoved</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">remove_noise_kwargs</span><span class="p">)</span>   
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">):</span>
                    <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span>                    
                
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error with remove_noise for site </span><span class="si">{</span><span class="n">data_noiseRemoved</span><span class="o">.</span><span class="n">site</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">errMsg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
                <span class="c1"># Mark that remove_noise failed</span>
                <span class="c1"># Reformat data so HVSRData and HVSRBatch data both work here</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_noiseRemoved</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">):</span>
                    <span class="n">data_noiseRemoved</span> <span class="o">=</span> <span class="p">{</span><span class="n">data_noiseRemoved</span><span class="o">.</span><span class="n">site</span><span class="p">:</span> <span class="n">data_noiseRemoved</span><span class="p">}</span>
                    <span class="n">data_noiseRemoved</span> <span class="o">=</span> <span class="p">{</span><span class="n">data_noiseRemoved</span><span class="o">.</span><span class="n">site</span><span class="p">:</span> <span class="n">data_noiseRemoved</span><span class="p">}</span>
                    
                <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">data_noiseRemoved</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">data_noiseRemoved</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;remove_noise_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># Since noise removal is not required for data processing, check others first</span>
                    <span class="k">if</span> <span class="n">data_noiseRemoved</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]:</span>
                        <span class="n">data_noiseRemoved</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">data_noiseRemoved</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># If it wasn&#39;t originally HVSRBatch, make it HVSRData object again</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">data_noiseRemoved</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;batch&#39;</span><span class="p">]:</span>
                        <span class="n">data_noiseRemoved</span> <span class="o">=</span> <span class="n">data_noiseRemoved</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_noiseRemoved</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">):</span>
                <span class="n">data_noiseRemoved</span> <span class="o">=</span> <span class="p">{</span><span class="n">data_noiseRemoved</span><span class="o">.</span><span class="n">site</span><span class="p">:</span> <span class="n">data_noiseRemoved</span><span class="p">}</span>
                
            <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">data_noiseRemoved</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># This should work more or less the same for batch and regular data now</span>
                <span class="n">data_noiseRemoved</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;stream_edited&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_noiseRemoved</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>
                
                <span class="n">data_noiseRemoved</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;remove_noise_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        
                <span class="c1"># If it wasn&#39;t originally HVSRBatch, make it HVSRData object again</span>
                <span class="c1">#if not data_noiseRemoved[site_name][&#39;batch&#39;]:</span>
                <span class="n">data_noiseRemoved</span> <span class="o">=</span> <span class="n">data_noiseRemoved</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span> <span class="ow">or</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;raw&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">):</span>
                <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;batch&#39;</span> <span class="ow">in</span> <span class="n">data_noiseRemoved</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">data_noiseRemoved</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;generate_psds() error: </span><span class="si">{</span><span class="n">errMsg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># Generate PPSDs</span>
    <span class="n">psd_data</span> <span class="o">=</span> <span class="n">data_noiseRemoved</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">generate_psds_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">generate_psds</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
        <span class="n">PPSDkwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">PPSD</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
        <span class="n">generate_psds_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">PPSDkwargs</span><span class="p">)</span>
        <span class="n">generate_psds_kwargs</span><span class="p">[</span><span class="s1">&#39;azimuthal_psds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">azimuth_calculation</span>
        <span class="n">psd_data</span> <span class="o">=</span> <span class="n">generate_psds</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">psd_data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">generate_psds_kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">):</span>
            <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">errMsg</span> <span class="o">=</span> <span class="n">e</span>
        
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during generate_psds() for </span><span class="si">{</span><span class="n">site_name</span><span class="si">}</span><span class="s2">: </span><span class="se">\n</span><span class="si">{</span><span class="n">errMsg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span> <span class="ow">or</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;raw&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;generate_psds() error: </span><span class="si">{</span><span class="n">errMsg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Reformat data so HVSRData and HVSRBatch data both work here</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">psd_data</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">):</span>
            <span class="n">psd_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">psd_data</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]:</span> <span class="n">psd_data</span><span class="p">}</span>
            
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">psd_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># This should work more or less the same for batch and regular data now</span>
            <span class="n">psd_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;generate_psds_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">psd_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    
            <span class="c1">#If it wasn&#39;t originally HVSRBatch, make it HVSRData object again</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">psd_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;batch&#39;</span><span class="p">]:</span>
                <span class="n">psd_data</span> <span class="o">=</span> <span class="n">psd_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span>

    <span class="c1"># Remove Outlier PSD Curves</span>
    <span class="n">data_curvesRemoved</span> <span class="o">=</span> <span class="n">psd_data</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">remove_outlier_curve_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">remove_outlier_curves</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
        <span class="k">if</span> <span class="s1">&#39;use_hv_curves&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">remove_outlier_curve_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">use_hv_curves</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_hv_curves</span> <span class="o">=</span> <span class="n">remove_outlier_curve_kwargs</span><span class="p">[</span><span class="s1">&#39;use_hv_curves&#39;</span><span class="p">]</span>
        <span class="c1"># Check whether it is indicated to remove outlier curves</span>
        <span class="n">outlier_curve_keys_used</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">remove_outlier_curve_kwargs</span> <span class="o">==</span> <span class="p">{}</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="n">remove_outlier_curve_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;show_plot&#39;</span><span class="p">]:</span>
            <span class="n">outlier_curve_keys_used</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">outlier_curves_removal</span> <span class="ow">or</span> <span class="n">outlier_curve_keys_used</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">use_hv_curves</span><span class="p">:</span>
            <span class="n">remove_outlier_curve_kwargs</span><span class="p">[</span><span class="s1">&#39;remove_outliers_during_plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">data_curvesRemoved</span> <span class="o">=</span> <span class="n">remove_outlier_curves</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">data_curvesRemoved</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span><span class="o">**</span><span class="n">remove_outlier_curve_kwargs</span><span class="p">)</span>   
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_obj</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_frame</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_lineno</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span>
        <span class="n">errLineNo</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
        <span class="n">error_category</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Error&#39;</span><span class="p">)</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">errLineNo</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_category</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">errLineNo</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        
        <span class="c1"># Reformat data so HVSRData and HVSRBatch data both work here</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_curvesRemoved</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">):</span>
            <span class="n">data_curvesRemoved_interim</span> <span class="o">=</span> <span class="p">{</span><span class="n">data_curvesRemoved</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]:</span> <span class="n">data_curvesRemoved</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_curvesRemoved_interim</span> <span class="o">=</span> <span class="n">data_curvesRemoved</span>
        
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">data_curvesRemoved_interim</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># This should work more or less the same for batch and regular data now</span>
            <span class="n">data_curvesRemoved_interim</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;remove_outlier_curves_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1">#data_curvesRemoved_interim[site_name][&#39;processing_status&#39;][&#39;overall_status&#39;] = False</span>
    
            <span class="c1">#If it wasn&#39;t originally HVSRBatch, make it HVSRData object again</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data_curvesRemoved_interim</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;batch&#39;</span><span class="p">]:</span>
                <span class="n">data_curvesRemoved_interim</span> <span class="o">=</span> <span class="n">data_curvesRemoved_interim</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span>
        <span class="n">data_curvesRemoved</span> <span class="o">=</span> <span class="n">data_curvesRemoved_interim</span>
        
    <span class="c1"># Process HVSR Curves</span>
    <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">data_curvesRemoved</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">process_hvsr_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">process_hvsr</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
        
        <span class="k">if</span> <span class="n">azimuth_calculation</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;azimuth_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
                <span class="n">process_hvsr_kwargs</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;azimuth_angle&#39;</span><span class="p">]</span>
        
        <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">process_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">psd_data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">process_hvsr_kwargs</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_get_error_from_exception</span><span class="p">(</span><span class="n">e</span><span class="p">,</span>
                                              <span class="n">print_error_message</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">):</span>
            <span class="n">hvsr_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]:</span> <span class="n">hvsr_results</span><span class="p">}</span>
            
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">hvsr_results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># This should work more or less the same for batch and regular data now</span>
        
            <span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;process_hvsr_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
            <span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="c1"># If it wasn&#39;t originally HVSRBatch, make it HVSRData object again</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;batch&#39;</span><span class="p">]:</span>
                <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span>            

    <span class="c1"># Remove outlier HV Curves</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">remove_outlier_curve_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">remove_outlier_curves</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
        <span class="k">if</span> <span class="s1">&#39;use_hv_curves&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">remove_outlier_curve_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">use_hv_curves</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">use_hv_curves</span> <span class="o">=</span> <span class="n">remove_outlier_curve_kwargs</span><span class="p">[</span><span class="s1">&#39;use_hv_curves&#39;</span><span class="p">]</span>
        <span class="c1"># Check whether it is indicated to remove outlier curves</span>
        <span class="n">outlier_curve_keys_used</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">remove_outlier_curve_kwargs</span> <span class="o">==</span> <span class="p">{}</span> <span class="ow">or</span> <span class="nb">list</span><span class="p">(</span><span class="n">remove_outlier_curve_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;show_plot&#39;</span><span class="p">]:</span>
            <span class="n">outlier_curve_keys_used</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">outlier_curves_removal</span> <span class="ow">or</span> <span class="n">outlier_curve_keys_used</span><span class="p">)</span> <span class="ow">and</span> <span class="n">use_hv_curves</span><span class="p">:</span>
            <span class="n">remove_outlier_curve_kwargs</span><span class="p">[</span><span class="s1">&#39;remove_outliers_during_plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">remove_outlier_curves</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span><span class="o">**</span><span class="n">remove_outlier_curve_kwargs</span><span class="p">)</span>   
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_obj</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_frame</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_lineno</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">f_code</span><span class="o">.</span><span class="n">co_filename</span>
        <span class="n">errLineNo</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
        <span class="n">error_category</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="s1">&#39;Error&#39;</span><span class="p">)</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">errLineNo</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_category</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">errLineNo</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">lineno</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        
        <span class="c1"># Reformat data so HVSRData and HVSRBatch data both work here</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">):</span>
            <span class="n">data_curvesRemoved_interim</span> <span class="o">=</span> <span class="p">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]:</span> <span class="n">hvsr_results</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_curvesRemoved_interim</span> <span class="o">=</span> <span class="n">hvsr_results</span>
        
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">data_curvesRemoved_interim</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># This should work more or less the same for batch and regular data now</span>
            <span class="n">data_curvesRemoved_interim</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;remove_outlier_curves_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1">#data_curvesRemoved_interim[site_name][&#39;processing_status&#39;][&#39;overall_status&#39;] = False</span>
    
            <span class="c1">#If it wasn&#39;t originally HVSRBatch, make it HVSRData object again</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data_curvesRemoved_interim</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;batch&#39;</span><span class="p">]:</span>
                <span class="n">data_curvesRemoved_interim</span> <span class="o">=</span> <span class="n">data_curvesRemoved_interim</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span>
        <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">data_curvesRemoved_interim</span>
        

    <span class="c1"># Final post-processing/reporting</span>
    <span class="c1"># Check peaks</span>
    <span class="n">check_peaks_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">check_peaks</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
    <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">check_peaks</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">check_peaks_kwargs</span><span class="p">)</span>

    <span class="n">get_report_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">get_report</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
    <span class="c1"># Add &#39;az&#39; as a default plot if the following conditions</span>
    <span class="c1"># first check if report_formats is specified, if not, add default value</span>
    <span class="k">if</span> <span class="s1">&#39;report_formats&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">get_report_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">get_report</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
    
    <span class="c1"># Now, check if plot is specified, then if plot_type is specified, then add &#39;az&#39; if stream has azimuths</span>
    <span class="k">if</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]:</span>
        <span class="n">plot_hvsr_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">plot_hvsr</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
        <span class="n">get_report_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plot_hvsr_kwargs</span><span class="p">)</span>
        <span class="n">usingDefault</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;plot_type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">get_report_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">get_report</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">usingDefault</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Check if az is already specified as plot output</span>
        <span class="n">azList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">,</span> <span class="s1">&#39;az&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;radial&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">]</span>
        <span class="n">az_requested</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">azStr</span> <span class="ow">in</span> <span class="n">azList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">azStr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]:</span>
                <span class="n">az_requested</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">):</span>
            <span class="n">hvsr_results_interim</span> <span class="o">=</span> <span class="p">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]:</span> <span class="n">hvsr_results</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hvsr_results_interim</span> <span class="o">=</span> <span class="n">hvsr_results</span>

        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">hvsr_results_interim</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># This should work more or less the same for batch and regular data now</span>
            <span class="c1"># Check if data has azimuth data</span>
            <span class="n">hasAz</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;stream&#39;</span> <span class="ow">in</span> <span class="n">hvsr_results_interim</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">hvsr_results_interim</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">component</span> <span class="o">==</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span>
                        <span class="n">hasAz</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
            
            <span class="c1"># Assuming all sites in batch have az if one does</span>
            <span class="k">if</span> <span class="n">hasAz</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="c1"># If it wasn&#39;t originally HVSRBatch, make it HVSRData object again</span>
            <span class="c1">#if not hvsr_results_interim[site_name][&#39;batch&#39;]:</span>
            <span class="c1">#    hvsr_results_interim = hvsr_results_interim[site_name]            </span>
            
        <span class="c1"># Add azimuth as a requested plot if azimuthal data exists but not requested in plot</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">az_requested</span> <span class="ow">and</span> <span class="n">hasAz</span> <span class="ow">and</span> <span class="n">hvsr_results</span><span class="o">.</span><span class="n">horizontal_method</span> <span class="o">!=</span> <span class="s1">&#39;Single Azimuth&#39;</span><span class="p">:</span>
            <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; az&#39;</span>

    <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">get_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="o">=</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">get_report_kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;report_formats&#39;</span> <span class="ow">in</span> <span class="n">get_report_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">report_formats</span> <span class="o">=</span> <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]):</span>
                    <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    
            <span class="c1"># if report_formats is &#39;print&#39;, we would have already printed it in previous step</span>
            <span class="k">if</span> <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;print&#39;</span> <span class="ow">or</span> <span class="s1">&#39;print&#39;</span> <span class="ow">in</span> <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
                <span class="c1"># We do not need to print another report if already printed to terminal</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We will just change the report_formats kwarg to print, since we already got the originally intended report format above, </span>
                <span class="c1">#   now need to print for verbose output</span>
                <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;print&#39;</span>
                <span class="n">get_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="o">=</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="o">**</span><span class="n">get_report_kwargs</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">or</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]:</span>
                <span class="c1"># We do not need to plot another report if already plotted</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># hvplot_kwargs = {k: v for k, v in kwargs.items() if k in plot_hvsr.__code__.co_varnames}</span>
                <span class="c1"># hvsr_results[&#39;Plot_Report&#39;] = plot_hvsr(hvsr_results, return_fig=True, show_plot=False, close_figs=True)</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
    
    <span class="c1"># Export processed data if hvsr_export_path(as pickle currently, default .hvsr extension)</span>
    <span class="k">if</span> <span class="s1">&#39;hvsr_export_path&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;hvsr_export_path&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;ext&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ext&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;hvsr&#39;</span>
            <span class="n">export_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">hvsr_export_path</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;hvsr_export_path&#39;</span><span class="p">],</span> <span class="n">ext</span><span class="o">=</span><span class="n">ext</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>        
    <span class="k">if</span> <span class="s1">&#39;show_plot&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;show_plot&#39;</span><span class="p">]:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


    <span class="k">return</span> <span class="n">hvsr_results</span></div>



<span class="c1"># Read data as batch</span>
<div class="viewcode-block" id="batch_data_read">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.batch_data_read">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">batch_data_read</span><span class="p">(</span><span class="n">batch_data</span><span class="p">,</span> <span class="n">batch_type</span><span class="o">=</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="n">param_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">batch_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">readcsv_getMeta_fetch_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to read data in data as a batch of multiple data files. </span>
<span class="sd">      This is best used through sprit.fetch_data(*args, source=&#39;batch&#39;, **other_kwargs).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    batch_data : filepath or list</span>
<span class="sd">        Input data information for how to read in data as batch. Can be filepath or list of filepaths/stream objects.</span>
<span class="sd">        If filepath, should point to .csv (or similar that can be read by pandas.read_csv()) with batch data information.</span>
<span class="sd">    batch_type : str, optional</span>
<span class="sd">        Type of batch read, only &#39;table&#39; and &#39;filelist&#39; accepted. </span>
<span class="sd">        If &#39;table&#39;, will read data from a file read in using pandas.read_csv(), by default &#39;table&#39;</span>
<span class="sd">    param_col : None or str, optional</span>
<span class="sd">        Name of parameter column from batch information file. Only used if a batch_type=&#39;table&#39; and single parameter column is used, rather than one column per parameter (for single parameter column, parameters are formatted with = between keys/values and , between item pairs), by default None</span>
<span class="sd">    batch_params : list, dict, or None, default = None</span>
<span class="sd">        Parameters to be used if batch_type=&#39;filelist&#39;. If it is a list, needs to be the same length as batch_data. If it is a dict, will be applied to all files in batch_data and will combined with extra keyword arguments caught by **readcsv_getMeta_fetch_kwargs.</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Whether to print information to terminal during batch read, by default False</span>
<span class="sd">    **readcsv_getMeta_fetch_kwargs</span>
<span class="sd">        Keyword arguments that will be read into pandas.read_csv(), sprit.input_params, sprit.get_metadata(), and/or sprit.fetch_data()</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    hvsrBatch</span>
<span class="sd">        HVSRBatch object with each item representing a different HVSRData object</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IndexError</span>
<span class="sd">        _description_</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Processing batch data from </span><span class="si">{</span><span class="n">batch_type</span><span class="si">}</span><span class="s1">:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Batch data source: </span><span class="si">{</span><span class="n">batch_data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># First figure out which parameters go with which function</span>
    <span class="n">input_params_params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="n">get_metadata_params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">get_metadata</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="n">fetch_data_params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fetch_data</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="n">calculate_azimuth_params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">calculate_azimuth</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="n">remove_noise_params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">remove_noise</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="n">generate_ppsds_params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">generate_psds</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="n">remove_outlier_curves_params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">remove_outlier_curves</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="n">process_hvsr_params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">process_hvsr</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="n">check_peaks_params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">check_peaks</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
    <span class="n">get_report_params</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">get_report</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span>
  
    <span class="n">dict_of_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;input_params&#39;</span><span class="p">:</span> <span class="n">input_params_params</span><span class="p">,</span>
                      <span class="s1">&#39;get_metadata&#39;</span><span class="p">:</span> <span class="n">get_metadata_params</span><span class="p">,</span>
                      <span class="s1">&#39;fetch_data_params&#39;</span><span class="p">:</span> <span class="n">fetch_data_params</span><span class="p">,</span>
                      <span class="s1">&#39;calculate_azimuth_params&#39;</span><span class="p">:</span> <span class="n">calculate_azimuth_params</span><span class="p">,</span>
                      <span class="s1">&#39;remove_noise_params&#39;</span><span class="p">:</span> <span class="n">remove_noise_params</span><span class="p">,</span>
                      <span class="s1">&#39;generate_ppsds_params&#39;</span><span class="p">:</span> <span class="n">generate_ppsds_params</span><span class="p">,</span>
                      <span class="s1">&#39;remove_outlier_curves_params&#39;</span><span class="p">:</span> <span class="n">remove_outlier_curves_params</span><span class="p">,</span>
                      <span class="s1">&#39;process_hvsr_params&#39;</span><span class="p">:</span> <span class="n">process_hvsr_params</span><span class="p">,</span>
                      <span class="s1">&#39;check_peaks_params&#39;</span><span class="p">:</span> <span class="n">check_peaks_params</span><span class="p">,</span>
                      <span class="s1">&#39;get_report_params&#39;</span><span class="p">:</span> <span class="n">get_report_params</span><span class="p">}</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">__get_run_functions</span><span class="p">():</span>
        <span class="c1"># Get a list of all functions (for which paramters are used) in sprit.run()</span>
        <span class="n">run_functions_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_params</span><span class="p">,</span> <span class="n">fetch_data</span><span class="p">,</span> <span class="n">batch_data_read</span><span class="p">,</span>
                            <span class="n">get_metadata</span><span class="p">,</span> <span class="n">calculate_azimuth</span><span class="p">,</span> 
                            <span class="n">remove_noise</span><span class="p">,</span> <span class="n">generate_psds</span><span class="p">,</span> <span class="n">remove_outlier_curves</span><span class="p">,</span> 
                            <span class="n">process_hvsr</span><span class="p">,</span> <span class="n">check_peaks</span><span class="p">,</span> 
                            <span class="n">get_report</span><span class="p">,</span> <span class="n">export_hvsr</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">run_functions_list</span>
    <span class="n">SPRIT_RUN_FUNCTIONS</span> <span class="o">=</span> <span class="n">__get_run_functions</span><span class="p">()</span>
    <span class="c1"># Get default values of all functions in a dict</span>
    <span class="n">default_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fun</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">SPRIT_RUN_FUNCTIONS</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">param_info</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">param_info</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span><span class="p">:</span>
                <span class="n">default_dict</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_info</span><span class="o">.</span><span class="n">default</span>
    
    <span class="k">if</span> <span class="n">batch_type</span> <span class="o">==</span> <span class="s1">&#39;sample&#39;</span> <span class="ow">or</span> <span class="n">batch_data</span> <span class="ow">in</span> <span class="n">sampleFileKeyMap</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">sample_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">batch_type</span> <span class="o">=</span> <span class="s1">&#39;table&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sample_data</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="c1"># Dictionary to store the stream objects</span>
    <span class="n">stream_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">batch_type</span> <span class="o">==</span> <span class="s1">&#39;table&#39;</span><span class="p">:</span>
        <span class="c1"># If this is sample data, we need to create absolute paths to the filepaths</span>
        <span class="k">if</span> <span class="n">sample_data</span><span class="p">:</span>
            <span class="n">dataReadInfoDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">sampleFileKeyMap</span><span class="p">[</span><span class="s1">&#39;sample_batch&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">dataReadInfoDF</span> <span class="o">=</span> <span class="n">batch_data</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c1"># For params input</span>
            <span class="n">dataReadInfoDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Read csv</span>
            <span class="n">read_csv_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()[</span><span class="s1">&#39;readcsv_getMeta_fetch_kwargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
            <span class="n">dataReadInfoDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">batch_data</span><span class="p">,</span> <span class="o">**</span><span class="n">read_csv_kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;input_data&#39;</span> <span class="ow">in</span> <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">filelist</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataReadInfoDF</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">])</span>

        <span class="c1"># Generate site names if they don&#39;t exist already           </span>
        <span class="k">if</span> <span class="s1">&#39;site&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">siterows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">filldigs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># Number of digits in df shape</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">siterows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;HVSRSite_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">filldigs</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">dataReadInfoDF</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">siterows</span>

        <span class="c1"># Print information about batch read, as specified</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> sites found: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">dataReadInfoDF</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">maxLength</span> <span class="o">=</span> <span class="mi">25</span>
            <span class="n">maxColWidth</span> <span class="o">=</span> <span class="mi">12</span>
            <span class="k">if</span> <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxLength</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> Showing information for first </span><span class="si">{</span><span class="n">maxLength</span><span class="si">}</span><span class="s1"> files only:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
            
            <span class="c1"># Print nicely formatted df</span>
            <span class="c1"># Print column names</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)[:</span><span class="n">maxColWidth</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">maxColWidth</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">)</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="c1"># Print separator</span>
            <span class="n">tableLen</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxColWidth</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">tableLen</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>

            <span class="c1">#Print columns/rows</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">maxColWidth</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)[:</span><span class="n">maxColWidth</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;...&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">maxColWidth</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)[:</span><span class="n">maxColWidth</span><span class="p">]</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">maxColWidth</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxLength</span><span class="p">:</span>
                <span class="n">endline</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">...</span><span class="si">{</span><span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">maxLength</span><span class="si">}</span><span class="s1"> more rows in file.</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">endline</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">endline</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fetching the following files:&#39;</span><span class="p">)</span>
            
        <span class="c1"># Get processing parameters, either from column param_col or from individual columns</span>
        <span class="c1"># If param_col, format is string of format: &quot;param_name=param_val, param_name2=param_val2&quot;</span>
        <span class="n">param_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">verboseStatement</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">param_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Not a single parameter column, each col=parameter</span>
            <span class="k">for</span> <span class="n">row_ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">verboseStatement</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fun</span> <span class="ow">in</span> <span class="n">SPRIT_RUN_FUNCTIONS</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                            <span class="n">currParam</span> <span class="o">=</span> <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_ind</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">currParam</span><span class="p">)</span> <span class="ow">or</span> <span class="n">currParam</span> <span class="o">==</span> <span class="s1">&#39;nan&#39;</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">default_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                    <span class="n">param_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>  <span class="c1"># Get default value</span>
                                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">default_dict</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                                            <span class="n">verboseStatement</span><span class="p">[</span><span class="n">row_ind</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">&#39;</span><span class="si">{}</span><span class="s2">&#39; parameter not specified in batch file. Using </span><span class="si">{}</span><span class="s2">=&#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">default_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span>
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">verboseStatement</span><span class="p">[</span><span class="n">row_ind</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">&#39;</span><span class="si">{}</span><span class="s2">&#39; parameter not specified in batch file. Using </span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">default_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">param_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">param_dict</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">row_ind</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span>
                <span class="n">param_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_dict</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not a column in </span><span class="si">{}</span><span class="s1"> (columns are: </span><span class="si">{}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param_col</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">,</span> <span class="n">dataReadInfoDF</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataReadInfoDF</span><span class="p">[</span><span class="n">param_col</span><span class="p">]:</span>
                <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">splitRow</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">splitRow</span><span class="p">:</span>
                    <span class="n">param_dict</span><span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">param_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param_dict</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">batch_type</span> <span class="o">==</span> <span class="s1">&#39;filelist&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_data</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;If batch_type is specified as &#39;filelist&#39; or &#39;list&#39;, batch_data must be list or tuple, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># Update formatting of batch_params for rest of processing</span>
        <span class="k">if</span> <span class="n">batch_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">batch_params</span> <span class="o">=</span> <span class="p">[{}]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)</span>
        
        <span class="c1"># Get batch_parameters</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_params</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_params</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_data</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;If batch_params is list, it must be the same length as batch_data. len(batch_params)=</span><span class="si">{}</span><span class="s1"> != len(batch_data)=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_params</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)))</span>
            <span class="n">param_dict_list</span> <span class="o">=</span> <span class="n">batch_params</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">batch_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">readcsv_getMeta_fetch_kwargs</span><span class="p">)</span>
            <span class="n">param_dict_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)):</span>
                <span class="n">param_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch_params</span><span class="p">)</span>
        
        <span class="c1"># Read and process each MiniSEED file</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_data</span><span class="p">):</span>
            <span class="n">param_dict_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file</span>
    
    <span class="c1"># Get a uniformly formatted input DataFrame</span>
    <span class="n">input_df_uniformatted</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">param_dict_list</span><span class="p">)</span>   
    
    <span class="c1"># Do batch fun of input_params() and fetch_data() (these are skipped in run() if batch mode is used)</span>
    <span class="n">hvsr_batchDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">zfillDigs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_dict_list</span><span class="p">)))</span>  <span class="c1"># Get number of digits of length of param_dict_list</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param_dict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">param_dict_list</span><span class="p">):</span>       
        <span class="c1"># Read the data file into a Stream object</span>
        <span class="n">input_params_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()[</span><span class="s1">&#39;readcsv_getMeta_fetch_kwargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
        <span class="n">input_params_kwargs2</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
        <span class="n">input_params_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">input_params_kwargs2</span><span class="p">)</span>

        <span class="c1"># Run input_params()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ipverboseString</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">input_params: &lt;No parameters specified&gt;, &#39;</span>
            <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">input_params_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ipverboseString</span> <span class="o">=</span> <span class="n">ipverboseString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;No parameters specified&gt;, &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>                    
                <span class="n">ipverboseString</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="n">ipverboseString</span> <span class="o">=</span> <span class="n">ipverboseString</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">ipverboseString</span> <span class="o">=</span> <span class="p">(</span><span class="n">ipverboseString</span><span class="p">[:</span><span class="mi">96</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ipverboseString</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">99</span> <span class="k">else</span> <span class="n">ipverboseString</span>

            <span class="n">params</span> <span class="o">=</span> <span class="n">input_params</span><span class="p">(</span><span class="o">**</span><span class="n">input_params_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">input_params_kwargs</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;input_params_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> 
            <span class="n">verboseStatement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Run fetch_data()</span>
        <span class="n">fetch_data_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">()[</span><span class="s1">&#39;readcsv_getMeta_fetch_kwargs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fetch_data</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
        <span class="n">fetch_data_kwargs2</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fetch_data</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
        <span class="n">fetch_data_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fetch_data_kwargs2</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fdverboseString</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">fetch_data: &lt;No parameters specified&gt;, &#39;</span>
            <span class="k">for</span> <span class="n">arg</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fetch_data_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">fdverboseString</span> <span class="o">=</span> <span class="n">fdverboseString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;No parameters specified&gt;, &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">fdverboseString</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="n">fdverboseString</span> <span class="o">=</span> <span class="n">fdverboseString</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">fdverboseString</span> <span class="o">=</span> <span class="p">(</span><span class="n">fdverboseString</span><span class="p">[:</span><span class="mi">96</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;...&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fdverboseString</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">99</span> <span class="k">else</span> <span class="n">fdverboseString</span>
                
            <span class="n">hvsrData</span> <span class="o">=</span> <span class="n">fetch_data</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">fetch_data_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">hvsrData</span> <span class="o">=</span> <span class="n">params</span>
            <span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;fetch_data_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">verboseStatement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ipverboseString</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fdverboseString</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verboseStatement</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">verboseStatement</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;site&#39;</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">sitename</span> <span class="o">=</span> <span class="n">param_dict</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sitename</span> <span class="o">=</span> <span class="s1">&#39;UNSPECIFIED_SITE&#39;</span>
                
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">sitename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">ipverboseString</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">fdverboseString</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verboseStatement</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">verboseStatement</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;     *</span><span class="si">{</span><span class="n">sitename</span><span class="si">}</span><span class="s2"> not read correctly. Processing will not be carried out.&quot;</span><span class="p">)</span>

        <span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># This may be redundant</span>
        <span class="k">if</span> <span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">default_dict</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]:</span>  <span class="c1"># If site was not designated</span>
            <span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="n">zfillDigs</span><span class="p">))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            
        <span class="c1"># Get processing parameters for other functions in sprit.run() besides input_params and fetch_data</span>
        <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsrData</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">processing_parameters</span> <span class="o">=</span> <span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">processing_parameters</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># &quot;input_params&quot;: input_params_kwargs, &quot;fetch_data&quot;: fetch_data_kwargs}</span>

        <span class="k">for</span> <span class="n">fun</span> <span class="ow">in</span> <span class="n">SPRIT_RUN_FUNCTIONS</span><span class="p">:</span>
            <span class="n">specified_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">}</span>
            <span class="n">processing_parameters</span><span class="p">[</span><span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">specified_params</span>

        <span class="c1"># Assume source is &#39;file&#39; if not specified</span>
        <span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">processing_parameters</span>
        <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;fetch_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;fetch_data&#39;</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;file&#39;</span>
        
        <span class="n">hvsr_batchDict</span><span class="p">[</span><span class="n">hvsrData</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">hvsrData</span>

    <span class="n">hvsrBatch</span> <span class="o">=</span> <span class="n">HVSRBatch</span><span class="p">(</span><span class="n">hvsr_batchDict</span><span class="p">,</span> <span class="n">df_as_read</span><span class="o">=</span><span class="n">input_df_uniformatted</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished reading input data in preparation for batch processing&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hvsrBatch</span></div>



<span class="c1"># Function to generate azimuthal readings from the horizontal components</span>
<div class="viewcode-block" id="calculate_azimuth">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.calculate_azimuth">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_azimuth</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">azimuth_angle</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">azimuth_type</span><span class="o">=</span><span class="s1">&#39;multiple&#39;</span><span class="p">,</span> <span class="n">azimuth_unit</span><span class="o">=</span><span class="s1">&#39;degrees&#39;</span><span class="p">,</span> 
                      <span class="n">show_az_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_azimuth_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to calculate azimuthal horizontal component at specified angle(s). </span>
<span class="sd">       Adds each new horizontal component as a radial component to obspy.Stream object at hvsr_data[&#39;stream&#39;]</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_data : HVSRData</span>
<span class="sd">        Input HVSR data</span>
<span class="sd">    azimuth_angle : int, default=10</span>
<span class="sd">        If `azimuth_type=&#39;multiple&#39;`, this is the angular step (in unit `azimuth_unit`) of each of the azimuthal measurements.</span>
<span class="sd">        If `azimuth_type=&#39;single&#39;` this is the angle (in unit `azimuth_unit`) of the single calculated azimuthal measruement. By default 10.</span>
<span class="sd">    azimuth_type : str, default=&#39;multiple&#39;</span>
<span class="sd">        What type of azimuthal measurement to make, by default &#39;multiple&#39;.</span>
<span class="sd">        If &#39;multiple&#39; (or {&#39;multi&#39;, &#39;mult&#39;, &#39;m&#39;}), will take a measurement at each angular step of azimuth_angle of unit azimuth_unit.</span>
<span class="sd">        If &#39;single&#39; (or {&#39;sing&#39;, &#39;s&#39;}), will take a single azimuthal measurement at angle specified in azimuth_angle.</span>
<span class="sd">    azimuth_unit : str, default=&#39;degrees&#39;</span>
<span class="sd">        Angular unit used to specify `azimuth_angle` parameter. By default &#39;degrees&#39;.</span>
<span class="sd">        If &#39;degrees&#39; (or {&#39;deg&#39;, &#39;d&#39;}), will use degrees.</span>
<span class="sd">        If &#39;radians&#39; (or {&#39;rad&#39;, &#39;r&#39;}), will use radians.</span>
<span class="sd">    show_az_plot : bool, default=False</span>
<span class="sd">        Whether to show azimuthal plot, by default False.</span>
<span class="sd">    verbose : bool, default=False</span>
<span class="sd">        Whether to print terminal output, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    HVSRData</span>
<span class="sd">        Updated HVSRData object specified in hvsr_data with hvsr_data[&#39;stream&#39;] attribute containing additional components (EHR-***),</span>
<span class="sd">        with *** being zero-padded (3 digits) azimuth angle in degrees.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get intput paramaters</span>
    <span class="n">orig_args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="c1"># Update with processing parameters specified previously in input_params, if applicable</span>
    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;calculate_azimuth&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">update_msg</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;calculate_azimuth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">defaultVDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">calculate_azimuth</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> 
                                        <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">calculate_azimuth</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span><span class="p">))</span>
                <span class="c1"># Manual input to function overrides the imported parameter values</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">defaultVDict</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> (previously </span><span class="si">{</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                    <span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                                     
    <span class="n">azimuth_angle</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;azimuth_angle&#39;</span><span class="p">]</span>
    <span class="n">azimuth_unit</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;azimuth_unit&#39;</span><span class="p">]</span>
    <span class="n">show_az_plot</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;show_az_plot&#39;</span><span class="p">]</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Generating azimuthal data (calculate_azimuth())&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Using the following parameters:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;hvsr_data&#39;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

            <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;calculate_azimuth&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">update_msg</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="nb">print</span><span class="p">()</span>
                    <span class="n">update_msg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">The following parameters were updated using the processing_parameters attribute:&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">msg_line</span> <span class="ow">in</span> <span class="n">update_msg</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">msg_line</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="c1"># If running batch, we&#39;ll loop through each site</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#Make a copy so we don&#39;t accidentally overwrite</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="c1">#Get what would normally be the &quot;hvsr_data&quot; variable for each site</span>
            <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                   <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">__azimuth_batch</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span> <span class="c1">#Call another function, that lets us run this function again</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;calculate_azimuths_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;calculate_azimuths_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">hvsr_data</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">HVSRBatch</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">,</span> <span class="n">df_as_read</span><span class="o">=</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">input_df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">)):</span>

        <span class="n">degList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;degrees&#39;</span><span class="p">,</span> <span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;°&#39;</span><span class="p">]</span>
        <span class="n">radList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;radians&#39;</span><span class="p">,</span> <span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">azimuth_unit</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">degList</span><span class="p">:</span>
            <span class="n">az_angle_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">azimuth_angle</span><span class="p">)</span>
            <span class="n">az_angle_deg</span> <span class="o">=</span> <span class="n">azimuth_angle</span>
        <span class="k">elif</span> <span class="n">azimuth_unit</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">radList</span><span class="p">:</span>
            <span class="n">az_angle_rad</span> <span class="o">=</span> <span class="n">azimuth_angle</span>
            <span class="n">az_angle_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">azimuth_angle</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;azimuth_unit=</span><span class="si">{</span><span class="n">azimuth_unit</span><span class="si">}</span><span class="s2"> not supported. Try &#39;degrees&#39; or &#39;radians&#39;. No azimuthal analysis run.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hvsr_data</span>

        <span class="c1"># Limit to 1-180 (and &quot;right&quot; half of compass) (will be reflected on other half if applicable to save computation time)</span>
        <span class="n">conversion_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">will_convert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">az_angle_deg</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">will_convert</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">conversion_message</span> <span class="o">=</span> <span class="n">conversion_message</span> <span class="o">+</span> <span class="s1">&#39;converted to a positive value&#39;</span>
            <span class="k">if</span> <span class="n">az_angle_deg</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">180</span><span class="p">:</span>
                <span class="n">conversion_message</span> <span class="o">=</span> <span class="n">conversion_message</span> <span class="o">+</span> <span class="s1">&#39; between 0 and 180 degrees&#39;</span>

        <span class="k">if</span> <span class="n">az_angle_deg</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
            <span class="n">will_convert</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">conversion_message</span> <span class="o">=</span> <span class="n">conversion_message</span> <span class="o">+</span> <span class="s1">&#39; converted to a value between 0 and 180 degrees&#39;</span>

        <span class="k">if</span> <span class="n">will_convert</span><span class="p">:</span>
            <span class="n">conversion_message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">The azimuth angle specified will be</span><span class="si">{</span><span class="n">conversion_message</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">conversion_message</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;: </span><span class="si">{</span><span class="n">az_angle_deg</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Convert angle to 0-180</span>
        <span class="n">az_angle_deg</span> <span class="o">=</span> <span class="n">az_angle_deg</span> <span class="o">-</span> <span class="p">(</span><span class="mi">180</span> <span class="o">*</span> <span class="p">(</span><span class="n">az_angle_deg</span> <span class="o">//</span> <span class="mi">180</span><span class="p">))</span>
        <span class="n">az_angle_rad</span> <span class="o">=</span> <span class="n">az_angle_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">azimuth_angle</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39; degrees --&gt; </span><span class="si">{</span><span class="n">az_angle_deg</span><span class="si">}</span><span class="s1"> degrees.&#39;</span><span class="p">)</span>

        <span class="n">multAzList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;multiple azimuths&#39;</span><span class="p">,</span> <span class="s1">&#39;multiple&#39;</span><span class="p">,</span> <span class="s1">&#39;multi&#39;</span><span class="p">,</span> <span class="s1">&#39;mult&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">]</span>
        <span class="n">singleAzList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;single azimuth&#39;</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="s1">&#39;sing&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">azimuth_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">multAzList</span><span class="p">:</span>
            <span class="n">azimuth_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">az_angle_rad</span><span class="p">))</span>
            <span class="n">azimuth_list_deg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="n">az_angle_deg</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">azimuth_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">singleAzList</span><span class="p">:</span>
            <span class="n">azimuth_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">az_angle_rad</span><span class="p">]</span>
            <span class="n">azimuth_list_deg</span> <span class="o">=</span> <span class="p">[</span><span class="n">az_angle_deg</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;azimuth_type=</span><span class="si">{</span><span class="n">azimuth_type</span><span class="si">}</span><span class="s2"> not supported. Try &#39;multiple&#39; or &#39;single&#39;. No azimuthal analysis run.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hvsr_data</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="n">zComp</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
            <span class="n">eComp</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
            <span class="n">nComp</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">):</span>
            <span class="n">zComp</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
            <span class="n">eComp</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
            <span class="n">nComp</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>          

        <span class="c1"># Reset stats for original data too</span>
        <span class="n">zComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;azimuth_deg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">eComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;azimuth_deg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">90</span>
        <span class="n">nComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;azimuth_deg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">zComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;azimuth_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">eComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;azimuth_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">nComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;azimuth_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">zComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;000&#39;</span>
        <span class="n">eComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;090&#39;</span>
        <span class="n">nComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;000&#39;</span>

        <span class="n">statsDict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">eComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">statsDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">az_rad</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">azimuth_list</span><span class="p">):</span>
            <span class="n">az_deg</span> <span class="o">=</span> <span class="n">azimuth_list_deg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">statsDict</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">az_deg</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="c1">#Change location name</span>
            <span class="n">statsDict</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;EHR&quot;</span><span class="c1">#-{str(round(az_deg,0)).zfill(3)}&quot; #Change channel name</span>
            <span class="n">statsDict</span><span class="p">[</span><span class="s1">&#39;azimuth_deg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">az_deg</span>
            <span class="n">statsDict</span><span class="p">[</span><span class="s1">&#39;azimuth_rad&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">az_rad</span>

            <span class="n">hasMask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">nComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
                <span class="n">nData</span> <span class="o">=</span> <span class="n">nComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span>
                <span class="n">nMask</span> <span class="o">=</span> <span class="n">nComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span>
                <span class="n">hasMask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nData</span> <span class="o">=</span> <span class="n">nComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="n">nMask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">nData</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">is_masked</span><span class="p">(</span><span class="n">eComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
                <span class="n">eData</span> <span class="o">=</span> <span class="n">eComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data</span>
                <span class="n">eMask</span> <span class="o">=</span> <span class="n">eComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mask</span>
                <span class="n">hasMask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">eData</span> <span class="o">=</span> <span class="n">eComp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="n">eMask</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">eData</span><span class="p">)</span>

            <span class="c1"># From hvsrpy: horizontal = self.ns._amp * math.cos(az_rad) + self.ew._amp*math.sin(az_rad)</span>
            <span class="k">if</span> <span class="kc">True</span> <span class="ow">in</span> <span class="n">hasMask</span><span class="p">:</span>
                <span class="n">radial_comp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nData</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">az_rad</span><span class="p">),</span> <span class="n">eData</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az_angle_rad</span><span class="p">)),</span> <span class="n">mask</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">and_</span><span class="p">,</span> <span class="n">nMask</span><span class="p">,</span> <span class="n">eMask</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">radial_comp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nData</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">az_rad</span><span class="p">),</span> <span class="n">eData</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az_rad</span><span class="p">))</span>

            <span class="n">radial_trace</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">radial_comp_data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">statsDict</span><span class="p">)</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radial_trace</span><span class="p">)</span>
    
    <span class="c1"># Verbose printing</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="n">dataINStr</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dataINStr</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">show_az_plot</span><span class="p">:</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Azimuth_Fig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_azimuth</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_azimuth_kwargs</span><span class="p">)</span>

    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;calculate_azimuths_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_processing_status</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span> <span class="n">func_name</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hvsr_data</span></div>



<span class="c1"># Quality checks, stability tests, clarity tests</span>
<span class="c1"># def check_peaks(hvsr, x, y, index_list, peak, peakm, peakp, hvsr_peaks, stdf, hvsr_log_std, rank, hvsr_band=[0.1, 50], do_rank=False):</span>
<div class="viewcode-block" id="check_peaks">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.check_peaks">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">check_peaks</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">hvsr_band</span><span class="o">=</span><span class="n">DEFAULT_BAND</span><span class="p">,</span> <span class="n">peak_selection</span><span class="o">=</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="n">peak_freq_range</span><span class="o">=</span><span class="n">DEFAULT_BAND</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="s1">&#39;HV&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to run tests on HVSR peaks to find best one and see if it passes SESAME quality checks</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hvsr_data : dict</span>
<span class="sd">            Dictionary containing all the calculated information about the HVSR data (i.e., hvsr_out returned from process_hvsr)</span>
<span class="sd">        hvsr_band : tuple or list, default=[0.1, 50]</span>
<span class="sd">            2-item tuple or list with lower and upper limit of frequencies to analyze</span>
<span class="sd">        peak_selection : str or numeric, default=&#39;max&#39;</span>
<span class="sd">            How to select the &quot;best&quot; peak used in the analysis. For peak_selection=&quot;max&quot; (default value), the highest peak within peak_freq_range is used.</span>
<span class="sd">            For peak_selection=&#39;scored&#39;, an algorithm is used to select the peak based in part on which peak passes the most SESAME criteria.</span>
<span class="sd">            If a numeric value is used (e.g., int or float), this should be a frequency value to manually select as the peak of interest.</span>
<span class="sd">        peak_freq_range : tuple or list, default=[0.1, 50];</span>
<span class="sd">            The frequency range within which to check for peaks. If there is an HVSR curve with multiple peaks, this allows the full range of data to be processed while limiting peak picks to likely range.</span>
<span class="sd">        verbose : bool, default=False</span>
<span class="sd">            Whether to print results and inputs to terminal.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hvsr_data   : HVSRData or HVSRBatch object</span>
<span class="sd">            Object containing previous input data, plus information about peak tests</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orig_args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># Get the initial arguments</span>
    
    <span class="c1"># Update with processing parameters specified previously in input_params, if applicable</span>
    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;check_peaks&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">update_msg</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;check_peaks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">defaultVDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">check_peaks</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> 
                                        <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">check_peaks</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span><span class="p">))</span>
                <span class="c1"># Manual input to function overrides the imported parameter values</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">defaultVDict</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> (previously </span><span class="si">{</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                    <span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    
    <span class="n">hvsr_band</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">]</span>
    <span class="n">peak_selection</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;peak_selection&#39;</span><span class="p">]</span>
    <span class="n">peak_freq_range</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;peak_freq_range&#39;</span><span class="p">]</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>

    <span class="c1">#if (verbose and &#39;input_params&#39; not in hvsr_data.keys()) or (verbose and not hvsr_data[&#39;batch&#39;]):</span>
    <span class="c1">#    if isinstance(hvsr_data, HVSRData) and hvsr_data[&#39;batch&#39;]:</span>
    <span class="c1">#        pass</span>
    <span class="c1">#    else:</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Checking peaks in the H/V Curve (check_peaks())&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Using the following parameters:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;hvsr_data&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;check_peaks&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">update_msg</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">update_msg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">The following parameters were updated using the processing_parameters attribute:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">msg_line</span> <span class="ow">in</span> <span class="n">update_msg</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg_line</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># First, divide up for batch or not</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  Running in batch mode&#39;</span><span class="p">)</span>
        <span class="c1">#If running batch, we&#39;ll loop through each site</span>
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#Make a copy so we don&#39;t accidentally overwrite</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="c1">#Get what would normally be the &quot;params&quot; variable for each site</span>
            <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">__check_peaks_batch</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span> <span class="c1">#Call another function, that lets us run this function again</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">site_name</span><span class="si">}</span><span class="s2">: check_peaks() unsuccessful. Peaks not checked.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">site_name</span><span class="si">}</span><span class="s2">: check_peaks() unsuccessful. Peaks not checked.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
                
        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">HVSRBatch</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">df_as_read</span><span class="o">=</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">input_df</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">HVColIDList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:])</span> <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;HV_Curves&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;Log&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col_name</span><span class="p">]</span>
        <span class="n">HVColIDList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;HV&#39;</span>
        
        <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hvsr_band</span><span class="p">:</span>
                <span class="n">hvsr_band</span> <span class="o">=</span> <span class="n">DEFAULT_BAND</span>
            
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_band</span>

            <span class="n">anyK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;PeakReport&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">HVColIDList</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="n">anyK</span><span class="p">]</span>  <span class="c1"># Consistent for all curves</span>
                <span class="k">if</span> <span class="n">col_id</span> <span class="o">==</span> <span class="s1">&#39;HV&#39;</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">]</span>  <span class="c1"># Calculated based on &quot;Use&quot; column            </span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_az&#39;</span><span class="p">][</span><span class="n">col_id</span><span class="p">]</span>
                
                <span class="n">scorelist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">,</span> <span class="s1">&#39;scored&#39;</span><span class="p">,</span> <span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span>
                <span class="n">maxlist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;maximum&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;highest&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">]</span>
                <span class="c1"># Convert peak_selection to numeric, get index of nearest value as list item for __init_peaks()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">peak_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">peak_selection</span><span class="p">)</span>
                    <span class="n">index_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">peak_val</span><span class="p">))]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># If score method is being used, get index list for __init_peaks()</span>
                    <span class="k">if</span> <span class="n">peak_selection</span> <span class="ow">in</span> <span class="n">scorelist</span><span class="p">:</span>
                        <span class="n">index_list</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_indices&#39;</span><span class="p">][</span><span class="n">col_id</span><span class="p">]</span> <span class="c1">#Calculated based on hvsr_curve</span>
                    <span class="k">else</span><span class="p">:</span><span class="c1"># str(peak_selection).lower() in maxlist:</span>
                        <span class="c1">#Get max index as item in list for __init_peaks()</span>
                        <span class="n">startInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">peak_freq_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                        <span class="n">endInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">peak_freq_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="k">if</span> <span class="n">startInd</span> <span class="o">&gt;</span> <span class="n">endInd</span><span class="p">:</span>
                            <span class="n">holder</span> <span class="o">=</span> <span class="n">startInd</span>
                            <span class="n">startInd</span> <span class="o">=</span> <span class="n">endInd</span>
                            <span class="n">endInd</span> <span class="o">=</span> <span class="n">holder</span>
                        <span class="n">subArrayMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">startInd</span><span class="p">:</span><span class="n">endInd</span><span class="p">])</span>

                        <span class="c1"># If max val is in subarray, this will be the same as the max of curve</span>
                        <span class="c1"># Otherwise, it will be the index of the value that is max within peak_freq_range</span>
                        <span class="n">index_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">subArrayMax</span><span class="o">+</span><span class="n">startInd</span><span class="p">]</span>
                
                <span class="n">hvsrp</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsrp&#39;</span><span class="p">][</span><span class="n">col_id</span><span class="p">]</span>  <span class="c1"># Calculated based on &quot;Use&quot; column</span>
                <span class="n">hvsrm</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsrm&#39;</span><span class="p">][</span><span class="n">col_id</span><span class="p">]</span>  <span class="c1"># Calculated based on &quot;Use&quot; column</span>
                
                <span class="n">hvsrPeaks</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]][</span><span class="s1">&#39;CurvesPeakIndices_&#39;</span><span class="o">+</span><span class="n">col_id</span><span class="p">]</span>
                
                <span class="n">hvsr_log_std</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_log_std&#39;</span><span class="p">][</span><span class="n">col_id</span><span class="p">]</span>
                <span class="n">peak_freq_range</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;peak_freq_range&#39;</span><span class="p">]</span>

                <span class="c1"># Do for hvsr</span>
                <span class="n">peak</span> <span class="o">=</span> <span class="n">__init_peaks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">index_list</span><span class="p">,</span> <span class="n">hvsr_band</span><span class="p">,</span> <span class="n">peak_freq_range</span><span class="p">,</span> <span class="n">_min_peak_amp</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

                <span class="n">peak</span> <span class="o">=</span> <span class="n">__check_curve_reliability</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">col_id</span><span class="p">)</span>
                <span class="n">peak</span> <span class="o">=</span> <span class="n">__check_clarity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">do_rank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Do for hvsrp</span>
                <span class="c1"># Find  the relative extrema of hvsrp (hvsr + 1 standard deviation)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hvsrp</span><span class="p">)):</span>
                    <span class="n">index_p</span> <span class="o">=</span> <span class="n">__find_peaks</span><span class="p">(</span><span class="n">hvsrp</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">index_p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

                <span class="n">peakp</span> <span class="o">=</span> <span class="n">__init_peaks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsrp</span><span class="p">,</span> <span class="n">index_p</span><span class="p">,</span> <span class="n">hvsr_band</span><span class="p">,</span> <span class="n">peak_freq_range</span><span class="p">,</span> <span class="n">_min_peak_amp</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">peakp</span> <span class="o">=</span> <span class="n">__check_clarity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsrp</span><span class="p">,</span> <span class="n">peakp</span><span class="p">,</span> <span class="n">do_rank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Do for hvsrm</span>
                <span class="c1"># Find  the relative extrema of hvsrm (hvsr - 1 standard deviation)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hvsrm</span><span class="p">)):</span>
                    <span class="n">index_m</span> <span class="o">=</span> <span class="n">__find_peaks</span><span class="p">(</span><span class="n">hvsrm</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">index_m</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

                <span class="n">peakm</span> <span class="o">=</span> <span class="n">__init_peaks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsrm</span><span class="p">,</span> <span class="n">index_m</span><span class="p">,</span> <span class="n">hvsr_band</span><span class="p">,</span> <span class="n">peak_freq_range</span><span class="p">,</span> <span class="n">_min_peak_amp</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">peakm</span> <span class="o">=</span> <span class="n">__check_clarity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsrm</span><span class="p">,</span> <span class="n">peakm</span><span class="p">,</span> <span class="n">do_rank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Get standard deviation of time peaks</span>
                <span class="n">stdf</span> <span class="o">=</span> <span class="n">__get_stdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index_list</span><span class="p">,</span> <span class="n">hvsrPeaks</span><span class="p">)</span>
                
                <span class="n">peak</span> <span class="o">=</span> <span class="n">__check_freq_stability</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span> <span class="n">peakm</span><span class="p">,</span> <span class="n">peakp</span><span class="p">)</span>
                <span class="n">peak</span> <span class="o">=</span> <span class="n">__check_stability</span><span class="p">(</span><span class="n">stdf</span><span class="p">,</span> <span class="n">peak</span><span class="p">,</span> <span class="n">hvsr_log_std</span><span class="p">,</span> <span class="n">rank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;PeakReport&#39;</span><span class="p">][</span><span class="n">col_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak</span>

                <span class="c1">#Iterate through peaks and </span>
                <span class="c1">#   Get the BestPeak based on the peak score</span>
                <span class="c1">#   Calculate whether each peak passes enough tests</span>
                <span class="n">curveTests</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;WinLen&#39;</span><span class="p">,</span><span class="s1">&#39;SigCycles&#39;</span><span class="p">,</span> <span class="s1">&#39;LowCurveStD&#39;</span><span class="p">]</span>
                <span class="n">peakTests</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ProminenceLow&#39;</span><span class="p">,</span> <span class="s1">&#39;ProminenceHi&#39;</span><span class="p">,</span> <span class="s1">&#39;AmpClarity&#39;</span><span class="p">,</span> <span class="s1">&#39;FreqStability&#39;</span><span class="p">,</span> <span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">,</span> <span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">]</span>
                <span class="n">bestPeakScore</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;PeakReport&#39;</span><span class="p">][</span><span class="n">col_id</span><span class="p">]:</span>
                    <span class="c1"># Get BestPeak</span>
                    <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bestPeakScore</span><span class="p">:</span>
                        <span class="n">bestPeakScore</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span>
                        <span class="n">bestPeak</span> <span class="o">=</span> <span class="n">p</span>

                    <span class="c1"># Calculate if peak passes criteria</span>
                    <span class="n">cTestsPass</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">pTestsPass</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">testName</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">testName</span> <span class="ow">in</span> <span class="n">curveTests</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="n">testName</span><span class="p">]:</span>
                                <span class="n">cTestsPass</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">elif</span> <span class="n">testName</span> <span class="ow">in</span> <span class="n">peakTests</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="n">testName</span><span class="p">]:</span>
                                <span class="n">pTestsPass</span> <span class="o">+=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">cTestsPass</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">pTestsPass</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;PeakPasses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">p</span><span class="p">[</span><span class="s1">&#39;PeakPasses&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        
                <span class="c1"># Designate BestPeak in output dict</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;PeakReport&#39;</span><span class="p">][</span><span class="n">col_id</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">bestPeak</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No Best Peak identified for </span><span class="si">{</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (azimuth </span><span class="si">{</span><span class="n">col_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

                <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">col_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">bestPeak</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">HVColIDList</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="s1">&#39;BestPeak&#39;</span><span class="p">):</span>
                    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">col_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing Errors: No Best Peak identified for </span><span class="si">{</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (azimuth </span><span class="si">{</span><span class="n">col_id</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hvsr_data</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;check_peaks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">exclude_params_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_params_list</span><span class="p">:</span>  
                <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;check_peaks&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">return</span> <span class="n">hvsr_data</span></div>



<span class="c1"># Function to export data stream to mseed (by default) or other format supported by obspy.write()</span>
<div class="viewcode-block" id="export_data">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.export_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">export_data</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">data_export_path</span><span class="p">,</span> <span class="n">data_export_format</span><span class="o">=</span><span class="s1">&#39;mseed&#39;</span><span class="p">,</span> <span class="n">starttime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tzone</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">export_edited_stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                <span class="n">site</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Export data stream to file. This uses the obspy.Stream.write() method on the hvsr_data[&#39;stream&#39;] object,</span>
<span class="sd">    but the stream can first be trimmed using starttime, endtime, and tzone.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_data : HVSRData, HVSRBatch, obspy.Stream, obspy.Trace</span>
<span class="sd">        Input stream or HVSR object</span>
<span class="sd">    data_export_path : pathlike-object</span>
<span class="sd">        Filepath at which to format data. If directory (recommended), filename will be generated automatically.</span>
<span class="sd">    data_export_format : str, optional</span>
<span class="sd">        Format of data, should be file format supported by obspy.write(), by default &#39;mseed&#39;</span>
<span class="sd">    starttime : str, UTCDateTime, or datetime.datetime, optional</span>
<span class="sd">        Starttime of stream, if trimming is desired, by default None</span>
<span class="sd">    endtime : str, UTCDateTime, or datetime.datetime, optional</span>
<span class="sd">        Endtime of stream, if trimming is desired, by default None</span>
<span class="sd">    tzone : str, zoneinfo.Zoneinfo, optional</span>
<span class="sd">        String readable by zoneinfo.Zoneinfo() or Zoneinfo object, by default None</span>
<span class="sd">    export_edited_stream : bool, optional</span>
<span class="sd">        Whether to export the raw stream (&#39;stream&#39; property; if False) or edited stream (&#39;stream_edited&#39; property; if True) in HVSRData object, by default False.</span>
<span class="sd">    site : str, optional</span>
<span class="sd">        Site name, to be used in filename generation, by default None</span>
<span class="sd">    project : str, optional</span>
<span class="sd">        Project or county name, to be used in filename generation, by default None</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Whether to print information to terminal, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obspy.Stream</span>
<span class="sd">        Stream object exported</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        hvsr_data must be of type HVSRData, HVSRBatch, obspy.Stream, or obspy.Trace</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Extract stream for export</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">:</span>
            <span class="n">export_data</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="n">site</span><span class="p">],</span> <span class="n">data_export_path</span><span class="o">=</span><span class="n">data_export_path</span><span class="p">,</span> <span class="n">data_export_format</span><span class="o">=</span><span class="n">data_export_format</span><span class="p">,</span>
                        <span class="n">starttime</span><span class="o">=</span><span class="n">starttime</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="n">endtime</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">):</span>
            <span class="n">outputStream</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputStream</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">([</span><span class="n">hvsr_data</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Assume data is in hvsr_data</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The sprit.export_data() parameter hvsr_data must be of type HVSRData, HVSRBatch, obspy.Stream, or obspy.Trace, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">export_edited_stream</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="s1">&#39;stream_edited&#39;</span><span class="p">):</span>
            <span class="n">outputStream</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream_edited&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outputStream</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
    <span class="c1"># Get starttime in obspy.UTCDateTime format</span>
    <span class="k">if</span> <span class="n">starttime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">sTimeDT</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_format_time</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">tzone</span><span class="o">=</span><span class="n">tzone</span><span class="p">)</span>
            <span class="n">acqDate</span> <span class="o">=</span> <span class="n">outputStream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">date</span>
            <span class="n">sTimeDT</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">acqDate</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">acqDate</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">acqDate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
            <span class="n">sTimeUTC</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">sTimeDT</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tzone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">starttime</span> <span class="o">=</span> <span class="n">starttime</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">tzone</span><span class="p">)</span>
            <span class="n">sTimeUTC</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">starttime</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sTimeUTC</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sTimeUTC</span> <span class="o">=</span> <span class="n">outputStream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
    
    <span class="c1"># Get endtime in obspy.UTCDateTime format</span>
    <span class="k">if</span> <span class="n">endtime</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">endtime</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">eTimeDT</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_format_time</span><span class="p">(</span><span class="n">endtime</span><span class="p">,</span> <span class="n">tzone</span><span class="o">=</span><span class="n">tzone</span><span class="p">)</span>
            <span class="n">acqDate</span> <span class="o">=</span> <span class="n">outputStream</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">date</span>
            <span class="n">eTimeDT</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">acqDate</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">acqDate</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">acqDate</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
            <span class="n">eTimeUTC</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">eTimeDT</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">endtime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">tzone</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">endtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">tzone</span><span class="p">)</span>
            <span class="n">eTimeUTC</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">endtime</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eTimeUTC</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">endtime</span><span class="p">)</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">eTimeUTC</span> <span class="o">=</span> <span class="n">outputStream</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>

    <span class="c1"># Build filepath</span>
    
    <span class="n">siteName</span> <span class="o">=</span> <span class="n">site</span>
    <span class="k">if</span> <span class="n">site</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">siteName</span> <span class="o">=</span> <span class="s2">&quot;HVSRSite&quot;</span>
    
    <span class="n">projectName</span> <span class="o">=</span> <span class="n">project</span>
    <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">projectName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">projectName</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">projectName</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">projectName</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span>
        <span class="n">projectName</span> <span class="o">+=</span> <span class="s2">&quot;-&quot;</span>

    <span class="n">sDateStr</span> <span class="o">=</span> <span class="n">outputStream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">sTimeStr</span> <span class="o">=</span> <span class="n">outputStream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H%M&quot;</span><span class="p">)</span>
    <span class="n">staStr</span> <span class="o">=</span> <span class="n">outputStream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>
    
    <span class="n">deFormat</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_export_format</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">data_export_format</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;.&#39;</span><span class="p">:</span>
        <span class="n">deFormat</span> <span class="o">=</span> <span class="n">deFormat</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    
    <span class="n">dePath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">data_export_path</span><span class="p">)</span>    
    <span class="n">autoFname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">siteName</span><span class="si">}</span><span class="s2">_Stream_</span><span class="si">{</span><span class="n">projectName</span><span class="si">}{</span><span class="n">sDateStr</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">sTimeStr</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">staStr</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">deFormat</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">dePath</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dePath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">dePath</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">outfPath</span> <span class="o">=</span> <span class="n">dePath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">autoFname</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dePath</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="n">outfPath</span> <span class="o">=</span> <span class="n">dePath</span>
    
    <span class="c1"># Trim stream as needed</span>
    <span class="k">if</span> <span class="n">starttime</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">endtime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">isMasked</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">doTrim</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">outputStream</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">):</span>
                <span class="n">isMasked</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">sTimeUTC</span> <span class="o">&gt;</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="ow">or</span> <span class="n">eTimeUTC</span> <span class="o">&lt;</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">:</span>
                <span class="n">doTrim</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">isMasked</span><span class="p">:</span>
            <span class="n">outputStream</span> <span class="o">=</span> <span class="n">outputStream</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">doTrim</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Trimming data to </span><span class="si">{</span><span class="n">sTimeUTC</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">eTimeUTC</span><span class="si">}</span><span class="se">\n\t\t</span><span class="s2"> Stream starttime: </span><span class="si">{</span><span class="n">outputStream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="si">}</span><span class="se">\n\t\t</span><span class="s2"> Stream endtime: </span><span class="si">{</span><span class="n">outputStream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">outputStream</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">sTimeUTC</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="n">eTimeUTC</span><span class="p">)</span>
        
    <span class="n">outputStream</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Take care of masked arrays for writing purposes</span>
    <span class="k">if</span> <span class="s1">&#39;fill_value&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">outputStream</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">):</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fill_value&#39;</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outputStream</span> <span class="o">=</span> <span class="n">outputStream</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    
    <span class="n">outputStream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">outfPath</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Stream has been written to &#39;</span> <span class="o">+</span> <span class="n">outfPath</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">outputStream</span></div>

    

<span class="c1"># Function to export data to .hvsr file (pickled)</span>
<div class="viewcode-block" id="export_hvsr">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.export_hvsr">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">export_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">hvsr_export_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;hvsr&#39;</span><span class="p">,</span> <span class="n">export_type</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">,</span>
                <span class="n">export_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Export data into pickle format that can be read back in using import_data().</span>
<span class="sd">       Intended so data does not need to be processed each time it needs to be used. </span>
<span class="sd">       By default, first, export_hvsr serializes the HVSRData object(s) using pickle.dumps(). </span>
<span class="sd">       Then, to save space, it writes that to a gzip file.</span>
<span class="sd">       Default extension is .hvsr no matter the format, though this can be set with `ext` parameter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_data : HVSRData or HVSRBatch</span>
<span class="sd">        Data to be exported</span>
<span class="sd">    hvsr_export_path : str or filepath object, default = None</span>
<span class="sd">        String or filepath object to be read by pathlib.Path() and/or a with open(hvsr_export_path, &#39;wb&#39;) statement. If None, defaults to input input_data directory, by default None</span>
<span class="sd">    ext : str, default = &#39;hvsr&#39;</span>
<span class="sd">        Filepath extension to use for data file, by default &#39;hvsr&#39;. </span>
<span class="sd">        This will be the extension no matter the export_type</span>
<span class="sd">    export_type : str, default = &#39;gzip&#39;</span>
<span class="sd">        Export type to use. If `export_type` is &#39;pickle&#39;, will just save to disk using pickle.dump.</span>
<span class="sd">        Otherwise, saves a pickle-serialized object to a gzip file (with a .hvsr extension in both cases, by default).</span>
<span class="sd">    verbose : bool, default=False</span>
<span class="sd">        Whether to print information about export. A confirmation message is printed no matter what.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_hvsr_export</span><span class="p">(</span><span class="n">_hvsr_data</span><span class="o">=</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">_export_path</span><span class="o">=</span><span class="n">hvsr_export_path</span><span class="p">,</span> <span class="n">_ext</span><span class="o">=</span><span class="n">ext</span><span class="p">):</span>
        
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_hvsr_data</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_HVSRData_</span><span class="si">{</span><span class="n">_hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="si">}</span><span class="s2">_pickled.</span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">_export_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">_export_path</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">_export_path</span> <span class="o">=</span> <span class="n">_hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span>
            <span class="n">_export_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">_export_path</span><span class="p">)</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_export_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">_export_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_export_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">_export_path</span> <span class="o">=</span> <span class="n">_export_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>    

        <span class="n">_export_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_export_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">export_type</span> <span class="o">==</span> <span class="s1">&#39;pickle&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">_export_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">_hvsr_data</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">_export_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">_hvsr_data</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;EXPORT COMPLETE&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processed data exported as pickled data to: </span><span class="si">{</span><span class="n">_export_path</span><span class="si">}</span><span class="s2"> [~</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">_export_path</span><span class="p">)</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_size</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="s2"> Mb]&quot;</span><span class="p">)</span>    

    <span class="n">hvData</span> <span class="o">=</span> <span class="n">hvsr_data</span>
    <span class="c1">#hvData = copy.deepcopy(hvsr_data)</span>
    <span class="c1">#if export_plots is False:</span>
    <span class="c1">#    for pk in PLOT_KEYS:</span>
    <span class="c1">#        if hasattr(hvData, pk):</span>
    <span class="c1">#            del hvData[pk]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvData</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sitename</span> <span class="ow">in</span> <span class="n">hvData</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">_hvsr_export</span><span class="p">(</span><span class="n">_hvsr_data</span><span class="o">=</span><span class="n">hvData</span><span class="p">[</span><span class="n">sitename</span><span class="p">],</span> <span class="n">_export_path</span><span class="o">=</span><span class="n">hvsr_export_path</span><span class="p">,</span> <span class="n">_ext</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvData</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">):</span>
        <span class="n">_hvsr_export</span><span class="p">(</span><span class="n">_hvsr_data</span><span class="o">=</span><span class="n">hvData</span><span class="p">,</span> <span class="n">_export_path</span><span class="o">=</span><span class="n">hvsr_export_path</span><span class="p">,</span> <span class="n">_ext</span><span class="o">=</span><span class="n">ext</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error in data export. Data must be either of type sprit.HVSRData or sprit.HVSRBatch&quot;</span><span class="p">)</span>         
    
    <span class="k">return</span></div>



<span class="c1"># Function to export reports to disk in various formats</span>
<div class="viewcode-block" id="export_report">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.export_report">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">export_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">report_export_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">report_export_format</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pdf&#39;</span><span class="p">],</span> <span class="n">azimuth</span><span class="o">=</span><span class="s1">&#39;HV&#39;</span><span class="p">,</span> <span class="n">csv_handling</span><span class="o">=</span><span class="s1">&#39;rename&#39;</span><span class="p">,</span> <span class="n">show_report</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to export reports to disk. Exportable formats for report_export_format include: </span>
<span class="sd">        * &#39;table&#39;: saves a pandas DataFrame as a csv)</span>
<span class="sd">        * &#39;plot&#39;: saves the matplotlib or plotly plot figure (depending on what is designated via plot_engine) as an image (png by default)</span>
<span class="sd">        * &#39;print&#39;: saves the print report as a .txt file</span>
<span class="sd">        * &#39;html&#39;: saves the html report as a .html file</span>
<span class="sd">        * &#39;pdf&#39;: saves the pdf report as a .pdf file</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_results : HVSRData object</span>
<span class="sd">        HVSRData object containing the HVSR data</span>
<span class="sd">    report_export_path : path-like object, optional</span>
<span class="sd">        The path to where the report should be exported. </span>
<span class="sd">        If this is None (default), this is written to the home directory.</span>
<span class="sd">        If this is a True, uses the same directory as the input data, but generates a filename.</span>
<span class="sd">        If this is a directory, generates a filename. </span>
<span class="sd">        If filename is specified and the extension does not match the report type, the extension is adjusted.</span>
<span class="sd">        Otherwise, this is the output file or , by default None</span>
<span class="sd">    csv_handling : {&#39;rename&#39;, &#39;append&#39;, &#39;overwrite&#39;, &#39;keep&#39;}, optional</span>
<span class="sd">        If table is the report type, this can prevent overwriting data, by default &#39;rename&#39;.</span>
<span class="sd">        * &quot;rename&quot; (or &quot;keep&quot;): renames the new file to prevent overwrite, appends a digit to the end of filename</span>
<span class="sd">        * &quot;append&quot;: appends the new data to the existing file</span>
<span class="sd">        * &quot;overwrite&quot;: overwrites the existing file</span>
<span class="sd">    report_export_format : str or list, optional</span>
<span class="sd">        The format (or a list of formats) to export the report, by default [&#39;pdf&#39;].</span>
<span class="sd">    show_report : bool, optional</span>
<span class="sd">        Whether to show the designated reports that were chosen for export, by default True</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Whether to print progress and other information to terminal, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    HVSRData</span>
<span class="sd">        An HVSRData object that is the same as hvsr_results, but with any additionally generated reports.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">report_export_format</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">report_export_format</span> <span class="o">=</span> <span class="p">[</span><span class="n">report_export_format</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">report_export_format</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">report_export_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The export_report(report_export_path) parameter was not specified.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The report will be saved the home directory: </span><span class="si">{</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;table&#39;</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.csv&#39;</span>
        <span class="k">elif</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.png&#39;</span>
        <span class="k">elif</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;print&#39;</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.txt&#39;</span>
        <span class="k">elif</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.html&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;pdf&#39;</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s1">&#39;.pdf&#39;</span>
            
        <span class="n">sitename</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sitename</span><span class="si">}</span><span class="s2">_REPORT_</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;hvsr_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="c1"># Initialize output as file in home directory (if not updated)</span>
        <span class="n">outFile</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">home</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">report_export_path</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">report_export_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Check so we don&#39;t write in sample directory</span>
            <span class="k">if</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;input_data&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">sampleFileKeyMap</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span> <span class="ow">in</span> <span class="n">sampleFileKeyMap</span><span class="o">.</span><span class="n">values</span><span class="p">():</span> <span class="c1">#Just in case current working directory is also sample directory</span>
                    <span class="n">inFile</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span> <span class="c1">#Use the path to user&#39;s home if all else fails</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inFile</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inFile</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;input_data&#39;</span><span class="p">])</span>
                            
            <span class="k">if</span> <span class="n">inFile</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">outFile</span> <span class="o">=</span> <span class="n">inFile</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outFile</span> <span class="o">=</span> <span class="n">inFile</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">report_export_path</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">report_export_path</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">outFile</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">report_export_path</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outFile</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">report_export_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;table&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="s1">&#39;Table_Report&#39;</span><span class="p">):</span>
                <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">_generate_table_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">show_table_report</span><span class="o">=</span><span class="n">show_report</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="n">reportDF</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;Table_Report&#39;</span><span class="p">]</span>

            <span class="c1"># Check if file already exists, and handle as specified in csv_handling</span>
            <span class="k">if</span> <span class="n">outFile</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="n">existFile</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">outFile</span><span class="p">)</span>

                 

                <span class="k">if</span> <span class="n">csv_handling</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;append&#39;</span><span class="p">:</span>
                    <span class="c1"># Append report to existing report as new row</span>
                    <span class="n">reportDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">existFile</span><span class="p">,</span> <span class="n">reportDF</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">csv_handling</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;overwrite&#39;</span><span class="p">:</span>
                    <span class="c1"># Overwrite existing report file</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># csv_handling.lower() in [&#39;keep&#39;, &#39;rename&#39;, or other]:</span>
                    <span class="c1"># Rename new report so as not to modify existing report (default handling)</span>
                    <span class="k">if</span> <span class="n">outFile</span><span class="o">.</span><span class="n">stem</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_&#39;</span> <span class="ow">and</span> <span class="n">outFile</span><span class="o">.</span><span class="n">stem</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">fileDigit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">outFile</span><span class="o">.</span><span class="n">stem</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fileDigit</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">fileDigit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">fileDigit</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">outFile</span> <span class="o">=</span> <span class="n">outFile</span><span class="o">.</span><span class="n">with_stem</span><span class="p">(</span><span class="n">outFile</span><span class="o">.</span><span class="n">stem</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">fileDigit</span><span class="p">)</span>

            <span class="c1"># Export to csv using pandas to_csv method</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Saving table report to: </span><span class="si">{</span><span class="n">outFile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">reportDF</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">outFile</span><span class="p">,</span> <span class="n">index_label</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Table report not exported. </span><span class="se">\n\t</span><span class="s2">Dataframe to be exported as csv has been saved in hvsr_results[&#39;BestPeak&#39;][&#39;Report&#39;][&#39;Table_Report]&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
 
            <span class="k">if</span> <span class="n">show_report</span> <span class="ow">or</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Table Report:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">maxColWidth</span> <span class="o">=</span> <span class="mi">13</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">reportDF</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">maxColWidth</span><span class="p">:</span>
                        <span class="n">colStr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)[:</span><span class="n">maxColWidth</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;...&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">colStr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">colStr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">maxColWidth</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span> <span class="c1">#new line</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reportDF</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxColWidth</span><span class="o">+</span><span class="mi">2</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxColWidth</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span> <span class="c1">#new line</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1">#Small indent at start                    </span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reportDF</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">maxColWidth</span><span class="p">:</span>
                            <span class="n">colStr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)[:</span><span class="n">maxColWidth</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;...&#39;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">colStr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">colStr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">maxColWidth</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="s1">&#39;Plot_Report&#39;</span><span class="p">):</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_hvsr</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Plot_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;Plot_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fig</span>

            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Saving plot to: </span><span class="si">{</span><span class="n">outFile</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scf</span> <span class="o">=</span> <span class="n">fig</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outFile</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;print&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="s2">&quot;Print_Report&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;Print_Report&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">_generate_print_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">show_print_report</span><span class="o">=</span><span class="n">show_report</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>            
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outFile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outF</span><span class="p">:</span>
                <span class="n">outF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;Print_Report&#39;</span><span class="p">])</span>
                <span class="c1"># Could write more details in the future</span>
                <span class="k">if</span> <span class="n">show_report</span> <span class="ow">or</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;Print_Report&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">ref</span> <span class="o">==</span> <span class="s2">&quot;html&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="s2">&quot;HTML_Report&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;HTML_Report&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">_generate_html_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outFile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outF</span><span class="p">:</span>
                <span class="n">outF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;HTML_Report&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">ref</span> <span class="o">==</span> <span class="s2">&quot;pdf&quot;</span><span class="p">:</span>
            <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">_generate_pdf_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">pdf_report_filepath</span><span class="o">=</span><span class="n">report_export_path</span><span class="p">,</span> <span class="n">show_pdf_report</span><span class="o">=</span><span class="n">show_report</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">hvsr_results</span></div>



<span class="c1"># **WORKING ON THIS**</span>
<span class="c1"># Save default instrument and processing settings to json file(s)</span>
<div class="viewcode-block" id="export_settings">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.export_settings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">export_settings</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">export_settings_path</span><span class="o">=</span><span class="s1">&#39;default&#39;</span><span class="p">,</span> <span class="n">export_settings_type</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">include_location</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Save processing settings to json file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    export_settings_path : str, default=&quot;default&quot;</span>
<span class="sd">        Where to save the json file(s) containing the settings, by default &#39;default&#39;. </span>
<span class="sd">        If &quot;default,&quot; will save to sprit package resources. Otherwise, set a filepath location you would like for it to be saved to.</span>
<span class="sd">        If &#39;all&#39; is selected, a directory should be supplied. </span>
<span class="sd">        Otherwise, it will save in the directory of the provided file, if it exists. Otherwise, defaults to the home directory.</span>
<span class="sd">    export_settings_type : str, {&#39;all&#39;, &#39;instrument&#39;, &#39;processing&#39;}</span>
<span class="sd">        What kind of settings to save. </span>
<span class="sd">        If &#39;all&#39;, saves all possible types in their respective json files.</span>
<span class="sd">        If &#39;instrument&#39;, save the instrument settings to their respective file.</span>
<span class="sd">        If &#39;processing&#39;, saves the processing settings to their respective file. By default &#39;all&#39;</span>
<span class="sd">    include_location : bool, default=False, input CRS</span>
<span class="sd">        Whether to include the location parametersin the exported settings document.This includes xcoord, ycoord, elevation, elev_unit, and input_crs</span>
<span class="sd">    verbose : bool, default=True</span>
<span class="sd">        Whether to print outputs and information to the terminal</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fnameDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fnameDict</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;instrument_settings.json&quot;</span>
    <span class="n">fnameDict</span><span class="p">[</span><span class="s1">&#39;processing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;processing_settings.json&quot;</span>

    <span class="k">if</span> <span class="n">export_settings_path</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span> <span class="ow">or</span> <span class="n">export_settings_path</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">settingsPath</span> <span class="o">=</span> <span class="n">RESOURCE_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">export_settings_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">export_settings_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">export_settings_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">export_settings_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The provided value for export_settings_path (</span><span class="si">{</span><span class="n">export_settings_path</span><span class="si">}</span><span class="s1">) does not exist. Saving settings to the home directory: </span><span class="si">{</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">settingsPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">settingsPath</span> <span class="o">=</span> <span class="n">export_settings_path</span><span class="o">.</span><span class="n">parent</span>
        
        <span class="k">if</span> <span class="n">export_settings_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">settingsPath</span> <span class="o">=</span> <span class="n">export_settings_path</span>
        <span class="k">elif</span> <span class="n">export_settings_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">settingsPath</span> <span class="o">=</span> <span class="n">export_settings_path</span><span class="o">.</span><span class="n">parent</span>
            <span class="n">fnameDict</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">export_settings_path</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;_instrumentSettings.json&quot;</span>
            <span class="n">fnameDict</span><span class="p">[</span><span class="s1">&#39;processing&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">export_settings_path</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;_processingSettings.json&quot;</span>

    <span class="c1">#Get final filepaths        </span>
    <span class="n">instSetFPath</span> <span class="o">=</span> <span class="n">settingsPath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">fnameDict</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">])</span>
    <span class="n">procSetFPath</span> <span class="o">=</span> <span class="n">settingsPath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">fnameDict</span><span class="p">[</span><span class="s1">&#39;processing&#39;</span><span class="p">])</span>

    <span class="c1">#Get settings values</span>
    <span class="n">instKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;instrument&quot;</span><span class="p">,</span> <span class="s2">&quot;net&quot;</span><span class="p">,</span> <span class="s2">&quot;sta&quot;</span><span class="p">,</span> <span class="s2">&quot;loc&quot;</span><span class="p">,</span> <span class="s2">&quot;cha&quot;</span><span class="p">,</span> <span class="s2">&quot;depth&quot;</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="s2">&quot;hvsr_band&quot;</span><span class="p">]</span>
    <span class="n">inst_location_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;xcoord&#39;</span><span class="p">,</span> <span class="s1">&#39;ycoord&#39;</span><span class="p">,</span> <span class="s1">&#39;elevation&#39;</span><span class="p">,</span> <span class="s1">&#39;elev_unit&#39;</span><span class="p">,</span> <span class="s1">&#39;input_crs&#39;</span><span class="p">]</span>
    <span class="n">procFuncs</span> <span class="o">=</span> <span class="p">[</span><span class="n">fetch_data</span><span class="p">,</span> <span class="n">remove_noise</span><span class="p">,</span> <span class="n">generate_psds</span><span class="p">,</span> <span class="n">process_hvsr</span><span class="p">,</span> <span class="n">check_peaks</span><span class="p">,</span> <span class="n">get_report</span><span class="p">]</span>

    <span class="n">instrument_settings_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">processing_settings_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">instKeys</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PurePath</span><span class="p">):</span>
            <span class="c1">#For those that are paths and cannot be serialized</span>
            <span class="n">instrument_settings_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">instrument_settings_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">include_location</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inst_location_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">PurePath</span><span class="p">):</span>
                <span class="c1">#For those that are paths and cannot be serialized</span>
                <span class="n">instrument_settings_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">instrument_settings_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    
    <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">procFuncs</span><span class="p">:</span>
        <span class="n">funcName</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">processing_settings_dict</span><span class="p">[</span><span class="n">funcName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="n">funcName</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="n">funcName</span><span class="p">][</span><span class="n">arg</span><span class="p">],</span> <span class="p">(</span><span class="n">HVSRBatch</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">)):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">processing_settings_dict</span><span class="p">[</span><span class="n">funcName</span><span class="p">][</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="n">funcName</span><span class="p">][</span><span class="n">arg</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exporting Settings&quot;</span><span class="p">)</span>
    <span class="c1">#Save settings files</span>
    <span class="k">if</span> <span class="n">export_settings_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;instrument&#39;</span> <span class="ow">or</span> <span class="n">export_settings_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">instSetFPath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.inst&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">instSetF</span><span class="p">:</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">instrument_settings_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1">#Format output for readability</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[ &#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  ]&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
                <span class="c1">#Export</span>
                <span class="n">instSetF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jsonString</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">instSetFPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">instSetFPath</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">instSetFPath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.inst&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">instSetF</span><span class="p">:</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">instrument_settings_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1">#Format output for readability</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[ &#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  ]&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
                <span class="c1">#Export</span>
                <span class="n">instSetF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jsonString</span><span class="p">)</span>
                            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Instrument settings exported to </span><span class="si">{</span><span class="n">instSetFPath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jsonString</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">export_settings_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;processing&#39;</span> <span class="ow">or</span> <span class="n">export_settings_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">procSetFPath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.proc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">procSetF</span><span class="p">:</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">processing_settings_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1">#Format output for readability</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[ &#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  ]&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  },&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n\t\t</span><span class="s1">},</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{ &quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\t\t</span><span class="s1">{</span><span class="se">\n\t\t</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, &quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;,</span><span class="se">\n\t\t</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  }&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\t\t</span><span class="s1">}&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;: {&#39;</span><span class="p">,</span> <span class="s1">&#39;:</span><span class="se">\n\t\t\t</span><span class="s1">{&#39;</span><span class="p">)</span>
                
                <span class="c1">#Export</span>
                <span class="n">procSetF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jsonString</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">procSetFPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">procSetFPath</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">procSetFPath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.proc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">procSetF</span><span class="p">:</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">processing_settings_dict</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1">#Format output for readability</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;[ &#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  ]&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  },&#39;</span><span class="p">,</span><span class="s1">&#39;</span><span class="se">\n\t\t</span><span class="s1">},</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{ &quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\t\t</span><span class="s1">{</span><span class="se">\n\t\t</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;, &quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;,</span><span class="se">\n\t\t</span><span class="s1">&quot;&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  }&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n\t\t</span><span class="s1">}&#39;</span><span class="p">)</span>
                <span class="n">jsonString</span> <span class="o">=</span> <span class="n">jsonString</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;: {&#39;</span><span class="p">,</span> <span class="s1">&#39;:</span><span class="se">\n\t\t\t</span><span class="s1">{&#39;</span><span class="p">)</span>
                
                <span class="c1">#Export</span>
                <span class="n">procSetF</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">jsonString</span><span class="p">)</span>            
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing settings exported to </span><span class="si">{</span><span class="n">procSetFPath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">jsonString</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span></div>



<span class="c1"># Reads in traces to obspy stream</span>
<div class="viewcode-block" id="fetch_data">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.fetch_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">fetch_data</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="n">data_export_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_export_format</span><span class="o">=</span><span class="s1">&#39;mseed&#39;</span><span class="p">,</span> 
               <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;spline&#39;</span><span class="p">,</span> <span class="n">detrend_options</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">filter_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">filter_options</span><span class="o">=</span><span class="p">{},</span>
               <span class="n">update_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
               <span class="n">plot_input_stream</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_engine</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
               <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fetch ambient seismic data from a source to read into obspy stream. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params  : dict</span>
<span class="sd">        Dictionary containing all the necessary params to get data.</span>
<span class="sd">            Parameters defined using input_params() function.</span>
<span class="sd">    source  : str, {&#39;raw&#39;, &#39;dir&#39;, &#39;file&#39;, &#39;batch&#39;}</span>
<span class="sd">        String indicating where/how data file was created. For example, if raw data, will need to find correct channels.</span>
<span class="sd">            &#39;raw&#39; finds raspberry shake data, from raw output copied using scp directly from Raspberry Shake, either in folder or subfolders; </span>
<span class="sd">            &#39;dir&#39; is used if the day&#39;s 3 component files (currently Raspberry Shake supported only) are all 3 contained in a directory by themselves.</span>
<span class="sd">            &#39;file&#39; is used if the params[&#39;input_data&#39;] specified in input_params() is the direct filepath to a single file to be read directly into an obspy stream.</span>
<span class="sd">            &#39;batch&#39; is used to read a list or specified set of seismic files. </span>
<span class="sd">                Most commonly, a csv file can be read in with all the parameters. Each row in the csv is a separate file. Columns can be arranged by parameter.</span>
<span class="sd">    data_export_path : None or str or pathlib obj, default=None</span>
<span class="sd">        If None (or False), data is not trimmed in this function.</span>
<span class="sd">        Otherwise, this is the directory to save trimmed and exported data.</span>
<span class="sd">    data_export_format: str=&#39;mseed&#39;</span>
<span class="sd">        If data_export_path is not None, this is the format in which to save the data</span>
<span class="sd">    detrend : str or bool, default=&#39;spline&#39;</span>
<span class="sd">        If False, data is not detrended.</span>
<span class="sd">        Otherwise, this should be a string accepted by the type parameter of the obspy.core.trace.Trace.detrend method: https://docs.obspy.org/packages/autogen/obspy.core.trace.Trace.detrend.html</span>
<span class="sd">    detrend_options : int, default=2</span>
<span class="sd">        If detrend parameter is &#39;spline&#39; or &#39;polynomial&#39;, this is passed directly to the order parameter of obspy.core.trace.Trace.detrend method.</span>
<span class="sd">    filter_type : None, str</span>
<span class="sd">        Type of filter to use on raw data.</span>
<span class="sd">        This should either be None or any of {&#39;bandpass&#39;, &#39;bandstop&#39;, &#39;lowpass&#39;, &#39;highpass&#39;, &#39;lowpass_cheby_2&#39;, &#39;lowpass_fir&#39;, &#39;remez_fir&#39;}.</span>
<span class="sd">        This passes `filter_type` to the `type` parameter and `**filter_options` to the `**options` parameter of the obspy.Stream filter() method.</span>
<span class="sd">        See here for more information: https://docs.obspy.org/packages/autogen/obspy.core.stream.Stream.filter.html</span>
<span class="sd">        If None, no filtering is done on the input seismic data.</span>
<span class="sd">    filter_options : dict</span>
<span class="sd">        Dictionary that will be unpacked into the `**options` parameter of the filter() method of the obspy.Stream class.</span>
<span class="sd">        This should fit the parameters of whichever filter type is specifed by filter_type.</span>
<span class="sd">        Example options for the &#39;bandpass&#39; filter_type might be: `filter_options={&#39;freqmin&#39;: 0.1, &#39;freqmax&#39;:50, &#39;df&#39;:100, &#39;corners&#39;:4, &#39;zerophase&#39;:True}`.</span>
<span class="sd">        See here for more information: https://docs.obspy.org/packages/autogen/obspy.core.stream.Stream.filter.html</span>
<span class="sd">    update_metadata : bool, default=True</span>
<span class="sd">        Whether to update the metadata file, used primarily with Raspberry Shake data which uses a generic inventory file.</span>
<span class="sd">    plot_input_stream : bool, default=False</span>
<span class="sd">        Whether to plot the raw input stream. This plot includes a spectrogram (Z component) and the raw (with decimation for speed) plots of each component signal.</span>
<span class="sd">    plot_engine : str, default=&#39;matplotlib&#39;</span>
<span class="sd">        Which plotting library/engine to use for plotting the Input stream. Options are &#39;matplotlib&#39;, &#39;plotly&#39;, or &#39;obspy&#39; (not case sensitive).</span>
<span class="sd">    verbose : bool, default=False</span>
<span class="sd">        Whether to print outputs and inputs to the terminal</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Keywords arguments, primarily for &#39;batch&#39; and &#39;dir&#39; sources</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    params : HVSRData or HVSRBatch object</span>
<span class="sd">        Same as params parameter, but with an additional &quot;stream&quot; attribute with an obspy data stream with 3 traces: Z (vertical), N (North-south), and E (East-west)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get intput paramaters</span>
    <span class="n">orig_args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    
    <span class="c1"># Keep track of any updates made to raw input along the way</span>
    <span class="n">update_msg</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Update with processing parameters specified previously in input_params, if applicable</span>
    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;fetch_data&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">defaultVDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">fetch_data</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> 
                        <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">fetch_data</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span><span class="p">))</span>
            <span class="n">defaultVDict</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;fetch_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Manual input to function overrides the imported parameter values</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;params&#39;</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">defaultVDict</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> (previously </span><span class="si">{</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                    <span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    
    <span class="c1"># Update local variables, in case of previously-specified parameters</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">data_export_path</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;data_export_path&#39;</span><span class="p">]</span>
    <span class="n">data_export_format</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;data_export_format&#39;</span><span class="p">]</span>
    <span class="n">detrend</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;detrend&#39;</span><span class="p">]</span>
    <span class="n">detrend_options</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;detrend_options&#39;</span><span class="p">]</span>
    <span class="n">filter_type</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;filter_type&#39;</span><span class="p">]</span>
    <span class="n">filter_options</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;filter_options&#39;</span><span class="p">]</span>
    <span class="n">update_metadata</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;update_metadata&#39;</span><span class="p">]</span>
    <span class="n">plot_input_stream</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;plot_input_stream&#39;</span><span class="p">]</span>
    <span class="n">plot_engine</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;plot_engine&#39;</span><span class="p">]</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span>

    <span class="c1"># Print inputs for verbose setting</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Fetching data (fetch_data())&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;fetch_data&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">update_msg</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">update_msg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">The following parameters were updated using the processing_parameters attribute:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">msg_line</span> <span class="ow">in</span> <span class="n">update_msg</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg_line</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>

    <span class="n">raspShakeInstNameList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raspberry shake&#39;</span><span class="p">,</span> <span class="s1">&#39;shake&#39;</span><span class="p">,</span> <span class="s1">&#39;raspberry&#39;</span><span class="p">,</span> <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;rs3d&#39;</span><span class="p">,</span> <span class="s1">&#39;rasp. shake&#39;</span><span class="p">,</span> <span class="s1">&#39;raspshake&#39;</span><span class="p">]</span>
    <span class="n">trominoNameList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tromino&#39;</span><span class="p">,</span> <span class="s1">&#39;trom&#39;</span><span class="p">,</span><span class="s1">&#39;tromino blue&#39;</span><span class="p">,</span> <span class="s1">&#39;tromino blu&#39;</span><span class="p">,</span> <span class="s1">&#39;tromino 3g&#39;</span><span class="p">,</span> <span class="s1">&#39;tromino 3g+&#39;</span><span class="p">,</span> <span class="s1">&#39;tr&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">]</span>

    <span class="c1"># Check if data is from tromino, and adjust parameters accordingly</span>
    <span class="k">if</span> <span class="s1">&#39;trc&#39;</span> <span class="ow">in</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s1">&#39;instrument&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trominoNameList</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Data from tromino detected. Changing instrument from </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to &#39;Tromino&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;tromino&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Tromino&#39;</span>

    <span class="c1"># Get metadata (inventory/response information)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">get_metadata</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">update_metadata</span><span class="o">=</span><span class="n">update_metadata</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">inv</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span>

    <span class="c1"># Cleanup for gui input</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">)):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="s1">&#39;}&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]):</span> <span class="c1"># This is how tkinter gui data comes in</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="c1"># Make sure input_data is pointing to an actual file</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]):</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_checkifpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">sample_list</span><span class="o">=</span><span class="n">SAMPLE_LIST</span><span class="p">)</span>
        <span class="n">dPath</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">)):</span>
        <span class="n">dPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">()</span> <span class="c1">#params[&#39;input_data&#39;]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">],</span> <span class="n">HVSRData</span><span class="p">):</span>
        <span class="n">dPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">][</span><span class="s1">&#39;input_data&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">],</span> <span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">)):</span>
                        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">elif</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">pass</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The params[&quot;input_data&quot;] parameter of fetch_data() was determined to be an HVSRData object, but no data in the &quot;stream&quot; attribute.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">The params[&quot;input_data&quot;] argument is already an HVSRData obect.&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Checking metadata then moving on.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dPath</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_checkifpath</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">],</span> <span class="n">sample_list</span><span class="o">=</span><span class="n">SAMPLE_LIST</span><span class="p">)</span>

    <span class="n">inst</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span>

    <span class="c1"># Need to put dates and times in right formats first</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">366</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;First item in date tuple must be day of year (0-366)&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">date</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Second item in date tuple should be year, but given item is in the future&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">date</span><span class="p">:</span>
            <span class="n">dateSplit</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;-&#39;</span> <span class="ow">in</span> <span class="n">date</span><span class="p">:</span>
            <span class="n">dateSplit</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dateSplit</span> <span class="o">=</span> <span class="n">date</span>

        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">:</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
        <span class="k">elif</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">&lt;=</span><span class="mi">12</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Preferred date format is &#39;yyyy-mm-dd&#39; or &#39;yyyy/mm/dd&#39;. Will attempt to parse date.&quot;</span><span class="p">)</span>
            <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">dateSplit</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
            <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Preferred date format is &#39;yyyy-mm-dd&#39; or &#39;yyyy/mm/dd&#39;. Cannot parse date.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">date</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
    <span class="k">else</span><span class="p">:</span>  
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">year</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Did not recognize date, using year </span><span class="si">{}</span><span class="s2"> and day </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">doy</span><span class="p">))</span>

    <span class="c1"># Select which instrument we are reading from (requires different processes for each instrument)</span>
    <span class="c1"># Get any kwargs that are included in obspy.read</span>
    <span class="n">obspyReadKwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">argName</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">argName</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">obspyReadKwargs</span><span class="p">[</span><span class="n">argName</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">argName</span><span class="p">]</span>

    <span class="c1"># Select how reading will be done</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">],</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">):</span>
        <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)[:</span><span class="mi">10</span><span class="p">],</span>
                                       <span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)[</span><span class="mi">11</span><span class="p">:</span><span class="mi">19</span><span class="p">],</span>
                                       <span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">)[</span><span class="mi">11</span><span class="p">:</span><span class="mi">19</span><span class="p">]])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">],</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">):</span>
        <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">])</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">tr</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)[:</span><span class="mi">10</span><span class="p">],</span> 
                                       <span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)[</span><span class="mi">11</span><span class="p">:</span><span class="mi">19</span><span class="p">],</span> 
                                       <span class="nb">str</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">)[</span><span class="mi">11</span><span class="p">:</span><span class="mi">19</span><span class="p">]])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">],</span> <span class="n">HVSRData</span><span class="p">):</span>
        <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">source</span><span class="o">==</span><span class="s1">&#39;raw&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inst</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">trominoNameList</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Tromino&#39;</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Tromino&#39;</span>

                    <span class="n">trominoKwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">read_tromino_files</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
                    <span class="n">paramDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                    <span class="n">trominoKwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">paramDict</span><span class="p">)</span>
                    <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">read_tromino_files</span><span class="p">(</span><span class="n">dPath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">trominoKwargs</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">inst</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">raspShakeInstNameList</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unrecognized value instrument=</span><span class="si">{</span><span class="n">inst</span><span class="si">}</span><span class="s2">. Defaulting to raw raspberry shake data.&quot;</span><span class="p">)</span>
                    <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">__read_RS_file_struct</span><span class="p">(</span><span class="n">dPath</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">doy</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data not fetched for </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Check input parameters or the data file.</span><span class="se">\n\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;stream&#39;</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">)):</span>
            <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;dir&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inst</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">raspShakeInstNameList</span><span class="p">:</span>
                <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">__read_RS_file_struct</span><span class="p">(</span><span class="n">dPath</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">doy</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">obspyFiles</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">obForm</span> <span class="ow">in</span> <span class="n">OBSPY_FORMATS</span><span class="p">:</span>
                    <span class="n">temp_file_glob</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">dPath</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">obForm</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">temp_file_glob</span><span class="p">:</span>
                        <span class="n">currParams</span> <span class="o">=</span> <span class="n">params</span>
                        <span class="n">currParams</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>

                        <span class="n">curr_data</span> <span class="o">=</span> <span class="n">fetch_data</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">,</span> <span class="c1">#all the same as input, except just reading the one file using the source=&#39;file&#39;</span>
                                    <span class="n">data_export_path</span><span class="o">=</span><span class="n">data_export_path</span><span class="p">,</span> <span class="n">data_export_format</span><span class="o">=</span><span class="n">data_export_format</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">detrend_options</span><span class="o">=</span><span class="n">detrend_options</span><span class="p">,</span> <span class="n">update_metadata</span><span class="o">=</span><span class="n">update_metadata</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="n">curr_data</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
                        <span class="n">obspyFiles</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">stem</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_data</span>  <span class="c1">#Add path object to dict, with filepath&#39;s stem as the site name</span>
                <span class="k">return</span> <span class="n">HVSRBatch</span><span class="p">(</span><span class="n">obspyFiles</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;file&#39;</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SAMPLE_LIST</span><span class="p">:</span>
            <span class="c1"># Read the file specified by input_data</span>
            <span class="c1"># Automatically read tromino data</span>
            <span class="k">if</span> <span class="n">inst</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">trominoNameList</span> <span class="ow">or</span> <span class="s1">&#39;trc&#39;</span> <span class="ow">in</span> <span class="n">dPath</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Tromino&#39;</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Tromino&#39;</span>

                <span class="k">if</span> <span class="s1">&#39;blu&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Tromino Blue&#39;</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Tromino Blue&#39;</span>

                <span class="k">if</span> <span class="s1">&#39;trc&#39;</span> <span class="ow">in</span> <span class="n">dPath</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
                    <span class="n">trominoKwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">read_tromino_files</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
                    <span class="n">paramDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                    <span class="n">trominoKwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">paramDict</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">&#39;input_data&#39;</span> <span class="ow">in</span> <span class="n">trominoKwargs</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">trominoKwargs</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="s1">&#39;tromino_model&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">trominoKwargs</span><span class="p">:</span>
                        <span class="n">trominoKwargs</span><span class="p">[</span><span class="s1">&#39;tromino_model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span>
                    <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">read_tromino_files</span><span class="p">(</span><span class="n">input_data</span><span class="o">=</span><span class="n">dPath</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">trominoKwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dPath</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dPath</span><span class="o">.</span><span class="n">suffix</span><span class="si">}</span><span class="s2"> is not a a filetype that can be read by SpRIT (via ObsPy)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dPath</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dPath</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="n">rawStreams</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">datafile</span> <span class="ow">in</span> <span class="n">dPath</span><span class="p">:</span>
                        <span class="n">rawStream</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="o">**</span><span class="n">obspyReadKwargs</span><span class="p">)</span>
                        <span class="n">rawStreams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rawStream</span><span class="p">)</span> <span class="c1">#These are actually streams, not traces</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stream</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rawStreams</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="c1">#Just in case</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">rawDataIN</span> <span class="o">+</span> <span class="n">stream</span> <span class="c1">#This adds a stream/trace to the current stream object</span>
                <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">dPath</span><span class="p">)[:</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sample&#39;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dPath</span><span class="p">,</span> <span class="o">**</span><span class="n">obspyReadKwargs</span><span class="p">)</span><span class="c1">#, starttime=obspy.core.UTCDateTime(params[&#39;starttime&#39;]), endttime=obspy.core.UTCDateTime(params[&#39;endtime&#39;]), nearest_sample =True)</span>
                <span class="c1">#import warnings # For some reason not being imported at the start</span>
                <span class="c1">#with warnings.catch_warnings():</span>
                    <span class="c1">#warnings.simplefilter(action=&#39;ignore&#39;, category=UserWarning)</span>
                    <span class="c1">#rawDataIN.attach_response(inv)</span>
        <span class="k">elif</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;batch&#39;</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SAMPLE_LIST</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Fetching data (fetch_data())&#39;</span><span class="p">)</span>
            <span class="n">batch_data_read_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">batch_data_read</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">batch_data_read</span><span class="p">(</span><span class="n">batch_data</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="o">**</span><span class="n">batch_data_read_kwargs</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">HVSRBatch</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">df_as_read</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">input_df</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">params</span>
        <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">SAMPLE_LIST</span> <span class="ow">or</span> <span class="sa">f</span><span class="s2">&quot;sample</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">SAMPLE_LIST</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">source</span><span class="o">==</span><span class="s1">&#39;batch&#39;</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;Batch_SampleData.csv&#39;</span><span class="p">)</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">batch_data_read</span><span class="p">(</span><span class="n">batch_data</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">],</span> <span class="n">batch_type</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">HVSRBatch</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">df_as_read</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">input_df</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">params</span>
            <span class="k">elif</span> <span class="n">source</span><span class="o">==</span><span class="s1">&#39;dir&#39;</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;Batch_SampleData.csv&#39;</span><span class="p">)</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">batch_data_read</span><span class="p">(</span><span class="n">batch_data</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">],</span> <span class="n">batch_type</span><span class="o">=</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">HVSRBatch</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">df_as_read</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">input_df</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">params</span>
            <span class="k">elif</span> <span class="n">source</span><span class="o">==</span><span class="s1">&#39;file&#39;</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">sampleFileKeyMap</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sample&#39;</span><span class="p">:</span>
                        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampleFileKeyMap</span>
                        
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampleFileKeyMap</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAMPLE_DATA_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;SampleHVSRSite1_AM.RAC84.00.2023.046_2023-02-15_1704-1734.MSEED&#39;</span><span class="p">)</span>

                <span class="n">dPath</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_data&#39;</span><span class="p">]</span>
                <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dPath</span><span class="p">)</span><span class="c1">#, starttime=obspy.core.UTCDateTime(params[&#39;starttime&#39;]), endttime=obspy.core.UTCDateTime(params[&#39;endtime&#39;]), nearest_sample =True)</span>
                <span class="c1">#import warnings</span>
                <span class="c1">#with warnings.catch_warnings():</span>
                <span class="c1">#    warnings.simplefilter(action=&#39;ignore&#39;, category=UserWarning)</span>
                <span class="c1">#    rawDataIN.attach_response(inv)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Last try if source cannot be read correctly</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">dPath</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;source=</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1"> not recognized, and input_data cannot be read using obspy.read()&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> Data as read in initially:&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">rawDataIN</span><span class="p">)</span><span class="si">}</span><span class="s1"> trace(s) in Stream:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rawDataIN</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">prevComponent</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">component</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">prevComponent</span><span class="si">}</span><span class="s1"> Component&#39;</span><span class="p">)</span>
                
            <span class="n">currComponent</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">component</span>
            <span class="k">if</span> <span class="n">prevComponent</span> <span class="o">!=</span> <span class="n">currComponent</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">currComponent</span><span class="si">}</span><span class="s2"> Component&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">  &quot;</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">prevComponent</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">component</span>
        <span class="nb">print</span><span class="p">()</span>
        
    <span class="c1"># Get metadata from the data itself, if not reading raw data</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># If the data already exists (not reading in raw from RS, for example), get the parameters from the data</span>
        <span class="n">dataIN</span> <span class="o">=</span> <span class="n">rawDataIN</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">source</span> <span class="o">!=</span> <span class="s1">&#39;raw&#39;</span><span class="p">:</span>           
            <span class="c1"># Use metadata from file for updating: </span>
            <span class="c1"># site</span>
            <span class="n">site_default</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
            <span class="n">updateMsg</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site_default</span> <span class="ow">and</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dPath</span><span class="o">.</span><span class="n">stem</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dPath</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">dPath</span> <span class="o">=</span> <span class="n">dPath</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dPath</span><span class="o">.</span><span class="n">stem</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dPath</span><span class="o">.</span><span class="n">stem</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">updateMsg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Site name updated to </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="c1"># network</span>
            <span class="n">net_default</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">net_default</span> <span class="ow">and</span> <span class="n">net_default</span> <span class="o">!=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;net&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">updateMsg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Network name updated to </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># station</span>
            <span class="n">sta_default</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">sta_default</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;sta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;station&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">updateMsg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Station name updated to </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># location</span>
            <span class="n">loc_default</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">loc_default</span> <span class="ow">and</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">updateMsg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Location updated to </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># channels</span>
            <span class="n">channelList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cha_default</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;cha&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">cha_default</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">channelList</span><span class="p">:</span>
                        <span class="n">channelList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">)</span>
                        <span class="n">channelList</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#Just so z is first, just in case</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;cha&#39;</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">channelList</span><span class="p">):</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;cha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">channelList</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;cha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">channelList</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">updateMsg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Channels updated to </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;cha&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Acquisition date</span>
            <span class="c1"># acqdate_default = inspect.signature(input_params).parameters[&#39;acq_date&#39;].default</span>
            <span class="n">acqdate_default</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>

            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">acqdate_default</span> <span class="ow">and</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">date</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">updateMsg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Acquisition Date updated to </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># starttime</span>
            <span class="n">today_Starttime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                                                 <span class="n">day</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                                                <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">maxStarttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> 
                                             <span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

            <span class="n">stime_default</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">NOWTIME</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">NOWTIME</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">NOWTIME</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">stime_default</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="o">.</span><span class="n">merge</span><span class="p">():</span>
                    <span class="n">currTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                        <span class="n">hour</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> 
                                       <span class="n">second</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">microsecond</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">currTime</span> <span class="o">&gt;</span> <span class="n">maxStarttime</span><span class="p">:</span>
                        <span class="n">maxStarttime</span> <span class="o">=</span> <span class="n">currTime</span>

                <span class="n">newStarttime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                                                 <span class="n">day</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                                                <span class="n">hour</span><span class="o">=</span><span class="n">maxStarttime</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="n">maxStarttime</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> 
                                                                <span class="n">second</span><span class="o">=</span><span class="n">maxStarttime</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="n">maxStarttime</span><span class="o">.</span><span class="n">microsecond</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">newStarttime</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newStarttime</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newStarttime</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">updateMsg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Starttime updated to </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># endttime</span>
            <span class="n">today_Endtime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                                                 <span class="n">day</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                                                <span class="n">hour</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">999999</span><span class="p">))</span>
            <span class="n">tomorrow_Endtime</span> <span class="o">=</span> <span class="n">today_Endtime</span> <span class="o">+</span> <span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="p">)</span>
            <span class="n">minEndtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="c1">#.replace(tzinfo=datetime.timezone.utc)#(hour=23, minute=59, second=59, microsecond=999999)</span>

            <span class="n">etime_default</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">NOWTIME</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">NOWTIME</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">NOWTIME</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">999999</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">etime_default</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="n">tomorrow_Endtime</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="o">.</span><span class="n">merge</span><span class="p">():</span>
                    <span class="n">currTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                        <span class="n">hour</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> 
                                       <span class="n">second</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">microsecond</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">currTime</span> <span class="o">&lt;</span> <span class="n">minEndtime</span><span class="p">:</span>
                        <span class="n">minEndtime</span> <span class="o">=</span> <span class="n">currTime</span>
                <span class="n">newEndtime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">minEndtime</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">minEndtime</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                                                 <span class="n">day</span> <span class="o">=</span> <span class="n">minEndtime</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                                                <span class="n">hour</span><span class="o">=</span><span class="n">minEndtime</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="n">minEndtime</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> 
                                                                <span class="n">second</span><span class="o">=</span><span class="n">minEndtime</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="n">minEndtime</span><span class="o">.</span><span class="n">microsecond</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">newEndtime</span><span class="p">:</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newEndtime</span>
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;endtime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newEndtime</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">updateMsg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Endtime updated to </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># HVSR_ID (derived)</span>
            <span class="n">project</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">proj_id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">proj_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">project</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span>
            
            <span class="c1"># Update HVSR_ID with new information</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;hvsr_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">proj_id</span><span class="si">}{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;hvsr_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">proj_id</span><span class="si">}{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">updateMsg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">updateMsg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;The following parameters have been updated directly from the data:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">msgLine</span> <span class="ow">in</span> <span class="n">updateMsg</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">msgLine</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>

            <span class="c1"># Clean up</span>
            <span class="n">dataIN</span> <span class="o">=</span> <span class="n">dataIN</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">dataIN</span> <span class="o">=</span> <span class="n">dataIN</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">],</span> <span class="n">endtime</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">])</span>
            <span class="n">dataIN</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Data as read by obspy does not contain the proper metadata. </span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">.</span><span class="se">\n</span><span class="s1">Check your input parameters or the data file.&#39;</span><span class="p">)</span>

    <span class="c1"># Latitude, Longitude, Elevation</span>
    <span class="c1"># Maybe make this more comprehensive, like for all input_params</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">):</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">):</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="s1">&#39;elevation&#39;</span><span class="p">):</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="s1">&#39;elev_unit&#39;</span><span class="p">):</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;elev_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;elev_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;elev_unit&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="s1">&#39;input_crs&#39;</span><span class="p">):</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_crs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;input_crs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;input_crs&#39;</span><span class="p">]</span>

    <span class="c1"># Get and update metadata after updating data from source</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">get_metadata</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">update_metadata</span><span class="o">=</span><span class="n">update_metadata</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
    <span class="n">inv</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span>

    <span class="c1"># Trim and save data as specified</span>
    <span class="k">if</span> <span class="n">data_export_path</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
        <span class="n">data_export_path</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data_export_path</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dataIN</span> <span class="o">=</span> <span class="n">_trim_data</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">dataIN</span><span class="p">,</span> <span class="n">export_dir</span><span class="o">=</span><span class="n">data_export_path</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">data_export_format</span><span class="o">=</span><span class="n">data_export_format</span><span class="p">)</span>

    <span class="c1"># Split data if masked array (if there are gaps)...detrending cannot be done without</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">):</span>
            <span class="n">dataIN</span> <span class="o">=</span> <span class="n">dataIN</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="c1">#Splits entire stream if any trace is masked_array</span>
            <span class="k">break</span>

    <span class="c1"># Detrend data</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataIN</span> <span class="o">=</span> <span class="n">__detrend_data</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">dataIN</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">detrend_options</span><span class="o">=</span><span class="n">detrend_options</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>

    <span class="c1"># Filter data</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">filter_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataIN</span><span class="o">.</span><span class="n">filter_type</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">filter_type</span><span class="p">,</span> <span class="o">**</span><span class="n">filter_options</span><span class="p">)</span>

    <span class="c1"># Remerge data</span>
    <span class="n">dataIN</span> <span class="o">=</span> <span class="n">dataIN</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Plot the input stream?</span>
    <span class="k">if</span> <span class="n">plot_input_stream</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">plot_engine</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;plotly&#39;</span><span class="p">,</span> <span class="s1">&#39;plty&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;spectrogram_component&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">specComp</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;spectrogram_component&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">specComp</span> <span class="o">=</span> <span class="s1">&#39;Z&#39;</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Input_Plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprit_plot</span><span class="o">.</span><span class="n">plot_input_stream</span><span class="p">(</span><span class="n">hv_data</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">dataIN</span><span class="p">,</span> <span class="n">spectrogram_component</span><span class="o">=</span><span class="n">specComp</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="n">show_plot</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">plot_engine</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;obspy&#39;</span><span class="p">,</span> <span class="s1">&#39;ospby&#39;</span><span class="p">,</span> <span class="s1">&#39;osbpy&#39;</span><span class="p">,</span> <span class="s1">&#39;opsby&#39;</span><span class="p">,</span> <span class="s1">&#39;opspy&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">]:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Input_Plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">handle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Input_Plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprit_plot</span><span class="o">.</span><span class="n">_plot_input_stream_mpl</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">dataIN</span><span class="p">,</span> <span class="n">hv_data</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="n">stack_type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">dbscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_gaps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylimstd</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                    
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Error with default plotting method: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">.</span><span class="se">\n</span><span class="s1"> Falling back to internal obspy plotting method&#39;</span><span class="p">)</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Input_Plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">handle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;Input_Plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Sort channels (make sure Z is first, makes things easier later)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataIN</span> <span class="o">=</span> <span class="n">_sort_channels</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">dataIN</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Clean up the ends of the data unless explicitly specified to do otherwise (this is a kwarg, not a parameter)</span>
    <span class="k">if</span> <span class="s1">&#39;clean_ends&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">clean_ends</span> <span class="o">=</span> <span class="kc">True</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="n">clean_ends</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;clean_ends&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">clean_ends</span><span class="p">:</span>
        <span class="n">maxStarttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">36500</span><span class="p">)</span>  <span class="c1"># 100 years ago</span>
        <span class="n">minEndtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">36500</span><span class="p">)</span>  <span class="c1"># 100 years from now</span>

        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="p">:</span>
            <span class="n">currStarttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> 
                                              <span class="n">hour</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> 
                                              <span class="n">second</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">microsecond</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">currStarttime</span> <span class="o">&gt;</span> <span class="n">maxStarttime</span><span class="p">:</span>
                <span class="n">maxStarttime</span> <span class="o">=</span> <span class="n">currStarttime</span>

            <span class="n">currEndtime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> 
                                         <span class="n">hour</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> 
                                         <span class="n">second</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">microsecond</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">currEndtime</span> <span class="o">&lt;</span> <span class="n">minEndtime</span><span class="p">:</span>
                <span class="n">minEndtime</span> <span class="o">=</span> <span class="n">currEndtime</span>

        <span class="n">maxStarttime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">maxStarttime</span><span class="p">)</span>
        <span class="n">minEndtime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">minEndtime</span><span class="p">)</span>
        <span class="n">dataIN</span> <span class="o">=</span> <span class="n">dataIN</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="p">:</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">maxStarttime</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="n">minEndtime</span><span class="p">)</span>
            <span class="k">pass</span>
        <span class="n">dataIN</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
    
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Set False by default, will get corrected later if batch</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Original stream as read</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Stream that may be modified later</span>
    
    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;fetch_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">exclude_params_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_params_list</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;fetch_data&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="c1"># Attach response data to stream and get paz (for PPSD later)</span>
    <span class="c1"># Check if response can be attached</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">responseMatch</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">component</span>
            
            <span class="c1"># Check if station, channel, location, and timing match</span>
            <span class="n">responseMatch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Default to false until proven otherwise</span>

            <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stations</span><span class="p">:</span>  <span class="c1"># Assumes only one network per inst</span>
                <span class="n">hasCha</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># all default to false until proven otherwise</span>
                <span class="n">hasLoc</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">hasSta</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">isStarted</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">notEnded</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="c1"># Check station</span>
                <span class="k">if</span> <span class="n">sta</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span><span class="p">:</span>
                    <span class="n">hasSta</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Check Channel</span>
                <span class="k">for</span> <span class="n">cha</span> <span class="ow">in</span> <span class="n">sta</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cha</span><span class="o">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">:</span>
                        <span class="n">hasCha</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># Check location</span>
                    <span class="k">if</span> <span class="n">cha</span><span class="o">.</span><span class="n">location_code</span> <span class="o">==</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span><span class="p">:</span>
                        <span class="n">hasLoc</span> <span class="o">=</span> <span class="kc">True</span>


                    <span class="c1"># Check time</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">cha</span><span class="o">.</span><span class="n">start_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cha</span><span class="o">.</span><span class="n">start_date</span> <span class="o">&lt;=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">):</span>
                        <span class="n">isStarted</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">cha</span><span class="o">.</span><span class="n">end_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cha</span><span class="o">.</span><span class="n">end_date</span> <span class="o">&gt;=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="p">):</span>
                        <span class="n">notEnded</span> <span class="o">=</span> <span class="kc">True</span>

                    
                    <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">hasSta</span><span class="p">,</span> <span class="n">hasCha</span><span class="p">,</span> <span class="n">hasLoc</span><span class="p">,</span> <span class="n">isStarted</span><span class="p">,</span> <span class="n">notEnded</span><span class="p">]):</span>
                        <span class="n">responseMatch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">responseMatch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">responseMatch</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Station&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">hasSta</span><span class="p">,</span> <span class="p">[</span><span class="n">sta</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stations</span><span class="p">]),</span>
                                    <span class="s1">&#39;Channel&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">hasCha</span><span class="p">,</span> <span class="p">[</span><span class="n">cha</span><span class="o">.</span><span class="n">code</span> <span class="k">for</span> <span class="n">cha</span> <span class="ow">in</span> <span class="n">sta</span> <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stations</span><span class="p">]),</span> 
                                    <span class="s1">&#39;Location&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">hasLoc</span><span class="p">,</span> <span class="p">[</span><span class="n">cha</span><span class="o">.</span><span class="n">location_code</span> <span class="k">for</span> <span class="n">cha</span> <span class="ow">in</span> <span class="n">sta</span> <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stations</span><span class="p">]),</span> 
                                    <span class="s1">&#39;Starttime&#39;</span><span class="p">:(</span><span class="n">isStarted</span><span class="p">,</span> <span class="p">[</span><span class="n">cha</span><span class="o">.</span><span class="n">start_date</span> <span class="k">for</span> <span class="n">cha</span> <span class="ow">in</span> <span class="n">sta</span> <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stations</span><span class="p">]),</span> 
                                    <span class="s1">&#39;Endtime&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="n">notEnded</span><span class="p">,</span>  <span class="p">[</span><span class="n">cha</span><span class="o">.</span><span class="n">end_date</span> <span class="k">for</span> <span class="n">cha</span> <span class="ow">in</span> <span class="n">sta</span> <span class="k">for</span> <span class="n">sta</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stations</span><span class="p">])}</span>

        <span class="n">metadataMatchError</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">comp</span><span class="p">,</span> <span class="n">matchItems</span> <span class="ow">in</span> <span class="n">responseMatch</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">matchItems</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">metadataMatchError</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">errorMsg</span> <span class="o">=</span> <span class="s1">&#39;The following items in your data need to be matched in the instrument response/metadata:&#39;</span>
                <span class="k">for</span> <span class="n">matchType</span><span class="p">,</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matchItems</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">match</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">errorMsg</span> <span class="o">=</span> <span class="n">errorMsg</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="si">{</span><span class="n">matchType</span><span class="si">}</span><span class="s2"> does not match </span><span class="si">{</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> correctly for component </span><span class="si">{</span><span class="n">comp</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">comp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="n">matchType</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">metadataMatchError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">errorMsg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Instrument Response/Metadata does not match input data and cannot be used!!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">errorMsg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">attach_response</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]:</span>
                <span class="n">cmpnt</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">component</span>

                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;paz&#39;</span><span class="p">][</span><span class="n">cmpnt</span><span class="p">][</span><span class="s1">&#39;poles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_paz</span><span class="p">()</span><span class="o">.</span><span class="n">poles</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;paz&#39;</span><span class="p">][</span><span class="n">cmpnt</span><span class="p">][</span><span class="s1">&#39;zeros&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_paz</span><span class="p">()</span><span class="o">.</span><span class="n">zeros</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;paz&#39;</span><span class="p">][</span><span class="n">cmpnt</span><span class="p">][</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_paz</span><span class="p">()</span><span class="o">.</span><span class="n">stage_gain</span>
                <span class="n">params</span><span class="p">[</span><span class="s1">&#39;paz&#39;</span><span class="p">][</span><span class="n">cmpnt</span><span class="p">][</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get_paz</span><span class="p">()</span><span class="o">.</span><span class="n">normalization_factor</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;obspy_ppsds&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;obspy_ppsds&#39;</span><span class="p">]:</span>
            <span class="n">errMsg</span> <span class="o">=</span> <span class="s2">&quot;Metadata missing, incomplete, or incorrect. Instrument response cannot be removed.&quot;</span>
            <span class="n">errMsg</span> <span class="o">+=</span> <span class="s2">&quot;if metadata cannot be matched, use obspy_ppsds=False to perform analysis on raw data (without instrument response removed)&quot;</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">errMsg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Metadata/instrument response does not match data.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">  Raw data (without the instrument response removed) will be used for processing.&quot;</span><span class="p">)</span>
    
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;fetch_data_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">dataINStr</span> <span class="o">=</span> <span class="n">dataIN</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dataINStr</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
    
    <span class="n">params</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_processing_status</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span> <span class="n">func_name</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">params</span></div>



<span class="c1"># For backwards compatibility (now generate_psds()</span>
<div class="viewcode-block" id="generate_ppsds">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.generate_ppsds">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_ppsds</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_psds_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function is to maintain backwards compatibility with previous version</span>
<span class="sd">    </span>
<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    generate_psds</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;generate_ppsds() is now deprecated, use generate_psds()&quot;</span><span class="p">,</span> <span class="ne">DeprecationWarning</span><span class="p">)</span>
    <span class="n">hvsrData</span> <span class="o">=</span> <span class="n">generate_psds</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="o">**</span><span class="n">gen_psds_kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hvsrData</span></div>



<span class="c1"># Generate PSDs for each channel</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_psds</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">overlap_pct</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">window_type</span><span class="o">=</span><span class="s1">&#39;hann&#39;</span><span class="p">,</span> <span class="n">window_length_method</span><span class="o">=</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> 
                  <span class="n">remove_response</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_on_gaps</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_freq_bins</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">hvsr_band</span><span class="o">=</span><span class="n">DEFAULT_BAND</span><span class="p">,</span>
                  <span class="n">obspy_ppsds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">azimuthal_psds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_psds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">obspy_ppsd_kwargs</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate Power Spectral Density (PSD) curves for each channel.</span>
<span class="sd">        Uses the [scipy.signal.welch()](https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.welch.html) function </span>
<span class="sd">        to generate PSDs by default, or can use Obspy&#39;s PPSD class.</span>
<span class="sd">        Info on Obspy PPSD creation here (if obspy_ppsds=True): https://docs.obspy.org/packages/autogen/obspy.signal.spectral_estimation.PPSD.html</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        hvsr_data : dict, HVSRData object, or HVSRBatch object</span>
<span class="sd">            Data object containing all the parameters and other data of interest (stream and paz, for example)</span>
<span class="sd">        window_length : float</span>
<span class="sd">            Length of the window, in seconds, to use for each PSD calculation. Defaults to 30.0.</span>
<span class="sd">        overlap_pct : float</span>
<span class="sd">            Percentage (should be 0-1) for overlapping each window used for PSD calculation. Defaults to 0.5.</span>
<span class="sd">        window_type : str</span>
<span class="sd">            Type of window to use. This is passed to the window parameter of the scipy.signal.welch function</span>
<span class="sd">        window_length_method : str = {&#39;length&#39;, &#39;number&#39;}</span>
<span class="sd">            Whether the window length should be a measure of length in seconds or number of windows. </span>
<span class="sd">            If number of windows uses integer value.</span>
<span class="sd">        remove_response : bool, default=False</span>
<span class="sd">            Whether to remove the instrument response from the data traces before calculating PSD data.</span>
<span class="sd">            If True, the appropriate metadata (i.e., obspy.Inventory object) must be attached to the stream and should be stored in the &#39;inv&#39; attribute of hvsr_data.</span>
<span class="sd">        skip_on_gaps : bool, default=True</span>
<span class="sd">            Whether to skip data gaps when processing windows. </span>
<span class="sd">            This is passed to the skip_on_gaps parameter of the Obspy PPSD class.</span>
<span class="sd">        num_freq_bins : int, default=512</span>
<span class="sd">            Number of frequency bins to use. When using the default (i.e., scipy.signal.welch) PSD function, the frequency bins are created manually for processing.</span>
<span class="sd">        obspy_ppsds : bool, default=False</span>
<span class="sd">            Whether to use the Obspy PPSD class.</span>
<span class="sd">        azimuthal_psds : bool, default=False</span>
<span class="sd">            Whether to generate PPSDs for azimuthal data</span>
<span class="sd">        verbose : bool, default=True</span>
<span class="sd">            Whether to print inputs and results to terminal</span>
<span class="sd">        plot_psds : bool, default=False</span>
<span class="sd">            Whether to show a plot of the psds here.</span>
<span class="sd">        **obspy_ppsd_kwargs : dict</span>
<span class="sd">            Dictionary with keyword arguments that are passed directly to obspy.signal.PPSD.</span>
<span class="sd">            If the following keywords are not specified, their defaults are amended in this function from the obspy defaults for its PPSD function. Specifically:</span>
<span class="sd">                - ppsd_length defaults to 30 (seconds) here instead of 3600</span>
<span class="sd">                - skip_on_gaps defaults to True instead of False</span>
<span class="sd">                - period_step_octaves defaults to 0.03125 instead of 0.125</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            ppsds : HVSRData object</span>
<span class="sd">                Dictionary containing entries with ppsds for each channel</span>
<span class="sd">                </span>
<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        [scipy.signal.welch](https://docs.scipy.org/doc/scipy/reference/generated/scipy.signal.welch.html)</span>
<span class="sd">        [obspy.signal.spectral_estimation.PPSD](https://docs.obspy.org/packages/autogen/obspy.signal.spectral_estimation.PPSD.html)</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># First, divide up for batch or not</span>
    <span class="n">orig_args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Get the initial arguments</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="n">obspy_ppsd_kwargs_sprit_defaults</span> <span class="o">=</span> <span class="n">obspy_ppsd_kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Set defaults here that are different than obspy defaults</span>
    <span class="k">if</span> <span class="s1">&#39;ppsd_length&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obspy_ppsd_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">obspy_ppsd_kwargs_sprit_defaults</span><span class="p">[</span><span class="s1">&#39;ppsd_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">30.0</span>      
    <span class="k">if</span> <span class="s1">&#39;period_step_octaves&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obspy_ppsd_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">obspy_ppsd_kwargs_sprit_defaults</span><span class="p">[</span><span class="s1">&#39;period_step_octaves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.03125</span>
    <span class="k">if</span> <span class="s1">&#39;period_limits&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obspy_ppsd_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;hvsr_band&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">obspy_ppsd_kwargs_sprit_defaults</span><span class="p">[</span><span class="s1">&#39;period_limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="o">/</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="s1">&#39;input_params&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;hvsr_band&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">obspy_ppsd_kwargs_sprit_defaults</span><span class="p">[</span><span class="s1">&#39;period_limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="o">/</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obspy_ppsd_kwargs_sprit_defaults</span><span class="p">[</span><span class="s1">&#39;period_limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">hvsr_band</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="o">/</span><span class="n">hvsr_band</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Updating hvsr_band to band specified by period_limits=</span><span class="si">{</span><span class="n">obspy_ppsd_kwargs</span><span class="p">[</span><span class="s1">&#39;period_limits&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s1">&#39;hvsr_band&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">obspy_ppsd_kwargs</span><span class="p">[</span><span class="s1">&#39;period_limits&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">obspy_ppsd_kwargs</span><span class="p">[</span><span class="s1">&#39;period_limits&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="o">/</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">obspy_ppsd_kwargs</span><span class="p">[</span><span class="s1">&#39;period_limits&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="o">/</span><span class="n">obspy_ppsd_kwargs</span><span class="p">[</span><span class="s1">&#39;period_limits&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="s1">&#39;input_params&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;hvsr_band&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">obspy_ppsd_kwargs</span><span class="p">[</span><span class="s1">&#39;period_limits&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="o">/</span><span class="n">obspy_ppsd_kwargs</span><span class="p">[</span><span class="s1">&#39;period_limits&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            
        
    <span class="c1"># Get Probablistic power spectral densities (PPSDs)</span>
    <span class="c1"># Get default args for function</span>
    <span class="n">obspy_ppsd_kwargs</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_get_default_args</span><span class="p">(</span><span class="n">PPSD</span><span class="p">)</span>
    <span class="n">obspy_ppsd_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">obspy_ppsd_kwargs_sprit_defaults</span><span class="p">)</span>  <span class="c1"># Update with sprit defaults, or user input</span>
    <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;obspy_ppsd_kwargs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obspy_ppsd_kwargs</span>

    <span class="c1"># Update with processing parameters specified previously in input_params, if applicable</span>
    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;generate_psds&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">defaultVDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">generate_psds</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> 
                                    <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">generate_psds</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span><span class="p">))</span>
            <span class="n">defaultVDict</span><span class="p">[</span><span class="s1">&#39;obspy_ppsd_kwargs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obspy_ppsd_kwargs</span>
            <span class="n">update_msg</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;generate_psds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Manual input to function overrides the imported parameter values</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">defaultVDict</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> (previously </span><span class="si">{</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                    <span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="n">azimuthal_psds</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;azimuthal_psds&#39;</span><span class="p">]</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>
    <span class="n">obspy_ppsd_kwargs</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;obspy_ppsd_kwargs&#39;</span><span class="p">]</span>

    <span class="c1"># if (verbose and isinstance(hvsr_data, HVSRBatch)) or (verbose and not hvsr_data[&#39;batch&#39;]):</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Generating Probabilistic Power Spectral Densities (generate_psds())&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Using the following parameters:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;hvsr_data&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;generate_psds&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">update_msg</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">update_msg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">The following parameters were updated using the processing_parameters attribute:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">msg_line</span> <span class="ow">in</span> <span class="n">update_msg</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg_line</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="c1"># If running batch, we&#39;ll loop through each one</span>
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># Make a copy so we don&#39;t accidentally overwrite</span>
            <span class="n">individual_params</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span>  <span class="c1"># Get what would normally be the &quot;hvsr_data&quot; variable for each site</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">individual_params</span>  <span class="c1"># reset the hvsr_data parameter we originally read in to an individual site hvsr_data</span>

            <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">__generate_ppsds_batch</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span> <span class="c1">#Call another function, that lets us run this function again</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;generate_psds_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
                    <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>                     
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;generate_psds_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
                <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>                
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sprit_tkinter_ui</span><span class="o">.</span><span class="n">update_progress_bars</span><span class="p">(</span><span class="n">prog_percent</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1">#print(e)</span>
        <span class="k">return</span> <span class="n">hvsr_data</span>
    
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_obspy_ppsds</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span><span class="o">**</span><span class="n">obspy_ppsd_kwargs</span><span class="p">):</span>
        <span class="n">paz</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;paz&#39;</span><span class="p">]</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>

        <span class="c1"># Get ppsds of e component</span>
        <span class="n">eStream</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">)</span>
        <span class="n">estats</span> <span class="o">=</span> <span class="n">eStream</span><span class="o">.</span><span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span>
        <span class="n">ppsdE</span> <span class="o">=</span> <span class="n">PPSD</span><span class="p">(</span><span class="n">estats</span><span class="p">,</span> <span class="n">paz</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">],</span>  <span class="o">**</span><span class="n">obspy_ppsd_kwargs</span><span class="p">)</span>
        <span class="n">ppsdE</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">eStream</span><span class="p">)</span>

        <span class="c1"># Get ppsds of n component</span>
        <span class="n">nStream</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>
        <span class="n">nstats</span> <span class="o">=</span> <span class="n">nStream</span><span class="o">.</span><span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span>
        <span class="n">ppsdN</span> <span class="o">=</span> <span class="n">PPSD</span><span class="p">(</span><span class="n">nstats</span><span class="p">,</span> <span class="n">paz</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">obspy_ppsd_kwargs</span><span class="p">)</span>
        <span class="n">ppsdN</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nStream</span><span class="p">)</span>

        <span class="c1"># Get ppsds of z component</span>
        <span class="n">zStream</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span>
        <span class="n">zstats</span> <span class="o">=</span> <span class="n">zStream</span><span class="o">.</span><span class="n">traces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span>
        <span class="n">ppsdZ</span> <span class="o">=</span> <span class="n">PPSD</span><span class="p">(</span><span class="n">zstats</span><span class="p">,</span> <span class="n">paz</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">obspy_ppsd_kwargs</span><span class="p">)</span>
        <span class="n">ppsdZ</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">zStream</span><span class="p">)</span>

        <span class="c1"># Get ppsds of R components (azimuthal data)</span>
        <span class="n">has_az</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">ppsds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">ppsdZ</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span><span class="n">ppsdE</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span><span class="n">ppsdN</span><span class="p">}</span>
        <span class="n">rStream</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">curr_trace</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;R&#39;</span> <span class="ow">in</span> <span class="n">curr_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span><span class="p">:</span>
                <span class="n">curr_stats</span> <span class="o">=</span> <span class="n">curr_trace</span><span class="o">.</span><span class="n">stats</span>
                <span class="n">ppsd_curr</span> <span class="o">=</span> <span class="n">PPSD</span><span class="p">(</span><span class="n">curr_stats</span><span class="p">,</span> <span class="n">paz</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">],</span> <span class="o">**</span><span class="n">obspy_ppsd_kwargs</span><span class="p">)</span>        
                <span class="n">has_az</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">ppsdName</span> <span class="o">=</span> <span class="n">curr_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span>
                <span class="n">ppsd_curr</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rStream</span><span class="p">)</span>
                <span class="n">ppsds</span><span class="p">[</span><span class="n">ppsdName</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppsd_curr</span>
        
        <span class="c1"># Add to the input dictionary, so that some items can be manipulated later on, and original can be saved</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds_obspy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppsds</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">anyKey</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds_obspy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Get ppsd class members</span>
        <span class="n">members</span> <span class="o">=</span> <span class="p">[</span><span class="n">mems</span> <span class="k">for</span> <span class="n">mems</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds_obspy&#39;</span><span class="p">][</span><span class="n">anyKey</span><span class="p">])</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">mems</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mems</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ppsds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1">#Get lists/arrays so we can manipulate data later and copy everything over to main &#39;ppsds&#39; subdictionary (convert lists to np.arrays for consistency)</span>
        <span class="n">listList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;times_data&#39;</span><span class="p">,</span> <span class="s1">&#39;times_gaps&#39;</span><span class="p">,</span> <span class="s1">&#39;times_processed&#39;</span><span class="p">,</span><span class="s1">&#39;current_times_used&#39;</span><span class="p">,</span> <span class="s1">&#39;psd_values&#39;</span><span class="p">]</span> <span class="c1">#Things that need to be converted to np.array first, for consistency</span>
        <span class="n">timeKeys</span><span class="o">=</span> <span class="p">[</span><span class="s1">&#39;times_processed&#39;</span><span class="p">,</span><span class="s1">&#39;current_times_used&#39;</span><span class="p">,</span><span class="s1">&#39;psd_values&#39;</span><span class="p">]</span>
        <span class="n">timeDiffWarn</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">dfList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">time_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">time_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds_obspy&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">m</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">listList</span><span class="p">:</span>
                    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">m</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;times_processed&#39;</span><span class="p">:</span>
                <span class="n">unique_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">],</span>
                                                    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">],</span>
                                                    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]]))</span>

                <span class="n">common_times</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">currTime</span> <span class="ow">in</span> <span class="n">unique_times</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">currTime</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">currTime</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="n">currTime</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]:</span>
                                <span class="n">common_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currTime</span><span class="p">)</span>

                <span class="n">cTimeIndList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">cTime</span> <span class="ow">in</span> <span class="n">common_times</span><span class="p">:</span>
                    <span class="n">ZArr</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>
                    <span class="n">EArr</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>
                    <span class="n">NArr</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>

                    <span class="n">cTimeIndList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ZArr</span> <span class="o">==</span> <span class="n">cTime</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">EArr</span> <span class="o">==</span> <span class="n">cTime</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                                        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">NArr</span> <span class="o">==</span> <span class="n">cTime</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])])</span>
                    
            <span class="c1"># Make sure number of time windows is the same between PPSDs (this can happen with just a few slightly different number of samples)</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">timeKeys</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;times_processed&#39;</span><span class="p">:</span>
                    <span class="n">time_data</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">m</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">],</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">],</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span>

                <span class="n">tSteps_same</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">tSteps_same</span><span class="p">:</span>
                    <span class="n">shortestTimeLength</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="n">maxPctDiff</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">currCompTimeLength</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">timeLengthDiff</span> <span class="o">=</span> <span class="n">currCompTimeLength</span> <span class="o">-</span> <span class="n">shortestTimeLength</span>
                        <span class="n">percentageDiff</span> <span class="o">=</span> <span class="n">timeLengthDiff</span> <span class="o">/</span> <span class="n">currCompTimeLength</span>
                        <span class="k">if</span> <span class="n">percentageDiff</span> <span class="o">&gt;</span> <span class="n">maxPctDiff</span><span class="p">:</span>
                            <span class="n">maxPctDiff</span> <span class="o">=</span> <span class="n">percentageDiff</span>

                    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">while</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">shortestTimeLength</span><span class="p">:</span>
                            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="n">m</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">comp</span><span class="p">][</span><span class="n">m</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    
                    
                    <span class="k">if</span> <span class="n">maxPctDiff</span> <span class="o">&gt;</span> <span class="mf">0.05</span> <span class="ow">and</span> <span class="n">timeDiffWarn</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">  Number of ppsd time windows between different components is significantly different: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">maxPctDiff</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">% &gt; 5%. Last windows will be trimmed.&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">verbose</span>  <span class="ow">and</span> <span class="n">timeDiffWarn</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">  Number of ppsd time windows between different components is different by </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">maxPctDiff</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">%. Last window(s) of components with larger number of ppsd windows will be trimmed.&quot;</span><span class="p">)</span>
                    <span class="n">timeDiffWarn</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#So we only do this warning once, even though there may be multiple arrays that need to be trimmed</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">currTStep</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cTimeIndList</span><span class="p">):</span>
            <span class="n">colList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">currTStepList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">colList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Use&#39;</span><span class="p">)</span>
            <span class="n">currTStepList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">common_times</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">tk</span> <span class="ow">in</span> <span class="n">time_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="s1">&#39;current_times_used&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tk</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">]:</span>
                            <span class="n">colList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tk</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">k</span><span class="p">)</span>
                            <span class="n">currTStepList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_data</span><span class="p">[</span><span class="n">tk</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="n">currTStep</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="n">dfList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currTStepList</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hvsr_data</span><span class="p">,</span> <span class="n">dfList</span><span class="p">,</span> <span class="n">colList</span><span class="p">,</span> <span class="n">common_times</span>

    <span class="k">if</span> <span class="n">obspy_ppsds</span><span class="p">:</span>
        <span class="n">hvsr_data</span><span class="p">,</span> <span class="n">dfList</span><span class="p">,</span> <span class="n">colList</span><span class="p">,</span> <span class="n">common_times</span> <span class="o">=</span> <span class="n">_get_obspy_ppsds</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="o">**</span><span class="n">obspy_ppsd_kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">psdDict</span><span class="p">,</span> <span class="n">common_times</span> <span class="o">=</span> <span class="n">__single_psd_from_raw_data</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="n">window_length</span><span class="p">,</span> <span class="n">window_length_method</span><span class="o">=</span><span class="n">window_length_method</span><span class="p">,</span> <span class="n">window_type</span><span class="o">=</span><span class="n">window_type</span><span class="p">,</span>
                                                           <span class="n">num_freq_bins</span><span class="o">=</span><span class="n">num_freq_bins</span><span class="p">,</span>
                                                           <span class="n">overlap</span><span class="o">=</span><span class="n">overlap_pct</span><span class="p">,</span> <span class="n">remove_response</span><span class="o">=</span><span class="n">remove_response</span><span class="p">,</span> <span class="n">do_azimuths</span><span class="o">=</span><span class="n">azimuthal_psds</span><span class="p">,</span> <span class="n">show_psd_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">x_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">num_freq_bins</span><span class="p">))</span>
        
        <span class="n">psdDictUpdate</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">compdict</span> <span class="ow">in</span> <span class="n">psdDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">psdDictUpdate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">arr</span><span class="p">))</span> <span class="k">for</span> <span class="n">time</span><span class="p">,</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">compdict</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1">#hvsr_data[&#39;ppsds&#39;] = {&#39;Z&#39;:{}, &#39;E&#39;:{}, &#39;N&#39;:{}}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">psdDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">currSt</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
                      
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currSt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">channel</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;current_times_used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">common_times</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">currSt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
            <span class="c1">#hvsr_data[&#39;ppsds&#39;][key][&#39;get_mean&#39;] = np.nanmean(item)</span>
            <span class="c1">#hvsr_data[&#39;ppsds&#39;][key][&#39;mean&#39;] = np.nanmean(item)</span>
            <span class="c1">#hvsr_data[&#39;ppsds&#39;][key][&#39;get_mode&#39;] = scipy.stats.mode(item)</span>
            <span class="c1">#hvsr_data[&#39;ppsds&#39;][key][&#39;mode&#39;] = scipy.stats.mode(item)</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currSt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">window_length</span> <span class="o">/</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currSt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">currSt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">response</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">currSt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="s1">&#39;response&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;network&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currSt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;nfft&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">window_length</span> <span class="o">/</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;nlap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">overlap_pct</span><span class="o">*</span><span class="n">window_length</span> <span class="o">/</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;delta&#39;</span><span class="p">])</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;overlap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap_pct</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;period_bin_centers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">round</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x_freqs</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_freqs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;period_bin_centers&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">x_freqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">3</span><span class="p">)))</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;period_bin_centers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;period_bin_centers&#39;</span><span class="p">])</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;period_bin_left_edges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">x_freqs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;period_bin_right_edges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">x_freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;period_xedges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">x_freqs</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;ppsd_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">window_length</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;psd_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">window_length</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;psd_frequencies&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_freqs</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;psd_periods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">x_freqs</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;psd_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">psdDictUpdate</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currSt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;skip_on_gaps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">skip_on_gaps</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;station&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">currSt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;step&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">window_length</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">overlap_pct</span><span class="p">)</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;times_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">common_times</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;times_gaps&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;times_processed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span>
            
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds_obspy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dfList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">common_times</span><span class="p">):</span>
            <span class="n">ws</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="n">dfList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="n">psdDictUpdate</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">psdDictUpdate</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">psdDictUpdate</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span>
        <span class="n">colList</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Use&quot;</span><span class="p">,</span> <span class="s2">&quot;psd_values_Z&quot;</span><span class="p">,</span> <span class="s2">&quot;psd_values_E&quot;</span><span class="p">,</span> <span class="s2">&quot;psd_values_N&quot;</span><span class="p">]</span>
        <span class="c1"># dfList: list of np.arrays, fitting the above column</span>
        <span class="c1"># common_times: times in common between all, should be length of 1 psd dimension above</span>
        <span class="c1"># hvsr_data[&#39;ppsds&#39;][&#39;Z&#39;][&#39;times_gaps&#39;]: list of two-item lists with UTCDatetimes for gaps</span>
        
        <span class="c1"># #Maybe not needed hvsr_data[&#39;ppsds&#39;][&#39;Z&#39;][&#39;current_times_used&#39;]</span>

    <span class="n">hvsrDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dfList</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">colList</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">hvsrDF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> processing windows generated and psd values stored in hvsr_windows_df with columns: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">hvsrDF</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="c1"># Add azimuthal ppsds values</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">]:</span>
            <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;psd_values_&#39;</span><span class="o">+</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;psd_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

    <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_Obspy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">common_times</span>
    <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_ObspyEnd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_Obspy&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">obspy_ppsd_kwargs</span><span class="p">[</span><span class="s1">&#39;ppsd_length&#39;</span><span class="p">]</span>
    <span class="c1">#    colList.append(&#39;TimesProcessed_Obspy&#39;)</span>
    <span class="c1">#    currTStepList.append(common_times[i])            </span>
    <span class="c1"># Add other times (for start times)</span>
    
    <span class="c1"># Create functions to be used in pandas .apply() for datetime conversions</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_to_datetime</span><span class="p">(</span><span class="n">obspyUTCDateTime</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obspyUTCDateTime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_to_mpl_dates</span><span class="p">(</span><span class="n">obspyUTCDateTime</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obspyUTCDateTime</span><span class="o">.</span><span class="n">matplotlib_date</span>

    <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_Obspy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">convert_to_datetime</span><span class="p">)</span>
    
    <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_End&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="n">obspy_ppsd_kwargs</span><span class="p">[</span><span class="s1">&#39;ppsd_length&#39;</span><span class="p">])</span>
    <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_MPL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_Obspy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">convert_to_mpl_dates</span><span class="p">)</span>
    <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_MPLEnd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_MPL&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">obspy_ppsd_kwargs</span><span class="p">[</span><span class="s1">&#39;ppsd_length&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">86400</span><span class="p">)</span>
    
    <span class="c1"># Take care of existing time gaps, in case not taken care of previously</span>
    <span class="k">if</span> <span class="n">obspy_ppsds</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">gap</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="s1">&#39;times_gaps&#39;</span><span class="p">]:</span>
            <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_MPL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">gap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">matplotlib_date</span><span class="p">))</span><span class="o">|</span> \
                        <span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_MPLEnd&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">gap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">matplotlib_date</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span><span class="c1"># | \</span>
    
    <span class="n">hvsrDF</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;TimesProcessed&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsrDF</span>
    
    <span class="c1"># Remove data set for removal during remove_noise()</span>
    <span class="k">if</span> <span class="s1">&#39;x_windows_out&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Removing Noisy windows from hvsr_windows_df.&quot;</span><span class="p">)</span>
        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">__remove_windows_from_df</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="c1">#for window in hvsr_data[&#39;x_windows_out&#39;]:</span>
        <span class="c1">#    print(window)</span>
        <span class="c1">#    hvsrDF[&#39;Use&#39;] = (hvsrDF[&#39;TimesProcessed_MPL&#39;][hvsrDF[&#39;Use&#39;]].lt(window[0]) &amp; hvsrDF[&#39;TimesProcessed_MPLEnd&#39;][hvsrDF[&#39;Use&#39;]].lt(window[0]) )| \</span>
        <span class="c1">#            (hvsrDF[&#39;TimesProcessed_MPL&#39;][hvsrDF[&#39;Use&#39;]].gt(window[1]) &amp; hvsrDF[&#39;TimesProcessed_MPLEnd&#39;][hvsrDF[&#39;Use&#39;]].gt(window[1])).astype(bool)</span>
        <span class="c1">#hvsrDF[&#39;Use&#39;] = hvsrDF[&#39;Use&#39;].astype(bool)</span>
        
    <span class="c1"># Create dict entry to keep track of how many outlier hvsr curves are removed </span>
    <span class="c1"># This is a (2-item list with [0]=current number, [1]=original number of curves)</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;tsteps_used&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="c1">#hvsr_data[&#39;tsteps_used&#39;] = [hvsr_data[&#39;ppsds&#39;][&#39;Z&#39;][&#39;times_processed&#39;].shape[0], hvsr_data[&#39;ppsds&#39;][&#39;Z&#39;][&#39;times_processed&#39;].shape[0]]</span>
    <span class="c1">#hvsr_data[&#39;tsteps_used&#39;][0] = hvsr_data[&#39;ppsds&#39;][&#39;Z&#39;][&#39;current_times_used&#39;].shape[0]</span>
    
    <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_make_it_classy</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;generate_psds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">exclude_params_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_params_list</span><span class="p">:</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;generate_psds&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;generate_psds_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_processing_status</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span> <span class="n">func_name</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    
    <span class="c1">#for ind, row in hvsrDF.iterrows():</span>
    <span class="c1">#    print(row[&#39;psd_values_Z&#39;].shape)</span>
    <span class="k">if</span> <span class="n">plot_psds</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">hvsrDF</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;psd_values_Z&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;psd_values_E&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;psd_values_N&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">hvsr_data</span>


<span class="c1"># Gets the metadata for Raspberry Shake, specifically for 3D v.7</span>
<div class="viewcode-block" id="get_metadata">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.get_metadata">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_metadata</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">write_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">update_metadata</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">read_inventory_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get metadata and calculate or get paz parameter needed for PSD</span>
<span class="sd">       Adds an obspy.Inventory object to the &quot;inv&quot; attribute or key of params</span>
<span class="sd">    </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params : dict</span>
<span class="sd">        Dictionary containing all the input and other parameters needed for processing</span>
<span class="sd">            Ouput from input_params() function</span>
<span class="sd">    write_path : str</span>
<span class="sd">        String with output filepath of where to write updated inventory or metadata file</span>
<span class="sd">            If not specified, does not write file </span>
<span class="sd">    update_metadata : bool</span>
<span class="sd">        Whether to update the metadata file itself, or just read as-is. If using provided raspberry shake metadata file, select True.</span>
<span class="sd">    source : str, default=None</span>
<span class="sd">        This passes the source variable value to _read_RS_metadata. It is expected that this is passed directly from the source parameter of sprit.fetch_data()</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    params : dict</span>
<span class="sd">        Modified input dictionary with additional key:value pair containing paz dictionary (key = &quot;paz&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">invPath</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span>
    <span class="n">raspShakeInstNameList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raspberry shake&#39;</span><span class="p">,</span> <span class="s1">&#39;shake&#39;</span><span class="p">,</span> <span class="s1">&#39;raspberry&#39;</span><span class="p">,</span> 
                             <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;rs3d&#39;</span><span class="p">,</span> <span class="s1">&#39;rasp. shake&#39;</span><span class="p">,</span> 
                             <span class="s1">&#39;raspshake&#39;</span><span class="p">,</span> <span class="s1">&#39;raspberry shake 3d&#39;</span><span class="p">]</span>
    <span class="n">trominoNameList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tromino&#39;</span><span class="p">,</span> <span class="s1">&#39;trom&#39;</span><span class="p">,</span> <span class="s1">&#39;trm&#39;</span><span class="p">,</span> <span class="s1">&#39;t&#39;</span><span class="p">]</span>
       
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">raspShakeInstNameList</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">update_metadata</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">_update_shake_metadata</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">invPath</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">write_path</span><span class="o">=</span><span class="n">write_path</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">_read_RS_Metadata</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">trominoNameList</span><span class="p">:</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;paz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z&#39;</span><span class="p">:{},</span> <span class="s1">&#39;E&#39;</span><span class="p">:{},</span> <span class="s1">&#39;N&#39;</span><span class="p">:{}}</span>

        <span class="c1"># Initially started here: https://ds.iris.edu/NRL/sensors/Sunfull/RESP.XX.NS721..BHZ.PS-4.5C1_LF4.5_RC3400_RSNone_SG82_STgroundVel</span>
        <span class="n">tromino_paz</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;zeros&#39;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">3.141592653589793</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">0</span><span class="n">j</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.141592653589793</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">0</span><span class="n">j</span><span class="p">],</span>
                        <span class="s1">&#39;poles&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="mi">17</span><span class="o">-</span><span class="mi">24</span><span class="n">j</span><span class="p">),</span> <span class="p">(</span><span class="mi">17</span><span class="o">+</span><span class="mi">24</span><span class="n">j</span><span class="p">)],</span>
                        <span class="s1">&#39;stage_gain&#39;</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span>
                        <span class="s1">&#39;stage_gain_frequency&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span>
                        <span class="s1">&#39;normalization_frequency&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span> 
                        <span class="s1">&#39;normalization_factor&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
        
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;paz&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">params</span><span class="p">[</span><span class="s1">&#39;paz&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;paz&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tromino_paz</span>
        
        <span class="n">tromChaResponse</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">Response</span><span class="p">()</span><span class="o">.</span><span class="n">from_paz</span><span class="p">(</span><span class="o">**</span><span class="n">tromino_paz</span><span class="p">)</span>

        <span class="n">obspyStartDate</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="mi">1900</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">obspyNow</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="c1"># Update location code to match partition</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">])</span>

        <span class="c1"># Create channel objects to be used in inventory                </span>
        <span class="n">channelObj_Z</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s1">&#39;EHZ&#39;</span><span class="p">,</span> <span class="n">location_code</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span> <span class="n">latitude</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span> 
                                                <span class="n">longitude</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">],</span> <span class="n">elevation</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;elevation&#39;</span><span class="p">],</span> <span class="n">depth</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> 
                                                <span class="n">azimuth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dip</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">obspyStartDate</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">obspyNow</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">tromChaResponse</span><span class="p">)</span>
        <span class="n">channelObj_E</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s1">&#39;EHE&#39;</span><span class="p">,</span> <span class="n">location_code</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span> <span class="n">latitude</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span> 
                                                <span class="n">longitude</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">],</span> <span class="n">elevation</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;elevation&#39;</span><span class="p">],</span> <span class="n">depth</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> 
                                                <span class="n">azimuth</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">dip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">obspyStartDate</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">obspyNow</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">tromChaResponse</span><span class="p">)</span> 
        <span class="n">channelObj_N</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">Channel</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s1">&#39;EHN&#39;</span><span class="p">,</span> <span class="n">location_code</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">],</span> <span class="n">latitude</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span> 
                                                <span class="n">longitude</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">],</span> <span class="n">elevation</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;elevation&#39;</span><span class="p">],</span> <span class="n">depth</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">],</span> 
                                                <span class="n">azimuth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">obspyStartDate</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">obspyNow</span><span class="p">,</span> <span class="n">response</span><span class="o">=</span><span class="n">tromChaResponse</span><span class="p">)</span> 
        
        <span class="c1"># Create site object for inventory</span>
        <span class="n">siteObj</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">Site</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">town</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">county</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">country</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        
        <span class="c1"># Create station object for inventory</span>
        <span class="n">stationObj</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">station</span><span class="o">.</span><span class="n">Station</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s1">&#39;TRMNO&#39;</span><span class="p">,</span> <span class="n">latitude</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span> <span class="n">longitude</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">],</span> 
                                            <span class="n">elevation</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;elevation&#39;</span><span class="p">],</span> <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="n">channelObj_Z</span><span class="p">,</span> <span class="n">channelObj_E</span><span class="p">,</span> <span class="n">channelObj_N</span><span class="p">],</span> <span class="n">site</span><span class="o">=</span><span class="n">siteObj</span><span class="p">,</span> 
                                            <span class="n">vault</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">geology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">equipments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">creation_date</span><span class="o">=</span><span class="n">obspyStartDate</span><span class="p">,</span>
                                            <span class="n">termination_date</span><span class="o">=</span><span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="mi">2100</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">total_number_of_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                                            <span class="n">selected_number_of_channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Estimated data for Tromino, this is NOT from the manufacturer&#39;</span><span class="p">,</span>
                                            <span class="n">comments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">obspyStartDate</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">obspyNow</span><span class="p">,</span> 
                                            <span class="n">restricted_status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alternate_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">historical_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                            <span class="n">data_availability</span><span class="o">=</span><span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">DataAvailability</span><span class="p">(</span><span class="n">obspyStartDate</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span> 
                                            <span class="n">identifiers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">water_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Create network object for inventory</span>
        <span class="n">network</span> <span class="o">=</span> <span class="p">[</span><span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">network</span><span class="o">.</span><span class="n">Network</span><span class="p">(</span><span class="n">code</span><span class="o">=</span><span class="s1">&#39;AM&#39;</span><span class="p">,</span> <span class="n">stations</span><span class="o">=</span><span class="p">[</span><span class="n">stationObj</span><span class="p">],</span> <span class="n">total_number_of_stations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                            <span class="n">selected_number_of_stations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">obspyStartDate</span><span class="p">,</span> 
                                            <span class="n">end_date</span><span class="o">=</span><span class="n">obspyNow</span><span class="p">,</span> <span class="n">restricted_status</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alternate_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">historical_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                            <span class="n">data_availability</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">identifiers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">operators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)]</span>
        
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Inventory</span><span class="p">(</span><span class="n">networks</span><span class="o">=</span><span class="n">network</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">invPath</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1">#if invPath is None</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">invPath</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="n">invPath</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The metadata parameter was not specified correctly. Returning original params value </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">readInvKwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">argspecs</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">read_inventory</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">argName</span> <span class="ow">in</span> <span class="n">argspecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">argName</span> <span class="ow">in</span> <span class="n">read_inventory_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">readInvKwargs</span><span class="p">[</span><span class="n">argName</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_inventory_kwargs</span><span class="p">[</span><span class="n">argName</span><span class="p">]</span>

        <span class="n">readInvKwargs</span><span class="p">[</span><span class="s1">&#39;path_or_file_object&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">invPath</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read_inventory</span><span class="p">(</span><span class="n">invPath</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;params&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">params</span></div>



<span class="c1"># Get report (report generation and export)</span>
<div class="viewcode-block" id="get_report">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.get_report">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">report_formats</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">],</span> <span class="n">azimuth</span><span class="o">=</span><span class="s1">&#39;HV&#39;</span><span class="p">,</span>
               <span class="n">plot_type</span><span class="o">=</span><span class="n">DEFAULT_PLOT_STR</span><span class="p">,</span> <span class="n">plot_engine</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span> 
               <span class="n">show_print_report</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_table_report</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_plot_report</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_html_report</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_pdf_report</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">suppress_report_outputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_report_outputs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">csv_handling</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">,</span> 
               <span class="n">report_export_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">report_export_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
               <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>    
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate and/or print and/or export a report of the HVSR analysis in a variety of formats. </span>
<span class="sd">    </span>
<span class="sd">    Formats include:</span>
<span class="sd">    * &#39;print&#39;: A (monospace) text summary of the HVSR results</span>
<span class="sd">    * &#39;table&#39;: A pandas.DataFrame summary of the HVSR Results.</span>
<span class="sd">            This is useful for copy/pasting directly into a larger worksheet.</span>
<span class="sd">    * &#39;plot&#39;: A plot summary of the HVSR results, generated using the plot_hvsr() function.</span>
<span class="sd">    * &#39;html&#39;: An HTML document/text of the HVSR results. This includes the table, print, and plot reports in one document.</span>
<span class="sd">    * &#39;pdf&#39;: A PDF document showing the summary of the HVSR Results. </span>
<span class="sd">            The PDF report is simply the HTML report saved to an A4-sized PDF document.</span>

<span class="sd">        </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_results : dict</span>
<span class="sd">        Dictionary containing all the information about the processed hvsr data</span>
<span class="sd">    report_formats : {&#39;table&#39;, &#39;print&#39;, plot}</span>
<span class="sd">        Format in which to print or export the report.</span>
<span class="sd">        The following report_formats return the following items in the following attributes:</span>
<span class="sd">            - &#39;plot&#39;: hvsr_results[&#39;Print_Report&#39;] as a str</span>
<span class="sd">            - &#39;print&#39;: hvsr_results[&#39;Plot_Report&#39;] - matplotlib.Figure object</span>
<span class="sd">            - &#39;table&#39;:  hvsr_results[&#39;Table_Report&#39;]- pandas.DataFrame object</span>
<span class="sd">                - list/tuple - a list or tuple of the above objects, in the same order they are in the report_formats list</span>
<span class="sd">            - &#39;html&#39;: hvsr_results[&#39;HTML_Report&#39;] - a string containing the text for an HTML document</span>
<span class="sd">            - &#39;pdf&#39;: currently does not save to the HVSRData object itself, can only be saved to the disk directly</span>
<span class="sd">    plot_type : str, default = &#39;HVSR p ann C+ p ann Spec p ann&#39;</span>
<span class="sd">        What type of plot to plot, if &#39;plot&#39; part of report_formats input</span>
<span class="sd">    azimuth : str, default = &#39;HV&#39;</span>
<span class="sd">        Which azimuth to plot, by default &quot;HV&quot; which is the main &quot;azimuth&quot; combining the E and N components</span>
<span class="sd">    csv_handling : str, {&#39;append&#39;, &#39;overwrite&#39;, &#39;keep/rename&#39;}</span>
<span class="sd">        How to handle table report outputs if the designated csv output file already exists. By default, appends the new information to the end of the existing file.</span>
<span class="sd">    suppress_report_outputs : bool, default=False</span>
<span class="sd">        If True, only reads output to appropriate attribute of data class (ie, print does not print, only reads text into variable). If False, performs as normal.</span>
<span class="sd">    report_export_format : list or str, default=[&#39;pdf&#39;]</span>
<span class="sd">        A string or list of strings indicating which report formats should be exported to disk.</span>
<span class="sd">    report_export_path : None, bool, or filepath, default = None</span>
<span class="sd">        If None or False, does not export; if True, will export to same directory as the input_data parameter in the input_params() function.</span>
<span class="sd">        Otherwise, it should be a string or path object indicating where to export results. May be a file or directory.</span>
<span class="sd">        If a directory is specified, the filename will be  &quot;&lt;site_name&gt;_&lt;acq_date&gt;_&lt;UTC start time&gt;-&lt;UTC end time&gt;&quot;. </span>
<span class="sd">        The extension/suffix defaults to png for report_formats=&quot;plot&quot;, csv for &#39;table&#39;, txt for &#39;print&#39;, html for &#39;html&#39;, and pdf for &#39;pdf.&#39;</span>
<span class="sd">    verbose : bool, default=True</span>
<span class="sd">        Whether to print the results to terminal. This is the same output as report_formats=&#39;print&#39;, and will not repeat if that is already selected</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sprit.HVSRData</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orig_args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#Get the initial arguments</span>
    <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]]</span>
    <span class="n">update_msg</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Update with processing parameters specified previously in input_params, if applicable</span>
    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;get_report&#39;</span> <span class="ow">in</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;get_report&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">defaultVDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">get_report</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> 
                                        <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">get_report</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span><span class="p">))</span>
                <span class="n">defaultVDict</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1"># Manual input to function overrides the imported parameter values</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">defaultVDict</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> (previously </span><span class="si">{</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                    <span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    
    <span class="n">report_formats</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]</span>
    <span class="n">azimuth</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]</span>
    <span class="n">plot_type</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]</span>
    <span class="n">plot_engine</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;plot_engine&#39;</span><span class="p">]</span>
    <span class="n">show_print_report</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;show_print_report&#39;</span><span class="p">]</span>
    <span class="n">show_table_report</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;show_table_report&#39;</span><span class="p">]</span>
    <span class="n">show_plot_report</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;show_plot_report&#39;</span><span class="p">]</span>
    <span class="n">show_html_report</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;show_html_report&#39;</span><span class="p">]</span>
    <span class="n">show_pdf_report</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;show_pdf_report&#39;</span><span class="p">]</span>
    <span class="n">suppress_report_outputs</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;suppress_report_outputs&#39;</span><span class="p">]</span>
    <span class="n">show_report_outputs</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;show_report_outputs&#39;</span><span class="p">]</span>
    <span class="n">report_export_format</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;report_export_format&#39;</span><span class="p">]</span>
    <span class="n">report_export_path</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;report_export_path&#39;</span><span class="p">]</span>
    <span class="n">csv_handling</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;csv_handling&#39;</span><span class="p">]</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span>

    <span class="c1"># Put Processing parameters in hvsr_results immediately (gets used later local function in get_report)</span>
    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;get_report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">exclude_params_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hvsr_results&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_params_list</span><span class="p">:</span>
            <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;get_report&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Getting HVSR Report: get_report()&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Using the following parameters:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;params&#39;</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">)):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">update_msg</span> <span class="o">!=</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">update_msg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">The following parameters were updated using the processing_parameters attribute:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">msg_line</span> <span class="ow">in</span> <span class="n">update_msg</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">msg_line</span><span class="p">)</span>
                    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Getting Reports: Running in batch mode&#39;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Using parameters:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>    
            <span class="nb">print</span><span class="p">()</span>
        
        <span class="c1">#If running batch, we&#39;ll loop through each site</span>
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">hvsr_results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#Make a copy so we don&#39;t accidentally overwrite</span>
            <span class="n">individual_params</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="c1">#Get what would normally be the &quot;params&quot; variable for each site</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;hvsr_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">individual_params</span> <span class="c1">#reset the params parameter we originally read in to an individual site params</span>
            <span class="k">if</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">__get_report_batch</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span> <span class="c1">#Call another function, that lets us run this function again</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span>
        
        <span class="n">combined_csvReport</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">hvsr_results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;Table_Report&#39;</span> <span class="ow">in</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">combined_csvReport</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">combined_csvReport</span><span class="p">,</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;Table_Report&#39;</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">report_export_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">report_export_path</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;input_data&#39;</span><span class="p">])</span> <span class="ow">in</span> <span class="n">sampleFileKeyMap</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">csvExportPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">csvExportPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;input_data&#39;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">report_export_path</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">csvExportPath</span> <span class="o">=</span> <span class="n">report_export_path</span>
            <span class="k">elif</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">report_export_path</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">csvExportPath</span> <span class="o">=</span> <span class="n">report_export_path</span><span class="o">.</span><span class="n">parent</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">csvExportPath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span><span class="o">.</span><span class="n">input_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">csvExportPath</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">csvExportPath</span> <span class="o">=</span> <span class="n">csvExportPath</span><span class="o">.</span><span class="n">parent</span>
                
            <span class="n">combined_csvReport</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csvExportPath</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hvsr_results</span>
    
    <span class="k">if</span> <span class="n">suppress_report_outputs</span><span class="p">:</span>
        <span class="n">show_print_report</span> <span class="o">=</span> <span class="n">show_plot_report</span> <span class="o">=</span> <span class="n">show_table_report</span> <span class="o">=</span> <span class="n">show_html_report</span> <span class="o">=</span> <span class="n">show_pdf_report</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">show_report_outputs</span><span class="p">:</span>
        <span class="n">show_print_report</span> <span class="o">=</span> <span class="n">show_plot_report</span> <span class="o">=</span> <span class="n">show_table_report</span> <span class="o">=</span> <span class="n">show_html_report</span> <span class="o">=</span> <span class="n">show_pdf_report</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1">#if &#39;BestPeak&#39; in hvsr_results.keys() and &#39;PassList&#39; in hvsr_results[&#39;BestPeak&#39;].keys():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">curvTestsPassed</span> <span class="o">=</span> <span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;WinLen&#39;</span><span class="p">]</span> <span class="o">+</span>
                            <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;SigCycles&#39;</span><span class="p">]</span><span class="o">+</span>
                            <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowCurveStD&#39;</span><span class="p">])</span>
        <span class="n">curvePass</span> <span class="o">=</span> <span class="n">curvTestsPassed</span> <span class="o">&gt;</span> <span class="mi">2</span>
        
        <span class="c1">#Peak Pass?</span>
        <span class="n">peakTestsPassed</span> <span class="o">=</span> <span class="p">(</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;ProminenceLow&#39;</span><span class="p">]</span> <span class="o">+</span>
                    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;ProminenceHi&#39;</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;AmpClarity&#39;</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;FreqStability&#39;</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">])</span>
        <span class="n">peakPass</span> <span class="o">=</span> <span class="n">peakTestsPassed</span> <span class="o">&gt;=</span> <span class="mi">5</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">errMsg</span><span class="o">=</span> <span class="s1">&#39;No BestPeak identified. Check peak_freq_range or hvsr_band or try to remove bad noise windows using remove_noise() or change processing parameters in process_hvsr() or generate_psds(). Otherwise, data may not be usable for HVSR.&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">errMsg</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">plotString_noBestPeak</span> <span class="o">=</span> <span class="s1">&#39;HVSR t all C+ t SPEC&#39;</span>
        <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;Plot_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_hvsr</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="n">plotString_noBestPeak</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hvsr_results</span>
        <span class="c1">#raise RuntimeError(&#39;No BestPeak identified. Check peak_freq_range or hvsr_band or try to remove bad noise windows using remove_noise() or change processing parameters in process_hvsr() or generate_psds(). Otherwise, data may not be usable for HVSR.&#39;)</span>

    <span class="c1"># Figure out which reports will be used, and format them correctly</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">report_formats</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">report_formats</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">rf</span> <span class="ow">in</span> <span class="n">report_formats</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#We will use a loop later even if it&#39;s just one report type, so reformat to prepare for for loop</span>
        <span class="n">allList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">report_formats</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">allList</span><span class="p">:</span>
            <span class="n">report_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">report_formats</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">report_formats</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>   

    <span class="c1"># Format the export formats correctly</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">report_export_format</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">report_export_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># We will use list methods later even if it&#39;s just one report type, so reformat as list</span>
        <span class="n">allList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">report_export_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">allList</span><span class="p">:</span>
            <span class="n">report_export_format</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">report_export_format</span> <span class="o">=</span> <span class="p">[</span><span class="n">report_export_format</span><span class="p">]</span>   

    <span class="c1"># Put print first to get results immediatley while plots and others are created</span>
    <span class="k">if</span> <span class="s1">&#39;print&#39;</span> <span class="ow">in</span> <span class="n">report_formats</span> <span class="ow">and</span> <span class="n">report_formats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;print&#39;</span><span class="p">:</span>
        <span class="n">report_formats</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="s1">&#39;plot&#39;</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="s1">&#39;pdf&#39;</span><span class="p">]</span>
        <span class="n">report_formats</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">report_formats</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;print&#39;</span><span class="p">))</span>
        <span class="n">report_formats</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;print&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rep_form</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">report_formats</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">report_export_path</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">report_formats</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;report_export_path is a list/tuple and report_formats is not. This may result in unexpected behavior.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">report_formats</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">report_export_path</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">report_formats</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">report_export_path</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;report_export_path and report_formats are both lists or tuples, but they are not the same length. This may result in unexpected behavior.&#39;</span><span class="p">)</span>
            <span class="n">exp_path</span> <span class="o">=</span> <span class="n">report_export_path</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exp_path</span> <span class="o">=</span> <span class="n">report_export_path</span>
        
        <span class="k">if</span> <span class="n">report_export_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">report_export_format</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
       
        <span class="c1"># Print_Report</span>
        <span class="k">if</span> <span class="n">rep_form</span> <span class="o">==</span> <span class="s1">&#39;print&#39;</span><span class="p">:</span>
            <span class="n">verbose_print</span> <span class="o">=</span> <span class="n">verbose</span>
            <span class="k">if</span> <span class="n">show_print_report</span><span class="p">:</span>
                <span class="n">verbose_print</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="c1"># Generates print report and saves to hvsr_results[&quot;Print_Report&quot;]</span>
            <span class="n">hsvr_results</span> <span class="o">=</span> <span class="n">_generate_print_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> 
                                <span class="n">azimuth</span> <span class="o">=</span> <span class="n">azimuth</span><span class="p">,</span> 
                                <span class="n">show_print_report</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_print</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;print&#39;</span> <span class="ow">in</span> <span class="n">report_export_format</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exp_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">print_exp_path</span> <span class="o">=</span> <span class="n">exp_path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">print_exp_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exp_path</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">)</span>
                
                <span class="n">export_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span>
                              <span class="n">report_export_format</span><span class="o">=</span><span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="n">report_export_path</span><span class="o">=</span><span class="n">print_exp_path</span><span class="p">,</span> 
                              <span class="n">show_report</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># If report is to be shown, done in previous step</span>
                              <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose_print</span><span class="p">)</span>

        <span class="c1"># Table_Report</span>
        <span class="k">elif</span> <span class="n">rep_form</span> <span class="o">==</span> <span class="s1">&#39;table&#39;</span><span class="p">:</span>
            <span class="n">verbose_table</span> <span class="o">=</span> <span class="n">verbose</span>
            <span class="k">if</span> <span class="n">show_table_report</span><span class="p">:</span>
                <span class="n">verbose_table</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="n">hsvr_results</span> <span class="o">=</span> <span class="n">_generate_table_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> 
                                <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span>
                                <span class="n">show_table_report</span><span class="o">=</span><span class="n">show_table_report</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_table</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;table&#39;</span> <span class="ow">in</span> <span class="n">report_export_format</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exp_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">table_exp_path</span> <span class="o">=</span> <span class="n">exp_path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">table_exp_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exp_path</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
                
                <span class="n">export_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span>
                            <span class="n">report_export_format</span><span class="o">=</span><span class="s1">&#39;table&#39;</span><span class="p">,</span> <span class="n">report_export_path</span><span class="o">=</span><span class="n">table_exp_path</span><span class="p">,</span>
                            <span class="n">csv_handling</span><span class="o">=</span><span class="n">csv_handling</span><span class="p">,</span>
                            <span class="n">show_report</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># If report is to be shown, done in previous step</span>
                            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose_table</span><span class="p">)</span>

        <span class="c1"># Plot_Report</span>
        <span class="k">elif</span> <span class="n">rep_form</span> <span class="o">==</span> <span class="s1">&#39;plot&#39;</span><span class="p">:</span>
            <span class="n">plot_hvsr_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">plot_hvsr</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
            <span class="k">if</span> <span class="s1">&#39;plot_type&#39;</span> <span class="ow">in</span> <span class="n">plot_hvsr_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">plot_hvsr_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;plot_type&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;plot_engine&#39;</span> <span class="ow">in</span> <span class="n">plot_hvsr_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">plot_hvsr_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;plot_engine&#39;</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_hvsr</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">plot_engine</span><span class="o">=</span><span class="n">plot_engine</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="n">show_plot_report</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">expFigAx</span> <span class="o">=</span> <span class="n">fig</span>
            
            <span class="k">if</span> <span class="s1">&#39;plot&#39;</span> <span class="ow">in</span> <span class="n">report_export_format</span><span class="p">:</span>
                <span class="n">export_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="o">=</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">report_export_path</span><span class="o">=</span><span class="n">report_export_path</span><span class="p">,</span> <span class="n">report_export_format</span><span class="o">=</span><span class="s1">&#39;plot&#39;</span><span class="p">)</span>
            <span class="c1">#hvsr_results[&#39;BestPeak&#39;][azimuth][&#39;Report&#39;][&#39;Plot_Report&#39;] = fig</span>
            <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;Plot_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fig</span>

            <span class="k">if</span> <span class="n">show_plot_report</span><span class="p">:</span><span class="c1">#&#39;show_plot&#39; in plot_hvsr_kwargs.keys() and plot_hvsr_kwargs[&#39;show_plot&#39;] is False:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">plot_engine</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Plot of data report:&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">plot_engine</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>                    
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Plot of data report created and saved in [&#39;Plot_Report&#39;] attribute&quot;</span><span class="p">)</span>

        <span class="c1"># HTML_Report</span>
        <span class="k">elif</span> <span class="n">rep_form</span> <span class="o">==</span> <span class="s1">&#39;html&#39;</span><span class="p">:</span>
            <span class="n">verbose_html</span> <span class="o">=</span> <span class="n">verbose</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">or</span> <span class="n">show_html_report</span><span class="p">:</span>
                <span class="n">verbose_html</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">_generate_html_report</span><span class="p">(</span><span class="n">hsvr_results</span><span class="p">,</span> <span class="n">show_html_report</span><span class="o">=</span><span class="n">show_html_report</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_html</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;html&#39;</span> <span class="ow">in</span> <span class="n">report_export_format</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exp_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">html_exp_path</span> <span class="o">=</span> <span class="n">exp_path</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">html_exp_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exp_path</span><span class="p">)</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="s1">&#39;.html&#39;</span><span class="p">)</span>

                <span class="n">export_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span>
                            <span class="n">report_export_format</span><span class="o">=</span><span class="s1">&#39;html&#39;</span><span class="p">,</span> <span class="n">report_export_path</span><span class="o">=</span><span class="n">html_exp_path</span><span class="p">,</span>
                            <span class="n">show_report</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="c1"># If report is to be shown, done in previous step</span>
                            <span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose_html</span><span class="p">)</span>

        <span class="c1"># PDF_Report</span>
        <span class="k">elif</span> <span class="n">rep_form</span> <span class="o">==</span> <span class="s1">&#39;pdf&#39;</span><span class="p">:</span>
            <span class="n">verbose_pdf</span> <span class="o">=</span> <span class="n">verbose</span>

            <span class="c1"># Don&#39;t repeat html printing, etc. if already done</span>
            <span class="k">if</span> <span class="s1">&#39;html&#39;</span> <span class="ow">in</span> <span class="n">report_formats</span><span class="p">:</span>
                <span class="n">show_html_report</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">show_html_report</span> <span class="o">=</span> <span class="n">show_html_report</span>

            <span class="k">if</span> <span class="n">exp_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pdf_exp_path</span> <span class="o">=</span> <span class="n">exp_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pdf_exp_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">exp_path</span><span class="p">)</span>
            <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">_generate_pdf_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">pdf_report_filepath</span><span class="o">=</span><span class="n">pdf_exp_path</span><span class="p">,</span>
                            <span class="n">show_pdf_report</span><span class="o">=</span><span class="n">show_pdf_report</span><span class="p">,</span> <span class="n">show_html_report</span><span class="o">=</span><span class="n">show_html_report</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose_pdf</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">hvsr_results</span></div>



<span class="c1"># Import data</span>
<div class="viewcode-block" id="import_data">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.import_data">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">import_data</span><span class="p">(</span><span class="n">import_filepath</span><span class="p">,</span> <span class="n">data_format</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span><span class="p">,</span> <span class="n">show_data</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to import .hvsr (or other extension) data exported using export_hvsr() function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    import_filepath : str or path object</span>
<span class="sd">        Filepath of file created using export_hvsr() function. This is usually a pickle file with a .hvsr extension</span>
<span class="sd">    data_format : str, default=&#39;pickle&#39;</span>
<span class="sd">        Type of format data is in. Currently, only &#39;pickle&#39; supported. Eventually, json or other type may be supported, by default &#39;pickle&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    HVSRData or HVSRBatch object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">sample_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;sampledata&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">import_filepath</span> <span class="ow">in</span> <span class="n">sample_list</span><span class="p">:</span>
        <span class="n">import_filepath</span> <span class="o">=</span> <span class="n">RESOURCE_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;sample_data&#39;</span><span class="p">)</span>
        <span class="n">import_filepath</span> <span class="o">=</span> <span class="n">import_filepath</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;SampleHVSRSite01.hvsr&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data_format</span> <span class="o">==</span> <span class="s1">&#39;pickle&#39;</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">import_filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dataIN</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">data_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;dataframe&#39;</span><span class="p">:</span>
        <span class="n">dataIN</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">import_filepath</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">import_filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">dataIN</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">import_filepath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">dataIN</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">show_data</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">dataIN</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">dataIN</span></div>



<span class="c1"># Import settings</span>
<div class="viewcode-block" id="import_settings">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.import_settings">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">import_settings</span><span class="p">(</span><span class="n">settings_import_path</span><span class="p">,</span> <span class="n">settings_import_type</span><span class="o">=</span><span class="s1">&#39;instrument&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to import settings, intended for use with settings saved to disk using export_settings</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    settings_import_path : pathlike object</span>
<span class="sd">        Filepath to exported settings document</span>
<span class="sd">    settings_import_type : str, optional</span>
<span class="sd">        What type of settings to export (can be &#39;instrument&#39; or &#39;all&#39;), by default &#39;instrument&#39;</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Whether to print information to terminal, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        A dictionary containing the function names as keys of internal dictionaries, </span>
<span class="sd">        with key:value pairs for each parameter name:value in that function.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="s1">&#39;any&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">settings_import_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allList</span><span class="p">:</span>
        <span class="c1"># if just a single settings dict is desired</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">settings_import_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">settingsDict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Either a directory or list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">settings_import_path</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">setPath</span> <span class="ow">in</span> <span class="n">settings_import_path</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">settings_import_path</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_checkifpath</span><span class="p">(</span><span class="n">settings_import_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">settings_import_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;settings_import_type=</span><span class="si">{</span><span class="n">settings_import_type</span><span class="si">}</span><span class="s1">, but settings_import_path is not list/tuple or filepath to directory&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">instFile</span> <span class="o">=</span> <span class="n">settings_import_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.inst&#39;</span><span class="p">)</span>
                <span class="n">procFile</span> <span class="o">=</span> <span class="n">settings_import_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.proc&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">settingsDict</span></div>



<span class="c1"># Define input parameters</span>
<div class="viewcode-block" id="input_params">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.input_params">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">input_params</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span>
                <span class="n">site</span><span class="o">=</span><span class="s1">&#39;HVSRSite&#39;</span><span class="p">,</span>
                <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">network</span><span class="o">=</span><span class="s1">&#39;AM&#39;</span><span class="p">,</span> 
                <span class="n">station</span><span class="o">=</span><span class="s1">&#39;NONE&#39;</span><span class="p">,</span> 
                <span class="n">location</span><span class="o">=</span><span class="s1">&#39;00&#39;</span><span class="p">,</span> 
                <span class="n">channels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;EHZ&#39;</span><span class="p">,</span> <span class="s1">&#39;EHN&#39;</span><span class="p">,</span> <span class="s1">&#39;EHE&#39;</span><span class="p">],</span>
                <span class="n">acq_date</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">starttime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">endtime</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">tzone</span> <span class="o">=</span> <span class="s1">&#39;UTC&#39;</span><span class="p">,</span>
                <span class="n">xcoord</span> <span class="o">=</span> <span class="o">-</span><span class="mf">88.229</span><span class="p">,</span>
                <span class="n">ycoord</span> <span class="o">=</span>  <span class="mf">40.101</span><span class="p">,</span>
                <span class="n">elevation</span> <span class="o">=</span> <span class="mi">225</span><span class="p">,</span>
                <span class="n">input_crs</span> <span class="o">=</span> <span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span> <span class="c1">#Default is WGS84,#4269 is NAD83</span>
                <span class="n">output_crs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">elev_unit</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span><span class="p">,</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="n">instrument</span> <span class="o">=</span> <span class="s2">&quot;Seismometer&quot;</span><span class="p">,</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">hvsr_band</span> <span class="o">=</span> <span class="n">DEFAULT_BAND</span><span class="p">,</span>
                <span class="n">peak_freq_range</span> <span class="o">=</span> <span class="n">DEFAULT_BAND</span><span class="p">,</span>
                <span class="n">processing_parameters</span><span class="o">=</span><span class="p">{},</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function for designating input parameters for reading in and processing data</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_data : str or pathlib.Path object</span>
<span class="sd">        Filepath of data. This can be a directory or file, but will need to match with what is chosen later as the source parameter in fetch_data()</span>
<span class="sd">    site : str, default=&quot;HVSR Site&quot;</span>
<span class="sd">        Site name as designated by user for ease of reference. Used for plotting titles, filenames, etc.</span>
<span class="sd">    project : str, default=None</span>
<span class="sd">        A prefix that may be used to create unique identifiers for each site. </span>
<span class="sd">        The identifier created is saved as the [&#39;HVSR_ID&#39;] attribute of the HVSRData object,</span>
<span class="sd">        and is equivalent to the following formatted string:</span>
<span class="sd">        f&quot;{project}-{acq_date.strftime(&quot;%Y%m%d&quot;)}-{starttime.strftime(&quot;%H%M&quot;)}-{station}&quot;.</span>
<span class="sd">    network : str, default=&#39;AM&#39;</span>
<span class="sd">        The network designation of the seismometer. This is necessary for data from Raspberry Shakes. &#39;AM&#39; is for Amateur network, which fits Raspberry Shakes.</span>
<span class="sd">    station : str, default=&#39;None&#39;</span>
<span class="sd">        The station name of the seismometer. This is necessary for data from Raspberry Shakes.</span>
<span class="sd">    location : str, default=&#39;00&#39;</span>
<span class="sd">        Location information of the seismometer.</span>
<span class="sd">    channels : list, default=[&#39;EHZ&#39;, &#39;EHN&#39;, &#39;EHE&#39;]</span>
<span class="sd">        The three channels used in this analysis, as a list of strings. Preferred that Z component is first, but not necessary</span>
<span class="sd">    acq_date : str, int, date object, or datetime object</span>
<span class="sd">        If string, preferred format is &#39;YYYY-MM-DD&#39;. </span>
<span class="sd">        If int, this will be interpreted as the time_int of year of current year (e.g., 33 would be Feb 2 of current year)</span>
<span class="sd">        If date or datetime object, this will be the date. Make sure to account for time change when converting to UTC (if UTC is the following time_int, use the UTC time_int).</span>
<span class="sd">    starttime : str, time object, or datetime object, default=&#39;00:00:00.00&#39;</span>
<span class="sd">        Start time of data stream. This is necessary for Raspberry Shake data in &#39;raw&#39; form, or for trimming data. Format can be either &#39;HH:MM:SS.micros&#39; or &#39;HH:MM&#39; at minimum.</span>
<span class="sd">    endtime : str, time obejct, or datetime object, default=&#39;23:59:99.99&#39;</span>
<span class="sd">        End time of data stream. This is necessary for Raspberry Shake data in &#39;raw&#39; form, or for trimming data. Same format as starttime.</span>
<span class="sd">    tzone : str or int, default = &#39;UTC&#39;</span>
<span class="sd">        Timezone of input data. If string, &#39;UTC&#39; will use the time as input directly. Any other string value needs to be a TZ identifier in the IANA database, a wikipedia page of these is available here: https://en.wikipedia.org/wiki/List_of_tz_database_time_zones.</span>
<span class="sd">        If int, should be the int value of the UTC offset (e.g., for American Eastern Standard Time: -5). </span>
<span class="sd">        This is necessary for Raspberry Shake data in &#39;raw&#39; format.</span>
<span class="sd">    xcoord : float, default=-88.2290526</span>
<span class="sd">        Longitude (or easting, or, generally, X coordinate) of data point, in Coordinate Reference System (CRS) designated by input_crs. Currently only used in table output, but will likely be used in future for mapping/profile purposes.</span>
<span class="sd">    ycoord : float, default=40.1012122</span>
<span class="sd">        Latitute (or northing, or, generally, X coordinate) of data point, in Coordinate Reference System (CRS) designated by input_crs. Currently only used in table output, but will likely be used in future for mapping/profile purposes.</span>
<span class="sd">    input_crs : str or other format read by pyproj, default=&#39;EPSG:4326&#39;</span>
<span class="sd">        Coordinate reference system of input data, as used by pyproj.CRS.from_user_input()</span>
<span class="sd">    output_crs : str or other format read by pyproj, default=&#39;EPSG:4326&#39;</span>
<span class="sd">        Coordinate reference system to which input data will be transformed, as used by pyproj.CRS.from_user_input()</span>
<span class="sd">    elevation : float, default=755</span>
<span class="sd">        Surface elevation of data point. Not currently used (except in table output), but will likely be used in the future.</span>
<span class="sd">    depth : float, default=0</span>
<span class="sd">        Depth of seismometer. Not currently used, but will likely be used in the future.</span>
<span class="sd">    instrument : str {&#39;Raspberry Shake&#39;, &quot;Tromino&quot;}</span>
<span class="sd">        Instrument from which the data was acquired. </span>
<span class="sd">    metadata : str or pathlib.Path object, default=None</span>
<span class="sd">        Filepath of metadata, in format supported by obspy.read_inventory. If default value of None, will read from resources folder of repository (only supported for Raspberry Shake).</span>
<span class="sd">    hvsr_band : list, default=[0.1, 50]</span>
<span class="sd">        Two-element list containing low and high &quot;corner&quot; frequencies (in Hz) for processing. This can specified again later.</span>
<span class="sd">    peak_freq_range : list or tuple, default=[0.1, 50]</span>
<span class="sd">        Two-element list or tuple containing low and high frequencies (in Hz) that are used to check for HVSR Peaks. This can be a tigher range than hvsr_band, but if larger, it will still only use the hvsr_band range.</span>
<span class="sd">    processing_parameters={} : dict or filepath, default={}</span>
<span class="sd">        If filepath, should point to a .proc json file with processing parameters (i.e, an output from sprit.export_settings()). </span>
<span class="sd">        Note that this only applies to parameters for the functions: &#39;fetch_data&#39;, &#39;remove_noise&#39;, &#39;generate_psds&#39;, &#39;process_hvsr&#39;, &#39;check_peaks&#39;, and &#39;get_report.&#39;</span>
<span class="sd">        If dictionary, dictionary containing nested dictionaries of function names as they key, and the parameter names/values as key/value pairs for each key. </span>
<span class="sd">        If a function name is not present, or if a parameter name is not present, default values will be used.</span>
<span class="sd">        For example: </span>
<span class="sd">            `{ &#39;fetch_data&#39; : {&#39;source&#39;:&#39;batch&#39;, &#39;data_export_path&#39;:&quot;/path/to/trimmed/data&quot;, &#39;data_export_format&#39;:&#39;mseed&#39;, &#39;detrend&#39;:&#39;spline&#39;, &#39;plot_input_stream&#39;:True, &#39;verbose&#39;:False, kwargs:{&#39;kwargskey&#39;:&#39;kwargsvalue&#39;}} }`</span>
<span class="sd">    verbose : bool, default=False</span>
<span class="sd">        Whether to print output and results to terminal</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    params : sprit.HVSRData</span>
<span class="sd">        sprit.HVSRData class containing input parameters, including data file path and metadata path. This will be used as an input to other functions. If batch processing, params will be converted to batch type in fetch_data() step.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orig_args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#Get the initial arguments</span>
    <span class="c1"># Record starting time for this function run</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="c1"># Record any updates that are made to input_params based</span>
    <span class="n">update_msg</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Reformat times</span>
    <span class="c1"># Date will come out of this block as a string of datetime.date</span>
    <span class="k">if</span> <span class="n">acq_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">acq_date</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">acq_date</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">acq_date</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span>
        <span class="n">date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">acq_date</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">acq_date</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">monthStrs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;jan&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;january&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;feb&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;february&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                    <span class="s1">&#39;mar&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;march&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span>
                    <span class="s1">&#39;apr&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;april&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                    <span class="s1">&#39;may&#39;</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span>
                    <span class="s1">&#39;jun&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;june&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span>
                    <span class="s1">&#39;jul&#39;</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;july&#39;</span><span class="p">:</span><span class="mi">7</span><span class="p">,</span>
                    <span class="s1">&#39;aug&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span> <span class="s1">&#39;august&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
                    <span class="s1">&#39;sep&#39;</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;sept&#39;</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span> <span class="s1">&#39;september&#39;</span><span class="p">:</span><span class="mi">9</span><span class="p">,</span>
                    <span class="s1">&#39;oct&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;october&#39;</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> 
                    <span class="s1">&#39;nov&#39;</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span><span class="s1">&#39;november&#39;</span><span class="p">:</span><span class="mi">11</span><span class="p">,</span>
                    <span class="s1">&#39;dec&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span><span class="s1">&#39;december&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">}</span>

        <span class="n">spelledMonth</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">monthStrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">acq_date</span> <span class="o">=</span> <span class="n">acq_date</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">acq_date</span><span class="p">:</span>
                <span class="n">spelledMonth</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">spelledMonth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">month</span> <span class="o">=</span> <span class="n">monthStrs</span><span class="p">[</span><span class="n">m</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">acq_date</span><span class="p">:</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">acq_date</span><span class="p">:</span>
            <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;.&#39;</span>
        <span class="k">elif</span> <span class="s1">&#39; &#39;</span> <span class="ow">in</span> <span class="n">acq_date</span><span class="p">:</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span>
            <span class="n">acq_date</span> <span class="o">=</span> <span class="n">acq_date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>

        <span class="n">acq_date</span> <span class="o">=</span> <span class="n">acq_date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">acq_date</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span> <span class="c1">#American format</span>
            <span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq_date</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">acq_date</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">acq_date</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1">#international format, one we&#39;re going to use</span>
            <span class="n">date</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">-</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">acq_date</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">acq_date</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">acq_date</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>     
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">acq_date</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">year</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        <span class="n">date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">acq_date</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>

    <span class="c1"># Starttime will be standardized as string, then converted to UTCDateTime</span>
    <span class="c1"># If not specified, will be set to 00:00 of current UTC date</span>
    <span class="k">if</span> <span class="n">starttime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">NOWTIME</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">NOWTIME</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">NOWTIME</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">starttime</span><span class="p">:</span>
            <span class="c1">#date=starttime.split(&#39;T&#39;)[0]</span>
            <span class="n">starttime</span> <span class="o">=</span> <span class="n">starttime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
            <span class="c1">#starttime = date+&#39;T&#39;+starttime</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
        <span class="c1">#date = str(starttime.date())</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">starttime</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="c1">###HERE IS NEXT</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">):</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;T&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span>
    <span class="n">starttime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_format_time</span><span class="p">(</span><span class="n">starttime</span><span class="p">,</span> <span class="n">tzone</span><span class="o">=</span><span class="n">tzone</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">],</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">)</span> <span class="ow">or</span> <span class="n">starttime</span> <span class="o">!=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]:</span>
        <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">starttime was updated from </span><span class="si">{</span><span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">starttime</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># endtime will be standardized as string, then converted to UTCDateTime</span>
    <span class="c1"># If not specified, will be set to 23:59:59.999999 of current UTC date</span>
    <span class="k">if</span> <span class="n">endtime</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">endtime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">NOWTIME</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">NOWTIME</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">NOWTIME</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">999999</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">endtime</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;T&#39;</span> <span class="ow">in</span> <span class="n">endtime</span><span class="p">:</span>
            <span class="n">date</span><span class="o">=</span><span class="n">endtime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">endtime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">endtime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">endtime</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
        <span class="n">endtime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">endtime</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">endtime</span><span class="p">)</span> <span class="ow">is</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">():</span>
        <span class="n">endtime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">endtime</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">endtime</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">):</span>
        <span class="n">endtime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">date</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;T&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">endtime</span><span class="p">)</span>
    <span class="n">endtime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_format_time</span><span class="p">(</span><span class="n">endtime</span><span class="p">,</span> <span class="n">tzone</span><span class="o">=</span><span class="n">tzone</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">],</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">)</span> <span class="ow">or</span> <span class="n">starttime</span> <span class="o">!=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]:</span>
        <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">endtime was updated from </span><span class="si">{</span><span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">endtime</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">acq_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">month</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">day</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]))</span>
    <span class="k">if</span> <span class="n">acq_date</span> <span class="o">!=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]:</span>
        <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">acq_date was updated from </span><span class="si">{</span><span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">acq_date</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">raspShakeInstNameList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raspberry shake&#39;</span><span class="p">,</span> <span class="s1">&#39;shake&#39;</span><span class="p">,</span> <span class="s1">&#39;raspberry&#39;</span><span class="p">,</span> <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;rs3d&#39;</span><span class="p">,</span> <span class="s1">&#39;rasp. shake&#39;</span><span class="p">,</span> <span class="s1">&#39;raspshake&#39;</span><span class="p">]</span>
    
    <span class="c1"># If no CRS specified, assume WGS84</span>
    <span class="k">if</span> <span class="n">input_crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">input_crs</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">No value specified for input_crs, assuming WGS84 (EPSG:4326)&quot;</span><span class="p">)</span>
        <span class="n">input_crs</span> <span class="o">=</span> <span class="s1">&#39;EPSG:4326&#39;</span>
    
    <span class="k">if</span> <span class="n">output_crs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">No value specified for output_crs, using same coordinate system is input_crs: (</span><span class="si">{</span><span class="n">input_crs</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">output_crs</span> <span class="o">=</span> <span class="n">input_crs</span>

    <span class="k">if</span> <span class="n">xcoord</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">xcoord</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">xcoord</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xcoord</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">xcoord</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ycoord</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ycoord</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">ycoord</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ycoord</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ycoord</span><span class="p">)</span>
    <span class="c1"># Get CRS Objects</span>
    <span class="n">input_crs</span> <span class="o">=</span> <span class="n">CRS</span><span class="o">.</span><span class="n">from_user_input</span><span class="p">(</span><span class="n">input_crs</span><span class="p">)</span>
    <span class="n">output_crs</span> <span class="o">=</span> <span class="n">CRS</span><span class="o">.</span><span class="n">from_user_input</span><span class="p">(</span><span class="n">output_crs</span><span class="p">)</span>

    <span class="c1"># We always need latitude and longitude, so specify this regadless of in/output crs</span>
    <span class="c1"># Get WGS84 coordinates (needed for inventory)</span>
    <span class="n">wgs84_crs</span> <span class="o">=</span> <span class="n">CRS</span><span class="o">.</span><span class="n">from_user_input</span><span class="p">(</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">)</span>
    <span class="n">wgs84_transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">input_crs</span><span class="p">,</span> <span class="n">wgs84_crs</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">xcoord_wgs84</span><span class="p">,</span> <span class="n">ycoord_wgs84</span> <span class="o">=</span> <span class="n">wgs84_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">xcoord</span><span class="p">,</span> <span class="n">ycoord</span><span class="p">)</span>

    <span class="n">xcoord_wgs84</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">xcoord_wgs84</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">ycoord_wgs84</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">ycoord_wgs84</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>

    <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">Longitude (</span><span class="si">{</span><span class="n">xcoord_wgs84</span><span class="si">}</span><span class="s2">) and Latitude (</span><span class="si">{</span><span class="n">ycoord_wgs84</span><span class="si">}</span><span class="s2">) calculated for compatibility with obspy.&quot;</span><span class="p">)</span>

    <span class="c1"># Get coordinates in CRS specified in output_crs</span>
    <span class="n">xcoordIN</span> <span class="o">=</span> <span class="n">xcoord</span>
    <span class="n">ycoordIN</span> <span class="o">=</span> <span class="n">ycoord</span>
    <span class="n">coord_transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">input_crs</span><span class="p">,</span> <span class="n">output_crs</span><span class="p">,</span> <span class="n">always_xy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">xcoord</span><span class="p">,</span> <span class="n">ycoord</span> <span class="o">=</span> <span class="n">coord_transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">xcoordIN</span><span class="p">,</span> <span class="n">ycoordIN</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processing_parameters</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">processing_parameters</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_checkifpath</span><span class="p">(</span><span class="n">processing_parameters</span><span class="p">)</span>
        <span class="n">processing_parameters</span> <span class="o">=</span> <span class="n">import_settings</span><span class="p">(</span><span class="n">processing_parameters</span><span class="p">,</span> <span class="n">settings_import_type</span><span class="o">=</span><span class="s1">&#39;processing&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Get elevation in meters</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">elev_unit</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;feet&#39;</span><span class="p">,</span> <span class="s1">&#39;foot&#39;</span><span class="p">,</span> <span class="s1">&#39;ft&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;imperial&#39;</span><span class="p">,</span> <span class="s1">&#39;imp&#39;</span><span class="p">,</span> <span class="s1">&#39;american&#39;</span><span class="p">,</span> <span class="s1">&#39;us&#39;</span><span class="p">]:</span>
        <span class="n">elevation</span> <span class="o">=</span> <span class="n">elevation</span> <span class="o">*</span> <span class="mf">0.3048</span>
        <span class="n">elev_unit</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span>
        <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> Elevations are automatically converted to meters during processing&quot;</span><span class="p">)</span>
        <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> elevation was updated to </span><span class="si">{</span><span class="n">elevation</span><span class="si">}</span><span class="s2"> m (from </span><span class="si">{</span><span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> ft)&quot;</span><span class="p">)</span>
        <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> elev_unit was also updated to </span><span class="si">{</span><span class="n">elev_unit</span><span class="si">}</span><span class="s2"> (from </span><span class="si">{</span><span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;elev_unit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    
    <span class="c1"># Create a unique identifier for each site</span>
    <span class="k">if</span> <span class="n">project</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">proj_id</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">proj_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">project</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;-&#39;</span>
    
    <span class="n">hvsr_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">proj_id</span><span class="si">}{</span><span class="n">acq_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">starttime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">station</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">hvsr_id generated from input parameters: </span><span class="si">{</span><span class="n">hvsr_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1">#Add key/values to input parameter dictionary for use throughout the rest of the package</span>
    <span class="n">inputParamDict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;site&#39;</span><span class="p">:</span><span class="n">site</span><span class="p">,</span> <span class="s1">&#39;project&#39;</span><span class="p">:</span><span class="n">project</span><span class="p">,</span> <span class="s1">&#39;hvsr_id&#39;</span><span class="p">:</span><span class="n">hvsr_id</span><span class="p">,</span> <span class="s1">&#39;network&#39;</span><span class="p">:</span><span class="n">network</span><span class="p">,</span> <span class="s1">&#39;station&#39;</span><span class="p">:</span><span class="n">station</span><span class="p">,</span><span class="s1">&#39;location&#39;</span><span class="p">:</span><span class="n">location</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">:</span><span class="n">channels</span><span class="p">,</span>
                      <span class="s1">&#39;net&#39;</span><span class="p">:</span><span class="n">network</span><span class="p">,</span><span class="s1">&#39;sta&#39;</span><span class="p">:</span><span class="n">station</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span><span class="n">location</span><span class="p">,</span> <span class="s1">&#39;cha&#39;</span><span class="p">:</span><span class="n">channels</span><span class="p">,</span> <span class="s1">&#39;instrument&#39;</span><span class="p">:</span><span class="n">instrument</span><span class="p">,</span>
                      <span class="s1">&#39;acq_date&#39;</span><span class="p">:</span><span class="n">acq_date</span><span class="p">,</span><span class="s1">&#39;starttime&#39;</span><span class="p">:</span><span class="n">starttime</span><span class="p">,</span><span class="s1">&#39;endtime&#39;</span><span class="p">:</span><span class="n">endtime</span><span class="p">,</span> <span class="s1">&#39;timezone&#39;</span><span class="p">:</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span> <span class="c1">#Will be in UTC by this point</span>
                      <span class="s1">&#39;xcoord_input&#39;</span><span class="p">:</span><span class="n">xcoordIN</span><span class="p">,</span> <span class="s1">&#39;ycoord_input&#39;</span><span class="p">:</span> <span class="n">ycoordIN</span> <span class="p">,</span><span class="s1">&#39;xcoord&#39;</span><span class="p">:</span><span class="n">xcoord</span><span class="p">,</span> <span class="s1">&#39;ycoord&#39;</span><span class="p">:</span><span class="n">ycoord</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">:</span><span class="n">xcoord_wgs84</span><span class="p">,</span><span class="s1">&#39;latitude&#39;</span><span class="p">:</span><span class="n">ycoord_wgs84</span><span class="p">,</span>
                      <span class="s1">&#39;elevation&#39;</span><span class="p">:</span><span class="n">elevation</span><span class="p">,</span> <span class="s1">&#39;elev_unit&#39;</span><span class="p">:</span><span class="n">elev_unit</span><span class="p">,</span> <span class="s1">&#39;input_crs&#39;</span><span class="p">:</span><span class="n">input_crs</span><span class="p">,</span> <span class="s1">&#39;output_crs&#39;</span><span class="p">:</span><span class="n">output_crs</span><span class="p">,</span>
                      <span class="s1">&#39;depth&#39;</span><span class="p">:</span><span class="n">depth</span><span class="p">,</span> <span class="s1">&#39;input_data&#39;</span><span class="p">:</span> <span class="n">input_data</span><span class="p">,</span> <span class="s1">&#39;metadata&#39;</span><span class="p">:</span><span class="n">metadata</span><span class="p">,</span> <span class="s1">&#39;hvsr_band&#39;</span><span class="p">:</span><span class="n">hvsr_band</span><span class="p">,</span> <span class="s1">&#39;peak_freq_range&#39;</span><span class="p">:</span><span class="n">peak_freq_range</span><span class="p">,</span>
                      <span class="s1">&#39;processing_parameters&#39;</span><span class="p">:</span><span class="n">processing_parameters</span><span class="p">,</span> <span class="s1">&#39;processing_status&#39;</span><span class="p">:{</span><span class="s1">&#39;input_params_status&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;overall_status&#39;</span><span class="p">:</span><span class="kc">True</span><span class="p">}</span>
                      <span class="p">}</span>
    

    <span class="c1">#Replace any default parameter settings with those from json file of interest, potentially</span>
    <span class="n">instrument_settings_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">instrument</span><span class="p">))</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">instrument_settings</span> <span class="o">=</span> <span class="n">import_settings</span><span class="p">(</span><span class="n">settings_import_path</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span> <span class="n">settings_import_type</span><span class="o">=</span><span class="s1">&#39;instrument&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">input_params_args</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">input_params</span><span class="p">)</span><span class="o">.</span><span class="n">args</span>
        <span class="n">input_params_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;net&#39;</span><span class="p">)</span>
        <span class="n">input_params_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;sta&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">settings_value</span> <span class="ow">in</span> <span class="n">instrument_settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_params_args</span><span class="p">:</span>
                <span class="n">instrument_settings_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings_value</span>
        <span class="n">inputParamDict</span><span class="p">[</span><span class="s1">&#39;instrument_settings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inputParamDict</span><span class="p">[</span><span class="s1">&#39;instrument&#39;</span><span class="p">]</span>
        <span class="n">inputParamDict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">instrument_settings_dict</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">instrument</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">raspShakeInstNameList</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">metadata</span><span class="o">==</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">files</span><span class="p">(</span><span class="s1">&#39;sprit&#39;</span><span class="p">)))</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;resources&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;rs3dv5plus_metadata.inv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
            <span class="n">inputParamDict</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>

    <span class="k">for</span> <span class="n">settingName</span> <span class="ow">in</span> <span class="n">instrument_settings_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">settingName</span> <span class="ow">in</span> <span class="n">inputParamDict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">inputParamDict</span><span class="p">[</span><span class="n">settingName</span><span class="p">]</span> <span class="o">=</span> <span class="n">instrument_settings_dict</span><span class="p">[</span><span class="n">settingName</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Gathering input parameters (input_params())&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">inputParamDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">()</span>

        <span class="n">update_msg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">The following parameters were modified from the raw input:&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">msg_line</span> <span class="ow">in</span> <span class="n">update_msg</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">msg_line</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
        
    <span class="c1">#Format everything nicely</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_make_it_classy</span><span class="p">(</span><span class="n">inputParamDict</span><span class="p">)</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;input_params_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_processing_status</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span> <span class="n">func_name</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">params</span></div>



<span class="c1"># Plot Azimuth data</span>
<div class="viewcode-block" id="plot_azimuth">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.plot_azimuth">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_azimuth</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_azimuth_peaks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interpolate_azimuths</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_azimuth_grid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_azimuth_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to plot azimuths when azimuths are calculated</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_data : HVSRData or HVSRBatch</span>
<span class="sd">        HVSRData that has gone through at least the sprit.fetch_data() step, and before sprit.generate_psds()</span>
<span class="sd">    show_azimuth_peaks : bool, optional</span>
<span class="sd">        Whether to display the peak value at each azimuth calculated on the chart, by default False</span>
<span class="sd">    interpolate_azimuths : bool, optional</span>
<span class="sd">        Whether to interpolate the azimuth data to get a smoother plot. </span>
<span class="sd">        This is just for visualization, does not change underlying data.</span>
<span class="sd">        It takes a lot of time to process the data, but interpolation for vizualization can happen fairly fast. By default True.</span>
<span class="sd">    show_azimuth_grid : bool, optional</span>
<span class="sd">        Whether to display the grid on the chart, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matplotlib.Figure, matplotlib.Axis</span>
<span class="sd">        Figure and axis of resulting azimuth plot</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orig_args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#Get the initial arguments</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="c1">#If running batch, we&#39;ll loop through each site</span>
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#Make a copy so we don&#39;t accidentally overwrite</span>
            <span class="n">individual_params</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="c1">#Get what would normally be the &quot;params&quot; variable for each site</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">individual_params</span> <span class="c1">#reset the params parameter we originally read in to an individual site params</span>
            <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Azimuth_Fig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__plot_azimuth_batch</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span> <span class="c1">#Call another function, that lets us run this function again</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: </span><span class="si">{</span><span class="n">site_name</span><span class="si">}</span><span class="s2"> will not have azimuths plotted.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

        <span class="n">hvsr_band</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_band</span>

        <span class="n">azDataList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">azExtraDataList</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_az</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">currData</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_az</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">azDataList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currData</span><span class="p">)</span>
            <span class="n">azExtraDataList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">currData</span><span class="p">)</span>
        
            
        <span class="n">freq</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">x_freqs</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_az</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">azDataList</span><span class="p">)</span>
        <span class="n">z2</span> <span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">azExtraDataList</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">interp_along_theta</span><span class="p">(</span><span class="n">orig_array</span><span class="p">,</span> <span class="n">orig_ind</span><span class="p">):</span>
            <span class="n">newArrayList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a1</span> <span class="ow">in</span> <span class="n">orig_array</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
                <span class="c1"># Resample the array along the first dimension using numpy.interp</span>
                <span class="n">newZ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">180</span><span class="p">),</span>  <span class="c1"># New indices</span>
                    <span class="n">orig_ind</span><span class="p">,</span>  <span class="c1"># Original indices</span>
                    <span class="n">a1</span><span class="p">)</span>
                <span class="n">newArrayList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newZ</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newArrayList</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="s1">&#39;plot_type&#39;</span> <span class="ow">in</span> <span class="n">plot_azimuth_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;i&#39;</span> <span class="ow">in</span> <span class="n">plot_azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]:</span>
                <span class="n">interpolate_azimuths</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;-i&#39;</span> <span class="ow">in</span> <span class="n">plot_azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]:</span>
                <span class="n">interpolate_azimuths</span> <span class="o">=</span> <span class="kc">False</span>


        <span class="k">if</span> <span class="n">interpolate_azimuths</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">interp_along_theta</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
            <span class="n">z2</span> <span class="o">=</span> <span class="n">interp_along_theta</span><span class="p">(</span><span class="n">z2</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

            <span class="n">a</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">180</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">r</span><span class="p">,</span> <span class="n">th</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
        <span class="n">r2</span><span class="p">,</span> <span class="n">th2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>

        <span class="c1"># Set up plot</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">polar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_theta_zero_location</span><span class="p">(</span><span class="s2">&quot;N&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_theta_direction</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="n">hvsr_band</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hvsr_band</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="c1"># Plot data</span>
        <span class="n">pmesh1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">th</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;jet&#39;</span><span class="p">)</span>
        <span class="n">pmesh2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">th2</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;jet&#39;</span><span class="p">)</span>

        <span class="n">azList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">,</span> <span class="s1">&#39;az&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;radial&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">]</span>
        <span class="n">azOpts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;plot_type&#39;</span> <span class="ow">in</span> <span class="n">plot_azimuth_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">plot_azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">ptList</span> <span class="o">=</span> <span class="n">plot_azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plot_azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">ptList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plot_azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">az</span> <span class="ow">in</span> <span class="n">azList</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">az</span> <span class="ow">in</span> <span class="n">ptList</span><span class="p">:</span>
                    <span class="n">azOpts</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ptList</span><span class="p">[</span><span class="n">ptList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">az</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:]]</span>

        <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">azOpts</span><span class="p">:</span>
            <span class="n">show_azimuth_peaks</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="s1">&#39;g&#39;</span> <span class="ow">in</span> <span class="n">azOpts</span><span class="p">:</span>
            <span class="n">show_azimuth_grid</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">show_azimuth_peaks</span><span class="p">:</span>
            <span class="n">peakVals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">peakThetas</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_az</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="n">peakVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">BestPeak</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span>
                <span class="n">peakThetas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="n">peakThetas</span> <span class="o">=</span> <span class="n">peakThetas</span> <span class="o">+</span> <span class="p">(</span><span class="mi">180</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peakThetas</span><span class="p">))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">peakThetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">peakThetas</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">peakVals</span> <span class="o">=</span> <span class="n">peakVals</span> <span class="o">+</span> <span class="n">peakVals</span>
            <span class="n">peakVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peakVals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">peakThetas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peakThetas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">peakThetas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peakThetas</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>

            <span class="n">peakThetas</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">peakThetas</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;full&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">newThetas</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">newVals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">peakThetas</span><span class="p">):</span>
                <span class="n">newThetas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">newThetas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">newVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peakVals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">newVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peakVals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">newVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peakVals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                    <span class="n">newVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">peakVals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">newThetas</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">newThetas</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">newThetas</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="n">newVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newVals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">newThetas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newThetas</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="c1">#peakThetas = newThetas</span>
            <span class="c1">#peakVals = newVals</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peakThetas</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
                <span class="n">alphaVal</span> <span class="o">=</span> <span class="mf">0.2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">alphaVal</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">-</span> <span class="p">(</span><span class="mi">19</span><span class="o">/</span><span class="mi">28</span><span class="p">)</span> 
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">peakThetas</span><span class="p">,</span> <span class="n">peakVals</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alphaVal</span><span class="p">)</span>
        <span class="c1">#plt.plot(a, r, ls=&#39;none&#39;, color = &#39;k&#39;) </span>

        <span class="k">if</span> <span class="n">show_azimuth_grid</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="n">show_azimuth_grid</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="n">show_azimuth_grid</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#plt.colorbar(pmesh1)</span>
        <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;AzimuthFig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fig</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;hvsr_data must be of type HVSRData or HVSRBatch, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>



<span class="c1"># Main function for plotting results</span>
<div class="viewcode-block" id="plot_hvsr">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.plot_hvsr">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="n">DEFAULT_PLOT_STR</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="s1">&#39;HV&#39;</span><span class="p">,</span> <span class="n">use_subplots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">plot_engine</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">close_figs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">clear_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to plot HVSR data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_data : dict                  </span>
<span class="sd">        Dictionary containing output from process_hvsr function</span>
<span class="sd">    plot_type : str or list, default = &#39;HVSR ann p C+ ann p SPEC ann p&#39;</span>
<span class="sd">        The plot_type of plot(s) to plot. If list, will plot all plots listed</span>
<span class="sd">        - &#39;HVSR&#39; - Standard HVSR plot, including standard deviation. Options are included below:</span>
<span class="sd">            - &#39;p&#39; shows a vertical dotted line at frequency of the &quot;best&quot; peak</span>
<span class="sd">            - &#39;ann&#39; annotates the frequency value of of the &quot;best&quot; peak</span>
<span class="sd">            - &#39;all&#39; shows all the peaks identified in check_peaks() (by default, only the max is identified)</span>
<span class="sd">            - &#39;t&#39; shows the H/V curve for all time windows</span>
<span class="sd">            - &#39;tp&#39; shows all the peaks from the H/V curves of all the time windows</span>
<span class="sd">            - &#39;fr&#39; shows the window within which SpRIT will search for peak frequencies, as set by peak_freq_range</span>
<span class="sd">            - &#39;test&#39; shows a visualization of the results of the peak validity test(s). Examples:</span>
<span class="sd">                - &#39;tests&#39; visualizes the results of all the peak tests (not the curve tests)</span>
<span class="sd">                - &#39;test12&#39; shows the results of tests 1 and 2.</span>
<span class="sd">                    - Append any number 1-6 after &#39;test&#39; to show a specific test result visualized</span>
<span class="sd">        - &#39;COMP&#39; - plot of the PPSD curves for each individual component (&quot;C&quot; also works)</span>
<span class="sd">            - &#39;+&#39; (as a suffix in &#39;C+&#39; or &#39;COMP+&#39;) plots C on a plot separate from HVSR (C+ is default, but without + will plot on the same plot as HVSR)</span>
<span class="sd">            - &#39;p&#39; shows a vertical dotted line at frequency of the &quot;best&quot; peak</span>
<span class="sd">            - &#39;ann&#39; annotates the frequency value of of the &quot;best&quot; peak</span>
<span class="sd">            - &#39;all&#39; shows all the peaks identified in check_peaks() (by default, only the max is identified)</span>
<span class="sd">            - &#39;t&#39; shows the H/V curve for all time windows</span>
<span class="sd">        - &#39;SPEC&#39; - spectrogram style plot of the H/V curve over time</span>
<span class="sd">            - &#39;p&#39; shows a horizontal dotted line at the frequency of the &quot;best&quot; peak</span>
<span class="sd">            - &#39;ann&#39; annotates the frequency value of the &quot;best&quot; peak</span>
<span class="sd">            - &#39;all&#39; shows all the peaks identified in check_peaks()</span>
<span class="sd">            - &#39;tp&#39; shows all the peaks of the H/V curve at all time windows</span>
<span class="sd">        - &#39;AZ&#39; - circular plot of calculated azimuthal HV curves, similar in style to SPEC plot.</span>
<span class="sd">            - &#39;p&#39; shows a point at each calculated (not interpolated) azimuth peak</span>
<span class="sd">            - &#39;g&#39; shows grid lines at various angles</span>
<span class="sd">            - &#39;i&#39; interpolates so that there is an interpolated azimuth at each degree interval (1 degree step)</span>
<span class="sd">                This is the default, so usually &#39;i&#39; is not needed.</span>
<span class="sd">            - &#39;-i&#39; prohibits interpolation (only shows the calculated azimuths, as determined by azimuth_angle (default = 30))</span>
<span class="sd">    azimuth : str, default = &#39;HV&#39;</span>
<span class="sd">        What &#39;azimuth&#39; to plot, default being standard N E components combined</span>
<span class="sd">    use_subplots : bool, default = True</span>
<span class="sd">        Whether to output the plots as subplots (True) or as separate plots (False)</span>
<span class="sd">    fig : matplotlib.Figure, default = None</span>
<span class="sd">        If not None, matplotlib figure on which plot is plotted</span>
<span class="sd">    ax : matplotlib.Axis, default = None</span>
<span class="sd">        If not None, matplotlib axis on which plot is plotted</span>
<span class="sd">    return_fig : bool</span>
<span class="sd">        Whether to return figure and axis objects</span>
<span class="sd">    plot_engine : str, default=&#39;Matplotlib&#39;</span>
<span class="sd">        Which engine to use for plotting. Both &quot;matplotlib&quot; and &quot;plotly&quot; are acceptable. For shorthand, &#39;mpl&#39;, &#39;m&#39; also work for matplotlib; &#39;plty&#39; or &#39;p&#39; also work for plotly. Not case sensitive.</span>
<span class="sd">    save_dir : str or None</span>
<span class="sd">        Directory in which to save figures</span>
<span class="sd">    save_suffix : str</span>
<span class="sd">        Suffix to add to end of figure filename(s), if save_dir is used</span>
<span class="sd">    show_legend : bool, default=False</span>
<span class="sd">        Whether to show legend in plot</span>
<span class="sd">    show_plot : bool</span>
<span class="sd">        Whether to show plot</span>
<span class="sd">    close_figs : bool, default=False</span>
<span class="sd">        Whether to close figures before plotting</span>
<span class="sd">    clear_fig : bool, default=True</span>
<span class="sd">        Whether to clear figures before plotting</span>
<span class="sd">    **kwargs : keyword arguments</span>
<span class="sd">        Keyword arguments for matplotlib.pyplot</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig, ax : matplotlib figure and axis objects</span>
<span class="sd">        Returns figure and axis matplotlib.pyplot objects if return_fig=True, otherwise, simply plots the figures</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orig_args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#Get the initial arguments</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="c1">#If running batch, we&#39;ll loop through each site</span>
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#Make a copy so we don&#39;t accidentally overwrite</span>
            <span class="n">individual_params</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="c1">#Get what would normally be the &quot;params&quot; variable for each site</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;hvsr_results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">individual_params</span> <span class="c1">#reset the params parameter we originally read in to an individual site params</span>
            <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">__hvsr_plot_batch</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span> <span class="c1">#Call another function, that lets us run this function again</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">site_name</span><span class="si">}</span><span class="s2"> not able to be plotted.&quot;</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="n">mplList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span> <span class="s1">&#39;mpl&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">]</span>
    <span class="n">plotlyList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;plotly&#39;</span><span class="p">,</span> <span class="s1">&#39;plty&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">plot_engine</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">plotlyList</span><span class="p">:</span>
        <span class="n">plotlyFigure</span> <span class="o">=</span> <span class="n">sprit_plot</span><span class="o">.</span><span class="n">plot_results_plotly</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">plot_string</span><span class="o">=</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span>
                                            <span class="n">results_fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="n">return_fig</span><span class="p">,</span> <span class="n">use_figure_widget</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                            <span class="n">show_results_plot</span><span class="o">=</span><span class="n">show_plot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_fig</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">plotlyFigure</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1">#plot_engine.lower() in mplList or any other value not in plotly list</span>
        <span class="k">if</span> <span class="n">clear_fig</span> <span class="ow">and</span> <span class="n">fig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1">#Intended use for tkinter</span>
            <span class="c1">#Clear everything</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">texts</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">t</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">close_figs</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

        <span class="c1"># The possible identifiers in plot_type for the different kind of plots</span>
        <span class="n">hvsrList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hvsr&#39;</span><span class="p">,</span> <span class="s1">&#39;hv&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">]</span>
        <span class="n">compList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="s1">&#39;component&#39;</span><span class="p">,</span> <span class="s1">&#39;components&#39;</span><span class="p">]</span>
        <span class="n">specgramList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spec&#39;</span><span class="p">,</span> <span class="s1">&#39;specgram&#39;</span><span class="p">,</span> <span class="s1">&#39;spectrogram&#39;</span><span class="p">]</span>
        <span class="n">azList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">,</span> <span class="s1">&#39;az&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;radial&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">]</span>

        <span class="n">hvsrInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">compInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">specInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">azInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">plot_type</span> <span class="o">=</span> <span class="n">plot_type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">kList</span> <span class="o">=</span> <span class="n">plot_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kList</span><span class="p">):</span>
            <span class="n">kList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

        <span class="c1"># Get the plots in the right order, no matter how they were input (and ensure the right options go with the right plot)</span>
        <span class="c1"># HVSR index</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">hvsrList</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">kList</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsrList</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">hv</span> <span class="ow">in</span> <span class="n">kList</span><span class="p">:</span>
                    <span class="n">hvsrInd</span> <span class="o">=</span> <span class="n">kList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">hv</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="c1"># Component index</span>
        <span class="c1">#if len(set(compList).intersection(kList)):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kList</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;+&#39;</span> <span class="ow">in</span> <span class="n">c</span> <span class="ow">and</span> <span class="n">c</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">compList</span><span class="p">:</span>
                <span class="n">compInd</span> <span class="o">=</span> <span class="n">kList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="k">break</span>
            
        <span class="c1"># Specgram index</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">specgramList</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">kList</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specgramList</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">kList</span><span class="p">:</span>
                    <span class="n">specInd</span> <span class="o">=</span> <span class="n">kList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
                    <span class="k">break</span>        

        <span class="c1"># Azimuth index</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">azList</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">kList</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">azList</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sp</span> <span class="ow">in</span> <span class="n">kList</span><span class="p">:</span>
                    <span class="n">azInd</span> <span class="o">=</span> <span class="n">kList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
                    <span class="k">break</span>        

        
        <span class="c1"># Get indices for all plot type indicators</span>
        <span class="n">indList</span> <span class="o">=</span> <span class="p">[</span><span class="n">hvsrInd</span><span class="p">,</span> <span class="n">compInd</span><span class="p">,</span> <span class="n">specInd</span><span class="p">,</span> <span class="n">azInd</span><span class="p">]</span>
        <span class="n">indListCopy</span> <span class="o">=</span> <span class="n">indList</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">plotTypeList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hvsr&#39;</span><span class="p">,</span> <span class="s1">&#39;comp&#39;</span><span class="p">,</span> <span class="s1">&#39;spec&#39;</span><span class="p">,</span> <span class="s1">&#39;az&#39;</span><span class="p">]</span>

        <span class="n">plotTypeOrder</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">plotIndOrder</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get lists with first and last indices of the specifiers for each plot</span>
        <span class="n">lastVal</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">lastVal</span> <span class="o">!=</span> <span class="mi">99</span><span class="p">:</span>
            <span class="n">firstInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">indListCopy</span><span class="p">)</span>
            <span class="n">plotTypeOrder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plotTypeList</span><span class="p">[</span><span class="n">firstInd</span><span class="p">])</span>
            <span class="n">plotIndOrder</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">indList</span><span class="p">[</span><span class="n">firstInd</span><span class="p">])</span>
            <span class="n">lastVal</span> <span class="o">=</span> <span class="n">indListCopy</span><span class="p">[</span><span class="n">firstInd</span><span class="p">]</span>
            <span class="n">indListCopy</span><span class="p">[</span><span class="n">firstInd</span><span class="p">]</span> <span class="o">=</span> <span class="mi">99</span>  <span class="c1">#just a high number</span>

        <span class="n">plotTypeOrder</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">plotIndOrder</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">kList</span><span class="p">)</span>
        
        <span class="c1"># set up subplots</span>
        <span class="n">figLayout</span> <span class="o">=</span> <span class="s1">&#39;constrained&#39;</span>
        <span class="n">figWidth</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">figHeight</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">figdpi</span> <span class="o">=</span> <span class="mi">220</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plotTypeOrder</span><span class="p">):</span>
            <span class="n">pStartInd</span> <span class="o">=</span> <span class="n">plotIndOrder</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">pEndInd</span> <span class="o">=</span> <span class="n">plotIndOrder</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">plotComponents</span> <span class="o">=</span> <span class="n">kList</span><span class="p">[</span><span class="n">pStartInd</span><span class="p">:</span><span class="n">pEndInd</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">use_subplots</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mosaicPlots</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">pto</span> <span class="ow">in</span> <span class="n">plotTypeOrder</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pto</span> <span class="o">==</span> <span class="s1">&#39;az&#39;</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mosaicPlots</span><span class="p">):</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">subp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;hvsr&#39;</span> <span class="ow">or</span> <span class="n">subp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;comp&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">([</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">plotTypeOrder</span> <span class="k">if</span> <span class="n">item</span> <span class="o">!=</span> <span class="s2">&quot;hvsr&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">mosaicPlots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">mosaicPlots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">mosaicPlots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">mosaicPlots</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pto</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mosaicPlots</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">pto</span><span class="p">])</span>
                <span class="n">perSubPDict</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="s1">&#39;az&#39;</span> <span class="ow">in</span> <span class="n">plotTypeOrder</span><span class="p">:</span>
                    <span class="n">perSubPDict</span><span class="p">[</span><span class="s1">&#39;az&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span><span class="s1">&#39;polar&#39;</span><span class="p">}</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">mosaicPlots</span><span class="p">,</span> <span class="n">per_subplot_kw</span><span class="o">=</span><span class="n">perSubPDict</span><span class="p">,</span> 
                                             <span class="n">layout</span><span class="o">=</span><span class="n">figLayout</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figWidth</span><span class="p">,</span> <span class="n">figHeight</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">figdpi</span><span class="p">)</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">use_subplots</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span> <span class="c1">#Often warns about xlim when it is not an issue</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="s1">&#39;__len__&#39;</span><span class="p">):</span><span class="c1">#print(dir(ax), ax, len(ax))</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="n">axis</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figWidth</span><span class="p">,</span> <span class="n">figHeight</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">figdpi</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="s1">&#39;hvsr&#39;</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;subplot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">_plot_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="n">plotComponents</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">xtype</span><span class="o">=</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="n">show_legend</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">p</span> <span class="o">==</span> <span class="s1">&#39;comp&#39;</span><span class="p">:</span>
                <span class="n">plotComponents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">plotComponents</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;subplot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
                <span class="n">minY</span> <span class="o">=</span> <span class="mi">99999</span> <span class="c1"># Start high</span>
                <span class="n">maxY</span> <span class="o">=</span> <span class="o">-</span><span class="mi">99999</span> <span class="c1"># Start low</span>
                
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">psd_raw</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">ppsd_std_vals_m</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">minY</span><span class="p">:</span>
                        <span class="n">minY</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">ppsd_std_vals_m</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">ppsd_std_vals_m</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">maxY</span><span class="p">:</span>
                        <span class="n">maxY</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">ppsd_std_vals_m</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="n">yRange</span> <span class="o">=</span> <span class="n">maxY</span> <span class="o">-</span> <span class="n">minY</span>
                <span class="n">compYlim</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">minY</span> <span class="o">-</span> <span class="p">(</span><span class="n">yRange</span><span class="o">*</span><span class="mf">0.05</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxY</span> <span class="o">+</span> <span class="p">(</span><span class="n">yRange</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">))]</span>
                <span class="n">compYlim</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="n">compKwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ylim&#39;</span><span class="p">:</span><span class="n">compYlim</span><span class="p">}</span>
                <span class="n">compKwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">_plot_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="n">plotComponents</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">xtype</span><span class="o">=</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">,</span> <span class="n">show_legend</span><span class="o">=</span><span class="n">show_legend</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">p</span> <span class="o">==</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span>
                <span class="n">plottypeKwargs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">plotComponents</span><span class="p">:</span>
                    <span class="n">plottypeKwargs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plottypeKwargs</span><span class="p">)</span>
                <span class="n">_plot_specgram_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">p</span> <span class="o">==</span> <span class="s1">&#39;az&#39;</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;plot_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plotComponents</span>
                <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Azimuth_fig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_azimuth</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Plot type </span><span class="si">{p}</span><span class="s1"> not recognized&#39;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span>   

        <span class="n">windowsUsedStr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> windows used&quot;</span>
        <span class="n">winText</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">windowsUsedStr</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;xx-small&#39;</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pad</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">winText</span><span class="o">.</span><span class="n">set_in_layout</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plotTypeOrder</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">matplotlib</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;figure.constrained_layout.h_pad&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.075</span>
        <span class="c1">#if use_subplots:</span>
        <span class="c1">#    fig.subplots_adjust()#.set(h_pad=0.075, hspace=-5)</span>
        <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="n">return_fig</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fig</span>

    <span class="k">return</span></div>



<span class="c1"># Main function for processing HVSR Curve</span>
<div class="viewcode-block" id="process_hvsr">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.process_hvsr">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">process_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">horizontal_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smooth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">freq_smooth</span><span class="o">=</span><span class="s1">&#39;konno ohmachi&#39;</span><span class="p">,</span> 
                 <span class="n">f_smooth_width</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">resample</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                 <span class="n">outlier_curve_percentile_threshold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process the input data and get HVSR data</span>
<span class="sd">    </span>
<span class="sd">    This is the main function that uses other (private) functions to do </span>
<span class="sd">    the bulk of processing of the HVSR data and the data quality checks.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_data  : HVSRData or HVSRBatch</span>
<span class="sd">        Data object containing all the parameters input and generated by the user (usually, during sprit.input_params(), sprit.fetch_data(), sprit.generate_psds() and/or sprit.remove_noise()).</span>
<span class="sd">    horizontal_method  : int or str, default=3</span>
<span class="sd">        Method to use for combining the horizontal components. Default is 3) Geometric Mean</span>
<span class="sd">            0) (not used) </span>
<span class="sd">            1) &#39;Diffuse field assumption&#39;   H = √( (eie_E + eie_N) / eie_Z), eie = equal interval energy</span>
<span class="sd">            2) &#39;Arithmetic Mean&#39;            H ≡ (HN + HE)/2</span>
<span class="sd">            3) &#39;Geometric Mean&#39;             H ≡ √(HN · HE), recommended by the SESAME project (2004)</span>
<span class="sd">            4) &#39;Vector Summation&#39;           H ≡ √(HN^2 + HE^2)</span>
<span class="sd">            5) &#39;Quadratic Mean&#39;             H ≡ √(HN^2 + HE^2)/2</span>
<span class="sd">            6) &#39;Maximum Horizontal Value&#39;   H ≡ max {HN, HE}</span>
<span class="sd">            7) &#39;Minimum Horizontal Valey&#39;   H ≡ min {HN, HE}</span>
<span class="sd">            8) &#39;Single Azimuth&#39;             H = H2·cos(az) + H1·sin(az)</span>
<span class="sd">    smooth  : bool, default=True</span>
<span class="sd">        bool or int may be used. </span>
<span class="sd">            If True, default to smooth H/V curve to using savgoy filter with window length of 51 (works well with default resample of 1000 pts)</span>
<span class="sd">            If int, the length of the window in the savgoy filter.</span>
<span class="sd">    freq_smooth : str {&#39;konno ohmachi&#39;, &#39;constant&#39;, &#39;proportional&#39;}</span>
<span class="sd">        Which frequency smoothing method to use. By default, uses the &#39;konno ohmachi&#39; method.</span>
<span class="sd">            - The Konno &amp; Ohmachi method uses the obspy.signal.konnoohmachismoothing.konno_ohmachi_smoothing() function: https://docs.obspy.org/packages/autogen/obspy.signal.konnoohmachismoothing.konno_ohmachi_smoothing.html</span>
<span class="sd">            - The constant method uses a window of constant length f_smooth_width</span>
<span class="sd">            - The proportional method uses a window the percentage length of the frequncy steps/range (f_smooth_width now refers to percentage)</span>
<span class="sd">        See here for more information: https://www.geopsy.org/documentation/geopsy/hv-processing.html</span>
<span class="sd">    f_smooth_width : int, default = 40</span>
<span class="sd">        - For &#39;konno ohmachi&#39;: passed directly to the bandwidth parameter of the konno_ohmachi_smoothing() function, determines the width of the smoothing peak, with lower values resulting in broader peak. Must be &gt; 0.</span>
<span class="sd">        - For &#39;constant&#39;: the size of a triangular smoothing window in the number of frequency steps</span>
<span class="sd">        - For &#39;proportional&#39;: the size of a triangular smoothing window in percentage of the number of frequency steps (e.g., if 1000 frequency steps/bins and f_smooth_width=40, window would be 400 steps wide)</span>
<span class="sd">    resample  : bool, default = True</span>
<span class="sd">        bool or int. </span>
<span class="sd">            If True, default to resample H/V data to include 1000 frequency values for the rest of the analysis</span>
<span class="sd">            If int, the number of data points to interpolate/resample/smooth the component psd/HV curve data to.</span>
<span class="sd">    outlier_curve_percentile_threshold : bool, float, default = False</span>
<span class="sd">        If False, outlier curve removal is not carried out here. </span>
<span class="sd">        If True, defaults to 98 (98th percentile). </span>
<span class="sd">        Otherwise, float of percentile used as outlier_threshold of remove_outlier_curve().</span>
<span class="sd">    azimuth : float, default = None</span>
<span class="sd">        The azimuth angle to use when method is single azimuth.</span>
<span class="sd">    verbose : bool, defualt=False</span>
<span class="sd">        Whether to print output to terminal</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        hvsr_out    : dict</span>
<span class="sd">            Dictionary containing all the information about the data, including input parameters</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">orig_args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#Get the initial arguments</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="c1"># Update with processing parameters specified previously in input_params, if applicable</span>
    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;process_hvsr&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">update_msg</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;process_hvsr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">defaultVDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">process_hvsr</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> 
                                        <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">process_hvsr</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span><span class="p">))</span>
                <span class="c1"># Manual input to function overrides the imported parameter values</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">defaultVDict</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> (previously </span><span class="si">{</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                    <span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                                        
    <span class="n">horizontal_method</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;horizontal_method&#39;</span><span class="p">]</span>
    <span class="n">smooth</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;smooth&#39;</span><span class="p">]</span>
    <span class="n">freq_smooth</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;freq_smooth&#39;</span><span class="p">]</span>
    <span class="n">f_smooth_width</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;f_smooth_width&#39;</span><span class="p">]</span>
    <span class="n">resample</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;resample&#39;</span><span class="p">]</span>
    <span class="n">outlier_curve_percentile_threshold</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;outlier_curve_percentile_threshold&#39;</span><span class="p">]</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculating Horizontal/Vertical Ratios at all frequencies/time steps (process_hvsr())&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Using the following parameters:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">==</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">()</span>

        <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;process_hvsr&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">update_msg</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="n">update_msg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">The following parameters were updated using the processing_parameters attribute:&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">msg_line</span> <span class="ow">in</span> <span class="n">update_msg</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">msg_line</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>
            
    <span class="c1"># PROCESSING STARTS HERE (SEPARATE LOOP FOR BATCH)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="c1">#If running batch, we&#39;ll loop through each site</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#Make a copy so we don&#39;t accidentally overwrite</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="c1">#Get what would normally be the &quot;hvsr_data&quot; variable for each site</span>
            <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">__process_hvsr_batch</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span> <span class="c1">#Call another function, that lets us run this function again</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">hvsr_data</span>
                    <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;process_hvsr_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
                    <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>                    
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">hvsr_data</span>
                <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;process_hvsr_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
                <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">HVSRBatch</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">,</span> <span class="n">df_as_read</span><span class="o">=</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">input_df</span><span class="p">)</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_processing_status</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span> <span class="n">func_name</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hvsr_out</span>
    
    <span class="n">ppsds</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="c1">#[k][&#39;psd_values&#39;]</span>
    <span class="n">ppsds</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_xvalues</span><span class="p">(</span><span class="n">ppsds</span><span class="p">)</span>

    <span class="n">methodList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;placeholder_0&gt;&#39;</span><span class="p">,</span> <span class="c1"># 0</span>
                    <span class="s1">&#39;Diffuse Field Assumption&#39;</span><span class="p">,</span> <span class="c1"># 1</span>
                    <span class="s1">&#39;Arithmetic Mean&#39;</span><span class="p">,</span> <span class="c1"># 2</span>
                    <span class="s1">&#39;Geometric Mean&#39;</span><span class="p">,</span> <span class="c1"># 3</span>
                    <span class="s1">&#39;Vector Summation&#39;</span><span class="p">,</span> <span class="c1"># 4</span>
                    <span class="s1">&#39;Quadratic Mean&#39;</span><span class="p">,</span> <span class="c1"># 5</span>
                    <span class="s1">&#39;Maximum Horizontal Value&#39;</span><span class="p">,</span> <span class="c1"># 6</span>
                    <span class="s1">&#39;Minimum Horizontal Value&#39;</span><span class="p">,</span> <span class="c1"># 7</span>
                    <span class="s1">&#39;Single Azimuth&#39;</span> <span class="p">]</span> <span class="c1"># 8</span>
    <span class="n">x_freqs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">x_periods</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">psdValsTAvg</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stDev</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stDevValsP</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">stDevValsM</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">psdRaw</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">currTimesUsed</span><span class="o">=</span><span class="p">{}</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">hvsrDF</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">move_avg</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">box_pts</span><span class="p">):</span>
        <span class="c1">#box = np.ones(box_pts)/box_pts</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hanning</span><span class="p">(</span><span class="n">box_pts</span><span class="p">)</span>
        <span class="n">y_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">box</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">box</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y_smooth</span>

    <span class="n">resampleList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;period_bin_centers&#39;</span><span class="p">,</span> <span class="s1">&#39;period_bin_left_edges&#39;</span><span class="p">,</span> <span class="s1">&#39;period_bin_right_edges&#39;</span><span class="p">,</span> <span class="s1">&#39;period_xedges&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;psd_frequencies&#39;</span><span class="p">,</span> <span class="s1">&#39;psd_periods&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ppsds</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="c1">#for ppsdk, ppsdv in ppsds[k].items():</span>
            <span class="c1">#print(ppsdk, isinstance(ppsdv, np.ndarray))</span>
        <span class="c1">#input_ppsds = ppsds[k][&#39;psd_values&#39;] #original, not used anymore</span>
        <span class="n">input_ppsds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;psd_values_&#39;</span><span class="o">+</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1">#currPPSDs = hvsrDF[&#39;psd_values_&#39;+k][hvsrDF[&#39;Use&#39;]].values</span>
        <span class="c1">#used_ppsds = np.stack(currPPSDs)</span>

        <span class="n">xValMin_per</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">xValMax_per</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">)</span>
        
        <span class="c1"># If resampling has been selected...</span>
        <span class="k">if</span> <span class="n">resample</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">resample</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">resample</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">float</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">resample</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">resample</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c1">#Default smooth value</span>

            <span class="c1"># Resample period bin values</span>
            <span class="n">x_periods</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">xValMin_per</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">xValMax_per</span><span class="p">),</span> <span class="n">num</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">smooth</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">smooth</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
                    <span class="n">smooth</span> <span class="o">=</span> <span class="mi">51</span> <span class="c1">#Default smoothing window</span>
                    <span class="n">padVal</span> <span class="o">=</span> <span class="mi">25</span>
                <span class="k">elif</span> <span class="n">smooth</span> <span class="o">%</span> <span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">smooth</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1">#Otherwise, needs to be odd</span>
                    <span class="n">padVal</span> <span class="o">=</span> <span class="n">smooth</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">padVal</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">padVal</span> <span class="o">+=</span> <span class="mi">1</span>


            <span class="c1"># Resample raw ppsd values</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ppsd_t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_ppsds</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_periods</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;period_bin_centers&#39;</span><span class="p">],</span> <span class="n">ppsd_t</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">smooth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">smooth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">padRawKPad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">[</span><span class="n">padVal</span><span class="p">,</span> <span class="n">padVal</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">)</span>
                        <span class="c1">#padRawKPadSmooth = scipy.signal.savgol_filter(padRawKPad, smooth, 3)</span>
                        <span class="n">padRawKPadSmooth</span> <span class="o">=</span> <span class="n">move_avg</span><span class="p">(</span><span class="n">padRawKPad</span><span class="p">,</span> <span class="n">smooth</span><span class="p">)</span>
                        <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">padRawKPadSmooth</span><span class="p">[</span><span class="n">padVal</span><span class="p">:</span><span class="o">-</span><span class="n">padVal</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_periods</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;period_bin_centers&#39;</span><span class="p">],</span> <span class="n">ppsd_t</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">smooth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">padRawKiPad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">padVal</span><span class="p">,</span> <span class="n">padVal</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">)</span>
                        <span class="c1">#padRawKiPadSmooth = scipy.signal.savgol_filter(padRawKiPad, smooth, 3)</span>
                        <span class="n">padRawKiPadSmooth</span> <span class="o">=</span> <span class="n">move_avg</span><span class="p">(</span><span class="n">padRawKiPad</span><span class="p">,</span> <span class="n">smooth</span><span class="p">)</span>
                        <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">padRawKiPadSmooth</span><span class="p">[</span><span class="n">padVal</span><span class="p">:</span><span class="o">-</span><span class="n">padVal</span><span class="p">]</span>

            <span class="c1"># Resample other values</span>
            <span class="k">for</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">resampleList</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">keys</span> <span class="o">==</span> <span class="s1">&#39;period_bin_centers&#39;</span><span class="p">:</span>
                    <span class="n">baseLength</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">keys</span><span class="p">])</span>
                
                <span class="k">if</span> <span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">keys</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">keys</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">baseLength</span><span class="p">:</span>
                        <span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">keys</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">keys</span><span class="p">])),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">keys</span><span class="p">])),</span> <span class="n">num</span><span class="o">=</span><span class="n">resample</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">keys</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">keys</span><span class="p">])),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">keys</span><span class="p">])),</span> <span class="n">num</span><span class="o">=</span><span class="n">resample</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arrList</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">arr</span> <span class="ow">in</span> <span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">keys</span><span class="p">]:</span>
                        <span class="n">arrList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">arr</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">arr</span><span class="p">)),</span> <span class="n">num</span><span class="o">=</span><span class="n">resample</span><span class="p">))</span>
                    
                    <span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">keys</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">arrList</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#If no resampling desired</span>
            <span class="n">x_periods</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ppsds</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s1">&#39;period_bin_centers&#39;</span><span class="p">])</span><span class="c1">#[:-1]#np.round([1/p for p in hvsr_data[&#39;ppsds&#39;][k][&#39;period_xedges&#39;][:-1]], 3)</span>

            <span class="c1"># Clean up edge freq. values</span>
            <span class="n">x_periods</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">x_periods</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># If simple curve smooothing desired</span>
            <span class="k">if</span> <span class="n">smooth</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">smooth</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">smooth</span><span class="p">:</span>
                    <span class="n">smooth</span> <span class="o">=</span> <span class="mi">51</span> <span class="c1">#Default smoothing window</span>
                    <span class="n">padVal</span> <span class="o">=</span> <span class="mi">25</span>
                <span class="k">elif</span> <span class="n">smooth</span> <span class="o">%</span> <span class="mi">2</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">smooth</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1">#Otherwise, needs to be odd</span>
                    <span class="n">padVal</span> <span class="o">=</span> <span class="n">smooth</span> <span class="o">//</span> <span class="mi">2</span>
                    <span class="k">if</span> <span class="n">padVal</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">padVal</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ppsd_t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_ppsds</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">ppsd_t</span>
                        <span class="n">padRawKPad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="p">[</span><span class="n">padVal</span><span class="p">,</span> <span class="n">padVal</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">)</span>
                        <span class="c1">#padRawKPadSmooth = scipy.signal.savgol_filter(padRawKPad, smooth, 3)</span>
                        <span class="n">padRawKPadSmooth</span> <span class="o">=</span> <span class="n">move_avg</span><span class="p">(</span><span class="n">padRawKPad</span><span class="p">,</span> <span class="n">smooth</span><span class="p">)</span>
                        <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">padRawKPadSmooth</span><span class="p">[</span><span class="n">padVal</span><span class="p">:</span><span class="o">-</span><span class="n">padVal</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ppsd_t</span><span class="p">))</span>
                        <span class="n">padRawKiPad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">padVal</span><span class="p">,</span> <span class="n">padVal</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect&#39;</span><span class="p">)</span>
                        <span class="c1">#padRawKiPadSmooth = scipy.signal.savgol_filter(padRawKiPad, smooth, 3)</span>
                        <span class="n">padRawKiPadSmooth</span> <span class="o">=</span> <span class="n">move_avg</span><span class="p">(</span><span class="n">padRawKiPad</span><span class="p">,</span> <span class="n">smooth</span><span class="p">)</span>
                        <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">padRawKiPadSmooth</span><span class="p">[</span><span class="n">padVal</span><span class="p">:</span><span class="o">-</span><span class="n">padVal</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If no simple curve smoothing</span>
                <span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">input_ppsds</span><span class="p">)</span>
        
        <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;psd_values_&#39;</span><span class="o">+</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">psdRaw</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">use</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1">#Get average psd value across time for each channel (used to calc main H/V curve)</span>
        <span class="n">psdValsTAvg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="n">use</span><span class="p">][</span><span class="s1">&#39;psd_values_&#39;</span><span class="o">+</span><span class="n">k</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">x_freqs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="o">/</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">x_periods</span><span class="p">[</span><span class="n">k</span><span class="p">]])</span> <span class="c1">#np.divide(np.ones_like(x_periods[k]), x_periods[k]) </span>
        <span class="n">stDev</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="n">use</span><span class="p">][</span><span class="s1">&#39;psd_values_&#39;</span><span class="o">+</span><span class="n">k</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">stDevValsM</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psdValsTAvg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">stDev</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="n">stDevValsP</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psdValsTAvg</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">stDev</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">currTimesUsed</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="n">use</span><span class="p">][</span><span class="s1">&#39;TimesProcessed_Obspy&#39;</span><span class="p">])</span>
        <span class="c1">#currTimesUsed[k] = ppsds[k][&#39;current_times_used&#39;] #original one</span>
    
    <span class="c1">#print(&#39;XFREQS&#39;, x_freqs[k].shape)</span>
    <span class="c1">#print(&#39;XPERs&#39;, x_periods[k].shape)</span>
    <span class="c1">#print(&#39;PSDRAW&#39;, psdRaw[k].shape)</span>

    <span class="c1"># Get string of horizontal_method type</span>
    <span class="c1"># First, define default</span>
    <span class="k">if</span> <span class="n">horizontal_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">horizontal_method</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># Geometric mean is used as default if nothing is specified</span>

    <span class="c1"># If an azimuth has been calculated and it&#39;s only one, automatically use the single azimuth method</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">horizontal_method</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># Single azimuth</span>

    <span class="c1"># horizontal_method needs to be str or int</span>
    <span class="c1"># First check if input is a string</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">horizontal_method</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">horizontal_method</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="n">horizontal_method</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">horizontal_method</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">horizontal_method</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="ow">in</span> <span class="n">methodList</span><span class="p">:</span>
            <span class="n">horizontal_method</span> <span class="o">=</span> <span class="n">methodList</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">horizontal_method</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Horizontal method </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> not recognized, reverting to default (geometric mean).</span><span class="se">\n\t</span><span class="s2">Must be one of </span><span class="si">{</span><span class="n">methodList</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">horizontal_method</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="c1"># Now, horizontal_method is int no matter how it was entered</span>
    <span class="n">methodInt</span> <span class="o">=</span> <span class="n">horizontal_method</span>
    <span class="n">horizontal_method</span> <span class="o">=</span> <span class="n">methodList</span><span class="p">[</span><span class="n">horizontal_method</span><span class="p">]</span>
    
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;horizontal_method&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">horizontal_method</span>

    <span class="c1">#This gets the main hvsr curve averaged from all time steps</span>
    <span class="n">anyK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">x_freqs</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hvsr_curve</span><span class="p">,</span> <span class="n">hvsr_az</span><span class="p">,</span> <span class="n">hvsr_tSteps</span> <span class="o">=</span> <span class="n">__get_hvsr_curve</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_freqs</span><span class="p">[</span><span class="n">anyK</span><span class="p">],</span> <span class="n">psd</span><span class="o">=</span><span class="n">psdValsTAvg</span><span class="p">,</span> <span class="n">horizontal_method</span><span class="o">=</span><span class="n">methodInt</span><span class="p">,</span> <span class="n">hvsr_data</span><span class="o">=</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">origPPSD</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds_obspy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1">#print(&#39;hvcurv&#39;, np.array(hvsr_curve).shape)</span>
    <span class="c1">#print(&#39;hvaz&#39;, np.array(hvsr_az).shape)</span>

    <span class="c1">#Add some other variables to our output dictionary</span>
    <span class="n">hvsr_dataUpdate</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;input_params&#39;</span><span class="p">:</span><span class="n">hvsr_data</span><span class="p">,</span>
                <span class="s1">&#39;x_freqs&#39;</span><span class="p">:</span><span class="n">x_freqs</span><span class="p">,</span>
                <span class="s1">&#39;hvsr_curve&#39;</span><span class="p">:</span><span class="n">hvsr_curve</span><span class="p">,</span>
                <span class="s1">&#39;hvsr_az&#39;</span><span class="p">:</span><span class="n">hvsr_az</span><span class="p">,</span>
                <span class="s1">&#39;x_period&#39;</span><span class="p">:</span><span class="n">x_periods</span><span class="p">,</span>
                <span class="s1">&#39;psd_raw&#39;</span><span class="p">:</span><span class="n">psdRaw</span><span class="p">,</span>
                <span class="s1">&#39;current_times_used&#39;</span><span class="p">:</span> <span class="n">currTimesUsed</span><span class="p">,</span>
                <span class="s1">&#39;psd_values_tavg&#39;</span><span class="p">:</span><span class="n">psdValsTAvg</span><span class="p">,</span>
                <span class="s1">&#39;ppsd_std&#39;</span><span class="p">:</span><span class="n">stDev</span><span class="p">,</span>
                <span class="s1">&#39;ppsd_std_vals_m&#39;</span><span class="p">:</span><span class="n">stDevValsM</span><span class="p">,</span>
                <span class="s1">&#39;ppsd_std_vals_p&#39;</span><span class="p">:</span><span class="n">stDevValsP</span><span class="p">,</span>
                <span class="s1">&#39;horizontal_method&#39;</span><span class="p">:</span><span class="n">horizontal_method</span><span class="p">,</span>
                <span class="s1">&#39;ppsds&#39;</span><span class="p">:</span><span class="n">ppsds</span><span class="p">,</span>
                <span class="s1">&#39;ppsds_obspy&#39;</span><span class="p">:</span><span class="n">origPPSD</span><span class="p">,</span>
                <span class="s1">&#39;tsteps_used&#39;</span><span class="p">:</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;tsteps_used&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">:</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span>
                <span class="p">}</span>
    
    <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">HVSRData</span><span class="p">(</span><span class="n">hvsr_dataUpdate</span><span class="p">)</span>

    <span class="c1">#This is if manual editing was used (should probably be updated at some point to just use masks)</span>
    <span class="k">if</span> <span class="s1">&#39;x_windows_out&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;x_windows_out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_windows_out&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;x_windows_out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">freq_smooth_ko</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;konno ohmachi&#39;</span><span class="p">,</span> <span class="s1">&#39;konno-ohmachi&#39;</span><span class="p">,</span> <span class="s1">&#39;konnoohmachi&#39;</span><span class="p">,</span> <span class="s1">&#39;konnohmachi&#39;</span><span class="p">,</span> <span class="s1">&#39;ko&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">]</span>
    <span class="n">freq_smooth_constant</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="s1">&#39;const&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]</span>
    <span class="n">freq_smooth_proport</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;proportional&#39;</span><span class="p">,</span> <span class="s1">&#39;proportion&#39;</span><span class="p">,</span> <span class="s1">&#39;prop&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">]</span>

    <span class="c1">#Frequency Smoothing</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">freq_smooth</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No frequency smoothing is being applied. This is not recommended for noisy datasets.&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">freq_smooth</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="p">(</span><span class="n">freq_smooth</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">freq_smooth_ko</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="ow">not</span> <span class="n">f_smooth_width</span> <span class="ow">and</span> <span class="ow">not</span> <span class="ow">not</span> <span class="n">freq_smooth</span><span class="p">)):</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">obspy.signal</span><span class="w"> </span><span class="kn">import</span> <span class="n">konnoohmachismoothing</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">]:</span>
            <span class="n">colName</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;psd_values_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span>

            <span class="n">psd_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="n">colName</span><span class="p">])</span>
            <span class="n">psd_data</span> <span class="o">=</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>


            <span class="n">freqs</span> <span class="o">=</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
            <span class="n">padding_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f_smooth_width</span><span class="p">)</span>

            <span class="n">padding_value_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">psd_data</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">padding_length</span><span class="p">:])</span>
            <span class="n">padding_value_L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">psd_data</span><span class="p">[:,:</span><span class="n">padding_length</span><span class="p">])</span>

            <span class="c1"># Pad the data to prevent boundary anamolies</span>
            <span class="n">padded_ppsd_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">psd_data</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="n">padding_length</span><span class="p">,</span> <span class="n">padding_length</span><span class="p">)),</span> 
                                        <span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="p">(</span><span class="n">padding_value_L</span><span class="p">,</span> <span class="n">padding_value_R</span><span class="p">))</span>

            <span class="c1"># Pad the frequencies</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Generate new elements on either side and combine</span>
            <span class="n">left_padding</span> <span class="o">=</span> <span class="p">[</span><span class="n">freqs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">**</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">padding_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">right_padding</span> <span class="o">=</span> <span class="p">[</span><span class="n">freqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">**</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">padded_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">left_padding</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">right_padding</span><span class="p">])</span>
            
            <span class="c1">#Filter out UserWarning for just this method, since it throws up a UserWarning that doesn&#39;t really matter about dtypes often</span>
            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                <span class="c1">#warnings.simplefilter(&#39;ignore&#39;, category=UserWarning)</span>
                <span class="n">padded_ppsd_data</span> <span class="o">=</span> <span class="n">padded_ppsd_data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">padded_freqs</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="c1"># Make them the same datatype</span>
                <span class="n">padded_ppsd_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">padded_ppsd_data</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="c1"># Prevent overflows</span>
                <span class="n">padded_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">padded_freqs</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>

                <span class="n">smoothed_ppsd_data</span> <span class="o">=</span> <span class="n">konnoohmachismoothing</span><span class="o">.</span><span class="n">konno_ohmachi_smoothing</span><span class="p">(</span><span class="n">padded_ppsd_data</span><span class="p">,</span> <span class="n">padded_freqs</span><span class="p">,</span> 
                                                    <span class="n">bandwidth</span><span class="o">=</span><span class="n">f_smooth_width</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="c1"># Only use the original, non-padded data</span>
            <span class="n">smoothed_ppsd_data</span> <span class="o">=</span> <span class="n">smoothed_ppsd_data</span><span class="p">[:,</span><span class="n">padding_length</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">padding_length</span><span class="p">]</span>
            <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">smoothed_ppsd_data</span>
            <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="n">colName</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">smoothed_ppsd_data</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">freq_smooth</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">freq_smooth_constant</span><span class="p">:</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">__freq_smooth_window</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">,</span> <span class="n">f_smooth_width</span><span class="p">,</span> <span class="n">kind_freq_smooth</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">freq_smooth</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">freq_smooth_proport</span><span class="p">:</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">__freq_smooth_window</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">,</span> <span class="n">f_smooth_width</span><span class="p">,</span> <span class="n">kind_freq_smooth</span><span class="o">=</span><span class="s1">&#39;proportional&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;You indicated no frequency smoothing should be applied (freq_smooth = </span><span class="si">{</span><span class="n">freq_smooth</span><span class="si">}</span><span class="s1">). This is not recommended for noisy datasets.&#39;</span><span class="p">)</span>

    <span class="c1">#Get hvsr curve from three components at each time step</span>
    <span class="n">anyK</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">horizontal_method</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">horizontal_method</span> <span class="o">==</span><span class="s1">&#39;dfa&#39;</span> <span class="ow">or</span> <span class="n">horizontal_method</span> <span class="o">==</span><span class="s1">&#39;Diffuse Field Assumption&#39;</span><span class="p">:</span>
        <span class="n">hvsr_tSteps_az</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hvsr_tSteps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">hvsr_tSteps_az</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tStep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">][</span><span class="n">anyK</span><span class="p">])):</span>
            <span class="n">tStepDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">]:</span>
                <span class="n">tStepDict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">][</span><span class="n">tStep</span><span class="p">]</span>
            <span class="n">hvsr_tstep</span><span class="p">,</span> <span class="n">hvsr_az_tstep</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">__get_hvsr_curve</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="n">anyK</span><span class="p">],</span> <span class="n">psd</span><span class="o">=</span><span class="n">tStepDict</span><span class="p">,</span> <span class="n">horizontal_method</span><span class="o">=</span><span class="n">methodInt</span><span class="p">,</span> <span class="n">hvsr_data</span><span class="o">=</span><span class="n">hvsr_out</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            
            <span class="n">hvsr_tSteps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">hvsr_tstep</span><span class="p">))</span> <span class="c1">#Add hvsr curve for each time step to larger list of arrays with hvsr_curves</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hvsr_az_tstep</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">tStep</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">hvsr_tSteps_az</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">v</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hvsr_tSteps_az</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;HV_Curves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_tSteps</span>
    
    <span class="c1"># Add azimuth HV Curves to hvsr_windows_df, if applicable</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="n">hvsr_tSteps_az</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;HV_Curves_&#39;</span><span class="o">+</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span>
    
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_curves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="s2">&quot;HV_Curves&quot;</span> <span class="ow">in</span> <span class="n">col_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col_name</span> <span class="o">==</span> <span class="s1">&#39;HV_Curves&#39;</span><span class="p">:</span>
                <span class="n">colID</span> <span class="o">=</span> <span class="s1">&#39;HV&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colID</span> <span class="o">=</span> <span class="n">col_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_curves&#39;</span><span class="p">][</span><span class="n">colID</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]][</span><span class="n">col_name</span><span class="p">])</span>

    <span class="c1">#Initialize array based only on the curves we are currently using</span>
    <span class="n">indHVCurvesArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;HV_Curves&#39;</span><span class="p">][</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]])</span>

    <span class="k">if</span> <span class="n">outlier_curve_percentile_threshold</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">outlier_curve_percentile_threshold</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">outlier_curve_percentile_threshold</span> <span class="o">=</span> <span class="mi">98</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">remove_outlier_curves</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">,</span> <span class="n">use_percentile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outlier_threshold</span><span class="o">=</span><span class="n">outlier_curve_percentile_threshold</span><span class="p">,</span> <span class="n">use_hv_curves</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_stdDev&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;HV_Curves&quot;</span> <span class="ow">in</span> <span class="n">col_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col_name</span> <span class="o">==</span> <span class="s1">&#39;HV_Curves&#39;</span><span class="p">:</span>
                <span class="n">keyID</span> <span class="o">=</span> <span class="s1">&#39;HV&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">keyID</span> <span class="o">=</span> <span class="n">col_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">curr_indHVCurvesArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="n">col_name</span><span class="p">][</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]])</span>
            <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_stdDev&#39;</span><span class="p">][</span><span class="n">keyID</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">curr_indHVCurvesArr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">#Get peaks for each time step</span>
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_peak_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">tStepPFDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#hvsr_out[&#39;hvsr_windows_df&#39;][&#39;CurvesPeakFreqs&#39;] = {}</span>
    <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">col_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HV_Curves&quot;</span><span class="p">):</span>
            <span class="n">tStepPeaks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">col_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">colSuffix</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colSuffix</span> <span class="o">=</span> <span class="s1">&#39;_HV&#39;</span>

            <span class="k">for</span> <span class="n">tStepHVSR</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="n">col_name</span><span class="p">]:</span>
                <span class="n">tStepPeaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__find_peaks</span><span class="p">(</span><span class="n">tStepHVSR</span><span class="p">))</span>                
            <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_peak_indices&#39;</span><span class="p">][</span><span class="s1">&#39;CurvesPeakIndices&#39;</span><span class="o">+</span><span class="n">colSuffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">tStepPeaks</span>

            <span class="n">tStepPFList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tPeaks</span> <span class="ow">in</span> <span class="n">tStepPeaks</span><span class="p">:</span>
                <span class="n">tStepPFs</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">pInd</span> <span class="ow">in</span> <span class="n">tPeaks</span><span class="p">:</span>
                    <span class="n">tStepPFs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="n">anyK</span><span class="p">][</span><span class="n">pInd</span><span class="p">]))</span>
                <span class="n">tStepPFList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tStepPFs</span><span class="p">)</span>
            <span class="n">tStepPFDict</span><span class="p">[</span><span class="s1">&#39;CurvesPeakFreqs&#39;</span><span class="o">+</span><span class="n">colSuffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">tStepPFList</span>
    
    <span class="n">indHVPeakIndsDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_peak_indices&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">tStepPFDictDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tStepPFDict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">indHVPeakIndsDF</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">indHVPeakIndsDF</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">tStepPFDictDF</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">tStepPFDictDF</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col</span><span class="p">]</span>

    <span class="c1">#Get peaks of main HV curve</span>
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_indices&#39;</span><span class="p">][</span><span class="s1">&#39;HV&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__find_peaks</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hvsr_az</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_indices&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">__find_peaks</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_az&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
    
    <span class="c1">#Get frequency values at HV peaks in main curve</span>
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_freqs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">hvsrPF</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_indices&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]:</span>
            <span class="n">hvsrPF</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="n">anyK</span><span class="p">][</span><span class="n">p</span><span class="p">])</span>
        <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_freqs&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hvsrPF</span><span class="p">)</span>

    <span class="c1">#Get other HVSR parameters (i.e., standard deviations, etc.)</span>
    <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">__gethvsrparams</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">)</span>

    <span class="c1">#Include the original obspy stream in the output</span>
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;input_stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_dataUpdate</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;input_stream&#39;</span><span class="p">]</span> <span class="c1">#input_stream</span>
    <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_make_it_classy</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">)</span>
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;process_hvsr_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;process_hvsr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">exclude_params_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_params_list</span><span class="p">:</span>
            <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;process_hvsr&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">horizontal_method</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;8&#39;</span> <span class="ow">or</span> <span class="n">horizontal_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;single azimuth&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">azimuth</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">azimuth</span> <span class="o">=</span> <span class="mi">90</span>
        <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;single_azimuth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">azimuth</span>

    <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_processing_status</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span> <span class="n">func_name</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hvsr_out</span></div>



<span class="c1"># Read data from Tromino</span>
<div class="viewcode-block" id="read_tromino_files">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.read_tromino_files">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_tromino_files</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">struct_format</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="n">tromino_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">sampling_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">set_record_duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_byte</span><span class="o">=</span><span class="mi">24576</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to read data from tromino. Specifically, this has been lightly tested on Tromino 3G+ and Blue machines</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input_data : str</span>
<span class="sd">        Falseilepath to .trc file</span>
<span class="sd">    struct_format : str, optional</span>
<span class="sd">        This is the format used in the struct module. </span>
<span class="sd">        Usually should not be changed, by default &#39;H&#39;</span>
<span class="sd">    tromino_model : str, optional</span>
<span class="sd">        Which tromino model is being read. </span>
<span class="sd">        Currently only &quot;Yellow&quot; and &quot;Blue&quot; are supported.</span>
<span class="sd">        If None, assumes &quot;Yellow&quot;, by default None.</span>
<span class="sd">    sampling_rate : int, optional</span>
<span class="sd">        Sampling rate (samples per second) used during acquisition. </span>
<span class="sd">        This may later be detected automatically.</span>
<span class="sd">        If None, 128 used, by default None</span>
<span class="sd">    set_record_duration : int, optional</span>
<span class="sd">        Duration of record to set manually in minutes, by default None</span>
<span class="sd">    start_byte : int, optional</span>
<span class="sd">        Used internally, by default 24576</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Whether to print information to terminal, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obspy.stream.Stream</span>
<span class="sd">        Obspy Stream object with Tromino data</span>
<span class="sd">    &quot;&quot;&quot;</span>
        
    <span class="n">dPath</span> <span class="o">=</span> <span class="n">input_data</span>

    <span class="n">blueModelList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;blu&#39;</span><span class="p">,</span> <span class="s1">&#39;tromino blu&#39;</span><span class="p">,</span> <span class="s1">&#39;tromino blue&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">tromino_model</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">blueModelList</span> <span class="ow">or</span> <span class="s1">&#39;blue&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">tromino_model</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">tBlueKwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">__read_tromino_data_blue</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
        <span class="k">if</span> <span class="s1">&#39;sampling_rate&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tBlueKwargs</span><span class="p">:</span>
            <span class="n">tBlueKwargs</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sampling_rate</span>
            <span class="k">return</span> <span class="n">__read_tromino_data_blue</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">tBlueKwargs</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">sampling_rate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sampling_rate</span> <span class="o">=</span> <span class="mi">128</span> <span class="c1"># default value</span>

    <span class="n">strucSizes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;h&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;H&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span>
                <span class="s1">&#39;i&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;I&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;l&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;L&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;f&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span>
                <span class="s1">&#39;q&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
                <span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span><span class="s1">&#39;p&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="mi">16</span><span class="p">}</span>

    <span class="c1">#H (pretty sure it&#39;s Q) I L or Q all seem to work (probably not Q?)</span>
    <span class="n">structFormat</span> <span class="o">=</span> <span class="n">struct_format</span>
    <span class="n">structSize</span> <span class="o">=</span> <span class="n">strucSizes</span><span class="p">[</span><span class="n">structFormat</span><span class="p">]</span>

    <span class="n">dataList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dPath</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">structSize</span><span class="p">)</span>  <span class="c1"># Read 4 bytes</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>  <span class="c1"># End of file</span>
                <span class="k">break</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">structFormat</span><span class="p">,</span> <span class="n">data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Interpret as a float</span>
            <span class="n">dataList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
     
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
    <span class="n">dataArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataList</span><span class="p">)</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

    <span class="n">medVal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">dataArr</span><span class="p">[</span><span class="mi">50000</span><span class="p">:</span><span class="mi">100000</span><span class="p">])</span>

    <span class="k">if</span> <span class="s1">&#39;start_byte&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">start_byte</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;start_byte&#39;</span><span class="p">]</span>

    <span class="n">station</span> <span class="o">=</span> <span class="s1">&#39;Tromino&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;station&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">station</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span>

    <span class="n">acq_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;acq_date&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">acq_date</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span>

    <span class="n">starttime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;starttime&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">starttime</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span>

    <span class="n">startByte</span> <span class="o">=</span> <span class="n">start_byte</span>
    <span class="n">comp1</span> <span class="o">=</span> <span class="n">dataArr</span><span class="p">[</span><span class="n">startByte</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">medVal</span>
    <span class="n">comp2</span> <span class="o">=</span> <span class="n">dataArr</span><span class="p">[</span><span class="n">startByte</span><span class="o">+</span><span class="mi">1</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">medVal</span>
    <span class="n">comp3</span> <span class="o">=</span> <span class="n">dataArr</span><span class="p">[</span><span class="n">startByte</span><span class="o">+</span><span class="mi">2</span><span class="p">::</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">medVal</span>
    <span class="n">headerBytes</span> <span class="o">=</span> <span class="n">dataArr</span><span class="p">[:</span><span class="n">startByte</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;diagnose&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;diagnose&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total file bytes: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataArr</span><span class="p">))</span>

    <span class="c1">#fig, ax = plt.subplots(3, sharex=True, sharey=True)</span>
    <span class="c1">#ax[0].plot(comp1, linewidth=0.1, c=&#39;k&#39;)</span>
    <span class="c1">#ax[1].plot(comp2, linewidth=0.1, c=&#39;k&#39;)</span>
    <span class="c1">#ax[2].plot(comp3, linewidth=0.1, c=&#39;k&#39;)</span>

    <span class="k">if</span> <span class="s1">&#39;sampling_rate&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">sampling_rate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">]</span>

    <span class="n">sTime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">acq_date</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">acq_date</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">acq_date</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                              <span class="n">starttime</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">starttime</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                              <span class="n">starttime</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">starttime</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>
    <span class="n">eTime</span> <span class="o">=</span> <span class="n">sTime</span> <span class="o">+</span> <span class="p">(((</span><span class="nb">len</span><span class="p">(</span><span class="n">comp1</span><span class="p">))</span><span class="o">/</span><span class="n">sampling_rate</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">*</span><span class="mi">60</span>

    <span class="n">loc</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">station</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span> <span class="ow">or</span> <span class="n">station</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">station</span><span class="p">)</span>

    <span class="n">traceHeader1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sampling_rate&#39;</span><span class="p">:</span><span class="n">sampling_rate</span><span class="p">,</span>
            <span class="s1">&#39;calib&#39;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;npts&#39;</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">comp1</span><span class="p">),</span>
            <span class="s1">&#39;network&#39;</span><span class="p">:</span><span class="s1">&#39;AM&#39;</span><span class="p">,</span>
            <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="n">loc</span><span class="p">,</span>
            <span class="s1">&#39;station&#39;</span> <span class="p">:</span> <span class="s1">&#39;TRMNO&#39;</span><span class="p">,</span>
            <span class="s1">&#39;channel&#39;</span><span class="p">:</span><span class="s1">&#39;EHE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;starttime&#39;</span><span class="p">:</span><span class="n">sTime</span><span class="p">}</span>
    
    <span class="n">traceHeader2</span><span class="o">=</span><span class="n">traceHeader1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">traceHeader3</span><span class="o">=</span><span class="n">traceHeader1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">traceHeader2</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;EHN&#39;</span>
    <span class="n">traceHeader3</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;EHZ&#39;</span>

    <span class="n">trace1</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">comp1</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">traceHeader1</span><span class="p">)</span>
    <span class="n">trace2</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">comp2</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">traceHeader2</span><span class="p">)</span>
    <span class="n">trace3</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">comp3</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">traceHeader3</span><span class="p">)</span>

    <span class="n">st</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">([</span><span class="n">trace1</span><span class="p">,</span> <span class="n">trace2</span><span class="p">,</span> <span class="n">trace3</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">st</span></div>



<span class="c1"># Function to remove noise windows from data</span>
<div class="viewcode-block" id="remove_noise">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.remove_noise">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_noise</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">remove_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">processing_window</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sat_percent</span><span class="o">=</span><span class="mf">0.995</span><span class="p">,</span> <span class="n">noise_percent</span><span class="o">=</span><span class="mf">0.80</span><span class="p">,</span> 
                 <span class="n">sta</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">lta</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">stalta_thresh</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">],</span> 
                 <span class="n">std_ratio_thresh</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">std_window_size</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">min_std_win</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                 <span class="n">warmup_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cooldown_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_win_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">remove_raw_noise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_stalta_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to remove noisy windows from data, using various methods.</span>
<span class="sd">    </span>
<span class="sd">    Methods include </span>
<span class="sd">    - Manual window selection (by clicking on a chart with spectrogram and stream data), </span>
<span class="sd">    - Auto window selection, which does the following two in sequence (these can also be done indepently):</span>
<span class="sd">        - A sta/lta &quot;antitrigger&quot; method (using stalta values to automatically remove triggered windows where there appears to be too much noise)</span>
<span class="sd">        - A noise threshold method, that cuts off all times where the noise threshold equals more than (by default) 80% of the highest amplitude noise sample for the length specified by lta (in seconds)</span>
<span class="sd">        - A saturation threshold method, that cuts off all times where the noise threshold equals more than (by default) 99.5% of the highest amplitude noise sample.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_data : dict, obspy.Stream, or obspy.Trace</span>
<span class="sd">        Dictionary containing all the data and parameters for the HVSR analysis</span>
<span class="sd">    remove_method : str, {&#39;auto&#39;, &#39;manual&#39;, &#39;stalta&#39;/&#39;antitrigger&#39;, &#39;saturation threshold&#39;, &#39;noise threshold&#39;, &#39;warmup&#39;/&#39;cooldown&#39;/&#39;buffer&#39;/&#39;warm_cool&#39;}</span>
<span class="sd">        The different methods for removing noise from the dataset. A list of strings will also work, in which case, it should be a list of the above strings. See descriptions above for what how each method works. By default &#39;auto.&#39;</span>
<span class="sd">        If remove_method=&#39;auto&#39;, this is the equivalent of remove_method=[&#39;noise threshold&#39;, &#39;antitrigger&#39;, &#39;saturation threshold&#39;, &#39;warm_cool&#39;]</span>
<span class="sd">    processing_window : list, tuple, or None</span>
<span class="sd">        A list/tuple of two items [s, e] or a list/tuple of two-item lists/tuples [[s0, e0], [s1,e1],...[sn, en]] with start and end time(s) for windows to *keep* for processing. </span>
<span class="sd">        Data outside of these times will be excluded from processing. </span>
<span class="sd">        Times should be obspy.UTCDateTime objects to ensure precision, but time strings (&quot;13:05&quot;) will also work in most cases (excpetions may be when the data stream starts/ends on different UTC days)</span>
<span class="sd">    sat_percent : float, default=0.995</span>
<span class="sd">        Percentage (between 0 and 1), to use as the threshold at which to remove data. This is used in the saturation method. By default 0.995. </span>
<span class="sd">        If a value is passed that is greater than 1, it will be divided by 100 to obtain the percentage.</span>
<span class="sd">    noise_percent : float, default = 0.8</span>
<span class="sd">        Percentage (between 0 and 1), to use as the threshold at which to remove data, if it persists for longer than time (in seconds (specified by min_win_size)). This is used in the noise threshold method. By default 0.8. </span>
<span class="sd">        If a value is passed that is greater than 1, it will be divided by 100 to obtain the percentage.</span>
<span class="sd">    sta : int, optional</span>
<span class="sd">        Short term average (STA) window (in seconds), by default 2. For use with sta/lta antitrigger method.</span>
<span class="sd">    lta : int, optional</span>
<span class="sd">        Long term average (STA) window (in seconds), by default 30. For use with sta/lta antitrigger method.</span>
<span class="sd">    stalta_thresh : list, default=[0.5,5]</span>
<span class="sd">        Two-item list or tuple with the thresholds for the stalta antitrigger. The first value (index [0]) is the lower threshold, the second value (index [1] is the upper threshold), by default [0.5,5]</span>
<span class="sd">    std_ratio_thresh : float, optional</span>
<span class="sd">        The ratio to use as a threshold for removal of noise. The ratio represents the standard deviation value for a rolling window (the size of which is determined by the std_window_size parameter) </span>
<span class="sd">        divided by the standard deviation calculated for the entire trace. This rolling window standard deviation method is similar to the default noise removal method used by the Grilla HVSR software.</span>
<span class="sd">    std_window_size : float, optional</span>
<span class="sd">        The length of the window (in seconds) to use for calculating the rolling/moving standard deviation of a trace for the rolling standard deviation method.</span>
<span class="sd">    min_std_win : float, optional</span>
<span class="sd">        The minimum size of &quot;window&quot; that will be remove using the rolling standard deviation method.</span>
<span class="sd">    warmup_time : int, default=0</span>
<span class="sd">        Time in seconds to allow for warmup of the instrument (or while operator is still near instrument). This will renove any data before this time, by default 0.</span>
<span class="sd">    cooldown_time : int, default=0</span>
<span class="sd">        Time in seconds to allow for cooldown of the instrument (or for when operator is nearing instrument). This will renove any data before this time, by default 0.</span>
<span class="sd">    min_win_size : float, default=1</span>
<span class="sd">        The minumum size a window must be over specified threshold (in seconds) for it to be removed</span>
<span class="sd">    remove_raw_noise : bool, default=False</span>
<span class="sd">        If remove_raw_noise=True, will perform operation on raw data (&#39;input_stream&#39;), rather than potentially already-modified data (&#39;stream&#39;).</span>
<span class="sd">    verbose : bool, default=False</span>
<span class="sd">        Whether to print status of remove_noise</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    output : dict</span>
<span class="sd">        Dictionary similar to hvsr_data, but containing modified data with &#39;noise&#39; removed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Get intput paramaters</span>
    <span class="n">orig_args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    
    <span class="c1"># Update with processing parameters specified previously in input_params, if applicable</span>
    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;remove_noise&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">update_msg</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;remove_noise&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">defaultVDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">remove_noise</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> 
                                        <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">remove_noise</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span><span class="p">))</span>
                <span class="c1"># Manual input to function overrides the imported parameter values</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">defaultVDict</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> (previously </span><span class="si">{</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                    <span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    
    <span class="n">remove_method</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;remove_method&#39;</span><span class="p">]</span>
    <span class="n">processing_window</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;processing_window&#39;</span><span class="p">]</span>
    <span class="n">sat_percent</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;sat_percent&#39;</span><span class="p">]</span>
    <span class="n">noise_percent</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;noise_percent&#39;</span><span class="p">]</span>
    <span class="n">sta</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">]</span>
    <span class="n">lta</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;lta&#39;</span><span class="p">]</span>
    <span class="n">stalta_thresh</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;stalta_thresh&#39;</span><span class="p">]</span>
    <span class="n">warmup_time</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;warmup_time&#39;</span><span class="p">]</span>
    <span class="n">cooldown_time</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;cooldown_time&#39;</span><span class="p">]</span>
    <span class="n">min_win_size</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;min_win_size&#39;</span><span class="p">]</span>
    <span class="n">remove_raw_noise</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;remove_raw_noise&#39;</span><span class="p">]</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Removing noisy data windows (remove_noise())&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Using the following parameters:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">==</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">()</span>

            <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;remove_noise&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">update_msg</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="n">update_msg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">The following parameters were updated using the processing_parameters attribute:&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">msg_line</span> <span class="ow">in</span> <span class="n">update_msg</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">msg_line</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>

    <span class="c1"># Set up lists</span>
    <span class="n">manualList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;manual&#39;</span><span class="p">,</span> <span class="s1">&#39;man&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="s1">&#39;windows&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">]</span>
    <span class="n">autoList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;automatic&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">]</span>
    <span class="n">antitrigger</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;stalta&#39;</span><span class="p">,</span> <span class="s1">&#39;anti&#39;</span><span class="p">,</span> <span class="s1">&#39;antitrigger&#39;</span><span class="p">,</span> <span class="s1">&#39;trigger&#39;</span><span class="p">,</span> <span class="s1">&#39;at&#39;</span><span class="p">]</span>
    <span class="n">movingstdList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;moving_std&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="s1">&#39;stdev&#39;</span><span class="p">,</span> <span class="s1">&#39;standard deviation&#39;</span><span class="p">,</span> <span class="s1">&#39;stdev&#39;</span><span class="p">,</span> <span class="s1">&#39;moving_stdev&#39;</span><span class="p">,</span> <span class="s1">&#39;movingstd&#39;</span><span class="p">,</span> <span class="s1">&#39;movingstdev&#39;</span><span class="p">]</span>
    <span class="n">saturationThresh</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;saturation threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;sat_thresh&#39;</span><span class="p">,</span> <span class="s1">&#39;sat thresh&#39;</span><span class="p">,</span> <span class="s1">&#39;saturation&#39;</span><span class="p">,</span> <span class="s1">&#39;sat&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span>
    <span class="n">noiseThresh</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;noise threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;noise thresh&#39;</span><span class="p">,</span> <span class="s1">&#39;noise_thresh&#39;</span><span class="p">,</span> <span class="s1">&#39;noise&#39;</span><span class="p">,</span> <span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">]</span>
    <span class="n">warmup_cooldown</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;warmup&#39;</span><span class="p">,</span> <span class="s1">&#39;cooldown&#39;</span><span class="p">,</span> <span class="s1">&#39;warm&#39;</span><span class="p">,</span> <span class="s1">&#39;cool&#39;</span><span class="p">,</span> <span class="s1">&#39;buffer&#39;</span><span class="p">,</span> <span class="s1">&#39;warmup-cooldown&#39;</span><span class="p">,</span> <span class="s1">&#39;warmup_cooldown&#39;</span><span class="p">,</span> <span class="s1">&#39;wc&#39;</span><span class="p">,</span> <span class="s1">&#39;warm_cool&#39;</span><span class="p">,</span> <span class="s1">&#39;warm-cool&#39;</span><span class="p">]</span>
    <span class="n">procWinList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;processing_window&#39;</span><span class="p">,</span> <span class="s1">&#39;processing window&#39;</span><span class="p">,</span> <span class="s1">&#39;windows&#39;</span><span class="p">,</span> <span class="s1">&#39;window&#39;</span><span class="p">,</span> <span class="s1">&#39;win&#39;</span><span class="p">,</span> <span class="s1">&#39;pw&#39;</span><span class="p">]</span>

    <span class="c1"># Do batch runs</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="c1">#If running batch, we&#39;ll loop through each site</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#Make a copy so we don&#39;t accidentally overwrite</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="c1">#Get what would normally be the &quot;hvsr_data&quot; variable for each site</span>
            <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                   <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">__remove_noise_batch</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span> <span class="c1">#Call another function, that lets us run this function again</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;remove_noise_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
                    <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;remove_noise_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
                <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">False</span>
                <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">hvsr_data</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">HVSRBatch</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">,</span> <span class="n">df_as_read</span><span class="o">=</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">input_df</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">)):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input of type type(hvsr_data)=</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> cannot be used.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hvsr_data</span>
    
    <span class="c1"># Which stream to use (input, or current)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">remove_raw_noise</span><span class="p">:</span>
            <span class="n">inStream</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_stream&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inStream</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="c1">#.copy()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inStream</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">inStream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">outStream</span> <span class="o">=</span> <span class="n">inStream</span>

    <span class="c1"># Get remove_method into consistent format (list)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remove_method</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="n">remove_method</span><span class="p">:</span>
            <span class="n">remove_method</span> <span class="o">=</span> <span class="n">remove_method</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remove_method</span> <span class="o">=</span> <span class="p">[</span><span class="n">remove_method</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">remove_method</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">remove_method</span><span class="p">:</span>
        <span class="n">remove_method</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input value remove_method=</span><span class="si">{</span><span class="n">remove_method</span><span class="si">}</span><span class="s2"> must be either string, list of strings, None, or False. No noise removal will be carried out. Please choose one of the following: &#39;manual&#39;, &#39;auto&#39;, &#39;antitrigger&#39;, &#39;noise threshold&#39;, &#39;warmup_cooldown&#39;.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
    <span class="n">orig_removeMeth</span> <span class="o">=</span> <span class="n">remove_method</span>
    <span class="c1"># Check if any parameter values are different from default (if they are, automatically add that method to remove_method)</span>
    <span class="n">rn_signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">remove_noise</span><span class="p">)</span>

    <span class="n">methodDict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;moving_std&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;std_ratio_thresh&#39;</span><span class="p">,</span> <span class="s1">&#39;std_window_size&#39;</span><span class="p">,</span> <span class="s1">&#39;min_std_win&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;sat_thresh&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sat_percent&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;antitrigger&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">,</span> <span class="s1">&#39;lta&#39;</span><span class="p">,</span> <span class="s1">&#39;stalta_thresh&#39;</span><span class="p">,</span> <span class="s1">&#39;show_stalta_plot&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;noise_thresh&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;noise_percent&#39;</span><span class="p">,</span> <span class="s1">&#39;min_win_size&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;warmup_cooldown&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;warmup_time&#39;</span><span class="p">,</span> <span class="s1">&#39;cooldown_time&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;processing_window&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;processing_window&#39;</span><span class="p">]}</span>

    <span class="n">defaultValDict</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">rn_signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">}</span>

    <span class="c1"># If a non-default parameter is specified, add the method it corresponds to to remove_method</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">def_val</span> <span class="ow">in</span> <span class="n">defaultValDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">def_val</span> <span class="o">!=</span> <span class="n">orig_args</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">methodKey</span><span class="p">,</span> <span class="n">methParamList</span> <span class="ow">in</span> <span class="n">methodDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">methParamList</span><span class="p">:</span>
                        <span class="c1"># Add the corresponding method to remove_mehtod if not already</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">methodKey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">remove_method</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;auto&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">remove_method</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">remove_method</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
                                <span class="n">remove_method</span> <span class="o">=</span> <span class="p">[</span><span class="n">methodKey</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">remove_method</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">methodKey</span><span class="p">)</span>

    <span class="c1"># Reorder list so manual is always first, if it is specified</span>
    <span class="n">do_manual</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_method</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">manualList</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">do_manual</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">manInd</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_method</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">manualList</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">remove_method</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">manInd</span><span class="p">)</span>
        <span class="n">remove_method</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">manInd</span><span class="p">)</span>

    <span class="c1"># Reorder list so auto is always first (if no manual) or second (if manual)</span>
    <span class="c1"># B/c if &#39;auto&#39; is carried out, no other methods need to be carried out (repetitive)</span>
    <span class="n">newAutoInd</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">do_manual</span><span class="p">:</span>
        <span class="n">newAutoInd</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_method</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">autoList</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">autoInd</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">remove_method</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">autoList</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">remove_method</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">autoInd</span><span class="p">)</span>
        <span class="n">remove_method</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">newAutoInd</span><span class="p">,</span> <span class="n">autoInd</span><span class="p">)</span>        
    
    <span class="c1">#Go through each type of removal and remove</span>
    <span class="k">if</span> <span class="n">orig_removeMeth</span> <span class="o">!=</span> <span class="n">remove_method</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">The remove_method parameter has been updated because non-default parameter values were detected.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">The remove_method parameter was entered as </span><span class="si">{</span><span class="n">orig_removeMeth</span><span class="si">}</span><span class="s1">, but has been updated to </span><span class="si">{</span><span class="n">remove_method</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># REMOVE DATA FROM ANALYSIS</span>
    <span class="k">for</span> <span class="n">rem_kind</span> <span class="ow">in</span> <span class="n">remove_method</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rem_kind</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">rem_kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">manualList</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="s1">&#39;x_windows_out&#39;</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="n">_select_windows</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                    <span class="n">window_list</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;x_windows_out&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outStream</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">Stream</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">window_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__remove_windows</span><span class="p">(</span><span class="n">inStream</span><span class="p">,</span> <span class="n">window_list</span><span class="p">,</span> <span class="n">warmup_time</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">output</span> <span class="o">=</span> <span class="n">_select_windows</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Only obspy.core.stream.Stream data type is currently supported for manual noise removal method.&quot;</span><span class="p">)</span>     
            <span class="k">elif</span> <span class="n">rem_kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">autoList</span><span class="p">:</span>
                <span class="n">outStream</span> <span class="o">=</span> <span class="n">__remove_moving_std</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">outStream</span><span class="p">,</span> <span class="n">std_ratio_thresh</span><span class="o">=</span><span class="n">std_ratio_thresh</span><span class="p">,</span> <span class="n">std_window_s</span><span class="o">=</span><span class="n">std_window_size</span><span class="p">,</span> <span class="n">min_win_size</span><span class="o">=</span><span class="n">min_std_win</span><span class="p">)</span>
                <span class="n">outStream</span> <span class="o">=</span> <span class="n">__remove_noise_saturate</span><span class="p">(</span><span class="n">outStream</span><span class="p">,</span> <span class="n">sat_percent</span><span class="o">=</span><span class="n">sat_percent</span><span class="p">,</span> <span class="n">min_win_size</span><span class="o">=</span><span class="n">min_win_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
                <span class="c1"># Break for-loop, since all the rest are already done as part of auto</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">rem_kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">antitrigger</span><span class="p">:</span>
                <span class="n">outStream</span> <span class="o">=</span> <span class="n">__remove_anti_stalta</span><span class="p">(</span><span class="n">outStream</span><span class="p">,</span> <span class="n">sta</span><span class="o">=</span><span class="n">sta</span><span class="p">,</span> <span class="n">lta</span><span class="o">=</span><span class="n">lta</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="n">stalta_thresh</span><span class="p">,</span> <span class="n">show_stalta_plot</span><span class="o">=</span><span class="n">show_stalta_plot</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">rem_kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">movingstdList</span><span class="p">:</span>
                <span class="n">outStream</span> <span class="o">=</span> <span class="n">__remove_moving_std</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">outStream</span><span class="p">,</span> <span class="n">std_ratio_thresh</span><span class="o">=</span><span class="n">std_ratio_thresh</span><span class="p">,</span> <span class="n">std_window_s</span><span class="o">=</span><span class="n">std_window_size</span><span class="p">,</span> <span class="n">min_win_size</span><span class="o">=</span><span class="n">min_std_win</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">rem_kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">saturationThresh</span><span class="p">:</span>
                <span class="n">outStream</span> <span class="o">=</span> <span class="n">__remove_noise_saturate</span><span class="p">(</span><span class="n">outStream</span><span class="p">,</span> <span class="n">sat_percent</span><span class="o">=</span><span class="n">sat_percent</span><span class="p">,</span> <span class="n">min_win_size</span><span class="o">=</span><span class="n">min_win_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">rem_kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">noiseThresh</span><span class="p">:</span>
                <span class="n">outStream</span> <span class="o">=</span> <span class="n">__remove_noise_thresh</span><span class="p">(</span><span class="n">outStream</span><span class="p">,</span> <span class="n">noise_percent</span><span class="o">=</span><span class="n">noise_percent</span><span class="p">,</span> <span class="n">lta</span><span class="o">=</span><span class="n">lta</span><span class="p">,</span> <span class="n">min_win_size</span><span class="o">=</span><span class="n">min_win_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">rem_kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">warmup_cooldown</span><span class="p">:</span>
                <span class="n">outStream</span> <span class="o">=</span> <span class="n">__remove_warmup_cooldown</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">outStream</span><span class="p">,</span> <span class="n">warmup_time</span><span class="o">=</span><span class="n">warmup_time</span><span class="p">,</span> <span class="n">cooldown_time</span><span class="o">=</span><span class="n">cooldown_time</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">rem_kind</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">procWinList</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">processing_window</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="n">outStream</span> <span class="o">=</span> <span class="n">_keep_processing_windows</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">outStream</span><span class="p">,</span> <span class="n">processing_window</span><span class="o">=</span><span class="n">processing_window</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">remove_method</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input value remove_method=</span><span class="si">{</span><span class="n">remove_method</span><span class="si">}</span><span class="s2"> is not recognized. No noise removal will be carried out. Please choose one of the following: &#39;manual&#39;, &#39;auto&#39;, &#39;antitrigger&#39;, &#39;noise threshold&#39;, &#39;warmup_cooldown&#39;.&quot;</span><span class="p">)</span>
                    <span class="k">break</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input value remove_method=</span><span class="si">{</span><span class="n">remove_method</span><span class="si">}</span><span class="s2"> is not recognized. Continuing with other noise removal methods.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  *Error with </span><span class="si">{</span><span class="n">rem_kind</span><span class="si">}</span><span class="s1"> method. Data was not removed using that method.&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  *</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="c1"># Add output</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outStream</span><span class="p">,</span> <span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">)):</span>
            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;stream_edited&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outStream</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;stream_edited&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outStream</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;input_stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_stream&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;remove_noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">output</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;remove_noise&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;remove_noise_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_processing_status</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span> <span class="n">func_name</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">__remove_windows_from_df</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1">#if &#39;hvsr_windows_df&#39; in output.keys() or (&#39;params&#39; in output.keys() and &#39;hvsr_windows_df&#39; in output[&#39;params&#39;].keys())or (&#39;input_params&#39; in output.keys() and &#39;hvsr_windows_df&#39; in output[&#39;input_params&#39;].keys()):</span>
        <span class="c1">#    hvsrDF = output[&#39;hvsr_windows_df&#39;]</span>
        <span class="c1">#    </span>
        <span class="c1">#    outStream = output[&#39;stream_edited&#39;].split()</span>
        <span class="c1">#    for i, trace in enumerate(outStream):</span>
        <span class="c1">#        if i == 0:</span>
        <span class="c1">#            trEndTime = trace.stats.endtime</span>
        <span class="c1">#            comp_end = trace.stats.component</span>
        <span class="c1">#            continue</span>
        <span class="c1">#        trStartTime = trace.stats.starttime</span>
        <span class="c1">#        comp_start = trace.stats.component</span>
                
        <span class="c1">#        if trEndTime &lt; trStartTime and comp_end == comp_start:</span>
        <span class="c1">#            gap = [trEndTime,trStartTime]</span>

        <span class="c1">#            output[&#39;hvsr_windows_df&#39;][&#39;Use&#39;] = (hvsrDF[&#39;TimesProcessed_Obspy&#39;].gt(gap[0]) &amp; hvsrDF[&#39;TimesProcessed_Obspy&#39;].gt(gap[1]) )| \</span>
        <span class="c1">#                            (hvsrDF[&#39;TimesProcessed_ObspyEnd&#39;].lt(gap[0]) &amp; hvsrDF[&#39;TimesProcessed_ObspyEnd&#39;].lt(gap[1]))# | \</span>
        <span class="c1">#            output[&#39;hvsr_windows_df&#39;][&#39;Use&#39;] = output[&#39;hvsr_windows_df&#39;][&#39;Use&#39;].astype(bool)</span>
        <span class="c1">#        </span>
        <span class="c1">#        trEndTime = trace.stats.endtime</span>
        <span class="c1">#    </span>
        <span class="c1">#    outStream.merge()</span>
        <span class="c1">#    output[&#39;stream_edited&#39;] = outStream</span>
                
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">outStream</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Output of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">output</span><span class="p">)</span><span class="si">}</span><span class="s2"> for this function will likely result in errors in other processing steps. Returning hvsr_data data.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hvsr_data</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_make_it_classy</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;x_windows_out&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">output</span><span class="p">[</span><span class="s1">&#39;x_windows_out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">output</span></div>



<span class="c1"># Remove outlier ppsds</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_outlier_curves</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">outlier_method</span><span class="o">=</span><span class="s1">&#39;prototype&#39;</span><span class="p">,</span>
                          <span class="n">outlier_threshold</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">use_percentile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">min_pts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                          <span class="n">use_hv_curves</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">plot_engine</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span> <span class="n">show_outlier_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">generate_outlier_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function used to remove outliers curves using a &quot;prototype&quot; or &quot;dbscan&quot; method. </span>
<span class="sd">    Prototype method calculates a prototype curve (i.e., median) and calculates the distance of the H/V or PSD curve from each window from that prototype curve.</span>
<span class="sd">    Currently, Root Mean Square Error is used to calculate the distance for each windowed H/V or PSD curve at each frequency step for all times.</span>
<span class="sd">    It calculates the RMSE for the PPSD curves of each component individually. All curves are removed from analysis.</span>

<span class="sd">    DBSCAN uses the DBSCAN method, outlier_threshold being by default the percentile value of distances of all curves from all other curves.</span>
<span class="sd">    Distance is calculated using scipy.spatial.distance.pdist, by default with &#39;euclidean&#39; distance. </span>
<span class="sd">    The `min_pts` parameter specifies the minimum number of curves whose distance must be within the threshold distance percentile/value to be retained.</span>
<span class="sd">    </span>
<span class="sd">    Some abberant curves often occur due to the remove_noise() function, so this should be run some time after remove_noise(). </span>
<span class="sd">    In general, the recommended workflow is to run this immediately following the `generate_psds()` function. or if use_hv_curves=True, after `process_hvsr()`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_data : dict</span>
<span class="sd">        Input dictionary containing all the values and parameters of interest</span>
<span class="sd">    outlier_method : str, default=&#39;prototype&#39;</span>
<span class="sd">        The method to use for outlier detection. Currently, &#39;dbscan&#39; and &#39;prototype&#39; is supported.</span>
<span class="sd">    outlier_threshold : float or int, default=98</span>
<span class="sd">        The Root Mean Square Error value to use as a threshold for determining whether a curve is an outlier. </span>
<span class="sd">        This averages over each individual entire curve so that curves with very abberant data (often occurs when using the remove_noise() method), can be identified.</span>
<span class="sd">        Otherwise, specify a float or integer to use as the cutoff RMSE value (all curves with RMSE above will be removed)</span>
<span class="sd">    use_percentile :  float, default=True</span>
<span class="sd">        Whether outlier_threshold should be interepreted as a raw RMSE value or as a percentile of the RMSE values.</span>
<span class="sd">    min_pts : int, default=5</span>
<span class="sd">        The minimum number of points to use for the outlier detection method.</span>
<span class="sd">        This is only used if outlier_method=&#39;dbscan&#39; </span>
<span class="sd">        This is minimum number of points a point needs in its neighborhood to not be considered an outlier.</span>
<span class="sd">    use_hv_curves : bool, default=False</span>
<span class="sd">        Whether to use the calculated HV Curve or the individual components. This can only be True after process_hvsr() has been run.</span>
<span class="sd">    show_plot : bool, default=False</span>
<span class="sd">        Whether to show a plot of the removed data</span>
<span class="sd">    verbose : bool, default=False</span>
<span class="sd">        Whether to print output of function to terminal</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    hvsr_data : dict</span>
<span class="sd">        Input dictionary with values modified based on work of function.</span>

<span class="sd">    SEE ALSO</span>
<span class="sd">    --------</span>
<span class="sd">    [scipy.spatial.distance.pdist](https://docs.scipy.org/doc/scipy/reference/generated/scipy.spatial.distance.pdist.html#scipy.spatial.distance.pdist)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Setup function</span>
    <span class="c1">#Get intput paramaters</span>
    <span class="n">orig_args</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    
    <span class="c1"># Update with processing parameters specified previously in input_params, if applicable</span>
    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;remove_outlier_curves&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;remove_noise&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">update_msg</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;remove_noise&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">defaultVDict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">remove_outlier_curves</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> 
                                        <span class="n">inspect</span><span class="o">.</span><span class="n">getfullargspec</span><span class="p">(</span><span class="n">remove_outlier_curves</span><span class="p">)</span><span class="o">.</span><span class="n">defaults</span><span class="p">))</span>
                <span class="c1"># Manual input to function overrides the imported parameter values</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">==</span><span class="n">defaultVDict</span><span class="p">[</span><span class="n">k</span><span class="p">]):</span>
                    <span class="n">update_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1"> = </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s1"> (previously </span><span class="si">{</span><span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
                    <span class="n">orig_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="c1"># Reset parameters in case of manual override of imported parameters</span>
    <span class="n">outlier_method</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;outlier_method&#39;</span><span class="p">]</span>
    <span class="n">outlier_threshold</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;outlier_threshold&#39;</span><span class="p">]</span>
    <span class="n">use_percentile</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;use_percentile&#39;</span><span class="p">]</span>
    <span class="n">min_pts</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;min_pts&#39;</span><span class="p">]</span>
    <span class="n">use_hv_curves</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;use_hv_curves&#39;</span><span class="p">]</span>
    <span class="n">plot_engine</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;plot_engine&#39;</span><span class="p">]</span>
    <span class="n">show_outlier_plot</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;show_outlier_plot&#39;</span><span class="p">]</span>
    <span class="n">generate_outlier_plot</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;generate_outlier_plot&#39;</span><span class="p">]</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">orig_args</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]</span>

    <span class="c1"># Allow skipping step if outlier_method specified as None (may help GUIs)</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">outlier_method</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span> <span class="ow">or</span> <span class="n">outlier_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">hvsr_data</span>

    <span class="c1">#Print if verbose, which changes depending on if batch data or not</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">verbose</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">)</span> <span class="ow">and</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;batch&#39;</span><span class="p">]:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Removing outlier curves from further analysis (remove_outlier_curves())&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Using the following parameters:&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;hvsr_data&#39;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1">=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">()</span>
                        
            <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;remove_outlier_curves&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">update_msg</span> <span class="o">!=</span> <span class="p">[]:</span>
                    <span class="n">update_msg</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">The following parameters were updated using the processing_parameters attribute:&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">msg_line</span> <span class="ow">in</span> <span class="n">update_msg</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">msg_line</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">()</span>
    
    <span class="c1">#First, divide up for batch or not</span>
    <span class="c1">#Site is in the keys anytime it&#39;s not batch</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="c1">#If running batch, we&#39;ll loop through each site</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">site_name</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#Make a copy so we don&#39;t accidentally overwrite</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="c1">#Get what would normally be the &quot;hvsr_data&quot; variable for each site</span>
            <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">__remove_outlier_curves</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span> <span class="c1">#Call another function, that lets us run this function again</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">hvsr_data</span>
                    <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;remove_outlier_curves_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>                    
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">hvsr_data</span>
                <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;remove_outlier_curves_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">hvsr_out</span><span class="p">[</span><span class="n">site_name</span><span class="p">][</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;overall_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">HVSRBatch</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">,</span> <span class="n">df_as_read</span><span class="o">=</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">input_df</span><span class="p">)</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_processing_status</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span> <span class="n">func_name</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hvsr_out</span>

    <span class="n">dbscanList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;dbscan&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="s1">&#39;dist&#39;</span><span class="p">,</span> <span class="s1">&#39;dbs&#39;</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]</span>
    <span class="n">prototypeList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;prototype&#39;</span><span class="p">,</span> <span class="s1">&#39;proto&#39;</span><span class="p">,</span> <span class="s1">&#39;ptype&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;root mean square&#39;</span><span class="p">,</span> <span class="s1">&#39;root mean square error&#39;</span><span class="p">,</span> 
                     <span class="s1">&#39;rms&#39;</span><span class="p">,</span> <span class="s1">&#39;rmse&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">]</span>

    <span class="c1"># Determine names of hvsr_windows_df columns to use</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">use_hv_curves</span><span class="p">:</span>
        <span class="n">compNames</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;psd_values&#39;</span> <span class="ow">in</span> <span class="n">col_name</span> <span class="ow">and</span> <span class="s1">&#39;RMSE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col_name</span><span class="p">:</span>
                <span class="n">cName</span> <span class="o">=</span> <span class="n">col_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">cName</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">compNames</span><span class="p">:</span>
                    <span class="n">compNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cName</span><span class="p">)</span>
        <span class="n">col_prefix</span> <span class="o">=</span> <span class="s1">&#39;psd_values_&#39;</span>
        <span class="n">colNames</span> <span class="o">=</span> <span class="p">[</span><span class="n">col_prefix</span><span class="o">+</span><span class="n">cn</span> <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">compNames</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">compNames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;HV_Curves&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;Log10&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col_name</span><span class="p">:</span>
                <span class="n">compNames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
        <span class="n">colNames</span> <span class="o">=</span> <span class="n">compNames</span>
        <span class="n">col_prefix</span> <span class="o">=</span> <span class="s1">&#39;HV_Curves&#39;</span>

    <span class="c1"># Remove outlier depending on method, prototype as default</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">outlier_method</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">dbscanList</span><span class="p">:</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">__dbscan_outlier_detect</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">use_hv_curves</span><span class="o">=</span><span class="n">use_hv_curves</span><span class="p">,</span> 
                                           <span class="n">use_percentile</span><span class="o">=</span><span class="n">use_percentile</span><span class="p">,</span>
                                           <span class="n">neighborhood_size</span><span class="o">=</span><span class="n">outlier_threshold</span><span class="p">,</span>
                                           <span class="n">dist_metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> 
                                           <span class="n">min_neighborhood_pts</span><span class="o">=</span><span class="n">min_pts</span><span class="p">,</span>
                                           <span class="n">col_names</span><span class="o">=</span><span class="n">colNames</span><span class="p">,</span>
                                           <span class="n">comp_names</span><span class="o">=</span><span class="n">compNames</span><span class="p">,</span>
                                           <span class="n">col_prefix</span><span class="o">=</span><span class="n">col_prefix</span><span class="p">,</span>
                                           <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">outlier_method</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">prototypeList</span><span class="p">:</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">__prototype_outlier_detect</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">use_hv_curves</span><span class="o">=</span><span class="n">use_hv_curves</span><span class="p">,</span> 
                                              <span class="n">use_percentile</span><span class="o">=</span><span class="n">use_percentile</span><span class="p">,</span>
                                              <span class="n">outlier_threshold</span><span class="o">=</span><span class="n">outlier_threshold</span><span class="p">,</span>
                                              <span class="n">col_names</span><span class="o">=</span><span class="n">colNames</span><span class="p">,</span>
                                              <span class="n">comp_names</span><span class="o">=</span><span class="n">compNames</span><span class="p">,</span>
                                              <span class="n">col_prefix</span><span class="o">=</span><span class="n">col_prefix</span><span class="p">,</span>
                                              <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">__prototype_outlier_detect</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">use_hv_curves</span><span class="o">=</span><span class="n">use_hv_curves</span><span class="p">,</span> 
                                              <span class="n">use_percentile</span><span class="o">=</span><span class="n">use_percentile</span><span class="p">,</span>
                                              <span class="n">outlier_threshold</span><span class="o">=</span><span class="n">outlier_threshold</span><span class="p">,</span>
                                              <span class="n">col_names</span><span class="o">=</span><span class="n">colNames</span><span class="p">,</span>
                                              <span class="n">comp_names</span><span class="o">=</span><span class="n">compNames</span><span class="p">,</span>
                                              <span class="n">col_prefix</span><span class="o">=</span><span class="n">col_prefix</span><span class="p">,</span>
                                              <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

    <span class="c1"># Show plot of removed/retained data</span>
    <span class="k">if</span> <span class="n">plot_engine</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;matplotlib&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">generate_outlier_plot</span> <span class="ow">or</span> <span class="n">show_outlier_plot</span><span class="p">):</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Outlier_Plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprit_plot</span><span class="o">.</span><span class="n">plot_outlier_curves</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">outlier_threshold</span><span class="o">=</span><span class="n">outlier_threshold</span><span class="p">,</span> <span class="n">use_percentile</span><span class="o">=</span><span class="n">use_percentile</span><span class="p">,</span> <span class="n">use_hv_curves</span><span class="o">=</span><span class="n">use_hv_curves</span><span class="p">,</span> <span class="n">plot_engine</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="n">show_outlier_plot</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plot_engine</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;plotly&#39;</span>  <span class="ow">and</span> <span class="p">(</span><span class="n">generate_outlier_plot</span> <span class="ow">or</span> <span class="n">show_outlier_plot</span><span class="p">):</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Outlier_Plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprit_plot</span><span class="o">.</span><span class="n">plot_outlier_curves</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">outlier_threshold</span><span class="o">=</span><span class="n">outlier_threshold</span><span class="p">,</span> <span class="n">use_percentile</span><span class="o">=</span><span class="n">use_percentile</span><span class="p">,</span> <span class="n">use_hv_curves</span><span class="o">=</span><span class="n">use_hv_curves</span><span class="p">,</span> <span class="n">plot_engine</span><span class="o">=</span><span class="s1">&#39;plotly&#39;</span><span class="p">,</span> <span class="n">from_roc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="n">show_outlier_plot</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;remove_outlier_curves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">exclude_params_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">orig_args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_params_list</span><span class="p">:</span>
            <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;remove_outlier_curves&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;processing_status&#39;</span><span class="p">][</span><span class="s1">&#39;remove_outlier_curves_status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="n">hvsr_out</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_processing_status</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">,</span> <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span> <span class="n">func_name</span><span class="o">=</span><span class="n">inspect</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">hvsr_out</span>


<span class="c1"># Just for testing</span>
<div class="viewcode-block" id="test_function">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.test_function">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">test_function</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;is this working?&#39;</span><span class="p">)</span></div>



<span class="c1"># Update all elevation-related attriutes</span>
<div class="viewcode-block" id="update_elevation">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.update_elevation">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_elevation</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">updated_surface_elevation</span><span class="p">,</span> <span class="n">updated_elevation_unit</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to quickly update all attributes associated with elevation of an HVSRData object</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_data : HVSRData or HVSRBatch</span>
<span class="sd">        HVSRData or HVSRBatch object containing attributes related to elevation.</span>
<span class="sd">        If HVSRBatch, updated_surface_elevation should be list or tuple and </span>
<span class="sd">        updated_elevation_unit may either be str or  list/tuple of strings.        </span>
<span class="sd">    updated_surface_elevation : numbers.Number</span>
<span class="sd">        Number (float or int) with the updated elevation.</span>
<span class="sd">        Meters is the preferred unit. If feet are used instead, it will be converted to meters.</span>
<span class="sd">    updated_elevation_unit : str</span>
<span class="sd">        Unit used for updated_surface_elevation. If &#39;feet&#39;, it will be converted to meters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    HVSRData</span>
<span class="sd">        HVSRData object with all attributes related to elevation updated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Break out for HVSRBatch</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRBatch</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">updated_surface_elevation</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">sites</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Elevations for HVSRBatch object could not be updated. </span><span class="se">\</span>
<span class="s1">                Length of updated_surface_elevation (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">updated_surface_elevation</span><span class="p">)</span><span class="si">}</span><span class="s1">) must equal</span><span class="se">\</span>
<span class="s1">                the number of sites (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span><span class="si">}</span><span class="s1">) in hvsr_data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hvsr_data</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">updated_elevation_unit</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">updated_elevation_unit</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">sites</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Elevations for HVSRBatch object could not be updated. </span><span class="se">\</span>
<span class="s1">                    Length of updated_elevation_unit (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">updated_elevation_unit</span><span class="p">)</span><span class="si">}</span><span class="s1">) must equal</span><span class="se">\</span>
<span class="s1">                    the number of sites (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span><span class="si">}</span><span class="s1">) in hvsr_data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">hvsr_data</span>
        
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">updated_elevation_unit</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">updated_elevation_unit</span> <span class="o">=</span> <span class="p">[</span><span class="n">updated_elevation_unit</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">sites</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;updated_elevation_unit must be list, tuple, or str, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">updated_elevation_unit</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sitename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span> <span class="n">hvsr_data</span><span class="p">):</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="n">sitename</span><span class="p">]</span> <span class="o">=</span> <span class="n">_update_elevation</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="n">sitename</span><span class="p">],</span> 
                                                   <span class="n">updated_surface_elevation</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                                   <span class="n">updated_elevation_unit</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">hvsr_data</span>
    
    <span class="c1">#elevation_attrs = [&#39;elevation&#39;, &#39;x_elev_m&#39;, &#39;x_elev_ft&#39;]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="s1">&#39;elevation&#39;</span><span class="p">):</span>
        <span class="n">elev_diff</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">updated_surface_elevation</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">elev_diff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">updated_surface_elevation</span>
        

    <span class="n">mList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;meters&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;standard&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;si&#39;</span><span class="p">,</span> <span class="s1">&#39;metres&#39;</span><span class="p">,</span> <span class="s1">&#39;metre&#39;</span><span class="p">,</span> <span class="s1">&#39;meter&#39;</span><span class="p">]</span>
    <span class="n">fList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;feet&#39;</span><span class="p">,</span> <span class="s1">&#39;ft&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;foot&#39;</span><span class="p">,</span> <span class="s1">&#39;american&#39;</span><span class="p">,</span> <span class="s1">&#39;imperial&#39;</span><span class="p">,</span> <span class="s1">&#39;imp&#39;</span><span class="p">]</span>
    
    <span class="c1"># Update parameters with elevations in them</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">updated_elevation_unit</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">fList</span><span class="p">:</span>
        <span class="n">updated_surface_elevation</span> <span class="o">=</span> <span class="n">updated_surface_elevation</span> <span class="o">*</span> <span class="mf">0.3048</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_surface_elevation</span>
        
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;elev_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span>
    
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="s1">&#39;x_elev_m&#39;</span><span class="p">):</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_elev_m&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_elev_m&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">elev_diff</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_elev_m&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_elev_m&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">elev_diff</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_elev_m&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_elev_m&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">elev_diff</span>
        
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_elev_ft&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_elev_m&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">0.3048</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_elev_ft&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_elev_m&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">0.3048</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_elev_ft&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_elev_m&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">0.3048</span>
    
    <span class="c1"># Update elevations in Table_Report</span>
    <span class="n">table_report_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Elevation&#39;</span><span class="p">,</span> <span class="s1">&#39;BedrockElevation&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="s1">&#39;Table_Report&#39;</span><span class="p">):</span>
        <span class="n">hvsr_data</span><span class="o">.</span><span class="n">Table_Report</span><span class="p">[</span><span class="s1">&#39;Elevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_surface_elevation</span>
        <span class="k">if</span> <span class="s1">&#39;BedrockDepth&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">Table_Report</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">hvsr_data</span><span class="o">.</span><span class="n">Table_Report</span><span class="p">[</span><span class="s1">&#39;BedrockElevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_surface_elevation</span> <span class="o">-</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">Table_Report</span><span class="p">[</span><span class="s1">&#39;BedrockDepth&#39;</span><span class="p">]</span>

    <span class="c1"># Update elevations in Print_Report</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="s2">&quot;Print_Report&quot;</span><span class="p">):</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Print_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Elevation:\s*[\d.]+&quot;</span><span class="p">,</span> 
                                            <span class="sa">f</span><span class="s2">&quot;Elevation: </span><span class="si">{</span><span class="n">updated_surface_elevation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                                            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Print_Report&#39;</span><span class="p">])</span>

    <span class="c1"># Update elevations in HTML_Report</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="s2">&quot;HTML_Report&quot;</span><span class="p">):</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;HTML_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Elevation:\s*[\d.]+&quot;</span><span class="p">,</span> 
                                            <span class="sa">f</span><span class="s2">&quot;Elevation: </span><span class="si">{</span><span class="n">updated_surface_elevation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                                            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;HTML_Report&#39;</span><span class="p">])</span>
    
    <span class="c1"># Update elevations in PeakReport attributes</span>
    <span class="n">azList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;HV&#39;</span><span class="p">]</span>
    <span class="n">azList</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_az</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
    <span class="k">for</span> <span class="n">az</span> <span class="ow">in</span> <span class="n">azList</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">peakReport</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">PeakReport</span><span class="p">[</span><span class="n">az</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;Table_Report&#39;</span> <span class="ow">in</span> <span class="n">peakReport</span><span class="p">[</span><span class="s1">&#39;Report&#39;</span><span class="p">]:</span> <span class="c1">#This is a dict</span>
                <span class="n">peakReport</span><span class="p">[</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Table_Report&#39;</span><span class="p">][</span><span class="s1">&#39;Elevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_surface_elevation</span>
                <span class="k">if</span> <span class="s1">&#39;BedrockDepth&#39;</span> <span class="ow">in</span> <span class="n">peakReport</span><span class="p">[</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Table_Report&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">peakReport</span><span class="p">[</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Table_Report&#39;</span><span class="p">][</span><span class="s1">&#39;BedrockElevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_surface_elevation</span> <span class="o">-</span> <span class="n">peakReport</span><span class="p">[</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Table_Report&#39;</span><span class="p">][</span><span class="s1">&#39;BedrockDepth&#39;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="s1">&#39;Print_Report&#39;</span> <span class="ow">in</span> <span class="n">peakReport</span><span class="p">[</span><span class="s1">&#39;Report&#39;</span><span class="p">]:</span> <span class="c1">#This is a dict</span>
                <span class="n">peakReport</span><span class="p">[</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Print_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Elevation:\s*[\d.]+&quot;</span><span class="p">,</span> 
                                                              <span class="sa">f</span><span class="s2">&quot;Elevation: </span><span class="si">{</span><span class="n">updated_surface_elevation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                                                              <span class="n">peakReport</span><span class="p">[</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Print_Report&#39;</span><span class="p">])</span>
                
    <span class="c1"># Update processing_parameters to reflect new elevations</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;fetch_data&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_surface_elevation</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;fetch_data&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;elev_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;fetch_data&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_surface_elevation</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;fetch_data&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;elev_unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;meters&#39;</span>
    
    <span class="k">return</span> <span class="n">hvsr_data</span></div>



<span class="c1"># Update instrument response file headers in .resp format</span>
<div class="viewcode-block" id="update_resp_file">
<a class="viewcode-back" href="../../sprit.sprit_hvsr.html#sprit.update_resp_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">update_resp_file</span><span class="p">(</span><span class="n">resp_file</span><span class="p">,</span> <span class="n">new_network</span><span class="p">,</span> <span class="n">new_station</span><span class="p">,</span> 
                     <span class="n">return_inv</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">new_channels</span><span class="o">=</span><span class="s1">&#39;CHZ&#39;</span><span class="p">,</span> <span class="n">new_location</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                     <span class="n">starttime_new</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">endtime_new</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_resp_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">existing_starttime</span><span class="o">=</span><span class="s1">&#39;2015,001,00:00:00.0000&#39;</span><span class="p">,</span> <span class="n">existing_endtime</span><span class="o">=</span><span class="s2">&quot;No Ending Time&quot;</span><span class="p">,</span>
                     <span class="n">existing_network</span><span class="o">=</span><span class="s1">&#39;XX&#39;</span><span class="p">,</span> <span class="n">existing_station</span><span class="o">=</span><span class="s1">&#39;NS124&#39;</span><span class="p">,</span> <span class="n">existing_channel</span><span class="o">=</span><span class="s1">&#39;CHZ&#39;</span><span class="p">,</span> <span class="n">existing_location</span><span class="o">=</span><span class="s1">&#39;??&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to update headers in .RESP instrument response files for easy copying.</span>
<span class="sd">       It is recommended to read this into a variable and set it as the metadata parameter of input_params</span>
<span class="sd">       if it is desired to correct for instrument response, for example.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    resp_file : str</span>
<span class="sd">        Filepath to input response file</span>
<span class="sd">    new_network : str</span>
<span class="sd">        Name of network to update header to.</span>
<span class="sd">    new_station : str</span>
<span class="sd">        Name of station to update header to.</span>
<span class="sd">    return_inv : bool, optional</span>
<span class="sd">        Whether to return an obspy inventory object.</span>
<span class="sd">        If False, a .RESP file will be saved in the same directory as resp_file, by default True</span>
<span class="sd">    new_channels : str, optional</span>
<span class="sd">        Name or list of channels to update the header to.</span>
<span class="sd">        If list, multiple inventory objects will be created/saved, by default &#39;CHZ&#39;</span>
<span class="sd">    new_location : str, optional</span>
<span class="sd">        New instrument location attribute to update header to, by default &quot;&quot;</span>
<span class="sd">    starttime : obspy.UTCDateTime, optional</span>
<span class="sd">        Input to update starttime. Must be readable by obspy.UTCDateTime(), by default None</span>
<span class="sd">    endtime : obspy.UTCDateTime, optional</span>
<span class="sd">        Input to update endtime. Must be readable by obspy.UTCDateTime(), by default None</span>
<span class="sd">    new_resp_file : str, optional</span>
<span class="sd">        Filepath to designate for .RESP file output, if desired (and return_inv=False)</span>
<span class="sd">        If None, uses same directory as resp_file, by default None</span>
<span class="sd">    existing_network : str, optional</span>
<span class="sd">        Name of network as specified in input file, by default &#39;XX&#39;</span>
<span class="sd">    existing_station : str, optional</span>
<span class="sd">        name of station as specified in input file, by default &#39;NS124&#39;</span>
<span class="sd">    existing_channel : str, optional</span>
<span class="sd">        Name of channel as specified in input file, by default &#39;CHZ&#39;</span>
<span class="sd">    existing_location : str, optional</span>
<span class="sd">        Name of location as specified in input file, by default &#39;??&#39;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obspy.Inventory</span>
<span class="sd">        Only returned if return_inv = True</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">resp_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">inFile</span><span class="p">:</span>
        <span class="n">respTextIN</span> <span class="o">=</span> <span class="n">inFile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="n">respText</span> <span class="o">=</span> <span class="n">respTextIN</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">existing_network</span><span class="p">,</span> <span class="n">new_network</span><span class="p">)</span>
    <span class="n">respText</span> <span class="o">=</span> <span class="n">respText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">existing_station</span><span class="p">,</span> <span class="n">new_station</span><span class="p">)</span>
    <span class="n">respTextNoChann</span> <span class="o">=</span> <span class="n">respText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">existing_location</span><span class="p">,</span> <span class="n">new_location</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_channels</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">new_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">new_channels</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">starttime_new</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sTime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">starttime_new</span><span class="p">)</span>
        <span class="n">sTimeText</span> <span class="o">=</span> <span class="n">existing_starttime</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;2015,&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sTime</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">sTimeText</span> <span class="o">=</span> <span class="n">sTimeText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;001,&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sTime</span><span class="o">.</span><span class="n">julday</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
        <span class="n">sTimeText</span> <span class="o">=</span> <span class="n">sTimeText</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;00:00:00.0000&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">sTime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S.</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)))</span>
        <span class="n">respTextNoChann</span> <span class="o">=</span> <span class="n">respTextNoChann</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">existing_starttime</span><span class="p">,</span> <span class="n">sTimeText</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">endtime_new</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">eTime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">endtime_new</span><span class="p">)</span>
        <span class="n">respTextNoChann</span> <span class="o">=</span> <span class="n">respTextNoChann</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">existing_endtime</span><span class="p">,</span> 
                                                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">eTime</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">eTime</span><span class="o">.</span><span class="n">julday</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">eTime</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M:%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">invList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">newcha</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_channels</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">newcha</span><span class="p">)</span>
        <span class="n">respText</span> <span class="o">=</span> <span class="n">respTextNoChann</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">existing_channel</span><span class="p">,</span> <span class="n">newcha</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_inv</span><span class="p">:</span>
            <span class="n">invList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">read_inventory</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">respText</span><span class="p">)))</span>
                        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">new_resp_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">resp_file</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>
                <span class="n">new_resp_file</span> <span class="o">=</span> <span class="nb">dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RESP_</span><span class="si">{</span><span class="n">new_network</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">new_station</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">new_station</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">newcha</span><span class="si">}</span><span class="s2">.resp&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_resp_file</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">new_resp_file</span><span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">new_resp_file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outFile</span><span class="p">:</span>
                <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_resp_file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="n">return_inv</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">invList</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">inv</span> <span class="o">=</span> <span class="n">r</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inv</span> <span class="o">=</span> <span class="n">inv</span> <span class="o">+</span> <span class="n">r</span>
        <span class="k">return</span> <span class="n">inv</span></div>


<span class="c1"># BATCH FUNCTIONS: various functions that are used to help the regular functions handle batch data</span>
<span class="c1"># Helper function for batch processing of check_peaks</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__check_peaks_batch</span><span class="p">(</span><span class="o">**</span><span class="n">check_peaks_kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">check_peaks</span><span class="p">(</span><span class="o">**</span><span class="n">check_peaks_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_peaks_kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1"> succesfully completed check_peaks()&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]))</span>    
    <span class="k">except</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in check_peaks(</span><span class="si">{</span><span class="n">check_peaks_kwargs</span><span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">][</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, **check_peaks_kwargs)&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">check_peaks_kwargs</span><span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">hvsr_data</span>


<span class="c1"># Support function for running batch</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__generate_ppsds_batch</span><span class="p">(</span><span class="o">**</span><span class="n">generate_psds_kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">generate_psds</span><span class="p">(</span><span class="o">**</span><span class="n">generate_psds_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">generate_psds_kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1"> successfully completed generate_psds()&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in generate_psds(</span><span class="si">{</span><span class="n">generate_psds_kwargs</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, **generate_psds_kwargs)&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">generate_psds_kwargs</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">params</span>


<span class="c1"># Helper function for batch processing of get_report</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__get_report_batch</span><span class="p">(</span><span class="o">**</span><span class="n">get_report_kwargs</span><span class="p">):</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">get_report</span><span class="p">(</span><span class="o">**</span><span class="n">get_report_kwargs</span><span class="p">)</span>
        <span class="c1">#Print if verbose, but selected report_formats was not print</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="c1">#add some &#39;whitespace&#39;</span>
        <span class="k">if</span> <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;print&#39;</span> <span class="ow">in</span> <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;report_formats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;print&#39;</span>
                <span class="n">get_report</span><span class="p">(</span><span class="o">**</span><span class="n">get_report_kwargs</span><span class="p">)</span>
        
    <span class="k">except</span><span class="p">:</span>
        <span class="n">warnMsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error in get_report(</span><span class="si">{</span><span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;hvsr_results&#39;</span><span class="p">][</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, **get_report_kwargs)&quot;</span>
        <span class="k">if</span> <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">warnMsg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warnMsg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">get_report_kwargs</span><span class="p">[</span><span class="s1">&#39;hvsr_results&#39;</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">hvsr_results</span>


<span class="c1"># Helper function for batch procesing of azimuth</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__azimuth_batch</span><span class="p">(</span><span class="o">**</span><span class="n">azimuth_kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">calculate_azimuth</span><span class="p">(</span><span class="o">**</span><span class="n">azimuth_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;input_params&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1"> successfully completed calculate_azimuth()&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="s1">&#39;site&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1"> successfully completed calculate_azimuth()&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in calculate_azimuth(</span><span class="si">{</span><span class="n">azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, **azimuth_kwargs)&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hvsr_data</span>


<span class="c1"># Helper function for batch procesing of remove_noise</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__remove_noise_batch</span><span class="p">(</span><span class="o">**</span><span class="n">remove_noise_kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">remove_noise</span><span class="p">(</span><span class="o">**</span><span class="n">remove_noise_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remove_noise_kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;input_params&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1"> successfully completed remove_noise()&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="s1">&#39;site&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1"> successfully completed remove_noise()&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in remove_noise(</span><span class="si">{</span><span class="n">remove_noise_kwargs</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, **remove_noise_kwargs)&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hvsr_data</span>


<span class="c1"># Helper function batch processing of remove_outlier_curves</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__remove_outlier_curves</span><span class="p">(</span><span class="o">**</span><span class="n">remove_outlier_curves_kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">remove_outlier_curves</span><span class="p">(</span><span class="o">**</span><span class="n">remove_outlier_curves_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remove_outlier_curves_kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;input_params&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1"> successfully completed remove_outlier_curves()&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="s1">&#39;site&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1"> successfully completed remove_outlier_curves()&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in remove_outlier_curves(</span><span class="si">{</span><span class="n">remove_outlier_curves_kwargs</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, **remove_outlier_curves_kwargs)&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hvsr_data</span>


<span class="c1"># Batch function for plot_hvsr()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__hvsr_plot_batch</span><span class="p">(</span><span class="o">**</span><span class="n">hvsr_plot_kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">plot_hvsr</span><span class="p">(</span><span class="o">**</span><span class="n">hvsr_plot_kwargs</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in plotting (</span><span class="si">{</span><span class="n">hvsr_plot_kwargs</span><span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">][</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, **hvsr_plot_kwargs)&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">hvsr_plot_kwargs</span><span class="p">[</span><span class="s1">&#39;hvsr_data&#39;</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">hvsr_data</span>


<span class="c1"># Support function for batch of plot_azimuth()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__plot_azimuth_batch</span><span class="p">(</span><span class="o">**</span><span class="n">plot_azimuth_kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Azimuth_Fig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_azimuth</span><span class="p">(</span><span class="o">**</span><span class="n">plot_azimuth_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plot_azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1"> successfully completed plot_azimuth()&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">errMsg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error in plot_azimuth(</span><span class="si">{</span><span class="n">plot_azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, **plot_azimuth_kwargs)&quot;</span>
        <span class="k">if</span> <span class="n">plot_azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">errMsg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">errMsg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">plot_azimuth_kwargs</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">hvsr_data</span>


<span class="c1"># Helper function for batch version of process_hvsr()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__process_hvsr_batch</span><span class="p">(</span><span class="o">**</span><span class="n">process_hvsr_kwargs</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">process_hvsr</span><span class="p">(</span><span class="o">**</span><span class="n">process_hvsr_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">process_hvsr_kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{}</span><span class="s1"> successfully completed process_hvsr()&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">errMsg</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Error in process_hvsr(</span><span class="si">{</span><span class="n">process_hvsr_kwargs</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, **process_hvsr_kwargs)&quot;</span>
        <span class="k">if</span> <span class="n">process_hvsr_kwargs</span><span class="p">[</span><span class="s1">&#39;verbose&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">errMsg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">errMsg</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
        <span class="n">hvsr_data</span> <span class="o">=</span> <span class="n">process_hvsr_kwargs</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">hvsr_data</span>

<span class="c1"># OTHER HELPER FUNCTIONS</span>

<span class="c1"># HELPER functions for fetch_data() and get_metadata()</span>
<span class="c1"># Read in metadata .inv file, specifically for RaspShake</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_update_shake_metadata</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">write_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reads static metadata file provided for Rasp Shake and updates with input parameters. Used primarily in the get_metadata() function.</span>

<span class="sd">        PARAMETERS</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str or pathlib.Path object</span>
<span class="sd">            Filepath to metadata file. Should be a file format supported by obspy.read_inventory().</span>
<span class="sd">        params : dict</span>
<span class="sd">            Dictionary containing necessary keys/values for updating, currently only supported for STATIONXML with Raspberry Shakes.</span>
<span class="sd">                Necessary keys: &#39;net&#39;, &#39;sta&#39;, </span>
<span class="sd">                Optional keys: &#39;longitude&#39;, &#39;latitude&#39;, &#39;elevation&#39;, &#39;depth&#39;</span>
<span class="sd">        write_path   : str, default=&#39;&#39;</span>
<span class="sd">            If specified, filepath to write to updated inventory file to.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        params : dict</span>
<span class="sd">            Updated params dict with new key:value pair with updated updated obspy.inventory object (key=&quot;inv&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Updating Metadata for Raspberry Shake Instrument Type&quot;</span><span class="p">)</span>

    <span class="n">network</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span>
    <span class="n">station</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">]</span>
    <span class="n">optKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;elevation&#39;</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">optKeys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;0&#39;</span>
    
    <span class="n">wgs84_transformer</span> <span class="o">=</span> <span class="n">Transformer</span><span class="o">.</span><span class="n">from_crs</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;input_crs&#39;</span><span class="p">],</span> <span class="s2">&quot;4326&quot;</span><span class="p">)</span>
    
    <span class="n">xcoord</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
    <span class="n">ycoord</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">])</span>
    <span class="n">elevation</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">])</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;depth&#39;</span><span class="p">])</span>
    
    
    <span class="n">startdate</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">year</span><span class="o">=</span><span class="mi">2023</span><span class="p">,</span> <span class="n">month</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">day</span><span class="o">=</span><span class="mi">15</span><span class="p">))</span> <span class="c1">#First day sprit code worked :)</span>
    <span class="n">enddate</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>

    <span class="n">filepath</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_checkifpath</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

    <span class="n">prefix</span><span class="o">=</span> <span class="s2">&quot;{http://www.fdsn.org/xml/station/1}&quot;</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Channel&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;startDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">startdate</span>
        <span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;endDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">enddate</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Station&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">station</span>
        <span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;startDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">startdate</span>
        <span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;endDate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">enddate</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Network&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">network</span>
        
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Latitude&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">ycoord</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Longitude&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">xcoord</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Created&#39;</span><span class="p">):</span>
        <span class="n">nowTime</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">item</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">nowTime</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Elevation&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="o">=</span> <span class="n">elevation</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="s1">&#39;Depth&#39;</span><span class="p">):</span>
        <span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="o">=</span><span class="n">depth</span>

    <span class="c1">#Set up (and) export</span>
    <span class="c1">#filetag = &#39;_&#39;+str(datetime.datetime.today().date())</span>
    <span class="c1">#outfile = str(parentPath)+&#39;\\&#39;+filename+filetag+&#39;.inv&#39;</span>

    <span class="k">if</span> <span class="n">write_path</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">write_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">write_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">write_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;network&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;station&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;_response.xml&#39;</span>
                <span class="n">write_file</span> <span class="o">=</span> <span class="n">write_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">write_file</span><span class="o">=</span><span class="n">write_path</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_file</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;xml&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read_inventory</span><span class="p">(</span><span class="n">write_file</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;STATIONXML&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;response&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;write_path=</span><span class="si">{</span><span class="n">write_path</span><span class="si">}</span><span class="s1"> is not recognized as a filepath, updated metadata file will not be written&#39;</span><span class="p">)</span>
            <span class="n">write_path</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1">#Create temporary file for reading into obspy</span>
            <span class="n">tpf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">stringRoot</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;xml&#39;</span><span class="p">)</span>
            <span class="n">tpf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">stringRoot</span><span class="p">)</span>

            <span class="n">inv</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read_inventory</span><span class="p">(</span><span class="n">tpf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;STATIONXML&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;response&#39;</span><span class="p">)</span>
            <span class="n">tpf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tpf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">write_file</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">with_name</span><span class="p">(</span><span class="s1">&#39;metadata.xml&#39;</span><span class="p">)</span>
            <span class="n">tree</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">write_file</span><span class="p">,</span> <span class="n">xml_declaration</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;xml&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
            <span class="n">inv</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read_inventory</span><span class="p">(</span><span class="n">write_file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;STATIONXML&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;response&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">write_file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>

    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv</span>
    <span class="k">return</span> <span class="n">params</span>


<span class="c1"># Support function for get_metadata()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_read_RS_Metadata</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to read the metadata from Raspberry Shake using the StationXML file provided by the company.</span>
<span class="sd">    Intended to be used within the get_metadata() function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params : dict</span>
<span class="sd">        The parameter dictionary output from input_params() and read into get_metadata()</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    params : dict</span>
<span class="sd">        Further modified parameter dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;inv&#39;</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_checkifpath</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">])</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read_inventory</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;STATIONXML&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;response&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv</span>

    <span class="n">station</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;sta&#39;</span><span class="p">]</span>
    <span class="n">network</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;net&#39;</span><span class="p">]</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;cha&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inv</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">Inventory</span><span class="p">):</span>
        <span class="c1">#Create temporary file from inventory object</span>
        <span class="n">tpf</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">inv</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tpf</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;STATIONXML&#39;</span><span class="p">)</span>

        <span class="c1">#Read data into xmlTree</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">tpf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

        <span class="c1">#Close and remove temporary file</span>
        <span class="n">tpf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tpf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_checkifpath</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span>
        <span class="n">inv</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read_inventory</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;STATIONXML&#39;</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;response&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inv</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">inv</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>

    <span class="c1">#if write_path != &#39;&#39;:</span>
    <span class="c1">#    inv.write(write_path, format=&#39;STATIONXML&#39;)</span>

    <span class="c1">#This is specific to RaspShake</span>
    <span class="n">c</span><span class="o">=</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pzList</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">))]</span>
    <span class="n">s</span><span class="o">=</span><span class="n">pzList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">prefix</span><span class="o">=</span> <span class="s2">&quot;{http://www.fdsn.org/xml/station/1}&quot;</span>

    <span class="n">sensitivityPath</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Network[@code=&#39;&quot;</span><span class="o">+</span><span class="n">network</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Station[@code=&#39;&quot;</span><span class="o">+</span><span class="n">station</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Channel[@code=&#39;&quot;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Response/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;InstrumentSensitivity/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Value&quot;</span>
    <span class="n">gainPath</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Network[@code=&#39;&quot;</span><span class="o">+</span><span class="n">network</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Station[@code=&#39;&quot;</span><span class="o">+</span><span class="n">station</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Channel[@code=&#39;&quot;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Response/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Stage[@number=&#39;1&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;StageGain/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Value&quot;</span>

    <span class="c1">#paz = []</span>
    <span class="n">rsCList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EHZ&#39;</span><span class="p">,</span> <span class="s1">&#39;EHN&#39;</span><span class="p">,</span> <span class="s1">&#39;EHE&#39;</span><span class="p">]</span>
    <span class="n">paz</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">channelPaz</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#channelPaz[&#39;channel&#39;] = c</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">sensitivityPath</span><span class="p">):</span>
            <span class="n">channelPaz</span><span class="p">[</span><span class="s1">&#39;sensitivity&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">gainPath</span><span class="p">):</span>
            <span class="n">channelPaz</span><span class="p">[</span><span class="s1">&#39;gain&#39;</span><span class="p">]</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        
        <span class="n">poleList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">zeroList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">pzList</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">polePathReal</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Network[@code=&#39;&quot;</span><span class="o">+</span><span class="n">network</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Station[@code=&#39;&quot;</span><span class="o">+</span><span class="n">station</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Channel[@code=&#39;&quot;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Response/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Stage[@number=&#39;1&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;PolesZeros/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Pole[@number=&#39;&quot;</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Real&quot;</span>
                <span class="n">polePathImag</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Network[@code=&#39;&quot;</span><span class="o">+</span><span class="n">network</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Station[@code=&#39;&quot;</span><span class="o">+</span><span class="n">station</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Channel[@code=&#39;&quot;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Response/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Stage[@number=&#39;1&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;PolesZeros/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Pole[@number=&#39;&quot;</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Imaginary&quot;</span>
                <span class="k">for</span> <span class="n">poleItem</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">polePathReal</span><span class="p">):</span>
                    <span class="n">poleReal</span> <span class="o">=</span> <span class="n">poleItem</span><span class="o">.</span><span class="n">text</span>
                <span class="k">for</span> <span class="n">poleItem</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">polePathImag</span><span class="p">):</span>
                    <span class="n">pole</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">poleReal</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">poleItem</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
                    <span class="n">poleList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pole</span><span class="p">)</span>
                    <span class="n">channelPaz</span><span class="p">[</span><span class="s1">&#39;poles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">poleList</span>
                    <span class="c1">#channelPaz[&#39;poles&#39;] = list(set(poleList))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zeroPathReal</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Network[@code=&#39;&quot;</span><span class="o">+</span><span class="n">network</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Station[@code=&#39;&quot;</span><span class="o">+</span><span class="n">station</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Channel[@code=&#39;&quot;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Response/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Stage[@number=&#39;1&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;PolesZeros/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Zero[@number=&#39;&quot;</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Real&quot;</span>
                <span class="n">zeroPathImag</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Network[@code=&#39;&quot;</span><span class="o">+</span><span class="n">network</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Station[@code=&#39;&quot;</span><span class="o">+</span><span class="n">station</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Channel[@code=&#39;&quot;</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Response/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Stage[@number=&#39;1&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;PolesZeros/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Zero[@number=&#39;&quot;</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="s2">&quot;&#39;]/&quot;</span><span class="o">+</span><span class="n">prefix</span><span class="o">+</span><span class="s2">&quot;Imaginary&quot;</span>
                <span class="k">for</span> <span class="n">zeroItem</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">zeroPathReal</span><span class="p">):</span>
                    <span class="n">zeroReal</span> <span class="o">=</span> <span class="n">zeroItem</span><span class="o">.</span><span class="n">text</span>
                
                <span class="k">for</span> <span class="n">zeroItem</span> <span class="ow">in</span> <span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">zeroPathImag</span><span class="p">):</span>
                    <span class="n">zero</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">zeroReal</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">zeroItem</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
                    <span class="c1">#zero = zeroReal + &quot;+&quot; + zeroItem.text+&#39;j&#39;</span>
                    <span class="n">zeroList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zero</span><span class="p">)</span>
                    <span class="c1">#channelPaz[&#39;zeros&#39;] = list(set(zeroList))</span>
                    <span class="n">channelPaz</span><span class="p">[</span><span class="s1">&#39;zeros&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeroList</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">rsCList</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">paz</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="o">=</span> <span class="n">channelPaz</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;paz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">paz</span>
    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">][</span><span class="s1">&#39;paz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">paz</span>

    <span class="k">return</span> <span class="n">params</span>


<span class="c1"># Helper function to sort channels</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_sort_channels</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">verbose</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">!=</span><span class="s1">&#39;batch&#39;</span><span class="p">:</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SITENAME&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;stream&#39;</span><span class="p">:</span><span class="nb">input</span><span class="p">}}</span> <span class="c1">#Make same structure as batch</span>

    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">rawDataIN</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">rawDataIN</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No data was read using specified parameters </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">input</span><span class="p">[</span><span class="n">site</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No data was read using specified parameters&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rawDataIN</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">Stream</span><span class="p">):</span>
            <span class="c1">#Make sure z component is first</span>
            <span class="n">dataIN</span> <span class="o">=</span> <span class="n">rawDataIN</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s1">&#39;channel&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#z, n, e order</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#Not usually used anymore, retained just in case</span>
            <span class="n">dataIN</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rawDataIN</span><span class="p">):</span>
                <span class="k">if</span> <span class="s1">&#39;Z&#39;</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]:</span><span class="c1">#).split(&#39;.&#39;)[3]:#[12:15]:</span>
                    <span class="n">dataIN</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rawDataIN</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dataIN</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rawDataIN</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sort</span><span class="p">([</span><span class="s1">&#39;channel&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="c1">#z, n, e order            </span>

        <span class="nb">input</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span>
            
    <span class="k">if</span> <span class="n">source</span><span class="o">==</span><span class="s1">&#39;batch&#39;</span><span class="p">:</span>
        <span class="c1">#Return a dict</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nb">input</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#Return a stream otherwise</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">output</span>


<span class="c1"># Trim data </span>
<span class="k">def</span><span class="w"> </span><span class="nf">_trim_data</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">export_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data_export_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to trim data to start and end time</span>

<span class="sd">        Trim data to start and end times so that stream being analyzed only contains wanted data.</span>
<span class="sd">        Can also export data to specified directory using a specified site name and/or data_export_format</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            input  : HVSRData</span>
<span class="sd">                HVSR Data class containing input parameters for trimming</span>
<span class="sd">            stream  : obspy.stream object  </span>
<span class="sd">                Obspy stream to be trimmed</span>
<span class="sd">            export_dir: str or pathlib obj   </span>
<span class="sd">                Output filepath to export trimmed data to. If not specified, does not export. </span>
<span class="sd">            data_export_format  : str or None, default=None  </span>
<span class="sd">                If None, and export_dir is specified, format defaults to .mseed. Otherwise, exports trimmed stream using obspy.core.stream.Stream.write() method, with data_export_format being passed to the format argument. </span>
<span class="sd">                https://docs.obspy.org/packages/autogen/obspy.core.stream.Stream.write.html#obspy.core.stream.Stream.write</span>
<span class="sd">            **kwargs</span>
<span class="sd">                Keyword arguments passed directly to obspy.core.stream.Stream.trim() method.</span>
<span class="sd">                </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            st_trimmed  : obspy.stream object </span>
<span class="sd">                Obpsy Stream trimmed to start and end times</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#if source!=&#39;batch&#39;:</span>
    <span class="c1">#    #input = {&#39;SITENAME&#39;: {&#39;stream&#39;:input}} #Make same structure as batch</span>
    <span class="c1">#    pass</span>

    <span class="k">if</span> <span class="s1">&#39;starttime&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="n">start</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="s1">&#39;endtime&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">end</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="s1">&#39;site&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">site</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">site</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">stream</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">st_trimmed</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="s1">&#39;stream&#39;</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">st_trimmed</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">UnboundLocalError</span><span class="p">(</span><span class="s2">&quot;stream not specified. Must either be specified using stream parameter or as a key in the input parameters (input[&#39;stream&#39;])&quot;</span><span class="p">)</span>
        
    <span class="n">trimStart</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">start</span><span class="p">)</span>
    <span class="n">trimEnd</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">end</span><span class="p">)</span>

    <span class="c1">#If data is contained in a masked array, split to undo masked array</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">):</span>
        <span class="n">st_trimmed</span> <span class="o">=</span> <span class="n">st_trimmed</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="c1">#This split is undone with the .merge() method a few lines down</span>

    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st_trimmed</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">trimStart</span> <span class="o">&gt;</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="ow">or</span> <span class="n">trimEnd</span> <span class="o">&lt;</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st_trimmed</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">trimStart</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="n">trimEnd</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">st_trimmed</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data_export_format</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_export_format</span> <span class="o">=</span> <span class="s1">&#39;.mseed&#39;</span>

    <span class="c1">#Format export filepath, if exporting</span>
    <span class="k">if</span> <span class="n">export_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">site</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">site</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">site</span> <span class="o">=</span> <span class="n">site</span><span class="o">+</span><span class="s1">&#39;_&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_export_format</span><span class="p">:</span>
            <span class="n">data_export_format</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">data_export_format</span>
        <span class="n">net</span> <span class="o">=</span> <span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">network</span>
        <span class="n">sta</span> <span class="o">=</span> <span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">station</span>
        <span class="n">loc</span> <span class="o">=</span> <span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">location</span>
        <span class="n">yr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">year</span><span class="p">)</span>
        <span class="n">strtD</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
        <span class="n">strtT</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">strtT</span><span class="o">=</span><span class="n">strtT</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">endT</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">endT</span> <span class="o">=</span> <span class="n">endT</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">.</span><span class="n">time</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">doy</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">st_trimmed</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">utctimetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">export_dir</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_checkifpath</span><span class="p">(</span><span class="n">export_dir</span><span class="p">)</span>
        <span class="n">export_dir</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">export_dir</span><span class="p">)</span>
        <span class="n">export_dir</span> <span class="o">=</span> <span class="n">export_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">export_dir</span> <span class="o">=</span> <span class="n">export_dir</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">data_export_format</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">site</span><span class="o">+</span><span class="n">net</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">sta</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">loc</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">yr</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">doy</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">strtD</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">strtT</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">endT</span><span class="o">+</span><span class="n">data_export_format</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">data_export_format</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">site</span><span class="o">+</span><span class="n">net</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">sta</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">loc</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">yr</span><span class="o">+</span><span class="s1">&#39;.&#39;</span><span class="o">+</span><span class="n">doy</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">strtD</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">strtT</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">endT</span><span class="o">+</span><span class="s1">&#39;.mseed&#39;</span>

        <span class="k">if</span> <span class="n">export_dir</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">export_dir</span><span class="o">=</span><span class="n">export_dir</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">exportFile</span> <span class="o">=</span> <span class="n">export_dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">filename</span>

        <span class="c1">#Take care of masked arrays for writing purposes</span>
        <span class="k">if</span> <span class="s1">&#39;fill_value&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">st_trimmed</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_array</span><span class="p">):</span>
                    <span class="n">tr</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;fill_value&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st_trimmed</span> <span class="o">=</span> <span class="n">st_trimmed</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        
        <span class="n">st_trimmed</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">exportFile</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="n">st_trimmed</span>


<span class="c1"># Helper function to detrend data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__detrend_data</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">detrend</span><span class="p">,</span> <span class="n">detrend_options</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function to detrend data, specifically formatted for the HVSRData and HVSRBatch objects&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">source</span> <span class="o">!=</span> <span class="s1">&#39;batch&#39;</span><span class="p">:</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SITENAME&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;stream&#39;</span><span class="p">:</span><span class="nb">input</span><span class="p">}}</span> <span class="c1">#Make same structure as batch</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">dataIN</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">detrend</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">detrend</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="c1">#By default, do a spline removal</span>
            <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="p">:</span>
                <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;spline&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">detrend_options</span><span class="p">,</span> <span class="n">dspline</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_undetrended</span> <span class="o">=</span> <span class="n">dataIN</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">detrend</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;simple&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="p">:</span>
                        <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">detrend</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="p">:</span>
                        <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">detrend</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;constant&#39;</span> <span class="ow">or</span> <span class="n">detrend</span><span class="o">==</span><span class="s1">&#39;demean&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="p">:</span>
                        <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">detrend</span><span class="p">)</span>                
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">detrend</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;polynomial&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="p">:</span>
                        <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">detrend_options</span><span class="p">)</span>   
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">detrend</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;spline&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="p">:</span>
                        <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">detrend</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">detrend_options</span><span class="p">),</span> <span class="n">dspline</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>       
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="p">:</span>
                        <span class="n">tr</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Detrend type </span><span class="si">{</span><span class="n">detrend</span><span class="si">}</span><span class="s1"> could not be carried out, using &quot;constant&quot; detrend instead.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>                        
                    <span class="n">dataIN</span> <span class="o">=</span> <span class="n">data_undetrended</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Detrend error, data not detrended. </span><span class="se">\n</span><span class="s2">Detrend Error Report below. Carrying on processing with non-detrended data: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="ne">UserWarning</span><span class="p">)</span>
            
        <span class="nb">input</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span>

    <span class="k">if</span> <span class="n">source</span><span class="o">==</span><span class="s1">&#39;batch&#39;</span><span class="p">:</span>
        <span class="c1">#Return a dict</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nb">input</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#Return a stream otherwise</span>
        <span class="n">output</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">output</span>


<span class="c1"># Helper function to read data from Tromino Blue instruments</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__read_tromino_data_blue</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                            <span class="n">channel_map</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">},</span> <span class="n">data_start_buffer</span><span class="o">=</span><span class="mi">113</span><span class="p">,</span>
                            <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="c1"># Reconfigure data for some of the analysis</span>
    <span class="n">swapped</span> <span class="o">=</span> <span class="n">__swap_bytes</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> 

    <span class="c1"># Initialize a result dictionary</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s1">&#39;gps_data&#39;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="s1">&#39;seismometer_data&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Will be replaced with a (7, n) numpy array</span>
        <span class="s1">&#39;stream&#39;</span><span class="p">:</span> <span class="kc">None</span> 
        <span class="p">}</span>
    
    <span class="c1"># Extract header information (text sections)</span>
    <span class="n">header_text</span> <span class="o">=</span> <span class="n">__extract_text_sections</span><span class="p">(</span><span class="n">swapped</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">header_text</span><span class="p">:</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s1">&#39;NAKAGRILLA FLASHCARD HEADER&#39;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="s1">&#39;header&#39;</span><span class="p">][</span><span class="s1">&#39;file_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Add more header parsing as needed</span>
    
    <span class="c1"># Extract GPS NMEA sentences</span>
    <span class="n">gps_data</span> <span class="o">=</span> <span class="n">__extract_gps_data</span><span class="p">(</span><span class="n">swapped</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="n">gps_data</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sentence</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;$GPGGA&#39;</span><span class="p">):</span>
            <span class="c1"># Parse GPGGA sentence (position data)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">sentence</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">lat</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">60</span> <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">lat_dir</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">lon</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">][:</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">3</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">60</span> <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">lon_dir</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">lat_dir</span> <span class="o">==</span> <span class="s1">&#39;S&#39;</span><span class="p">:</span>
                        <span class="n">lat</span> <span class="o">=</span> <span class="o">-</span><span class="n">lat</span>
                    <span class="k">if</span> <span class="n">lon_dir</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
                        <span class="n">lon</span> <span class="o">=</span> <span class="o">-</span><span class="n">lon</span>
                        
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;gps_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;GPGGA&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
                        <span class="s1">&#39;latitude&#39;</span><span class="p">:</span> <span class="n">lat</span><span class="p">,</span>
                        <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="n">lon</span><span class="p">,</span>
                        <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="n">sentence</span>
                    <span class="p">})</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;gps_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;GPGGA&#39;</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="n">sentence</span><span class="p">,</span> <span class="s1">&#39;parse_error&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
        
        <span class="k">elif</span> <span class="n">sentence</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;$GPZDA&#39;</span><span class="p">):</span>
            <span class="c1"># Parse GPZDA sentence (date &amp; time)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">sentence</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">day</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">month</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">year</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;gps_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                        <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;GPZDA&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
                        <span class="s1">&#39;date&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">day</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="n">sentence</span>
                    <span class="p">})</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;gps_data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;GPZDA&#39;</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="n">sentence</span><span class="p">,</span> <span class="s1">&#39;parse_error&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    
    <span class="c1"># Extract seismometer data</span>
    <span class="c1"># Find the start of seismometer data section (after GPS data)</span>
    <span class="n">seis_data_start</span> <span class="o">=</span> <span class="n">__locate_data_start_blue</span><span class="p">(</span><span class="n">swapped</span><span class="p">)</span>
    
    <span class="c1"># Get seismic starting buffer</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">header_text</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;FIRST DATA&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="n">data_buffer</span> <span class="o">=</span> <span class="n">data_start_buffer</span> <span class="c1">#137#int(str(item).split(&#39;-&#39;)[2].split(&quot;ADDRES &quot;)[1].split(&#39;.&#39;)[0])</span>

    <span class="c1"># Get sampling rate</span>
    <span class="k">if</span> <span class="n">sampling_rate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">header_text</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;PER SECOND&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="n">sampling_rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;BYTE &quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;PER&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Sampling rate detected as:&#39;</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="p">)</span>

    <span class="c1"># Read the file as simple bytes</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="c1">#data_start_byte SHOULD NOT BE HARDCODED! (will eventually determine)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">seis_data_start</span> <span class="o">+</span> <span class="n">data_buffer</span><span class="p">)</span>
        <span class="c1"># Read the rest of the file</span>
        <span class="n">raw_bytes</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="c1">#raw_bytes = swapped[seis_data_start + data_buffer:]</span>

    <span class="c1"># Assign variables for reading data</span>
    <span class="n">bytes_per_sample</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 16-bit</span>
    <span class="n">num_channels</span> <span class="o">=</span> <span class="mi">7</span> <span class="c1">#3x accel, 3x seism, 1x trigger</span>
    <span class="n">total_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">raw_bytes</span><span class="p">)</span> <span class="o">//</span> <span class="n">bytes_per_sample</span>

    <span class="c1"># Decode all samples</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">total_samples</span><span class="p">):</span>
        <span class="n">start_byte</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="n">bytes_per_sample</span>
        <span class="n">sample_bytes</span> <span class="o">=</span> <span class="n">raw_bytes</span><span class="p">[</span><span class="n">start_byte</span><span class="p">:</span><span class="n">start_byte</span> <span class="o">+</span> <span class="n">bytes_per_sample</span><span class="p">]</span>
        
        <span class="c1"># Try little-endian first</span>
        <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">sample_bytes</span><span class="p">,</span> <span class="n">byteorder</span><span class="o">=</span><span class="s1">&#39;little&#39;</span><span class="p">,</span> <span class="n">signed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="c1"># Convert to numpy array</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="c1"># Ensure we have complete sets of channel data</span>
    <span class="n">usable_samples</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">//</span> <span class="n">num_channels</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_channels</span>
    <span class="n">channel_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:</span><span class="n">usable_samples</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_channels</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="c1"># Analyze the data</span>
        <span class="n">zero_percent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">channel_data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Zero percentage: </span><span class="si">{</span><span class="n">zero_percent</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="c1"># Check zeros by channel</span>
        <span class="n">zeros_by_channel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">channel_data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">samples_per_channel</span> <span class="o">=</span> <span class="n">channel_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Zero percentage by channel:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_channels</span><span class="p">):</span>
            <span class="n">channel_zero_percent</span> <span class="o">=</span> <span class="n">zeros_by_channel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">samples_per_channel</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">channel_zero_percent</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

        <span class="c1"># Plot the first 1000 samples of each channel</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_channels</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">num_channels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">channel_data</span><span class="p">[:</span><span class="mi">1000</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Channel </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


    <span class="c1"># Extract data from GPS strings</span>
    <span class="n">acq_date</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">sTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">latPts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lonPts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">elevPts</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">gpsPt</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;gps_data&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="s1">&#39;ZDA&#39;</span> <span class="ow">in</span> <span class="n">gpsPt</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">in</span> <span class="n">gpsPt</span><span class="p">:</span>
                <span class="n">sTime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">gpsPt</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">][:</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">gpsPt</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">gpsPt</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">][</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]))</span>
            <span class="k">if</span> <span class="s1">&#39;date&#39;</span> <span class="ow">in</span> <span class="n">gpsPt</span><span class="p">:</span>
                <span class="n">acq_date</span><span class="o">=</span><span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">gpsPt</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="s1">&#39;GGA&#39;</span> <span class="ow">in</span> <span class="n">gpsPt</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]:</span>
            <span class="n">latPts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gpsPt</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">])</span>
            <span class="n">lonPts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gpsPt</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">])</span>
            <span class="n">elevPts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">gpsPt</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[</span><span class="mi">9</span><span class="p">]))</span>
        
    <span class="n">acq_date</span> <span class="o">=</span> <span class="n">acq_date</span> <span class="o">+</span> <span class="p">(</span><span class="n">sTime</span><span class="o">.</span><span class="n">hour</span><span class="o">*</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="n">sTime</span><span class="o">.</span><span class="n">minute</span><span class="o">*</span><span class="mi">60</span> <span class="o">+</span> <span class="n">sTime</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;network&#39;</span><span class="p">:</span><span class="s1">&#39;TR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;station&#39;</span><span class="p">:</span><span class="s1">&#39;BLUE&#39;</span><span class="p">,</span>
            <span class="s1">&#39;sampling_rate&#39;</span><span class="p">:</span><span class="n">sampling_rate</span><span class="p">,</span>
            <span class="s1">&#39;starttime&#39;</span><span class="p">:</span><span class="n">acq_date</span><span class="p">,</span>
            <span class="s1">&#39;longitude&#39;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">lonPts</span><span class="p">)),</span> <span class="mi">7</span><span class="p">),</span>
            <span class="s1">&#39;latitude&#39;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">latPts</span><span class="p">)),</span> <span class="mi">7</span><span class="p">),</span>
            <span class="s1">&#39;input_crs&#39;</span><span class="p">:</span><span class="s1">&#39;EPSG:4326&#39;</span><span class="p">,</span>
            <span class="s1">&#39;elevation&#39;</span><span class="p">:</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">elevPts</span><span class="p">)),</span> <span class="mi">7</span><span class="p">),</span>
            <span class="s1">&#39;elev_unit&#39;</span><span class="p">:</span><span class="s1">&#39;m&#39;</span><span class="p">,</span>
            <span class="s1">&#39;instrument&#39;</span><span class="p">:</span> <span class="s1">&#39;Tromino Blue&#39;</span>
            <span class="p">}</span>
    
    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;EHN&#39;</span>
    <span class="n">nTrace</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">channel_data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">channel_map</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]],</span> <span class="n">header</span><span class="o">=</span><span class="n">stats</span><span class="p">)</span>
    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;EHE&#39;</span>
    <span class="n">eTrace</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">channel_data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">channel_map</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">]],</span> <span class="n">header</span><span class="o">=</span><span class="n">stats</span><span class="p">)</span>
    <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;EHZ&#39;</span>
    <span class="n">zTrace</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">channel_data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">channel_map</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]],</span> <span class="n">header</span><span class="o">=</span><span class="n">stats</span><span class="p">)</span>

    <span class="n">st</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">([</span><span class="n">zTrace</span><span class="p">,</span> <span class="n">eTrace</span><span class="p">,</span> <span class="n">nTrace</span><span class="p">])</span>

    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span>

    <span class="k">if</span> <span class="n">return_dict</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">return</span> <span class="n">st</span>


<span class="k">def</span><span class="w"> </span><span class="nf">__extract_text_sections</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract text sections from binary data&quot;&quot;&quot;</span>
    <span class="c1"># Find blocks of ASCII text (simple approach)</span>
    <span class="n">text_sections</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Look for consecutive printable ASCII characters</span>
    <span class="n">ascii_chunks</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="sa">rb</span><span class="s1">&#39;[A-Za-z0-9 \t\r\n\.,_\-\+\*\/\$]{6,}&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">ascii_chunks</span><span class="p">:</span>
        <span class="n">text_sections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">text_sections</span>


<span class="k">def</span><span class="w"> </span><span class="nf">__extract_gps_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract GPS NMEA sentences from binary data&quot;&quot;&quot;</span>
    <span class="c1"># NMEA sentences start with $ and end with \r\n</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    
    <span class="c1"># Look for NMEA sentences</span>
    <span class="n">gps_sentences</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nmea_pattern</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\$(GP[A-Z]</span><span class="si">{3}</span><span class="s1">,.+?)\r\n&#39;</span>
    <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">nmea_pattern</span><span class="p">,</span> <span class="n">data_str</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
        <span class="n">gps_sentences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">gps_sentences</span>


<span class="k">def</span><span class="w"> </span><span class="nf">__locate_data_start_blue</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function looks after the last GPS point for an intitial, likely starting position of seismometer data&quot;&quot;&quot;</span>
    
    <span class="c1"># Look for the last NMEA sentence and start from there (small skip ahead</span>
    <span class="n">data_str</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">last_nmea_pos</span> <span class="o">=</span> <span class="n">data_str</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s1">&#39;$GP&#39;</span><span class="p">)</span>

    
    <span class="c1"># Assuming we find GPS data, find the spot after that indicating a new line</span>
    <span class="k">if</span> <span class="n">last_nmea_pos</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># Find the end of this sentence</span>
        <span class="n">end_GPS_marker</span> <span class="o">=</span> <span class="n">data_str</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">last_nmea_pos</span><span class="p">)</span>
        <span class="c1">#end_marker = data_str.find(&#39;[&#39;, last_nmea_pos)</span>

        <span class="k">if</span> <span class="n">end_GPS_marker</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Skip a bit further to be safe</span>
            <span class="k">return</span> <span class="n">end_GPS_marker</span> <span class="o">+</span> <span class="mi">8</span>
    
    <span class="k">return</span> <span class="n">end_GPS_marker</span>


<span class="k">def</span><span class="w"> </span><span class="nf">__swap_bytes</span><span class="p">(</span><span class="n">input_file</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Private function (not meant to be called except by internal functions) </span>
<span class="sd">    to read a binary file and return a bytearray with all bytes swapped in pairs.</span>
<span class="sd">    This handles odd-length files correctly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Open binary file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    
    <span class="c1"># Create new byte array for the swapped data</span>
    <span class="n">swapped</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    
    <span class="c1"># Swap bytes in pairs</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">swapped</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">swapped</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="c1"># Handle odd length</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">swapped</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">swapped</span>


<span class="c1"># Read data from raspberry shake</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__read_RS_file_struct</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">doy</span><span class="p">,</span> <span class="n">inv</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;&quot;Private function used by fetch_data() to read in Raspberry Shake data&quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">obspy.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">UTCDateTime</span>
    <span class="n">fileList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">folderPathList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">filesinfolder</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">input_data</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_checkifpath</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
    <span class="c1">#Read RS files</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">==</span><span class="s1">&#39;raw&#39;</span><span class="p">:</span> <span class="c1">#raw data with individual files per trace</span>
        <span class="k">if</span> <span class="n">input_data</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">input_data</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;AM&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">filesinfolder</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">folderPathList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
                    <span class="n">fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">child</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="n">child</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;EH&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">filesinfolder</span><span class="p">:</span>
                    <span class="n">folderPathList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;AM&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">doy</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                            <span class="n">fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>


            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">doyList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">printList</span><span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">folder</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">folderPathList</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">folder</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                            <span class="n">doyList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]))</span>
                            <span class="n">printList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">doyList</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;%Y %j&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%b </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2"> | Day of year: </span><span class="si">{</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">printList</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No files found matching Raspberry Shake data structure or files in specified directory.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No file found for specified date: </span><span class="si">{</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;acq_date&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">. The following days/files exist for specified year in this directory&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">printList</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">p</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileList</span><span class="p">)</span> <span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;3 channels needed! </span><span class="si">{}</span><span class="s1"> found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">folderPathList</span><span class="p">)),</span> <span class="ne">UserWarning</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fileList</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Puts z channel first</span>
                <span class="n">folderPathList</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">Reading files: </span><span class="se">\n\t</span><span class="si">{}</span><span class="se">\n\t</span><span class="si">{}</span><span class="se">\n\t</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fileList</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">fileList</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

            <span class="n">traceList</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fileList</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;^readMSEEDBuffer()&#39;</span><span class="p">)</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">))</span><span class="c1">#, starttime=UTCDateTime(params[&#39;starttime&#39;]), endtime=UTCDateTime(params[&#39;endtime&#39;]), nearest_sample=False)</span>
                    <span class="n">st</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]),</span> <span class="n">endtime</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]),</span> <span class="n">nearest_sample</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
                    <span class="n">tr</span> <span class="o">=</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="c1">#tr= obspy.Trace(tr.data,header=meta)</span>
                    <span class="n">traceList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span><span class="n">traceList</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">),</span> <span class="n">starttime</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]),</span> <span class="n">endttime</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]),</span> <span class="n">nearest_sample</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">source</span><span class="o">==</span><span class="s1">&#39;dir&#39;</span><span class="p">:</span> <span class="c1">#files with 3 traces, but may be several in a directory or only directory name provided</span>
        <span class="n">OBSPY_FORMATS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AH&#39;</span><span class="p">,</span><span class="s1">&#39;ALSEP_PSE&#39;</span><span class="p">,</span><span class="s1">&#39;ALSEP_WTH&#39;</span><span class="p">,</span><span class="s1">&#39;ALSEP_WTN&#39;</span><span class="p">,</span><span class="s1">&#39;CSS&#39;</span><span class="p">,</span><span class="s1">&#39;DMX&#39;</span><span class="p">,</span><span class="s1">&#39;GCF&#39;</span><span class="p">,</span><span class="s1">&#39;GSE1&#39;</span><span class="p">,</span><span class="s1">&#39;GSE2&#39;</span><span class="p">,</span><span class="s1">&#39;KINEMETRICS_EVT&#39;</span><span class="p">,</span><span class="s1">&#39;MSEED&#39;</span><span class="p">,</span><span class="s1">&#39;NNSA_KB_CORE&#39;</span><span class="p">,</span><span class="s1">&#39;PDAS&#39;</span><span class="p">,</span><span class="s1">&#39;PICKLE&#39;</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span><span class="s1">&#39;REFTEK130&#39;</span><span class="p">,</span><span class="s1">&#39;RG16&#39;</span><span class="p">,</span><span class="s1">&#39;SAC&#39;</span><span class="p">,</span><span class="s1">&#39;SACXY&#39;</span><span class="p">,</span><span class="s1">&#39;SEG2&#39;</span><span class="p">,</span><span class="s1">&#39;SEGY&#39;</span><span class="p">,</span><span class="s1">&#39;SEISAN&#39;</span><span class="p">,</span><span class="s1">&#39;SH_ASC&#39;</span><span class="p">,</span><span class="s1">&#39;SLIST&#39;</span><span class="p">,</span><span class="s1">&#39;SU&#39;</span><span class="p">,</span><span class="s1">&#39;TSPAIR&#39;</span><span class="p">,</span><span class="s1">&#39;WAV&#39;</span><span class="p">,</span><span class="s1">&#39;WIN&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">input_data</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">suffix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">rawFormat</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">isnumeric</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">367</span><span class="p">:</span>
                    <span class="n">rawFormat</span><span class="o">=</span><span class="kc">True</span>
            
            <span class="k">if</span> <span class="n">ext</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">OBSPY_FORMATS</span> <span class="ow">or</span> <span class="n">rawFormat</span><span class="p">:</span>
                <span class="n">filesinfolder</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">folderPathList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span>
                <span class="n">fileList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        
        <span class="n">filepaths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fileList</span><span class="p">):</span>
            <span class="n">filepaths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">folderPathList</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
            <span class="c1">#filepaths[i] = pathlib.Path(filepaths[i])</span>
            <span class="n">currData</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filepaths</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">currData</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
            <span class="c1">#rawDataIN.append(currData)</span>
            <span class="c1">#if i == 0:</span>
            <span class="c1">#    rawDataIN = currData.copy()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">currData</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">Stream</span><span class="p">):</span>
                <span class="n">rawDataIN</span> <span class="o">+=</span> <span class="n">currData</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1">#rawDataIN = obspy.Stream(rawDataIN)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rawDataIN</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">rawDataIN</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">rawDataIN</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">source</span><span class="o">==</span><span class="s1">&#39;file&#39;</span><span class="p">:</span>
        <span class="n">rawDataIN</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">),</span> <span class="n">starttime</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;starttime&#39;</span><span class="p">]),</span> <span class="n">endttime</span><span class="o">=</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;endtime&#39;</span><span class="p">]),</span> <span class="n">nearest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rawDataIN</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>   
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;List of sources not currently supported&#39;</span><span class="p">)</span>
        <span class="k">pass</span>  <span class="c1"># Eventually do something</span>

    <span class="k">return</span> <span class="n">rawDataIN</span>


<span class="c1"># Helper functions for remove_noise()</span>
<span class="c1"># Helper function for removing gaps</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__remove_gaps</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">window_gaps_obspy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function for removing gaps&quot;&quot;&quot;</span>
    
    <span class="c1"># combine overlapping windows</span>
    <span class="n">overlapList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">window_gaps_obspy</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">overlapList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">overlapList</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_gaps_obspy</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">window_gaps_obspy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Add streams</span>
    <span class="n">window_gaps_s</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">win</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">window_gaps_obspy</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">w</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_gaps_obspy</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">window_gaps_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_gaps_s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">stream_windows</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">window_gaps_s</span><span class="p">):</span>
            <span class="n">j</span><span class="o">=</span><span class="n">i</span>
            <span class="n">newSt</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">stream_windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newSt</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">endtime</span><span class="o">=</span><span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">newSt</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">stream_windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newSt</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">endtime</span><span class="o">=</span><span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stream_windows</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">outStream</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newSt</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">gap</span> <span class="o">=</span> <span class="n">window_gaps_s</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">outStream</span> <span class="o">=</span> <span class="n">outStream</span> <span class="o">+</span> <span class="n">newSt</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-</span> <span class="n">gap</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">outStream</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outStream</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">outStream</span>


<span class="c1"># Helper function for getting windows to remove noise using stalta antitrigger method</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__remove_anti_stalta</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">lta</span><span class="p">,</span> <span class="n">thresh</span><span class="p">,</span> <span class="n">show_stalta_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function for getting windows to remove noise using stalta antitrigger method</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stream : obspy.core.stream.Stream object</span>
<span class="sd">        Input stream on which to perform noise removal</span>
<span class="sd">    sta : int</span>
<span class="sd">        Number of seconds to use as short term window, reads from remove_noise() function.</span>
<span class="sd">    lta : int</span>
<span class="sd">        Number of seconds to use as long term window, reads from remove_noise() function.</span>
<span class="sd">    thresh : list</span>
<span class="sd">        Two-item list or tuple with the thresholds for the stalta antitrigger. </span>
<span class="sd">        Reads from remove_noise() function. The first value (index [0]) is the lower threshold (below which trigger is deactivated), </span>
<span class="sd">        the second value (index [1] is the upper threshold (above which trigger is activated)), by default [8, 8]</span>
<span class="sd">    show_plot : bool</span>
<span class="sd">        If True, will plot the trigger and stalta values. Reads from remove_noise() function, by default False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outStream : obspy.core.stream.Stream object</span>
<span class="sd">        Stream with a masked array for the data where &#39;noise&#39; has been removed</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">obspy.signal.trigger</span><span class="w"> </span><span class="kn">import</span> <span class="n">classic_sta_lta</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Removing noise using sta/lta antitrigger method: sta=</span><span class="si">{</span><span class="n">sta</span><span class="si">}</span><span class="s1">, lta=</span><span class="si">{</span><span class="n">lta</span><span class="si">}</span><span class="s1">, stalta_thresh=</span><span class="si">{</span><span class="n">thresh</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">sampleRate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>

    <span class="n">sta_samples</span> <span class="o">=</span> <span class="n">sta</span> <span class="o">/</span> <span class="n">sampleRate</span> <span class="c1">#Convert to samples</span>
    <span class="n">lta_samples</span> <span class="o">=</span> <span class="n">lta</span> <span class="o">/</span> <span class="n">sampleRate</span> <span class="c1">#Convert to samples</span>
    <span class="n">staltaStream</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">cFunList</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">staltaStream</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
            <span class="n">cFunList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">classic_sta_lta</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">nsta</span><span class="o">=</span><span class="n">sta_samples</span><span class="p">,</span> <span class="n">nlta</span><span class="o">=</span><span class="n">lta_samples</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">show_stalta_plot</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">obspy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">trigger</span><span class="o">.</span><span class="n">plot_trigger</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">cFunList</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">show_stalta_plot</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">obspy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">trigger</span><span class="o">.</span><span class="n">plot_trigger</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="n">cFunList</span><span class="p">[</span><span class="n">show_stalta_plot</span><span class="p">],</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">windows_samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">cf</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cFunList</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">trigger</span><span class="o">.</span><span class="n">trigger_onset</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">windows_samples</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">trigger</span><span class="o">.</span><span class="n">trigger_onset</span><span class="p">(</span><span class="n">cf</span><span class="p">,</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">thresh</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">condense_window_samples</span><span class="p">(</span><span class="n">win_samples</span><span class="p">):</span>
        <span class="c1"># Sort the list of lists based on the first element of each internal list</span>
        <span class="n">sorted_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">win_samples</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="c1"># Initialize an empty result list</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">win_samples</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="c1"># Initialize variables to track the current range</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">sorted_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Iterate over the sorted list</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_list</span><span class="p">)):</span>
            <span class="n">current_start</span><span class="p">,</span> <span class="n">current_end</span> <span class="o">=</span> <span class="n">sorted_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
            <span class="c1"># If the current range overlaps with the previous range</span>
            <span class="k">if</span> <span class="n">current_start</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">:</span>
                <span class="c1"># Update the end of the current range</span>
                <span class="n">end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">current_end</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Add the previous range to the result and update the current range</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">])</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">current_start</span><span class="p">,</span> <span class="n">current_end</span>
        
        <span class="c1"># Add the last range to the result</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">result</span>        
    <span class="n">windows_samples</span> <span class="o">=</span> <span class="n">condense_window_samples</span><span class="p">(</span><span class="n">windows_samples</span><span class="p">)</span>

    <span class="n">startT</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
    <span class="n">endT</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>
    <span class="n">window_UTC</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">window_MPL</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">window_UTC</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">startT</span><span class="p">,</span> <span class="n">startT</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">win</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">windows_samples</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">win</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">window_UTC</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">window_MPL</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="n">trigShift</span> <span class="o">=</span> <span class="n">sta</span>
            <span class="k">if</span> <span class="n">trigShift</span> <span class="o">&gt;</span> <span class="n">t</span> <span class="o">*</span> <span class="n">sampleRate</span><span class="p">:</span>
                <span class="n">trigShift</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">tSec</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="n">sampleRate</span> <span class="o">-</span> <span class="n">trigShift</span>
            <span class="n">window_UTC</span><span class="p">[</span><span class="n">w</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">startT</span><span class="o">+</span><span class="n">tSec</span><span class="p">)</span>
            <span class="n">window_MPL</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">window_UTC</span><span class="p">[</span><span class="n">w</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">matplotlib_date</span><span class="p">)</span>
    
    <span class="n">window_UTC</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">endT</span><span class="p">,</span> <span class="n">endT</span><span class="p">])</span>
    <span class="c1">#window_MPL[w].append(window_UTC[w][i].matplotlib_date)</span>
    <span class="n">outStream</span> <span class="o">=</span> <span class="n">__remove_gaps</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">window_UTC</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outStream</span>


<span class="c1"># Helper function for getting windows to remove noise using moving stdev</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__remove_moving_std</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">std_ratio_thresh</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">std_window_s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">min_win_size</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function for removing noisy data due to high local standard deviation.</span>
<span class="sd">    This is similar to the default noise removal method used in Grilla software.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stream : obspy.Stream</span>
<span class="sd">        Obspy stream that should be analyzed and segmented for noise removal</span>
<span class="sd">    std_ratio_thresh : float, optional</span>
<span class="sd">        Threshold ratio value to use for removing data.</span>
<span class="sd">        Ratio is calculated as the total standard deviation (of entire trace) over </span>
<span class="sd">        moving/local standard deviation (over rolling window specified by std_window_s), by default 2</span>
<span class="sd">    std_window_s : float, optional</span>
<span class="sd">        Size of the rolling window in seconds to use to calculate the local/moving/rolling standard deviation, by default 20</span>
<span class="sd">    min_win_size : float, optional</span>
<span class="sd">        The minimum size of window in seconds for data removal (where all points in that window exceed std_ratio_thresh), by default 5</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obspy.Stream</span>
<span class="sd">        Obspy Stream object with &quot;noisy&quot; windows calculated by remove_moving_std masked, if applicable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">instream</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">outstream</span> <span class="o">=</span> <span class="n">instream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">removeDTs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">([],</span> <span class="n">tz</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">)</span>  <span class="c1"># Empty index to start</span>
    <span class="c1"># Use pandas to simplify rolling/moving std</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">instream</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="n">dtList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tr</span><span class="o">.</span><span class="n">times</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;utcdatetime&quot;</span><span class="p">):</span>
            <span class="n">dtList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">zoneinfo</span><span class="o">.</span><span class="n">ZoneInfo</span><span class="p">(</span><span class="s1">&#39;UTC&#39;</span><span class="p">)))</span>
        <span class="c1"># Create pandas series out of trace data</span>
        <span class="n">traceData</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                            <span class="n">index</span><span class="o">=</span><span class="n">dtList</span><span class="p">)</span>

        <span class="c1"># Get StDev values</span>
        <span class="n">totalSTD</span> <span class="o">=</span> <span class="n">traceData</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">movingSTD</span> <span class="o">=</span> <span class="n">traceData</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">std_window_s</span><span class="p">),</span> <span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="c1"># Calculate whether ratio is larger than threshold value</span>
        <span class="n">boolseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">movingSTD</span><span class="o">/</span><span class="n">totalSTD</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">std_ratio_thresh</span>

        <span class="c1"># Create index of just removed windows</span>
        <span class="n">removeDTs</span> <span class="o">=</span> <span class="n">removeDTs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">boolseries</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">boolseries</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>

    <span class="c1"># Get unique indices as datetime.datetime objects</span>
    <span class="n">removeDTs</span> <span class="o">=</span> <span class="n">removeDTs</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>  <span class="c1"># Get unique dtindex</span>
    <span class="n">removeDTs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span>  <span class="c1"># Sort dt index</span>
    <span class="n">removeDTs</span> <span class="o">=</span> <span class="n">removeDTs</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()</span>  <span class="c1"># Convert to np.array of datetime.datetime objs</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>  <span class="c1"># Get sample rate</span>

    <span class="c1"># Convert instances of mstd/totstd &gt; thresh to windows (keep if longer than min_win_size)</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">windex</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rdt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">removeDTs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Intialize windows list</span>
            <span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">rdt</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If the &quot;window&quot; is just two samples next to each other, keep moving</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rdt</span> <span class="o">-</span> <span class="n">removeDTs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">==</span> <span class="n">delta</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">rdt</span> <span class="o">-</span> <span class="n">removeDTs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">delta</span><span class="p">:</span>
                <span class="c1"># if for some reason the window is less than sample rate, move on</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># if window exists, but is smaller than min_win_size</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">removeDTs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">windows</span><span class="p">[</span><span class="n">windex</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">min_win_size</span><span class="p">:</span>
                    <span class="n">windows</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># remove this window</span>
                    <span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">removeDTs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="kc">None</span><span class="p">])</span> <span class="c1"># Rest the window w/next data point</span>
                    <span class="k">continue</span>  <span class="c1"># Go to next dt</span>

                <span class="n">windows</span><span class="p">[</span><span class="n">windex</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">removeDTs</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Close last window</span>
                <span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">rdt</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="c1"># Start a new window</span>
                <span class="n">windex</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># Update window index</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># Need to convert these to windows now!</span>
    <span class="n">removeUTC</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">swin</span><span class="p">,</span> <span class="n">ewin</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
        <span class="n">removeUTC</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">swin</span><span class="p">),</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">ewin</span><span class="p">)])</span>
    
    <span class="n">stime</span> <span class="o">=</span> <span class="n">outstream</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
    <span class="n">etime</span> <span class="o">=</span> <span class="n">outstream</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>
    <span class="n">removeUTC</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">stime</span><span class="p">,</span> <span class="n">stime</span><span class="p">])</span>
    <span class="n">removeUTC</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">etime</span><span class="p">,</span> <span class="n">etime</span><span class="p">])</span>

    <span class="c1">#for win0, win1 in removeUTC:</span>
    <span class="c1">#    print(win0, win1, win1&gt;win0)</span>
    <span class="n">outstream</span>  <span class="o">=</span> <span class="n">__remove_gaps</span><span class="p">(</span><span class="n">outstream</span><span class="p">,</span> <span class="n">removeUTC</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outstream</span>


<span class="c1"># Remove noise saturation</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__remove_noise_saturate</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">sat_percent</span><span class="p">,</span> <span class="n">min_win_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to remove &quot;saturated&quot; data points that exceed a certain percent (sat_percent) of the maximum data value in the stream.  </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stream : obspy.Stream</span>
<span class="sd">        Obspy Stream of interest</span>
<span class="sd">    sat_percent : float</span>
<span class="sd">        Percentage of the maximum amplitude, which will be used as the saturation threshold above which data points will be excluded</span>
<span class="sd">    min_win_size : float</span>
<span class="sd">        The minumum size a window must be (in seconds) for it to be removed</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obspy.Stream</span>
<span class="sd">        Stream with masked array (if data removed) with &quot;saturated&quot; data removed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Removing noise using noise saturation method: sat_percent=</span><span class="si">{</span><span class="n">sat_percent</span><span class="si">}</span><span class="s1">, min_win_size=</span><span class="si">{</span><span class="n">min_win_size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sat_percent</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">sat_percent</span> <span class="o">=</span> <span class="n">sat_percent</span> <span class="o">/</span> <span class="mi">100</span>

    <span class="n">removeInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">dataArr</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>

        <span class="c1">#Get max amplitude value</span>
        <span class="n">maxAmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">dataArr</span><span class="p">,</span> <span class="n">where</span> <span class="o">=</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">thresholdAmp</span> <span class="o">=</span> <span class="n">maxAmp</span> <span class="o">*</span> <span class="n">sat_percent</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">dataArr</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">thresholdAmp</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">removeInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">removeInd</span><span class="p">,</span> <span class="n">cond</span><span class="p">])</span>
        <span class="c1">#trace.data = np.ma.where(np.absolute(data, where = not None) &gt; (noise_percent * maxAmp), None, data)</span>
    <span class="c1">#Combine indices from all three traces</span>
    <span class="n">removeInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">removeInd</span><span class="p">)</span>
    
    <span class="n">removeList</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># initialize</span>
    <span class="n">min_win_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_win_size</span> <span class="o">/</span> <span class="n">sample_rate</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">removeInd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">startInd</span> <span class="o">=</span> <span class="n">removeInd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">endInd</span> <span class="o">=</span> <span class="n">removeInd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">removeInd</span><span class="p">)):</span>             
            <span class="k">if</span> <span class="n">removeInd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">removeInd</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">endInd</span> <span class="o">-</span> <span class="n">startInd</span> <span class="o">&gt;=</span> <span class="n">min_win_samples</span><span class="p">:</span>
                    <span class="n">removeList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">startInd</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">endInd</span><span class="p">)])</span>
                <span class="n">startInd</span> <span class="o">=</span> <span class="n">removeInd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">endInd</span> <span class="o">=</span> <span class="n">removeInd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">removeList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#figure out a way to get rid of this</span>

    <span class="c1">#Convert removeList from samples to seconds after start to UTCDateTime</span>
    <span class="n">sampleRate</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>
    <span class="n">startT</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
    <span class="n">endT</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>
    <span class="n">removeSec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">removeUTC</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">removeUTC</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">startT</span><span class="p">,</span> <span class="n">startT</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">win</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">removeList</span><span class="p">):</span>
        <span class="n">removeSec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sampleRate</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">win</span><span class="p">),</span><span class="mi">6</span><span class="p">)))</span>
        <span class="n">removeUTC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">startT</span><span class="p">,</span> <span class="n">removeSec</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
    <span class="n">removeUTC</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">removeUTC</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">endT</span>
    
    <span class="n">outstream</span>  <span class="o">=</span> <span class="n">__remove_gaps</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">removeUTC</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outstream</span>


<span class="c1"># Helper function for removing data using the noise threshold input from remove_noise()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__remove_noise_thresh</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">noise_percent</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">lta</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">min_win_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function for removing data using the noise threshold input from remove_noise()</span>

<span class="sd">    The purpose of the noise threshold method is to remove noisy windows (e.g., lots of traffic all at once). </span>
<span class="sd">    </span>
<span class="sd">    This function uses the lta value (which can be specified here), and finds times where the lta value is at least at the noise_percent level of the max lta value for at least a specified time (min_win_size)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stream : obspy.core.stream.Stream object</span>
<span class="sd">        Input stream from which to remove windows. Passed from remove_noise().</span>
<span class="sd">    noise_percent : float, default=0.995</span>
<span class="sd">        Percentage (between 0 and 1), to use as the threshold at which to remove data. This is used in the noise threshold method. By default 0.995. </span>
<span class="sd">        If a value is passed that is greater than 1, it will be divided by 100 to obtain the percentage. Passed from remove_noise().</span>
<span class="sd">    lta : int, default = 30</span>
<span class="sd">        Length of lta to use (in seconds)</span>
<span class="sd">    min_win_size : int, default = 1</span>
<span class="sd">        Minimum amount of time (in seconds) at which noise is above noise_percent level.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outStream : obspy.core.stream.Stream object</span>
<span class="sd">        Stream with a masked array for the data where &#39;noise&#39; has been removed. Passed to remove_noise().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Removing noise using continuous noise threshold method: sat_percent=</span><span class="si">{</span><span class="n">noise_percent</span><span class="si">}</span><span class="s1">, lta=</span><span class="si">{</span><span class="n">lta</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">noise_percent</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">noise_percent</span> <span class="o">=</span> <span class="n">noise_percent</span> <span class="o">/</span> <span class="mi">100</span>

    <span class="n">removeInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">dataArr</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>
        <span class="n">lta_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">lta</span> <span class="o">/</span> <span class="n">sample_rate</span><span class="p">)</span>

        <span class="c1">#Get lta values across traces data</span>
        <span class="n">window_size</span> <span class="o">=</span> <span class="n">lta_samples</span>
        <span class="k">if</span> <span class="n">window_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">window_size</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span> <span class="o">/</span> <span class="n">window_size</span>
        <span class="n">maskedArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataArr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">ltaArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">maskedArr</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="c1">#Get max lta value</span>
        <span class="n">maxLTA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ltaArr</span><span class="p">,</span> <span class="n">where</span> <span class="o">=</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">ltaArr</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">noise_percent</span> <span class="o">*</span> <span class="n">maxLTA</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">removeInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">removeInd</span><span class="p">,</span> <span class="n">cond</span><span class="p">])</span>
        <span class="c1">#trace.data = np.ma.where(np.absolute(data, where = not None) &gt; (noise_percent * maxAmp), None, data)</span>
    <span class="c1">#Combine indices from all three traces</span>
    <span class="n">removeInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">removeInd</span><span class="p">)</span>

    <span class="c1"># Make sure we&#39;re not removing single indices (we only want longer than min_win_size)</span>
    <span class="n">removeList</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># initialize    </span>
    <span class="n">min_win_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_win_size</span> <span class="o">/</span> <span class="n">sample_rate</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">removeInd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">startInd</span> <span class="o">=</span> <span class="n">removeInd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">endInd</span> <span class="o">=</span> <span class="n">removeInd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">removeInd</span><span class="p">)):</span>
            <span class="c1">#If indices are non-consecutive... </span>
            <span class="k">if</span> <span class="n">removeInd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">removeInd</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1">#If the indices are non-consecutive and the </span>
                <span class="k">if</span> <span class="n">endInd</span> <span class="o">-</span> <span class="n">startInd</span> <span class="o">&gt;=</span> <span class="n">min_win_samples</span><span class="p">:</span>
                    <span class="n">removeList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">startInd</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">endInd</span><span class="p">)])</span>
                    
                <span class="c1">#Set startInd as the current index</span>
                <span class="n">startInd</span> <span class="o">=</span> <span class="n">removeInd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">endInd</span> <span class="o">=</span> <span class="n">removeInd</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
    <span class="n">removeList</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">sampleRate</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>
    <span class="n">startT</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
    <span class="n">endT</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>
    <span class="n">removeSec</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">removeUTC</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">removeUTC</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">startT</span><span class="p">,</span> <span class="n">startT</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">win</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">removeList</span><span class="p">):</span>
        <span class="n">removeSec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sampleRate</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">win</span><span class="p">),</span><span class="mi">6</span><span class="p">)))</span>
        <span class="n">removeUTC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">startT</span><span class="p">,</span> <span class="n">removeSec</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
    <span class="n">removeUTC</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">removeUTC</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">endT</span>

    <span class="n">outstream</span>  <span class="o">=</span> <span class="n">__remove_gaps</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">removeUTC</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outstream</span>


<span class="c1"># Helper function for removing data during warmup (when seismometers are still initializing) and &quot;cooldown&quot; (when there may be noise from deactivating seismometer) time, if desired</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__remove_warmup_cooldown</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">warmup_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cooldown_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Private helper function to remove data from the start and/or end of each site</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stream : obspy.Stream()</span>
<span class="sd">        Input stream to use for analysis for noise removal</span>
<span class="sd">    warmup_time : int, optional</span>
<span class="sd">        Time in seconds at the start of the record to remove from analysis, by default 0</span>
<span class="sd">    cooldown_time : int, optional</span>
<span class="sd">        Time in seconds at the end of the record to remove from analysis, by default 0</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Whether to print information about the process to the terminal, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obspy.Stream()</span>
<span class="sd">        obspy.Stream() with masked arrays for the data where removed/kept.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Removing noise using warmup/cooldown buffers: warmup_time=</span><span class="si">{</span><span class="n">warmup_time</span><span class="si">}</span><span class="s2"> s, cooldown_time=</span><span class="si">{</span><span class="n">cooldown_time</span><span class="si">}</span><span class="s2"> s &quot;</span><span class="p">)</span>
    <span class="n">sampleRate</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span><span class="p">)</span>
    <span class="n">outStream</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">warmup_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">warmup_time</span> <span class="o">/</span> <span class="n">sampleRate</span><span class="p">)</span> <span class="c1">#Convert to samples</span>
    <span class="n">windows_samples</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">totalSamples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tr</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="c1">#float(tr.stats.endtime - tr.stats.starttime) / tr.stats.delta</span>
        <span class="n">cooldown_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">totalSamples</span> <span class="o">-</span> <span class="p">(</span><span class="n">cooldown_time</span> <span class="o">/</span> <span class="n">sampleRate</span><span class="p">))</span> <span class="c1">#Convert to samples</span>
    
    <span class="c1"># Initiate list with warmup and cooldown samples</span>
    <span class="n">windows_samples</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="n">warmup_samples</span><span class="p">],[</span><span class="n">cooldown_samples</span><span class="p">,</span> <span class="n">totalSamples</span><span class="p">]]</span>
    
    <span class="c1"># Remove cooldown and warmup samples if there is none indicated (default of 0 for both)</span>
    <span class="k">if</span> <span class="n">cooldown_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">windows_samples</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">warmup_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">windows_samples</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">windows_samples</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="c1"># If no warmup or cooldown indicated, don&#39;t do anything</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Otherwise, get the actual starttime (UTCDateTime)</span>
        <span class="n">startT</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
        <span class="n">endT</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>
        <span class="n">window_UTC</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">window_MPL</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;warmup starttime&quot;</span><span class="p">,</span> <span class="n">startT</span><span class="p">)</span>
        <span class="c1"># Initiate list with starttimes</span>
        <span class="k">for</span> <span class="n">w</span><span class="p">,</span> <span class="n">win</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">windows_samples</span><span class="p">):</span>
            <span class="c1"># win is a list with start/end time for each buffer, in samples</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">tm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">win</span><span class="p">):</span>
                <span class="c1"># For each side (warmup or cooldown), add a new item</span>
                <span class="c1"># There will be 2 list items for warmup, 2 for cooldown (extra is for &quot;padding&quot;)</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">window_UTC</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                    <span class="n">window_MPL</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
                <span class="n">tSec</span> <span class="o">=</span> <span class="n">tm</span> <span class="o">*</span> <span class="n">sampleRate</span>

                <span class="c1"># Get the UTC time for the new item</span>
                <span class="n">window_UTC</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">startT</span><span class="o">+</span><span class="n">tSec</span><span class="p">)</span>
                <span class="n">window_MPL</span><span class="p">[</span><span class="n">w</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">window_UTC</span><span class="p">[</span><span class="n">w</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">matplotlib_date</span><span class="p">)</span>
        <span class="c1"># &quot;pad&quot; list with endtime</span>
        <span class="n">window_UTC</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">startT</span><span class="p">,</span> <span class="n">startT</span><span class="p">])</span>
        <span class="n">window_UTC</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">endT</span><span class="p">,</span> <span class="n">endT</span><span class="p">])</span>

        <span class="n">outStream</span> <span class="o">=</span> <span class="n">__remove_gaps</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">window_UTC</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">outStream</span>


<span class="c1"># Helper function for selecting windows</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_keep_processing_windows</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">processing_window</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;:&quot;</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Keep processing windows</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stream : obspy.Stream()</span>
<span class="sd">        Stream</span>
<span class="sd">    processing_window : list, optional</span>
<span class="sd">        Processing window list, by default [&quot;:&quot;]</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Whether to print information about the removal to the terminal</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    obspy.Stream()</span>
<span class="sd">        Obspy stream object with selected windows retained and all else removed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Removing noise outside the indicated processing window(s): processing_window=</span><span class="si">{</span><span class="n">processing_window</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">instream</span> <span class="o">=</span> <span class="n">stream</span>
    <span class="n">allList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;everything&#39;</span><span class="p">]</span>

    <span class="n">year</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">year</span>
    <span class="n">month</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">month</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">day</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processing_window</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
        <span class="n">processing_window</span> <span class="o">=</span> <span class="p">[</span><span class="n">processing_window</span><span class="p">]</span>

    <span class="n">windows_to_get</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">processing_window</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">allList</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">instream</span>
        
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">windows_to_get</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">)):</span>
                <span class="n">windows_to_get</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">windows_to_get</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">windows_to_get</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_format_time</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tzone</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">)))</span>
                <span class="n">windows_to_get</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_format_time</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tzone</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">)))</span>

                <span class="c1"># Make sure time are on the right day</span>
                <span class="n">windows_to_get</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">windows_to_get</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">windows_to_get</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">windows_to_get</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
                <span class="n">windows_to_get</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="n">month</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">windows_to_get</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">windows_to_get</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">windows_to_get</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processing_window</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">windows_to_get</span> <span class="o">=</span> <span class="p">[[</span><span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_format_time</span><span class="p">(</span><span class="n">processing_window</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tzone</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">)),</span>
                        <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_format_time</span><span class="p">(</span><span class="n">processing_window</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tzone</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">))]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The processing_window parameter of remove_noise was set as </span><span class="si">{</span><span class="n">processing_window</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The processing_window parameter must be a list or tuple with a start and end time or with lists/tuples of start/end times.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;processing_window noise removal method not applied&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">instream</span>
    
    <span class="c1"># windows_to_get should be a list of two-item lists with UTCDateTime objects no matter how it came in</span>
    <span class="n">stime</span> <span class="o">=</span> <span class="n">instream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
    <span class="n">etime</span> <span class="o">=</span> <span class="n">instream</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>

    <span class="n">windows_to_get</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">stime</span><span class="p">,</span> <span class="n">stime</span><span class="p">])</span>
    <span class="n">windows_to_get</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">etime</span><span class="p">,</span> <span class="n">etime</span><span class="p">])</span>

    <span class="c1"># Need the list formatted slightly different, use window_UTC</span>
    <span class="n">window_UTC</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Rearrange</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">win</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">windows_to_get</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">window_UTC</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">stime</span><span class="p">,</span> <span class="n">windows_to_get</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">elif</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">windows_to_get</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">window_UTC</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">windows_to_get</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>

    <span class="n">window_UTC</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">windows_to_get</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">window_UTC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">windows_to_get</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">outStream</span> <span class="o">=</span> <span class="n">__remove_gaps</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">window_UTC</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outStream</span>


<span class="c1"># Plot noise windows</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_plot_noise_windows</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">clear_fig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fill_gaps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                         <span class="n">do_stalta</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sta</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">lta</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">stalta_thresh</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span> 
                         <span class="n">do_pctThresh</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sat_percent</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">min_win_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                         <span class="n">do_noiseWin</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">noise_percent</span><span class="o">=</span><span class="mf">0.995</span><span class="p">,</span> 
                         <span class="n">do_warmup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">warmup_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cooldown_time</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                         <span class="n">return_dict</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_tkinter</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">clear_fig</span><span class="p">:</span> <span class="c1">#Intended use for tkinter</span>
        <span class="c1">#Clear everything</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1">#Really make sure it&#39;s out of memory</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">use_tkinter</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c1">#Don&#39;t think this is being used anymore, defined in sprit_gui separately</span>
            <span class="c1">#ax=ax_noise #self.ax_noise #?</span>
            <span class="c1">#fig=fig_noise</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1">#Reset axes, figure, and canvas widget</span>
    <span class="n">noise_mosaic</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;spec&#39;</span><span class="p">],[</span><span class="s1">&#39;spec&#39;</span><span class="p">],[</span><span class="s1">&#39;spec&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;spec&#39;</span><span class="p">],[</span><span class="s1">&#39;spec&#39;</span><span class="p">],[</span><span class="s1">&#39;spec&#39;</span><span class="p">],</span>
            <span class="p">[</span><span class="s1">&#39;signalz&#39;</span><span class="p">],[</span><span class="s1">&#39;signalz&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;signaln&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;signale&#39;</span><span class="p">]]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot_mosaic</span><span class="p">(</span><span class="n">noise_mosaic</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  
    <span class="c1">#self.noise_canvas = FigureCanvasTkAgg(fig, master=canvasFrame_noise)</span>
    <span class="c1">#self.noise_canvasWidget.destroy()</span>
    <span class="c1">#self.noise_canvasWidget = self.noise_canvas.get_tk_widget()#.pack(side=tk.TOP, fill=tk.BOTH, expand=1)</span>
    <span class="c1">#self.noise_canvasWidget.pack(fill=&#39;both&#39;)#.grid(row=0, column=0, sticky=&#39;nsew&#39;)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">sprit_plot</span><span class="o">.</span><span class="n">_plot_input_stream_mpl</span><span class="p">(</span><span class="n">stream</span><span class="o">=</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">],</span> <span class="n">hv_data</span><span class="o">=</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="n">stack_type</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">fill_gaps</span><span class="o">=</span><span class="n">fill_gaps</span><span class="p">,</span> <span class="n">dbscale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap_per</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">])</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="c1">#Set initial input</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">do_stalta</span><span class="p">:</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_noise</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">remove_method</span><span class="o">=</span><span class="s1">&#39;stalta&#39;</span><span class="p">,</span> <span class="n">sta</span><span class="o">=</span><span class="n">sta</span><span class="p">,</span> <span class="n">lta</span><span class="o">=</span><span class="n">lta</span><span class="p">,</span> <span class="n">stalta_thresh</span><span class="o">=</span><span class="n">stalta_thresh</span><span class="p">)</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">do_pctThresh</span><span class="p">:</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_noise</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">remove_method</span><span class="o">=</span><span class="s1">&#39;saturation&#39;</span><span class="p">,</span>  <span class="n">sat_percent</span><span class="o">=</span><span class="n">sat_percent</span><span class="p">,</span> <span class="n">min_win_size</span><span class="o">=</span><span class="n">min_win_size</span><span class="p">)</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">do_noiseWin</span><span class="p">:</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_noise</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">remove_method</span><span class="o">=</span><span class="s1">&#39;noise&#39;</span><span class="p">,</span> <span class="n">noise_percent</span><span class="o">=</span><span class="n">noise_percent</span><span class="p">,</span> <span class="n">lta</span><span class="o">=</span><span class="n">lta</span><span class="p">,</span> <span class="n">min_win_size</span><span class="o">=</span><span class="n">min_win_size</span><span class="p">)</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">do_warmup</span><span class="p">:</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">remove_noise</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">remove_method</span><span class="o">=</span><span class="s1">&#39;warmup&#39;</span><span class="p">,</span> <span class="n">warmup_time</span><span class="o">=</span><span class="n">warmup_time</span><span class="p">,</span> <span class="n">cooldown_time</span><span class="o">=</span><span class="n">cooldown_time</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">noise_windows_line_artists</span><span class="p">,</span> <span class="n">noise_windows_window_artists</span> <span class="o">=</span> <span class="n">_get_removed_windows</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">time_type</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">return_dict</span><span class="p">:</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;Windows_Plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hvsr_data</span>
    <span class="k">return</span> 


<span class="c1"># Helper function for manual window selection </span>
<span class="k">def</span><span class="w"> </span><span class="nf">__draw_boxes</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">clickNo</span><span class="p">,</span> <span class="n">xWindows</span><span class="p">,</span> <span class="n">pathList</span><span class="p">,</span> <span class="n">windowDrawn</span><span class="p">,</span> <span class="n">winArtist</span><span class="p">,</span> <span class="n">lineArtist</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function for manual window selection to draw boxes to show where windows have been selected for removal&quot;&quot;&quot;</span>
    <span class="c1">#Create an axis dictionary if it does not already exist so all functions are the same</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="n">ax</span><span class="p">}</span>

    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
            <span class="n">axDict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
                <span class="n">axDict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">a</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axDict</span>
    <span class="c1">#else:</span>
    <span class="c1">#    ax = {&#39;a&#39;:ax}</span>
    
    <span class="c1">#if event.inaxes!=ax: return</span>
    <span class="c1">#y0, y1 = ax.get_ylim()</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">kList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">kList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">y0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
    <span class="c1">#else:</span>
    <span class="c1">#    y0 = [ax.get_ylim()[0]]</span>
    <span class="c1">#    y1 = [ax.get_ylim()[1]]</span>

    <span class="k">if</span> <span class="n">clickNo</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1">#y = np.linspace(ax.get_ylim()[0], ax.get_ylim()[1], 2)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
        <span class="n">clickNo</span> <span class="o">=</span> <span class="mi">1</span>   
        <span class="n">lineArtist</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">winNums</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xWindows</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">linArt</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">lineArtist</span><span class="p">[</span><span class="n">winNums</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">linArt</span><span class="p">,</span> <span class="n">linArt</span><span class="p">])</span>
        <span class="c1">#else:</span>
        <span class="c1">#    linArt = plt.axvline(x0, y0[i], y1[i], color=&#39;k&#39;, linewidth=1, zorder=100)</span>
        <span class="c1">#    lineArtist.append([linArt, linArt])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span>
        <span class="n">clickNo</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">windowDrawn</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">winArtist</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>  
        <span class="n">pathList</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
        <span class="n">winNums</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xWindows</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kList</span><span class="p">):</span>
            <span class="n">path_data</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">MOVETO</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span>
                <span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span>
                <span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span>
                <span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span>
                <span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span>
                <span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">CLOSEPOLY</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">[</span><span class="n">i</span><span class="p">])),</span>
            <span class="p">]</span>
            <span class="n">codes</span><span class="p">,</span> <span class="n">verts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">path_data</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span>

            <span class="n">windowDrawn</span><span class="p">[</span><span class="n">winNums</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">winArtist</span><span class="p">[</span><span class="n">winNums</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="n">pathList</span><span class="p">[</span><span class="n">winNums</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">__draw_windows</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">event</span><span class="p">,</span> <span class="n">pathlist</span><span class="o">=</span><span class="n">pathList</span><span class="p">,</span> <span class="n">ax_key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">windowDrawn</span><span class="o">=</span><span class="n">windowDrawn</span><span class="p">,</span> <span class="n">winArtist</span><span class="o">=</span><span class="n">winArtist</span><span class="p">,</span> <span class="n">xWindows</span><span class="o">=</span><span class="n">xWindows</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">linArt</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

            <span class="p">[</span><span class="n">lineArtist</span><span class="p">[</span><span class="n">winNums</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">lineArtist</span><span class="p">[</span><span class="n">winNums</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">linArt</span><span class="p">)</span>
        <span class="n">x_win</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">]</span>
        <span class="n">x_win</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="c1">#Make sure they are in the right order</span>
        <span class="n">xWindows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_win</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">clickNo</span><span class="p">,</span> <span class="n">x0</span>


<span class="c1"># Helper function for manual window selection to draw boxes to deslect windows for removal</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__remove_on_right</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">xWindows</span><span class="p">,</span> <span class="n">pathList</span><span class="p">,</span> <span class="n">windowDrawn</span><span class="p">,</span> <span class="n">winArtist</span><span class="p">,</span>  <span class="n">lineArtist</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function for manual window selection to draw boxes to deslect windows for removal&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">xWindows</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xWins</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">xWindows</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span> <span class="o">&gt;</span> <span class="n">xWins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">event</span><span class="o">.</span><span class="n">xdata</span> <span class="o">&lt;</span> <span class="n">xWins</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">linArtists</span> <span class="o">=</span> <span class="n">lineArtist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pathList</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">linArtists</span><span class="p">):</span>
                    <span class="n">winArtist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span><span class="c1">#.pop(i)</span>
                    <span class="n">lineArtist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span><span class="c1">#.pop(i)#[i].pop(j)</span>
                    <span class="n">lineArtist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="n">windowDrawn</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">lineArtist</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="c1">#[i].pop(j)</span>
                <span class="n">winArtist</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="c1">#[i].pop(j)</span>
                <span class="n">xWindows</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span> 


<span class="c1"># Helper function for updating the canvas and drawing/deleted the boxes</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__draw_windows</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">pathlist</span><span class="p">,</span> <span class="n">ax_key</span><span class="p">,</span> <span class="n">windowDrawn</span><span class="p">,</span> <span class="n">winArtist</span><span class="p">,</span> <span class="n">xWindows</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function for updating the canvas and drawing/deleted the boxes&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pathlist</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pa</span><span class="p">):</span> 
            <span class="k">if</span> <span class="n">windowDrawn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">patch</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">PathPatch</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>                            
                <span class="n">winArt</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">ax_key</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
                <span class="n">windowDrawn</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">winArtist</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">winArt</span>

    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="ow">is</span> <span class="n">MouseButton</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>


<span class="c1"># Helper function for getting click event information</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__on_click</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function for getting click event information&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">clickNo</span>
    <span class="k">global</span> <span class="n">x0</span>
    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="ow">is</span> <span class="n">MouseButton</span><span class="o">.</span><span class="n">RIGHT</span><span class="p">:</span>
        <span class="n">__remove_on_right</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">xWindows</span><span class="p">,</span> <span class="n">pathList</span><span class="p">,</span> <span class="n">windowDrawn</span><span class="p">,</span> <span class="n">winArtist</span><span class="p">,</span> <span class="n">lineArtist</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="ow">is</span> <span class="n">MouseButton</span><span class="o">.</span><span class="n">LEFT</span><span class="p">:</span>            
        <span class="n">clickNo</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="n">__draw_boxes</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">clickNo</span><span class="p">,</span> <span class="n">xWindows</span><span class="p">,</span> <span class="n">pathList</span><span class="p">,</span> <span class="n">windowDrawn</span><span class="p">,</span> <span class="n">winArtist</span><span class="p">,</span> <span class="n">lineArtist</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>    


<span class="c1"># Function to select windows using original stream specgram/plots</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_select_windows</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to manually select windows for exclusion from data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    input : dict</span>
<span class="sd">        Dictionary containing all the hvsr information.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xWindows : list</span>
<span class="sd">        List of two-item lists containing start and end times of windows to be removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.backend_bases</span><span class="w"> </span><span class="kn">import</span> <span class="n">MouseButton</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
    <span class="k">global</span> <span class="n">fig</span>
    <span class="k">global</span> <span class="n">ax</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="p">(</span><span class="n">HVSRData</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
        <span class="k">if</span> <span class="s1">&#39;hvsr_curve&#39;</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="nb">input</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;spec&#39;</span><span class="p">,</span> <span class="n">returnfig</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;turbo&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hvsr_data</span> <span class="o">=</span> <span class="nb">input</span><span class="c1">#.copy()</span>
            <span class="n">input_stream</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_stream</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">Stream</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">sprit_plot</span><span class="o">.</span><span class="n">_plot_input_stream_mpl</span><span class="p">(</span><span class="n">input_stream</span><span class="p">,</span> <span class="n">component</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">])</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_stream</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">Trace</span><span class="p">):</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">sprit_plot</span><span class="o">.</span><span class="n">_plot_input_stream_mpl</span><span class="p">(</span><span class="n">input_stream</span><span class="p">)</span>

    <span class="k">global</span> <span class="n">lineArtist</span>
    <span class="k">global</span> <span class="n">winArtist</span>
    <span class="k">global</span> <span class="n">windowDrawn</span>
    <span class="k">global</span> <span class="n">pathList</span>
    <span class="k">global</span> <span class="n">xWindows</span>
    <span class="k">global</span> <span class="n">clickNo</span>
    <span class="k">global</span> <span class="n">x0</span>
    <span class="n">x0</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">clickNo</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">xWindows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">pathList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">windowDrawn</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">winArtist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lineArtist</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">global</span> <span class="n">fig_closed</span>
    <span class="n">fig_closed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="n">fig_closed</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;button_press_event&#39;</span><span class="p">,</span> <span class="n">__on_click</span><span class="p">)</span><span class="c1">#(clickNo, xWindows, pathList, windowDrawn, winArtist, lineArtist, x0, fig, ax))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">mpl_connect</span><span class="p">(</span><span class="s1">&#39;close_event&#39;</span><span class="p">,</span> <span class="n">_on_fig_close</span><span class="p">)</span><span class="c1">#(clickNo, xWindows, pathList, windowDrawn, winArtist, lineArtist, x0, fig, ax))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_windows_out&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xWindows</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;fig_noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fig</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ax_noise&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span>
    <span class="k">return</span> <span class="n">hvsr_data</span>


<span class="c1"># Support function to help select_windows run properly</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_on_fig_close</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">fig_closed</span>
    <span class="n">fig_closed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span>


<span class="c1"># Shows windows with None on input plot</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_get_removed_windows</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lineArtist</span> <span class="o">=</span><span class="p">[],</span> <span class="n">winArtist</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">existing_lineArtists</span><span class="o">=</span><span class="p">[],</span> <span class="n">existing_xWindows</span><span class="o">=</span><span class="p">[],</span> <span class="n">exist_win_format</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span> <span class="n">keep_line_artists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">time_type</span><span class="o">=</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span><span class="n">show_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function is for getting Nones from masked arrays and plotting them as windows&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">)):</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="nb">input</span><span class="p">[</span><span class="s1">&#39;stream&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="p">(</span><span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">trace</span><span class="o">.</span><span class="n">Trace</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">Stream</span><span class="p">)):</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span> <span class="c1">#Warning?</span>
        
    <span class="n">samplesList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sample&#39;</span><span class="p">,</span> <span class="s1">&#39;samples&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span>
    <span class="n">utcList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;utc&#39;</span><span class="p">,</span> <span class="s1">&#39;utcdatetime&#39;</span><span class="p">,</span> <span class="s1">&#39;obspy&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">]</span>
    <span class="n">matplotlibList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;matplotlib&#39;</span><span class="p">,</span> <span class="s1">&#39;mpl&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">]</span>    
    
    <span class="c1">#Get masked indices of trace(s)</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">merge</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1">#windows.append([0,np.nan])</span>
    <span class="c1">#mask = np.isnan(trace.data)  # Create a mask for None values</span>
    <span class="c1">#masked_array = np.ma.array(trace.data, mask=mask).copy()</span>
    <span class="n">masked_array</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">masked_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">MaskedArray</span><span class="p">):</span>
        <span class="n">masked_array</span> <span class="o">=</span> <span class="n">masked_array</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lastMaskInd</span> <span class="o">=</span> <span class="n">masked_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">wInd</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">masked_array</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">maskInd</span> <span class="o">=</span> <span class="n">masked_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">maskInd</span><span class="o">-</span><span class="n">lastMaskInd</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">windows</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">windows</span><span class="p">[</span><span class="n">wInd</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">masked_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">windows</span><span class="p">[</span><span class="n">wInd</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">masked_array</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">windows</span><span class="p">[</span><span class="n">wInd</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">masked_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">wInd</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">lastMaskInd</span> <span class="o">=</span> <span class="n">maskInd</span>
        <span class="n">windows</span><span class="p">[</span><span class="n">wInd</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">masked_array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#Fill in last masked value (wInd-1 b/c wInd+=1 earlier)</span>
    <span class="n">winTypeList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gaps&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">)</span>

    <span class="c1">#Check if the windows are just gaps</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_xWindows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">existWin</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#Check if windows are already being taken care of with the gaps</span>
        <span class="n">startList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">endList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
            <span class="n">startList</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span> <span class="n">start</span><span class="o">*</span><span class="n">sample_rate</span><span class="p">)</span><span class="o">.</span><span class="n">matplotlib_date</span><span class="p">)</span>
            <span class="n">endList</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span> <span class="n">end</span><span class="o">*</span><span class="n">sample_rate</span><span class="p">)</span><span class="o">.</span><span class="n">matplotlib_date</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">existing_xWindows</span><span class="p">:</span>
            <span class="n">removed</span><span class="o">=</span><span class="kc">False</span>
            <span class="k">if</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">startList</span> <span class="ow">and</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">endList</span><span class="p">:</span>
                <span class="n">existing_xWindows</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>

                <span class="n">removed</span><span class="o">=</span><span class="kc">True</span>                    
            <span class="k">if</span> <span class="n">exist_win_format</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">matplotlibList</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">removed</span><span class="p">:</span>
                <span class="n">sTimeMPL</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="o">.</span><span class="n">matplotlib_date</span> <span class="c1">#Convert time to samples from starttime</span>
                <span class="n">existWin</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">((</span><span class="n">w</span> <span class="o">-</span> <span class="n">sTimeMPL</span><span class="p">)</span><span class="o">*</span><span class="mi">3600</span><span class="o">*</span><span class="mi">24</span><span class="o">/</span><span class="n">sample_rate</span><span class="p">)))</span>
                                    
        <span class="n">windows</span> <span class="o">=</span> <span class="n">windows</span> <span class="o">+</span> <span class="n">existWin</span>
        <span class="n">existWinTypeList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;removed&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">existWin</span><span class="p">)</span>
        <span class="n">winTypeList</span> <span class="o">=</span> <span class="n">winTypeList</span> <span class="o">+</span> <span class="n">existWinTypeList</span>

    <span class="c1">#Reformat ax as needed</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">origAxes</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">newAx</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
            <span class="n">newAx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">newAx</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">origAxes</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">ax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">origAxes</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ax&#39;</span><span class="p">:</span><span class="n">ax</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="n">pathList</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">windowDrawn</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">winArtist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">existing_lineArtists</span> <span class="o">==</span> <span class="p">[]:</span>
            <span class="n">lineArtist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_lineArtists</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">keep_line_artists</span><span class="p">:</span>
            <span class="n">lineArtist</span> <span class="o">=</span> <span class="n">existing_lineArtists</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lineArtist</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">winNums</span><span class="p">,</span> <span class="n">win</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">windows</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">time_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">samplesList</span><span class="p">:</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">time_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">utcList</span> <span class="ow">or</span> <span class="n">time_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">matplotlibList</span><span class="p">:</span>
                <span class="c1">#sample_rate = trace.stats.delta</span>

                <span class="n">x0</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span> <span class="p">(</span><span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span> <span class="p">(</span><span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">time_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">matplotlibList</span><span class="p">:</span>
                    <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">matplotlib_date</span>
                    <span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">matplotlib_date</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;time_type=</span><span class="si">{</span><span class="n">time_type</span><span class="si">}</span><span class="s1"> not recognized. Defaulting to matplotlib time formatting&#39;</span><span class="p">)</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span> <span class="p">(</span><span class="n">win</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span> <span class="p">(</span><span class="n">win</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span>
                
                <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">matplotlib_date</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="o">.</span><span class="n">matplotlib_date</span>
            
            <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

            <span class="n">path_data</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">MOVETO</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)),</span>
                        <span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">)),</span>
                        <span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)),</span>
                        <span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y1</span><span class="p">)),</span>
                        <span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">LINETO</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)),</span>
                        <span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="o">.</span><span class="n">CLOSEPOLY</span><span class="p">,</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">)),</span>
                    <span class="p">]</span>
            
            <span class="n">codes</span><span class="p">,</span> <span class="n">verts</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">path_data</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">verts</span><span class="p">,</span> <span class="n">codes</span><span class="p">)</span>

            <span class="c1">#</span>
            <span class="n">windowDrawn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">winArtist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">lineArtist</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            
            <span class="k">if</span> <span class="n">winTypeList</span><span class="p">[</span><span class="n">winNums</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gaps&#39;</span><span class="p">:</span>
                <span class="n">clr</span> <span class="o">=</span> <span class="s1">&#39;#b13d41&#39;</span>
            <span class="k">elif</span> <span class="n">winTypeList</span><span class="p">[</span><span class="n">winNums</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;removed&#39;</span><span class="p">:</span>
                <span class="n">clr</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">clr</span> <span class="o">=</span> <span class="s1">&#39;yellow&#39;</span>

            <span class="n">linArt0</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">clr</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">linArt1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">clr</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">lineArtist</span><span class="p">[</span><span class="n">winNums</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">linArt0</span><span class="p">,</span> <span class="n">linArt1</span><span class="p">])</span>
            <span class="c1">#</span>
            
            <span class="n">pathList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pathList</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">windowDrawn</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">patch</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">PathPatch</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">clr</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>                            
                <span class="n">winArt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch</span><span class="p">)</span>
                <span class="n">windowDrawn</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">winArtist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">winArt</span>
        
        <span class="c1">#Reformat ax as needed</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">origAxes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">origAxes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">origAxes</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">origAxes</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">origAxes</span> <span class="o">=</span> <span class="n">ax</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">origAxes</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">lineArtist</span><span class="p">,</span> <span class="n">winArtist</span>


<span class="c1"># Helper function for removing windows from data, leaving gaps</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__remove_windows</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">window_list</span><span class="p">,</span> <span class="n">warmup_time</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function that actually does the work in obspy to remove the windows calculated in the remove_noise function</span>
<span class="sd">s</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    stream : obspy.core.stream.Stream object</span>
<span class="sd">        Input stream from which to remove windows</span>
<span class="sd">    window_list : list</span>
<span class="sd">        A list of windows with start and end times for the windows to be removed</span>
<span class="sd">    warmup_time : int, default = 0</span>
<span class="sd">        Passed from remove_noise, the amount of time in seconds to allow for warmup. Anything before this is removed as &#39;noise&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outStream : obspy.core.stream.Stream object</span>
<span class="sd">        Stream with a masked array for the data where &#39;noise&#39; has been removed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">og_stream</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1">#Find the latest start time and earliest endtime of all traces (in case they aren&#39;t consistent)</span>
    <span class="n">maxStartTime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="o">-</span><span class="mf">1e10</span><span class="p">)</span> <span class="c1">#Go back pretty far (almost 400 years) to start with</span>
    <span class="n">minEndTime</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="mf">1e10</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]:</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="n">comp</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">&gt;</span> <span class="n">maxStartTime</span><span class="p">:</span>
            <span class="n">maxStartTime</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
        <span class="k">if</span> <span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="o">&lt;</span> <span class="n">minEndTime</span><span class="p">:</span>
            <span class="n">minEndTime</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>

    <span class="c1">#Trim all traces to the same start/end time</span>
    <span class="n">stream</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">maxStartTime</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="n">minEndTime</span><span class="p">)</span>      

    <span class="c1">#Sort windows by the start of the window</span>
    <span class="n">sorted_window_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">windowStart</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">window_list</span><span class="p">):</span>
        <span class="n">windowStart</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">window</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">windowStart_og</span> <span class="o">=</span> <span class="n">windowStart</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">windowStart</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">sorted_start_list</span> <span class="o">=</span> <span class="n">windowStart</span>
    <span class="n">ranks</span> <span class="o">=</span> <span class="p">[</span><span class="n">windowStart_og</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">sorted_start_list</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranks</span><span class="p">:</span>
        <span class="n">sorted_window_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">window_list</span><span class="p">[</span><span class="n">r</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_window_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_window_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">sorted_window_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Overlapping windows. Please start over and reselect windows to be removed or use a different noise removal method: </span><span class="si">{</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> &#39;&gt;&#39; </span><span class="si">{</span><span class="n">sorted_window_list</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>
                
    <span class="n">window_gaps_obspy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">window_gaps</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">buffer_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">-</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span><span class="p">)</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span>

    <span class="c1">#Get obspy.UTCDateTime objects for the gap times</span>
    <span class="n">window_gaps_obspy</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span> <span class="n">warmup_time</span><span class="p">,</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span> <span class="n">warmup_time</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_window_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">window</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">window_gaps_obspy</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">UTCDateTime</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">dates</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
        <span class="n">window_gaps</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">window</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">window</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mi">86400</span><span class="p">)</span>
    <span class="n">window_gaps_obspy</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">-</span><span class="n">buffer_time</span><span class="p">,</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span><span class="o">-</span><span class="n">buffer_time</span><span class="p">])</span>
    <span class="c1">#Note, we added start and endtimes to obpsy list to help with later functionality</span>

    <span class="c1">#Clean up stream windows (especially, start and end)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">window_gaps</span><span class="p">):</span>
        <span class="n">newSt</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1">#Check if first window starts before end of warmup time</span>
        <span class="c1">#If the start of the first exclusion window is before the warmup_time is over</span>
        <span class="k">if</span> <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">newSt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">&lt;</span> <span class="n">warmup_time</span><span class="p">:</span>
            <span class="c1">#If the end of first exclusion window is also before the warmup_time is over</span>
            <span class="k">if</span> <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">newSt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">&lt;</span> <span class="n">warmup_time</span><span class="p">:</span>
                <span class="c1">#Remove that window completely, it is unnecessary</span>
                <span class="n">window_gaps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">window_gaps_obspy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1">#...and reset the entire window to start at the warmup_time end</span>
                <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">newSt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">+</span> <span class="n">warmup_time</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1">#if window overlaps the start of the stream after warmup_time</span>
                <span class="c1">#Remove that window</span>
                <span class="n">window_gaps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="c1">#...and reset the start of the window to be the end of warm up time</span>
                <span class="c1">#...and  remove that first window from the obspy list</span>
                <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="c1">#newSt[0].stats.starttime + warmup_time</span>
                <span class="n">window_gaps_obspy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">buffer_time</span><span class="p">:</span>        
            <span class="k">if</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stream</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">buffer_time</span><span class="p">:</span>
                <span class="n">window_gaps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">window_gaps_obspy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1">#if end of window overlaps the buffer time, just end it at the start of the window (always end with stream, not gap)</span>
                <span class="n">window_gaps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">window_gaps_obspy</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">newSt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">buffer_time</span>
   
    <span class="c1">#Add streams</span>
    <span class="n">stream_windows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">window</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">window_gaps</span><span class="p">):</span>
        <span class="n">j</span><span class="o">=</span><span class="n">i</span>
        <span class="n">newSt</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">stream_windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newSt</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">endtime</span><span class="o">=</span><span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">newSt</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">stream_windows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newSt</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">endtime</span><span class="o">=</span><span class="n">window_gaps_obspy</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">st</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stream_windows</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">outStream</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newSt</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">gap</span> <span class="o">=</span> <span class="n">window_gaps</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">outStream</span> <span class="o">=</span> <span class="n">outStream</span> <span class="o">+</span> <span class="n">newSt</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">-</span> <span class="n">gap</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>       
    <span class="n">outStream</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">outStream</span>


<span class="c1"># Helper functions for remove_outlier_curves()</span>
<span class="c1"># Use DBSCAN algorithm for outlier detection</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__dbscan_outlier_detect</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">use_hv_curves</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_percentile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">dist_metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> 
                            <span class="n">neighborhood_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">min_neighborhood_pts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HV_Curves&#39;</span><span class="p">],</span> <span class="n">comp_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">],</span> 
                            <span class="n">col_prefix</span> <span class="o">=</span> <span class="s1">&#39;HV_Curves&#39;</span><span class="p">,</span>                       
                            <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This is a helper function for remove_outlier_curves() to use a DBSCAN algorithm </span>
<span class="sd">    to identify and discard outlier curves.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_data : HVSRData</span>
<span class="sd">        HVSRData instance on which to perform DBSCAN analysis</span>
<span class="sd">    use_hv_curves : bool, optional</span>
<span class="sd">        Whether to use HV_Curves as the curve set of interest, by default True</span>
<span class="sd">    dist_metric : str, optional</span>
<span class="sd">        Distance metric to use (see scipy.spatial.distance.pdist), by default &#39;euclidean&#39;</span>
<span class="sd">    neighborhood_size : int, optional</span>
<span class="sd">        Percentile value to use in selecting neighborhood cutoff size.</span>
<span class="sd">        100 would use the largest distance in the distance matrix. 0 would use the smallest (0), by default 95</span>
<span class="sd">    min_neighborhood_pts : int, optional</span>
<span class="sd">        Minimum number of points in a curve&#39;s neighborhood for that point to be considered a core point, by default 5</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    HVSRData</span>
<span class="sd">        HVSRData instance with the hvsr_windows_df DataFrame &quot;Use&quot; column updated</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get the correct set of curves to use</span>
    <span class="c1"># This can be generalized better (and adapted for azimuthal values)</span>
    <span class="c1">#if use_hv_curves:</span>
    <span class="c1">#    curveCols = [&#39;HV_Curves&#39;]</span>
    <span class="c1">#else:</span>
    <span class="c1">#    curveCols = [&#39;psd_values_Z&#39;, &#39;psd_values_E&#39;, &#39;psd_values_N&#39;]</span>


    <span class="c1"># Clean up percentile value</span>
    <span class="k">if</span> <span class="n">use_percentile</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">neighborhood_size</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">neighborhood_size</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Neighborhood_percentile must be between 0-100, not &quot;</span><span class="p">,</span> <span class="n">neighborhood_size</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  Resetting neighborhood_size to 95&#39;</span><span class="p">)</span>
            <span class="n">neighborhood_size</span> <span class="o">=</span> <span class="mi">95</span>
        <span class="k">elif</span> <span class="n">neighborhood_size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">neighborhood_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">neighborhood_size</span> <span class="o">=</span> <span class="n">neighborhood_size</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="c1"># Define local function to use general dbscan algorithm for identifying outliers</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_dbscan_outliers</span><span class="p">(</span><span class="n">distance_matrix</span><span class="p">,</span> <span class="n">n_size</span><span class="p">,</span> <span class="n">min_pts</span><span class="p">,</span> <span class="n">_use_percentile</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">dist_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">has_neighbors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="c1"># Get epsilon based on whether it is a percentile</span>
        <span class="k">if</span> <span class="n">_use_percentile</span><span class="p">:</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">,</span> <span class="n">n_size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="n">n_size</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">neighbors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">eps</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">min_pts</span><span class="p">:</span>
                <span class="n">has_neighbors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="c1">#print(i, len(neighbors), has_neighbors[i])</span>
        
        <span class="k">return</span> <span class="n">has_neighbors</span>


    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">comp_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_hv_curves</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="n">col_prefix</span> <span class="o">+</span> <span class="n">column</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="n">column</span>


    <span class="c1"># Iterate through curves of interest</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">comp_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_hv_curves</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="n">col_prefix</span> <span class="o">+</span> <span class="n">column</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="n">curves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="n">column</span><span class="p">])</span>
        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">squareform</span><span class="p">(</span><span class="n">pdist</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">dist_metric</span><span class="p">))</span>

        <span class="n">noise_array</span> <span class="o">=</span> <span class="n">_dbscan_outliers</span><span class="p">(</span><span class="n">distance_matrix</span><span class="o">=</span><span class="n">dist_matrix</span><span class="p">,</span> 
                                       <span class="n">n_size</span><span class="o">=</span><span class="n">neighborhood_size</span><span class="p">,</span> 
                                       <span class="n">min_pts</span><span class="o">=</span><span class="n">min_neighborhood_pts</span><span class="p">,</span>
                                       <span class="n">_use_percentile</span><span class="o">=</span><span class="n">use_percentile</span><span class="p">)</span>
        <span class="c1"># Remove curves from analysis</span>
        <span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_windows_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">noise_array</span><span class="p">,</span> <span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">hvsr_data</span>


<span class="c1"># This is a remove_outlier_curve() helper function to use a &quot;prototype&quot; curve (median curve) to detect outliers</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__prototype_outlier_detect</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">use_hv_curves</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                                <span class="n">use_percentile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">outlier_threshold</span><span class="o">=</span><span class="mi">98</span><span class="p">,</span>
                                <span class="n">col_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HV_Curves&#39;</span><span class="p">],</span> <span class="n">comp_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">],</span> 
                                <span class="n">col_prefix</span> <span class="o">=</span> <span class="s1">&#39;HV_Curves&#39;</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="c1"># Loop through each component, and determine which curves are outliers</span>
    <span class="n">bad_rmse</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">col_names</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">comp_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_hv_curves</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="n">col_prefix</span> <span class="o">+</span> <span class="n">column</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="n">column</span>

        <span class="c1"># Retrieve data from dataframe (use all windows, just in case)</span>
        <span class="n">curr_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="n">column</span><span class="p">])</span>

        <span class="c1"># Calculate a median curve, and reshape so same size as original</span>
        <span class="n">medCurve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">curr_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">medCurveArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">medCurve</span><span class="p">,</span> <span class="p">(</span><span class="n">curr_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Calculate RMSE</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">curr_data</span><span class="p">,</span> <span class="n">medCurveArr</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">curr_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;RMSE_&#39;</span><span class="o">+</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmse</span>
        <span class="k">if</span> <span class="n">use_percentile</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">rmse_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">rmse</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rmse</span><span class="p">)],</span> <span class="n">outlier_threshold</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">RMSE at </span><span class="si">{</span><span class="n">outlier_threshold</span><span class="si">}</span><span class="s1">th percentile for </span><span class="si">{</span><span class="n">column</span><span class="si">}</span><span class="s1"> calculated at: </span><span class="si">{</span><span class="n">rmse_threshold</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rmse_threshold</span> <span class="o">=</span> <span class="n">outlier_threshold</span>

        <span class="c1"># Retrieve index of those RMSE values that lie outside the threshold</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">curve</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">curr_data</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rmse</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">rmse_threshold</span><span class="p">:</span>
                <span class="n">bad_rmse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

    <span class="c1"># Get unique values of bad_rmse indices and set the &quot;Use&quot; column of the hvsr_windows_df to False for that window</span>
    <span class="n">bad_rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">bad_rmse</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_rmse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">rmse_threshold</span> <span class="o">&gt;</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;RMSE_&#39;</span><span class="o">+</span><span class="n">column</span><span class="p">])</span>
        <span class="c1">#hvsr_data[&#39;hvsr_windows_df&#39;].loc[bad_index, &quot;Use&quot;] = False   </span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bad_rmse</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t\t</span><span class="s2">The windows starting at the following times have been removed from further analysis (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bad_rmse</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">):&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">bad_rmse</span><span class="p">)]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">  </span><span class="si">{</span><span class="n">b</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">No outlier curves have been removed&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hvsr_data</span>


<span class="c1"># Helper functions for generate_psds()</span>
<span class="c1"># Generate psds from raw data (no response removed)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__single_psd_from_raw_data</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">window_length_method</span><span class="o">=</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="n">window_type</span><span class="o">=</span><span class="s1">&#39;hann&#39;</span><span class="p">,</span>
                               <span class="n">overlap</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">num_freq_bins</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span>
                               <span class="n">show_psd_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">remove_response</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">do_azimuths</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function to get psds from raw trace streams (no response information is needed in this case)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_data : HVSRData object</span>
<span class="sd">        HVSRData object containing data to be processed</span>
<span class="sd">    window_length : float, optional</span>
<span class="sd">        Length of FFT processing window for in seconds, by default 30.0</span>
<span class="sd">    overlap : float, optional</span>
<span class="sd">        Percent overlap between windows (0-1), by default 0.5.</span>
<span class="sd">        A percentage value between 1-100 will be accepted, but will be divided by 100 to convert to 0-1.</span>
<span class="sd">        If the value is over 100, the modulus of 100 will be calculated, then divided by 100; i.e., (overlap%100)/100.</span>
<span class="sd">    show_psd_plot : bool, optional</span>
<span class="sd">        Whether to show a plot of the psds, by default False</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Whether to print information about the PSD processing to terminal, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple (dict, np.array)</span>
<span class="sd">        Tuple with index 0 being a dictionary with keys of components (&quot;Z&quot;, &quot;E&quot;, &quot;N&quot;).</span>
<span class="sd">        Values are numpy array containing the PSDs for that component at each time step.</span>
<span class="sd">        Index 1 of tuple contains a numpy array with the start and end times of each time window used for FFT processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zdata</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
    <span class="n">edata</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;E&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
    <span class="n">ndata</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>

    <span class="n">dataDict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="n">zdata</span><span class="p">,</span>
                <span class="s1">&#39;E&#39;</span><span class="p">:</span><span class="n">edata</span><span class="p">,</span>
                <span class="s1">&#39;N&#39;</span><span class="p">:</span><span class="n">ndata</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">do_azimuths</span><span class="p">:</span>
        <span class="n">azimuthStream</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">component</span><span class="o">=</span><span class="s1">&#39;R&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">azimuthTrace</span> <span class="ow">in</span> <span class="n">azimuthStream</span><span class="p">:</span>
            <span class="n">dataDict</span><span class="p">[</span><span class="n">azimuthTrace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">component</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">=</span> <span class="n">azimuthTrace</span>
        
    

    <span class="k">if</span> <span class="n">remove_response</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">compStream</span> <span class="ow">in</span> <span class="n">dataDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">compStream</span> <span class="o">=</span> <span class="n">compStream</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            
            <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">compStream</span><span class="p">:</span>
                <span class="n">trace</span><span class="o">.</span><span class="n">remove_response</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">])</span>
            
            <span class="n">compStream</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">Instrument Response Removed from Traces</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">zdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span>
    <span class="n">sample_space</span> <span class="o">=</span> <span class="n">zdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">delta</span>
    <span class="n">zdata</span> <span class="o">=</span> <span class="n">zdata</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>


    <span class="c1"># Transform overlap to proper formatting (% b/w 0-1)</span>
    <span class="k">if</span> <span class="n">overlap</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">The parameter overlap=</span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2"> should be a float between 0-1&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">  Since it is over 100, the modulus of 100 (overlap%100)/100=(</span><span class="si">{</span><span class="n">overlap</span><span class="o">%</span><span class="mi">100</span><span class="si">}</span><span class="s2">) will be used&quot;</span><span class="p">)</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="p">(</span><span class="n">overlap</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>
    <span class="k">elif</span> <span class="n">overlap</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="k">elif</span> <span class="n">overlap</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">The parameter overlap=</span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2"> should be a float between 0-1&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">  This has been updated to the default value of overlap=0.5&quot;</span><span class="p">)</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1">#just set it default otherwise</span>

    <span class="c1"># Get number of samples instead of seconds/percentage</span>
    <span class="n">psd_window_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">window_length</span> <span class="o">*</span> <span class="n">sample_rate</span><span class="p">)</span>
    <span class="n">overlap_samples</span> <span class="o">=</span> <span class="n">overlap</span> <span class="o">*</span> <span class="n">psd_window_samples</span>

    <span class="c1"># Generated x values to which data will be interpolated later</span>
    <span class="c1">#  This maintains consistency in array size across all FFT windows</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="s1">&#39;hvsr_band&#39;</span><span class="p">):</span>
        <span class="n">low_freq</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hi_freq</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_band</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">low_freq</span> <span class="o">=</span> <span class="n">DEFAULT_BAND</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hi_freq</span> <span class="o">=</span> <span class="n">DEFAULT_BAND</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">x_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">low_freq</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hi_freq</span><span class="p">),</span> <span class="n">num_freq_bins</span><span class="p">)</span>

    <span class="c1"># For each component, create the time windows and do FFT analysis</span>
    <span class="n">psdDict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">curr_component</span> <span class="ow">in</span> <span class="n">dataDict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">psdDict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="c1"># Get all data in same format (obspy.Stream, traces will be extracted later)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">curr_component</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">):</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">([</span><span class="n">curr_component</span><span class="p">])</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">curr_component</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Initialize for intermediate outputs</span>
        <span class="n">psds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">final_psds</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Get all possible windows and initialize output window list for windows that are actually used</span>
        <span class="c1">#  This will likely be the same if there are no gaps in the data</span>
        <span class="n">windows</span> <span class="o">=</span> <span class="n">_create_windows</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">=</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="n">window_length</span><span class="p">,</span> 
                                  <span class="n">overlap</span><span class="o">=</span><span class="n">overlap</span><span class="p">,</span> <span class="n">window_length_method</span><span class="o">=</span><span class="n">window_length_method</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">windows_out</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Iterate through each window to trim data trace and perform fft analysis</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">stime</span><span class="p">,</span> <span class="n">etime</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">windows</span><span class="p">):</span>
            <span class="c1"># Trim trace to just window time (copy so doesn&#39;t overwrite main trace)</span>
            <span class="n">window_trace</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">window_trace</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">starttime</span><span class="o">=</span><span class="n">stime</span><span class="p">,</span> <span class="n">endtime</span><span class="o">=</span><span class="n">etime</span><span class="p">)</span> 
            
            <span class="c1"># Handle gaps in data </span>
            <span class="c1"># Only process longest continous data section in each window, if gaps exist</span>
            <span class="n">window_st</span> <span class="o">=</span> <span class="n">window_trace</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>  <span class="c1"># Split into continuous data sections</span>
            <span class="n">longest_trace</span> <span class="o">=</span> <span class="n">window_st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Initialize longest as first trace</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_st</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># if more than one trace comes out of .split()</span>
                <span class="c1"># Get the longest trace and used that for analysis for this window</span>
                <span class="k">for</span> <span class="n">shorttr</span> <span class="ow">in</span> <span class="n">window_st</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shorttr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">longest_trace</span><span class="p">):</span>
                        <span class="n">longest_trace</span> <span class="o">=</span> <span class="n">shorttr</span>
            <span class="n">window_trace</span> <span class="o">=</span> <span class="n">longest_trace</span>

            <span class="c1"># If the data being processed ends up being shorter than window time</span>
            <span class="c1">#    Reset inputs to scipy.signal.welch to match new &quot;window&quot; length</span>
            <span class="n">nsamplesperwin</span> <span class="o">=</span> <span class="n">psd_window_samples</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_trace</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nsamplesperwin</span><span class="p">:</span>
                <span class="n">nsamplesperwin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">window_trace</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="n">overlap_samples</span> <span class="o">=</span> <span class="n">nsamplesperwin</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="c1"># PERFORM FFT analysis using Welch method if length of window is &gt; 1 sample</span>
            <span class="c1"># If time window used, the start time will be recorded in window_out list</span>
                <span class="c1"># and PSD will be stored in psdDict[key][str(starttime)] as numpy array.</span>
            <span class="k">if</span> <span class="n">nsamplesperwin</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span> <span class="c1"># Sometimes unnecessary warnings arise</span>
                    <span class="n">f</span><span class="p">,</span> <span class="n">pxx</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">welch</span><span class="p">(</span><span class="n">window_trace</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">window_trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">,</span> 
                                                <span class="n">window</span><span class="o">=</span><span class="n">window_type</span><span class="p">,</span> <span class="n">nperseg</span><span class="o">=</span><span class="n">nsamplesperwin</span><span class="p">,</span> 
                                                <span class="n">noverlap</span><span class="o">=</span><span class="n">overlap_samples</span><span class="p">,</span> <span class="n">nfft</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detrend</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">return_onesided</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                <span class="n">scaling</span><span class="o">=</span><span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">average</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
                
                <span class="c1"># Only add successful psds to psdDict (and the window starttime to window_out)</span>
                <span class="k">if</span> <span class="n">pxx</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">psds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">pxx</span><span class="p">))</span>
                    <span class="n">interpPSD</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">x_freqs</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pxx</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">interpPSD_dB</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">interpPSD</span><span class="p">)</span> <span class="c1"># Convert to decibels</span>
                    <span class="n">psdDict</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="nb">str</span><span class="p">(</span><span class="n">stime</span><span class="p">)]</span> <span class="o">=</span> <span class="n">interpPSD_dB</span>
                    <span class="n">final_psds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interpPSD_dB</span><span class="p">)</span>
                
                    <span class="n">windows_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stime</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Window starting at </span><span class="si">{</span><span class="n">stime</span><span class="si">}</span><span class="s2"> not used (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">window_trace</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples long)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Window starting at </span><span class="si">{</span><span class="n">stime</span><span class="si">}</span><span class="s2"> not used (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">window_trace</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples long)&quot;</span><span class="p">)</span>
        <span class="c1">#psds = np.mean(np.array(final_psds), axis=0)</span>
        <span class="c1">#psdDict[key][str(stime)] = np.array(final_psds)</span>

        <span class="k">if</span> <span class="n">show_psd_plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_freqs</span><span class="p">,</span> <span class="n">psds</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">psdDict</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">windows_out</span><span class="p">)</span>


<span class="c1"># Generate windows &quot;manually&quot;</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_create_windows</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">window_length_method</span><span class="o">=</span><span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to create time windows based on input stream.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_data : HVSRData object, Obspy.Stream, or Obspy.Trace</span>
<span class="sd">        Input object with stream data</span>
<span class="sd">    window : float or int, optional</span>
<span class="sd">        Windowing parameter. If window_length_method=&#39;length&#39;, this is the length of each window in seconds.</span>
<span class="sd">        If window_length_method=&#39;number&#39;, this must be int or be able to be converted to int, and is the number of windows, by default 30</span>
<span class="sd">    overlap : float, optional</span>
<span class="sd">        Window overlap in percentage. If &gt;=1, it will be interpreted as a percentage out of 100, by default 0.5</span>
<span class="sd">    window_length_method : str, optional</span>
<span class="sd">        Which windowing method to use, &quot;length&quot;, which creates windows of a specified length, or </span>
<span class="sd">        &quot;number&quot;, which creates a specified number of windows, by default &#39;length&#39;</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Whether to print information about the process to terminal, by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.array</span>
<span class="sd">        2D Numpy array containing, the size of the first dimension is the number of windows, size of second dimension is 2 (start and end) </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">length_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;window_length&#39;</span><span class="p">,</span> <span class="s1">&#39;window length&#39;</span><span class="p">,</span> 
                   <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="s1">&#39;len&#39;</span><span class="p">,</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">]</span>
    
    <span class="n">winNum_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;number of windows&#39;</span><span class="p">,</span> <span class="s1">&#39;window_number&#39;</span><span class="p">,</span> <span class="s1">&#39;window number&#39;</span><span class="p">,</span> 
                   <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="s1">&#39;winnum&#39;</span><span class="p">,</span> <span class="s1">&#39;window_num&#39;</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">]</span>

    <span class="c1"># Get input data as obspy.Stream</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">HVSRData</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Trace</span><span class="p">):</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">obspy</span><span class="o">.</span><span class="n">Stream</span><span class="p">([</span><span class="n">hvsr_data</span><span class="p">])</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;hvsr_data parameter of _create_windows() must be sprit.HVSRData, obspy.Stream, or obspy.Trace&quot;</span><span class="p">)</span>

    <span class="c1"># Get largest starttime and smallest endtime (to ensure all data is used)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">st</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">maxStart</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
            <span class="n">minEnd</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span> <span class="o">&gt;</span> <span class="n">maxStart</span><span class="p">:</span>
                <span class="n">maxStart</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
            <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span> <span class="o">&lt;</span> <span class="n">minEnd</span><span class="p">:</span>
                <span class="n">minEnd</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>
    <span class="c1"># Calculate time between end and start</span>
    <span class="n">timeRange</span> <span class="o">=</span> <span class="n">minEnd</span> <span class="o">-</span> <span class="n">maxStart</span>

    <span class="c1"># Transform overlap to proper formatting (% b/w 0-1)</span>
    <span class="k">if</span> <span class="n">overlap</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">The parameter overlap=</span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2"> should be a float between 0-1&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">  Since it is over 100, the modulus of 100 (overlap%100)/100=(</span><span class="si">{</span><span class="n">overlap</span><span class="o">%</span><span class="mi">100</span><span class="si">}</span><span class="s2">) will be used&quot;</span><span class="p">)</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="p">(</span><span class="n">overlap</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>
    <span class="k">elif</span> <span class="n">overlap</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap</span> <span class="o">/</span> <span class="mi">100</span>
    <span class="k">elif</span> <span class="n">overlap</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">The parameter overlap=</span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2"> should be a float between 0-1&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">  This has been updated to the default value of overlap=0.5&quot;</span><span class="p">)</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1">#just set it default otherwise</span>

    <span class="c1"># Calculate &quot;stride&quot; (time between start of each window) and window length</span>
    <span class="k">if</span> <span class="n">window_length_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">length_list</span><span class="p">:</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="n">window</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">overlap</span><span class="p">)</span>
        <span class="n">winLength</span> <span class="o">=</span> <span class="n">window</span>
    <span class="k">elif</span> <span class="n">window_length_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">winNum_list</span><span class="p">:</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="n">timeRange</span> <span class="o">//</span> <span class="n">window</span>
        <span class="n">winLength</span> <span class="o">=</span> <span class="n">stride</span> <span class="o">/</span> <span class="n">overlap</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">window_method=</span><span class="si">{</span><span class="n">window_length_method</span><span class="si">}</span><span class="s2"> is not a valid entry.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">  Use any of the following to create windows using a specific size: </span><span class="si">{</span><span class="n">length_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">  Use any of the following to create a specific number of windows : </span><span class="si">{</span><span class="n">winNum_list</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">  By default, using a window length of 30 seconds and overlap of 0.5&quot;</span><span class="p">)</span>
        <span class="c1"># Default of overlap=0.5, window_length=30</span>
        <span class="n">stride</span> <span class="o">=</span> <span class="mi">15</span>
        <span class="n">winLength</span> <span class="o">=</span> <span class="mi">30</span>
        <span class="n">overlap</span> <span class="o">=</span> <span class="mf">0.5</span>

    <span class="c1"># Get start and end of each window, and format appropriately (2d Numpy array)</span>
    <span class="n">windowStarts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">maxStart</span><span class="p">,</span> <span class="n">minEnd</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>
    <span class="n">windowEnds</span> <span class="o">=</span> <span class="n">windowStarts</span> <span class="o">+</span> <span class="n">winLength</span>
    <span class="n">windows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">windowStarts</span><span class="p">,</span> <span class="n">windowEnds</span><span class="p">)))</span>
    
    <span class="c1"># print information if verbose specified</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="n">verboseStatement</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Using the following windowing parameters&quot;</span><span class="p">]</span>
        <span class="n">verboseStatement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Number of windows: </span><span class="si">{</span><span class="n">windows</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">verboseStatement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Window Size: </span><span class="si">{</span><span class="n">winLength</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">verboseStatement</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2"> Window Overlap: </span><span class="si">{</span><span class="n">overlap</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">verboseStatement</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">windows</span>


<span class="c1"># Remove noisy windows from df</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__remove_windows_from_df</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># Get gaps from masked regions of traces</span>
    <span class="n">gaps0</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">gaps1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">outStream</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream_edited&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">outStream</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">trEndTime</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>
            <span class="n">comp_end</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">component</span>
            <span class="k">continue</span> <span class="c1"># Wait until the second trace</span>

        <span class="n">trStartTime</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">starttime</span>
        <span class="n">comp_start</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">component</span>
        <span class="n">firstDiff</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">secondDiff</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Check if both are different from any existing gap times</span>
        <span class="k">if</span> <span class="n">trEndTime</span> <span class="ow">in</span> <span class="n">gaps0</span><span class="p">:</span>
            <span class="n">firstDiff</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">trStartTime</span> <span class="ow">in</span> <span class="n">gaps1</span><span class="p">:</span>
            <span class="n">secondDiff</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># If the first element and second element are both new, add to gap list</span>
        <span class="k">if</span> <span class="n">firstDiff</span> <span class="ow">and</span> <span class="n">secondDiff</span><span class="p">:</span>
            <span class="n">gaps0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trEndTime</span><span class="p">)</span>
            <span class="n">gaps1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trStartTime</span><span class="p">)</span>

        <span class="n">trEndTime</span> <span class="o">=</span> <span class="n">trace</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">endtime</span>
    
    <span class="n">gaps</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gaps0</span><span class="p">,</span> <span class="n">gaps1</span><span class="p">))</span>
    <span class="n">hvsr_windows_df_exists</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;hvsr_windows_df&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;params&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;hvsr_windows_df&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;input_params&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;hvsr_windows_df&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">hvsr_windows_df_exists</span><span class="p">:</span>
        <span class="n">hvsrDF</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span>
        <span class="n">use_before</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s2">&quot;Use&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">outStream</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream_edited&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="c1">#for i, trace in enumerate(outStream):</span>
            <span class="c1">#if i == 0:</span>
            <span class="c1">#    trEndTime = trace.stats.endtime</span>
            <span class="c1">#    comp_end = trace.stats.component</span>
            <span class="c1">#    continue</span>
            <span class="c1">#trStartTime = trace.stats.starttime</span>
            <span class="c1">#comp_start = trace.stats.component</span>
            
            <span class="c1">#if trEndTime &lt; trStartTime and comp_end == comp_start:</span>
        <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">gap</span> <span class="ow">in</span> <span class="n">gaps</span><span class="p">:</span>
            <span class="c1"># All windows whose starts occur within the gap are set to False</span>
            <span class="n">gappedIndices</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="o">.</span><span class="n">between_time</span><span class="p">(</span><span class="n">gap</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">gap</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="c1">#.loc[:, &#39;Use&#39;]</span>
            <span class="n">hvsrDF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">gappedIndices</span><span class="p">,</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># The previous window is also set to false, since the start of the gap lies within that window</span>
            <span class="n">prevInd</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_indexer</span><span class="p">([</span><span class="n">gap</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">)</span>
            <span class="n">prevDTInd</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">prevInd</span><span class="p">]</span>
            <span class="n">hvsrDF</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">prevDTInd</span><span class="p">,</span> <span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
            
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsrDF</span>  <span class="c1"># May not be needed, just in case, though</span>

        <span class="n">use_after</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s2">&quot;Use&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="o">~</span><span class="n">use_before</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">use_after</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">removed</span><span class="p">[</span><span class="n">removed</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n\t\t</span><span class="s2">The windows starting at the following times have been removed from further analysis (</span><span class="si">{</span><span class="n">removed</span><span class="p">[</span><span class="n">removed</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">hvsrDF</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">removed</span><span class="p">[</span><span class="n">removed</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">  </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1"> &#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">No windows removed using remove_noise()&quot;</span><span class="p">)</span>

        <span class="n">outStream</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;stream_edited&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outStream</span>

    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_gaps_obspyDT&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gaps</span>

    <span class="k">return</span> <span class="n">hvsr_data</span>


<span class="c1"># Helper functions for process_hvsr()</span>
<span class="c1"># Get diffuse field assumption data</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_dfa</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsr_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span><span class="c1">#, equal_interval_energy, median_daily_psd, verbose=False):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function for performing Diffuse Field Assumption (DFA) analysis</span>

<span class="sd">        x : numpy.array</span>
<span class="sd">            Numpy array or list containing all x values (frequency or period) for each psd</span>
<span class="sd">        hvsr_data : HVSRData object</span>
<span class="sd">            HVSRData object containing all the data and information about the HVSR point being processed</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            Whether to print information about the DFA processing to terminal, default = False.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Use equal energy for daily PSDs to give small &#39;events&#39; a chance to contribute</span>
    <span class="c1"># the same as large ones, so that pH1List+pH2List+P3=1</span>
    <span class="n">hvsr_tSteps</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Using Diffuse Field Assumption (DFA)&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;WARNING: DFA method is currently experimental and has not been extensively tested.&#39;</span><span class="p">)</span>

    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">sum_ns_power</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">sum_ew_power</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">sum_z_power</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_int_psd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z&#39;</span><span class="p">:{},</span> <span class="s1">&#39;E&#39;</span><span class="p">:{},</span> <span class="s1">&#39;N&#39;</span><span class="p">:{}}</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_values&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;equal_interval_energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z&#39;</span><span class="p">:{},</span> <span class="s1">&#39;E&#39;</span><span class="p">:{},</span> <span class="s1">&#39;N&#39;</span><span class="p">:{}}</span>

    <span class="n">ti</span> <span class="o">=</span> <span class="mi">0</span>    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t_int</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="s1">&#39;current_times_used&#39;</span><span class="p">]):</span>
        <span class="n">ti</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">hvsr_curve_tinterval</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Initialize some lists for later use</span>
        <span class="n">sum_ns_power</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">sum_ew_power</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">sum_z_power</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        
        <span class="c1"># Add the time interval to the time_values list</span>
        <span class="n">time_int</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">t_int</span><span class="p">)</span><span class="c1">#day_time.split(&#39;T&#39;)[0]</span>
        <span class="k">if</span> <span class="n">time_int</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_values&#39;</span><span class="p">]:</span>
            <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_values&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time_int</span><span class="p">)</span>

        <span class="c1"># Get the psd data for each time, </span>
        <span class="n">tiIndDF</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_int_psd&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tiIndDF</span><span class="p">,</span><span class="s1">&#39;psd_values_Z&#39;</span><span class="p">]</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_int_psd&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tiIndDF</span><span class="p">,</span><span class="s1">&#39;psd_values_E&#39;</span><span class="p">]</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_int_psd&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">tiIndDF</span><span class="p">,</span><span class="s1">&#39;psd_values_N&#39;</span><span class="p">]</span>

        <span class="c1"># Each PSD for the time_int (there is only one in SpRIT)</span>
        <span class="n">pZList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">pH1List</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">pH2List</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">sum_pz</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sum_p1</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sum_p2</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Each sample of the PSD , convert to power</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">pz</span> <span class="o">=</span> <span class="n">__get_power</span><span class="p">([</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_int_psd&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">][</span><span class="n">j</span><span class="p">][()],</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_int_psd&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][()]],</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
            <span class="n">pZList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pz</span><span class="p">)</span>
            <span class="n">sum_pz</span> <span class="o">+=</span> <span class="n">pz</span>

            <span class="n">p1</span> <span class="o">=</span> <span class="n">__get_power</span><span class="p">([</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_int_psd&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">][</span><span class="n">j</span><span class="p">][()],</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_int_psd&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][()]],</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
            <span class="n">pH1List</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
            <span class="n">sum_p1</span> <span class="o">+=</span> <span class="n">p1</span>

            <span class="n">p2</span> <span class="o">=</span> <span class="n">__get_power</span><span class="p">([</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_int_psd&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">][</span><span class="n">j</span><span class="p">][()],</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_int_psd&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][()]],</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]])</span>
            <span class="n">pH2List</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
            <span class="n">sum_p2</span> <span class="o">+=</span> <span class="n">p2</span>
        
        <span class="n">sum_power</span> <span class="o">=</span> <span class="n">sum_pz</span> <span class="o">+</span> <span class="n">sum_p1</span> <span class="o">+</span> <span class="n">sum_p2</span>  <span class="c1"># total power</span>

        <span class="c1"># Mormalized power</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">sum_z_power</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pZList</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_power</span><span class="p">)</span>
            <span class="n">sum_ew_power</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pH1List</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_power</span><span class="p">)</span>
            <span class="n">sum_ns_power</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pH2List</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_power</span><span class="p">)</span>
            
        <span class="c1"># Average the normalized time interval power</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">sum_z_power</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_int_psd&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">])</span>
            <span class="n">sum_ew_power</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_int_psd&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">])</span>
            <span class="n">sum_ns_power</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;time_int_psd&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">])</span>

        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;equal_interval_energy&#39;</span><span class="p">][</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_z_power</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;equal_interval_energy&#39;</span><span class="p">][</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_ew_power</span>
        <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;equal_interval_energy&#39;</span><span class="p">][</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_ns_power</span>


        <span class="c1"># Start Second dfa section in original iris script</span>
        <span class="c1"># Perform h/v calculation at each frequency/time step</span>
        <span class="n">eie</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;dfa&#39;</span><span class="p">][</span><span class="s1">&#39;equal_interval_energy&#39;</span><span class="p">]</span> 
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time_int</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">eie</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time_int</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">eie</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time_int</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">eie</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                <span class="n">hv_x</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">eie</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">eie</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> <span class="n">eie</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">time_int</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                <span class="n">hvsr_curve_tinterval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hv_x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: &#39;</span><span class="o">+</span> <span class="n">t_int</span> <span class="o">+</span> <span class="s1">&#39; missing component, skipped!&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
        
        <span class="c1">#Average over time</span>
        <span class="n">hvsr_tSteps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr_curve_tinterval</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hvsr_tSteps</span>


<span class="c1"># Helper function for smoothing across frequencies</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__freq_smooth_window</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">,</span> <span class="n">f_smooth_width</span><span class="p">,</span> <span class="n">kind_freq_smooth</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function to smooth frequency if &#39;constant&#39; or &#39;proportional&#39; is passed to freq_smooth parameter of process_hvsr() function&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">kind_freq_smooth</span> <span class="o">==</span> <span class="s1">&#39;constant&#39;</span><span class="p">:</span>
        <span class="n">fwidthHalf</span> <span class="o">=</span> <span class="n">f_smooth_width</span><span class="o">//</span><span class="mi">2</span>
    <span class="k">elif</span> <span class="n">kind_freq_smooth</span> <span class="o">==</span> <span class="s1">&#39;proportional&#39;</span><span class="p">:</span>
        <span class="n">anyKey</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">freqLength</span> <span class="o">=</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">][</span><span class="n">anyKey</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">f_smooth_width</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fwidthHalf</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f_smooth_width</span><span class="o">/</span><span class="mi">100</span> <span class="o">*</span> <span class="n">freqLength</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fwidthHalf</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f_smooth_width</span> <span class="o">*</span> <span class="n">freqLength</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Oops, typo somewhere&#39;</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">]:</span>
        <span class="n">colName</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;psd_values_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">newTPSD</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="n">colName</span><span class="p">]))</span>
        <span class="c1">#newTPSD = list(np.ones_like(hvsr_out[&#39;psd_raw&#39;][k]))</span>

        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tPSD</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fVal</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tPSD</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fwidthHalf</span><span class="p">:</span>
                    <span class="n">downWin</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">fwidthHalf</span><span class="o">-</span><span class="n">downWin</span><span class="p">)</span>
                    <span class="n">windMultiplier_down</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">fwidthHalf</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">fwidthHalf</span><span class="p">,</span> <span class="n">fwidthHalf</span><span class="p">)</span>
                    <span class="n">windMultiplier_down</span> <span class="o">=</span> <span class="n">windMultiplier_down</span><span class="p">[:</span><span class="n">ind</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">downWin</span> <span class="o">=</span> <span class="n">fwidthHalf</span>
                    <span class="n">windMultiplier_down</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">fwidthHalf</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">fwidthHalf</span><span class="p">,</span> <span class="n">fwidthHalf</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">fwidthHalf</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tPSD</span><span class="p">):</span>
                    <span class="n">upWin</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tPSD</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="n">fwidthHalf</span><span class="o">-</span><span class="n">upWin</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">windMultiplier_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">fwidthHalf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fwidthHalf</span><span class="p">)</span>
                    <span class="n">windMultiplier_up</span> <span class="o">=</span> <span class="n">windMultiplier_up</span><span class="p">[:</span><span class="n">ind</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">upWin</span> <span class="o">=</span> <span class="n">fwidthHalf</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">windMultiplier_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="o">/</span><span class="n">fwidthHalf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fwidthHalf</span><span class="p">)</span>
            
                <span class="n">windMultiplier</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">windMultiplier_down</span><span class="p">,</span> <span class="n">windMultiplier_up</span><span class="p">]))</span>
                <span class="n">midInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">windMultiplier</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">midInd</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">windMultiplier</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">midInd</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">smoothVal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">tPSD</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">downWin</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">upWin</span><span class="p">],</span> <span class="n">windMultiplier</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">windMultiplier</span><span class="p">))</span>
                <span class="n">newTPSD</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">smoothVal</span>

        <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">newTPSD</span>
        <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="n">colName</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">newTPSD</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">hvsr_out</span>


<span class="c1"># Get an HVSR curve, given an array of x values (freqs), and a dict with psds for three components</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__get_hvsr_curve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">psd</span><span class="p">,</span> <span class="n">horizontal_method</span><span class="p">,</span> <span class="n">hvsr_data</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Get an HVSR curve from three components over the same time period/frequency intervals</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">        x   : list or array_like</span>
<span class="sd">            x value (frequency or period)</span>
<span class="sd">        psd : dict</span>
<span class="sd">            Dictionary with psd values for three components. Usually read in as part of hvsr_data from process_hvsr</span>
<span class="sd">        horizontal_method : int or str</span>
<span class="sd">            Integer or string, read in from process_hvsr method parameter</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        tuple</span>
<span class="sd">         (hvsr_curve, hvsr_tSteps), both np.arrays. hvsr_curve is a numpy array containing H/V ratios at each frequency/period in x.</span>
<span class="sd">         hvsr_tSteps only used with diffuse field assumption method. </span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hvsr_curve</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hvsr_tSteps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hvsr_azimuth</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">params</span> <span class="o">=</span> <span class="n">hvsr_data</span>
    <span class="k">if</span> <span class="n">horizontal_method</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">horizontal_method</span> <span class="o">==</span><span class="s1">&#39;dfa&#39;</span> <span class="ow">or</span> <span class="n">horizontal_method</span> <span class="o">==</span><span class="s1">&#39;Diffuse Field Assumption&#39;</span><span class="p">:</span>
        <span class="n">hvsr_tSteps</span> <span class="o">=</span> <span class="n">_dfa</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsr_data</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
        <span class="n">hvsr_curve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">hvsr_tSteps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">psd0</span> <span class="o">=</span> <span class="p">[</span><span class="n">psd</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">psd</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">psd1</span> <span class="o">=</span> <span class="p">[</span><span class="n">psd</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">psd</span><span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">psd2</span> <span class="o">=</span> <span class="p">[</span><span class="n">psd</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">psd</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
            <span class="n">f</span> <span class="o">=</span>    <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>

            <span class="n">hvratio</span> <span class="o">=</span> <span class="n">__get_hvsr</span><span class="p">(</span><span class="n">psd0</span><span class="p">,</span> <span class="n">psd1</span><span class="p">,</span> <span class="n">psd2</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">use_method</span><span class="o">=</span><span class="n">horizontal_method</span><span class="p">)</span>
            <span class="n">hvsr_curve</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvratio</span><span class="p">)</span>
            
            <span class="c1"># Do azimuth HVSR Calculations, if applicable</span>
            <span class="n">hvratio_az</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">psd</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;e&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">]:</span>
                    <span class="n">psd_az</span> <span class="o">=</span> <span class="p">[</span><span class="n">psd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">psd</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span>
                    <span class="n">hvratio_az</span> <span class="o">=</span> <span class="n">__get_hvsr</span><span class="p">(</span><span class="n">psd0</span><span class="p">,</span> <span class="n">psd_az</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">use_method</span><span class="o">=</span><span class="s1">&#39;az&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">hvsr_azimuth</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">hvratio_az</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">hvsr_azimuth</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvratio_az</span><span class="p">)</span>
            
        <span class="n">hvsr_tSteps</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Only used for DFA</span>


    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hvsr_curve</span><span class="p">),</span> <span class="n">hvsr_azimuth</span><span class="p">,</span> <span class="n">hvsr_tSteps</span>


<span class="c1"># Get HVSR</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__get_hvsr</span><span class="p">(</span><span class="n">_dbz</span><span class="p">,</span> <span class="n">_db1</span><span class="p">,</span> <span class="n">_db2</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_method</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Helper function to calculate H/V ratio</span>

<span class="sd">    _dbz : list</span>
<span class="sd">        Two item list with deciBel value of z component at either end of particular frequency step</span>
<span class="sd">    _db1 : list</span>
<span class="sd">        Two item list with deciBel value of either e or n component (does not matter which) at either end of particular frequency step</span>
<span class="sd">    _db2 : list</span>
<span class="sd">        Two item list with deciBel value of either e or n component (does not matter which) at either end of particular frequency step</span>
<span class="sd">    _x : list</span>
<span class="sd">        Two item list containing frequency values at either end of frequency step of interest</span>
<span class="sd">    use_method : int, default = 4</span>
<span class="sd">        H is computed based on the selected use_method see: https://academic.oup.com/gji/article/194/2/936/597415</span>
<span class="sd">            use_method:</span>
<span class="sd">            (1) Diffuse Field Assumption (DFA)</span>
<span class="sd">            (2) arithmetic mean, that is, H ≡ (HN + HE)/2</span>
<span class="sd">            (3) geometric mean, that is, H ≡ √HN · HE, recommended by the SESAME project (2004)</span>
<span class="sd">            (4) vector summation, that is, H ≡ √H2 N + H2 E</span>
<span class="sd">            (5) quadratic mean, that is, H ≡ √(H2 N + H2 E )/2</span>
<span class="sd">            (6) maximum horizontal value, that is, H ≡ max {HN, HE}</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="n">_pz</span> <span class="o">=</span> <span class="n">__get_power</span><span class="p">(</span><span class="n">_dbz</span><span class="p">,</span> <span class="n">_x</span><span class="p">)</span>
    <span class="n">_p1</span> <span class="o">=</span> <span class="n">__get_power</span><span class="p">(</span><span class="n">_db1</span><span class="p">,</span> <span class="n">_x</span><span class="p">)</span>
    
    <span class="n">_hz</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_pz</span><span class="p">)</span>
    <span class="n">_h1</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_p1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">_db2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_p2</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">_h2</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_p2</span> <span class="o">=</span> <span class="n">__get_power</span><span class="p">(</span><span class="n">_db2</span><span class="p">,</span> <span class="n">_x</span><span class="p">)</span>
        <span class="n">_h2</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_p2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">az_calc</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">h1</span><span class="p">,</span> <span class="n">h2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">az</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">az</span> <span class="o">=</span> <span class="mi">90</span>

        <span class="k">if</span> <span class="n">az</span> <span class="o">==</span> <span class="s1">&#39;HV&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_h1</span> <span class="o">*</span> <span class="n">_h2</span><span class="p">)</span>

        <span class="n">az_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">az</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">h2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">az_rad</span><span class="p">),</span> <span class="n">h1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">az_rad</span><span class="p">))</span>

    <span class="c1"># Previous structure from IRIS module</span>
    <span class="c1">#_h = {  2: (_h1 + _h2) / 2.0, # Arithmetic mean</span>
    <span class="c1">#        3: math.sqrt(_h1 * _h2), # Geometric mean</span>
    <span class="c1">#        4: math.sqrt(_p1 + _p2), # Vector summation</span>
    <span class="c1">#        5: math.sqrt((_p1 + _p2) / 2.0), # Quadratic mean</span>
    <span class="c1">#        6: max(_h1, _h2), # Max horizontal value</span>
    <span class="c1">#        7: min(_h1, _h2), # Minimum horizontal value</span>
    <span class="c1">#        8: &#39;do_azimuth_calc&#39;,</span>
    <span class="c1">#        &#39;az&#39;: _h1} # If azimuth, horizontals are already combined, no _h2} </span>
    
    <span class="c1"># Combine horizontal methods</span>
    <span class="k">if</span> <span class="n">use_method</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_method</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;2&#39;</span><span class="p">:</span>
        <span class="n">_hCombined</span> <span class="o">=</span> <span class="p">(</span><span class="n">_h1</span> <span class="o">+</span> <span class="n">_h2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="k">elif</span> <span class="n">use_method</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_method</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
        <span class="n">_hCombined</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_h1</span> <span class="o">*</span> <span class="n">_h2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use_method</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_method</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;4&#39;</span><span class="p">:</span>
        <span class="n">_hCombined</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_p1</span> <span class="o">+</span> <span class="n">_p2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use_method</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_method</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;5&#39;</span><span class="p">:</span>
        <span class="n">_hCombined</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">_p1</span> <span class="o">+</span> <span class="n">_p2</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use_method</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_method</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;6&#39;</span><span class="p">:</span>
        <span class="n">_hCombined</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">_h1</span><span class="p">,</span> <span class="n">_h2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use_method</span> <span class="o">==</span> <span class="mi">7</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_method</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;7&#39;</span><span class="p">:</span>
        <span class="n">_hCombined</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">_h1</span><span class="p">,</span> <span class="n">_h2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use_method</span> <span class="o">==</span> <span class="mi">8</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_method</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;8&#39;</span><span class="p">:</span>
        <span class="n">_hCombined</span> <span class="o">=</span> <span class="n">az_calc</span><span class="p">(</span><span class="n">azimuth</span><span class="p">,</span> <span class="n">_h1</span><span class="p">,</span> <span class="n">_h2</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use_method</span> <span class="o">==</span> <span class="s1">&#39;az&#39;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_method</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;az&#39;</span><span class="p">:</span>
        <span class="n">_hCombined</span> <span class="o">=</span> <span class="n">_h1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_hCombined</span> <span class="o">=</span> <span class="n">_h1</span>
    
    <span class="n">_hvsr</span> <span class="o">=</span> <span class="n">_hCombined</span> <span class="o">/</span> <span class="n">_hz</span>
    <span class="k">return</span> <span class="n">_hvsr</span>


<span class="c1"># For converting dB scaled data to power units</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__get_power</span><span class="p">(</span><span class="n">_db</span><span class="p">,</span> <span class="n">_x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate power for HVSR</span>

<span class="sd">    #FROM ORIGINAL (I think this is only step 6)</span>
<span class="sd">        Undo deciBel calculations as outlined below:</span>
<span class="sd">            1. Dividing the window into 13 segments having 75% overlap</span>
<span class="sd">            2. For each segment:</span>
<span class="sd">                2.1 Removing the trend and mean</span>
<span class="sd">                2.2 Apply a 10% sine taper</span>
<span class="sd">                2.3 FFT</span>
<span class="sd">            3. Calculate the normalized PSD</span>
<span class="sd">            4. Average the 13 PSDs &amp; scale to compensate for tapering</span>
<span class="sd">            5. Frequency-smooth the averaged PSD over 1-octave intervals at 1/8-octave increments</span>
<span class="sd">            6. Convert power to decibels</span>
<span class="sd">    #END FROM ORIGINAL</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _db : list</span>
<span class="sd">        Two-item list with individual power values in decibels for specified freq step.</span>
<span class="sd">    _x : list</span>
<span class="sd">        Two-item list with Individual x value (either frequency or period)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _p : float</span>
<span class="sd">        Individual power value, converted from decibels</span>

<span class="sd">    NOTE</span>
<span class="sd">    ----</span>
<span class="sd">        PSD is equal to the power divided by the width of the bin</span>
<span class="sd">          PSD = P / W</span>
<span class="sd">          log(PSD) = Log(P) - log(W)</span>
<span class="sd">          log(P) = log(PSD) + log(W)  here W is width in frequency</span>
<span class="sd">          log(P) = log(PSD) - log(Wt) here Wt is width in period</span>

<span class="sd">    for each bin perform rectangular integration to compute power</span>
<span class="sd">    power is assigned to the point at the begining of the interval</span>
<span class="sd">         _   _</span>
<span class="sd">        | |_| |</span>
<span class="sd">        |_|_|_|</span>

<span class="sd">     Here we are computing power for individual ponts, so, no integration is necessary, just</span>
<span class="sd">     compute area.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_dx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">_x</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">__remove_db</span><span class="p">(</span><span class="n">_db</span><span class="p">)),</span> <span class="n">_dx</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_p</span>


<span class="c1"># Remove decibel scaling</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__remove_db</span><span class="p">(</span><span class="n">_db_value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;convert dB power to power&quot;&quot;&quot;</span>
    <span class="n">_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_d</span> <span class="ow">in</span> <span class="n">_db_value</span><span class="p">:</span>
        <span class="n">_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_d</span><span class="p">)</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">))</span>
    <span class="c1">#FIX THIS</span>
    <span class="k">if</span> <span class="n">_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
       <span class="n">_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mf">10e-300</span>
    <span class="k">return</span> <span class="n">_values</span>


<span class="c1"># Find peaks in the hvsr ccruve</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__find_peaks</span><span class="p">(</span><span class="n">_y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finds all possible peaks on hvsr curves</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _y : list or array</span>
<span class="sd">        _y input is list or array of a curve.</span>
<span class="sd">          In this case, this is either main hvsr curve or individual time step curves</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_index_list</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">argrelextrema</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">greater</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_index_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="c1"># Get additional HVSR params for later calcualtions</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__gethvsrparams</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Private function to get HVSR parameters for later calculations (things like standard deviation, etc)&quot;&quot;&quot;</span>

    <span class="n">hvsrp2</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">hvsrm2</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="n">hvsrp2</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">hvsrm</span><span class="o">=</span><span class="p">[]</span>
    
    <span class="n">hvsr_log_std</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">hvsr</span> <span class="o">=</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">]</span>
    <span class="n">hvsr_az</span> <span class="o">=</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_az&#39;</span><span class="p">]</span>
    <span class="n">hvsrDF</span> <span class="o">=</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_curves&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># With arrays, original way of doing it</span>
        <span class="n">hvsr_log_std</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_curves&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">hvsr_log_std</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_curves&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#With dataframe, updated way to use DF for all time-step tasks, still testing</span>
        <span class="n">logStackedata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">hvsrp</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">hvsrm</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">hvsrp2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">hvsrm2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">hvsr_log_std</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HV_Curves&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">col_name</span> <span class="o">==</span> <span class="s1">&#39;HV_Curves&#39;</span><span class="p">:</span>
                    <span class="n">colSuffix</span> <span class="o">=</span> <span class="s1">&#39;_HV&#39;</span>
                    <span class="n">colID</span> <span class="o">=</span> <span class="s1">&#39;HV&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">colSuffix</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:])</span>
                    <span class="n">colID</span> <span class="o">=</span> <span class="n">colSuffix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">stackedData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="n">col_name</span><span class="p">])</span>

                <span class="n">logStackedata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">stackedData</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">logStackedata</span><span class="p">):</span>
                    <span class="n">logStackedata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

                <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;Log10_HV_Curves&#39;</span><span class="o">+</span><span class="n">colSuffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">logStackedata</span>
                <span class="n">hvsr_log_std</span><span class="p">[</span><span class="n">colID</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;Log10_HV_Curves&#39;</span><span class="o">+</span><span class="n">colSuffix</span><span class="p">][</span><span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                <span class="c1">#The components are already calculated, don&#39;t need to recalculate aren&#39;t calculated at the time-step level</span>
                <span class="n">hvsrp</span><span class="p">[</span><span class="n">colID</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">],</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_stdDev&#39;</span><span class="p">][</span><span class="n">colID</span><span class="p">])</span>
                <span class="n">hvsrm</span><span class="p">[</span><span class="n">colID</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">],</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_stdDev&#39;</span><span class="p">][</span><span class="n">colID</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_az&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">hvsrp</span><span class="p">[</span><span class="n">colID</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_az&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_stdDev&#39;</span><span class="p">][</span><span class="n">colID</span><span class="p">])</span>
                    <span class="n">hvsrm</span><span class="p">[</span><span class="n">colID</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;hvsr_az&#39;</span><span class="p">][</span><span class="n">k</span><span class="p">],</span> <span class="n">hvsr_out</span><span class="p">[</span><span class="s1">&#39;ind_hvsr_stdDev&#39;</span><span class="p">][</span><span class="n">colID</span><span class="p">])</span>
                <span class="n">hvsrp2</span><span class="p">[</span><span class="n">colID</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">hvsr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">hvsr_log_std</span><span class="p">[</span><span class="n">colID</span><span class="p">]))</span>
                <span class="n">hvsrm2</span><span class="p">[</span><span class="n">colID</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">hvsr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">hvsr_log_std</span><span class="p">[</span><span class="n">colID</span><span class="p">]))</span>

                <span class="n">newKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hvsr_log_std&#39;</span><span class="p">,</span> <span class="s1">&#39;hvsrp&#39;</span><span class="p">,</span><span class="s1">&#39;hvsrm&#39;</span><span class="p">,</span> <span class="s1">&#39;hvsrp2&#39;</span><span class="p">,</span><span class="s1">&#39;hvsrm2&#39;</span><span class="p">]</span>
                <span class="n">newVals</span> <span class="o">=</span> <span class="p">[</span><span class="n">hvsr_log_std</span><span class="p">,</span>    <span class="n">hvsrp</span><span class="p">,</span>  <span class="n">hvsrm</span><span class="p">,</span>   <span class="n">hvsrp2</span><span class="p">,</span>  <span class="n">hvsrm2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">nk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newKeys</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">nk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hvsr_out</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">hvsr_out</span><span class="p">[</span><span class="n">nk</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">hvsr_out</span><span class="p">[</span><span class="n">nk</span><span class="p">][</span><span class="n">colID</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newVals</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">colID</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">hvsr_out</span>


<span class="c1"># HELPER FUNCTIONS FOR GET REPORT</span>
<span class="c1"># Private function to generate print report</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_generate_print_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="s2">&quot;HV&quot;</span><span class="p">,</span> <span class="n">show_print_report</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function to perform create a printed (monospace) report with summary data for HVSR Site </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_results : HVSRData object</span>
<span class="sd">        HVSRData object with data to be reported on</span>
<span class="sd">    show_print_report : bool, optional</span>
<span class="sd">        Whether output will be produced or not (if show_print_report=True, no ouptut will be produced (report will not be printed)), by default False</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    HVSRData object</span>
<span class="sd">        HVSRData object with the [&quot;Print_Report&quot;] attribute created or updated.</span>
<span class="sd">        The .Print_Report attribute is a formatted string that can be </span>
<span class="sd">        displayed using print(hvsr_results[&#39;Print_Report&#39;] with a summary of the HVSR results)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Print results</span>

    <span class="c1">#Make separators for nicely formatted print output</span>
    <span class="n">sepLen</span> <span class="o">=</span> <span class="mi">99</span>
    <span class="n">siteSepSymbol</span> <span class="o">=</span> <span class="s1">&#39;=&#39;</span>
    <span class="n">intSepSymbol</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\u2012</span><span class="s2">&quot;</span>
    <span class="n">extSepSymbol</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\u2014</span><span class="s2">&quot;</span>
    
    <span class="k">if</span> <span class="n">sepLen</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">remainVal</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">remainVal</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">siteWhitespace</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="c1">#Format the separator lines internal to each site</span>
    <span class="n">internalSeparator</span> <span class="o">=</span> <span class="n">intSepSymbol</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">sepLen</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="n">intSepSymbol</span><span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">sepLen</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="n">extSiteSeparator</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">sepLen</span><span class="p">,</span> <span class="n">extSepSymbol</span><span class="p">)</span>
    <span class="n">siteSeparator</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">sepLen</span> <span class="o">-</span> <span class="n">siteWhitespace</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">sepLen</span><span class="p">,</span> <span class="n">siteSepSymbol</span><span class="p">)</span>
    <span class="n">endSiteSeparator</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="n">sepLen</span><span class="p">,</span> <span class="n">siteSepSymbol</span><span class="p">)</span>

    <span class="c1">#Start building list to print</span>
    <span class="n">report_string_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="c1">#Blank line to start</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extSiteSeparator</span><span class="p">)</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">siteSeparator</span><span class="p">)</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extSiteSeparator</span><span class="p">)</span>
    <span class="c1">#report_string_list.append(internalSeparator)</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Site Name: </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Acq. Date: </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;acq_date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Location : </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">°, </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">°&quot;</span><span class="p">)</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Elevation: </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> meters&quot;</span><span class="p">)</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">internalSeparator</span><span class="p">)</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;BestPeak&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hvsr_results</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">No identifiable BestPeak was present between </span><span class="si">{}</span><span class="s1"> for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">],</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">curvTestsPassed</span> <span class="o">=</span> <span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;WinLen&#39;</span><span class="p">]</span> <span class="o">+</span>
                            <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;SigCycles&#39;</span><span class="p">]</span><span class="o">+</span>
                            <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowCurveStD&#39;</span><span class="p">])</span>
        <span class="n">curvePass</span> <span class="o">=</span> <span class="n">curvTestsPassed</span> <span class="o">&gt;</span> <span class="mi">2</span>
        
        <span class="c1">#Peak Pass?</span>
        <span class="n">peakTestsPassed</span> <span class="o">=</span> <span class="p">(</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;ProminenceLow&#39;</span><span class="p">]</span> <span class="o">+</span>
                    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;ProminenceHi&#39;</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;AmpClarity&#39;</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;FreqStability&#39;</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span><span class="o">+</span>
                    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">])</span>
        <span class="n">peakPass</span> <span class="o">=</span> <span class="n">peakTestsPassed</span> <span class="o">&gt;=</span> <span class="mi">5</span>

        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{0:.3f}</span><span class="s1"> Hz Peak Frequency ± </span><span class="si">{1:.4f}</span><span class="s1"> Hz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s2">&quot;BestPeak&quot;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">])))</span>        
        <span class="k">if</span> <span class="n">curvePass</span> <span class="ow">and</span> <span class="n">peakPass</span><span class="p">:</span>
            <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1"> Peak at </span><span class="si">{}</span><span class="s1"> Hz passed quality checks! :D&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">(),</span> <span class="nb">round</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span><span class="mi">3</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">  </span><span class="si">{}</span><span class="s1"> Peak at </span><span class="si">{}</span><span class="s1"> Hz did NOT pass quality checks :(&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">(),</span> <span class="nb">round</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span><span class="mi">3</span><span class="p">)))</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">internalSeparator</span><span class="p">)</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

        <span class="n">justSize</span><span class="o">=</span><span class="mi">34</span>
        <span class="c1">#Print individual results</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Curve Tests: </span><span class="si">{}</span><span class="s1">/3 passed (3/3 needed)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">curvTestsPassed</span><span class="p">))</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Lw&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot; Length of processing windows&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">justSize</span><span class="p">)</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Lw&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Nc&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot; Number of significant cycles&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">justSize</span><span class="p">)</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Nc&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;σ_A(f)&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot; Small H/V StDev over time&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">justSize</span><span class="p">)</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;σ_A(f)&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Peak Tests: </span><span class="si">{}</span><span class="s2">/6 passed (5/6 needed)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peakTestsPassed</span><span class="p">))</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f-)&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot; Peak is prominent below&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">justSize</span><span class="p">)</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f-)&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f+)&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot; Peak is prominent above&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">justSize</span><span class="p">)</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f+)&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot; Peak is large&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">justSize</span><span class="p">)</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;FreqStability&#39;</span><span class="p">]:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span> <span class="s2">&quot; Peak freq. is stable over time&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">justSize</span><span class="p">)</span><span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P-&#39;</span><span class="p">][:</span><span class="mi">5</span><span class="p">]</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot; Stability of peak (Freq. StDev)&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">justSize</span><span class="p">)</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2"> </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s2">&quot; Stability of peak (Amp. StDev)&quot;</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">justSize</span><span class="p">)</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculated using </span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">][</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="si">}</span><span class="s2"> time windows&quot;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="n">sepLen</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">extSiteSeparator</span><span class="p">)</span>
    <span class="c1">#report_string_list.append(endSiteSeparator)</span>
    <span class="c1">#report_string_list.append(extSiteSeparator)</span>
    <span class="n">report_string_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    
    <span class="n">reportStr</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="c1">#Now print it</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">report_string_list</span><span class="p">:</span>
        <span class="n">reportStr</span> <span class="o">=</span> <span class="n">reportStr</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">line</span>

    <span class="k">if</span> <span class="n">show_print_report</span> <span class="ow">or</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">reportStr</span><span class="p">)</span>

    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Print_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reportStr</span>
    <span class="k">if</span> <span class="n">azimuth</span><span class="o">==</span><span class="s1">&#39;HV&#39;</span> <span class="ow">or</span> <span class="n">azimuth</span><span class="o">==</span><span class="s1">&#39;R&#39;</span><span class="p">:</span>
        <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;Print_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reportStr</span>
    <span class="k">return</span> <span class="n">hvsr_results</span>


<span class="c1"># Private function to generate table report</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_generate_table_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="s1">&#39;HV&#39;</span><span class="p">,</span> <span class="n">show_table_report</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Helper function for get_report() to generate a site report formatted into a pandas dataframe </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_results : HVSRData</span>
<span class="sd">        HVSRData object containing information about which the report will be generated.</span>
<span class="sd">    azimuth : str, optional</span>
<span class="sd">        The azimuth for which this report will be generated. If none specified/calculated, by default &#39;HV&#39;</span>
<span class="sd">    show_table_report : bool, optional</span>
<span class="sd">        Whether to print the table report (as text) to the terminal</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Whether or not to print information about the table report generation (including the pandas dataframe upon creation) to the terminal, by default False</span>


<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    HVSRData</span>
<span class="sd">        An HVSRData object with the [&quot;Table_Report&quot;] attribute created/updated. </span>
<span class="sd">        This is a pandas.DataFrame instance, but can be exported to csv.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">coord0Dir</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;output_crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">direction</span>

    <span class="c1"># Figure out which coordinate axis is which (some CRS do Y, X)</span>
    <span class="k">if</span> <span class="n">coord0Dir</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">,</span> <span class="s1">&#39;south&#39;</span><span class="p">]:</span>
        <span class="n">xaxisinfo</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;output_crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">yaxisinfo</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;output_crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xaxisinfo</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;output_crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yaxisinfo</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;output_crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># Get the axis name</span>
    <span class="n">xaxis_name</span> <span class="o">=</span> <span class="n">xaxisinfo</span><span class="o">.</span><span class="n">name</span>
    <span class="n">yaxis_name</span> <span class="o">=</span> <span class="n">yaxisinfo</span><span class="o">.</span><span class="n">name</span>
    
    <span class="c1"># Simplify the axis name</span>
    <span class="k">if</span> <span class="s1">&#39;longitude&#39;</span> <span class="ow">in</span> <span class="n">xaxis_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">xaxis_name</span> <span class="o">=</span> <span class="s1">&#39;Longitude&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;latitude&#39;</span> <span class="ow">in</span> <span class="n">yaxis_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">yaxis_name</span> <span class="o">=</span> <span class="s1">&#39;Latitude&#39;</span>
        
    <span class="n">pdCols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Site Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Acq_Date&#39;</span><span class="p">,</span> <span class="n">xaxis_name</span><span class="p">,</span> <span class="n">yaxis_name</span><span class="p">,</span> <span class="s1">&#39;Elevation&#39;</span><span class="p">,</span> <span class="s1">&#39;Peak&#39;</span><span class="p">,</span> <span class="s1">&#39;Peak_StDev&#39;</span><span class="p">,</span>
            <span class="s1">&#39;PeakPasses&#39;</span><span class="p">,</span><span class="s1">&#39;WinLen&#39;</span><span class="p">,</span><span class="s1">&#39;SigCycles&#39;</span><span class="p">,</span><span class="s1">&#39;LowCurveStD&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ProminenceLow&#39;</span><span class="p">,</span><span class="s1">&#39;ProminenceHi&#39;</span><span class="p">,</span><span class="s1">&#39;AmpClarity&#39;</span><span class="p">,</span><span class="s1">&#39;FreqStability&#39;</span><span class="p">,</span> <span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">,</span><span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">hvsr_results</span>
    <span class="n">criteriaList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">criteriaList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s2">&quot;PeakPasses&quot;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s2">&quot;PassList&quot;</span><span class="p">]:</span>
        <span class="n">criteriaList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s2">&quot;PassList&quot;</span><span class="p">][</span><span class="n">p</span><span class="p">])</span>
    <span class="n">dfList</span> <span class="o">=</span> <span class="p">[[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;acq_date&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;xcoord&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;ycoord&#39;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;elevation&#39;</span><span class="p">],</span> <span class="nb">round</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">],</span> <span class="mi">4</span><span class="p">)]]</span>
    <span class="n">dfList</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">criteriaList</span><span class="p">)</span>

    <span class="n">outDF</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">dfList</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">pdCols</span><span class="p">)</span>
    <span class="n">outDF</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;ID&#39;</span>
    
    <span class="k">if</span> <span class="n">show_table_report</span> <span class="ow">or</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Table Report:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">maxColWidth</span> <span class="o">=</span> <span class="mi">13</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">outDF</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">maxColWidth</span><span class="p">:</span>
                <span class="n">colStr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)[:</span><span class="n">maxColWidth</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;...&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colStr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">colStr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">maxColWidth</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span> <span class="c1">#new line</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">outDF</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxColWidth</span><span class="o">+</span><span class="mi">2</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">%</span> <span class="p">(</span><span class="n">maxColWidth</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span> <span class="c1">#new line</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1">#Small indent at start                    </span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">outDF</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">maxColWidth</span><span class="p">:</span>
                    <span class="n">colStr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)[:</span><span class="n">maxColWidth</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;...&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">colStr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">colStr</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">maxColWidth</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;  &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span>

    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Table_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outDF</span>
    <span class="k">if</span> <span class="n">azimuth</span> <span class="o">==</span> <span class="s1">&#39;HV&#39;</span> <span class="ow">or</span> <span class="n">azimuth</span> <span class="o">==</span> <span class="s1">&#39;R&#39;</span><span class="p">:</span>
        <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;Table_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outDF</span>
    <span class="k">return</span> <span class="n">hvsr_results</span>


<span class="c1"># Display html report without creating temporary file</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_display_html_report</span><span class="p">(</span><span class="n">html_report</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">platform</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">webbrowser</span>

    <span class="n">autodelete</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;Windows&quot;</span>

    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="n">autodelete</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.html&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tmp_file</span><span class="p">:</span>
        <span class="n">tmp_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">html_report</span><span class="p">)</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">tmp_file</span><span class="o">.</span><span class="n">name</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
        <span class="n">rawfpath</span> <span class="o">=</span> <span class="n">file_path</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">rawfpath</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">autodelete</span><span class="p">:</span>
            <span class="n">client</span> <span class="o">=</span> <span class="n">webbrowser</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;file:///&quot;</span><span class="p">):</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;file:///</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">client</span><span class="o">.</span><span class="n">open_new</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>                
            <span class="c1"># Adding a short sleep so that the file does not get cleaned</span>
            <span class="c1"># up immediately in case the browser takes a while to boot.</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">autodelete</span><span class="p">:</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">webbrowser</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;file:///&quot;</span><span class="p">):</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;file:///</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">client</span><span class="o">.</span><span class="n">open_new</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">rawfpath</span><span class="p">)</span>  <span class="c1"># Cleaning up the file in case of Windows</span>


<span class="c1"># Private function for html report generation</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_generate_html_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="s1">&#39;HV&#39;</span><span class="p">,</span> <span class="n">show_html_report</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Private function that generates html report, intented to be used by get_report() public function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_results : HVSRData or HVSRBatch</span>
<span class="sd">        Input data from which to generate report</span>
<span class="sd">    show_html_report : bool, optional</span>
<span class="sd">        Whether to show the report or simply generate and save it in the &quot;HTML_Report&quot; attribute of hvsr_results, by default False</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Whether to print information about the HTML report generation to terminal</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    HVSRData or HVSRBatch</span>
<span class="sd">        Returns the input dataset, with the HTML_Report attribute updated with the html text of the report</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">htmlTemplatePath</span> <span class="o">=</span> <span class="n">RESOURCE_DIR</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;html_report_template.html&#39;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">htmlTemplatePath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">htmlF</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">htmlF</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="c1"># Update report title (site name)</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;HVSR_REPORT_TITLE&quot;</span><span class="p">,</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">])</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;HVSR_ID&quot;</span><span class="p">,</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;hvsr_id&#39;</span><span class="p">])</span>

    <span class="c1"># Update peak freq info</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;PEAKFREQ&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)))</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;PEAKSTDEV&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">hvsr_results</span><span class="o">.</span><span class="n">Table_Report</span><span class="p">[</span><span class="s1">&#39;PeakPasses&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SESAME_TESTS_RESULTS&quot;</span><span class="p">,</span> <span class="s1">&#39;Peak has passed the SESAME validation tests.&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;SESAME_TESTS_RESULTS&quot;</span><span class="p">,</span> <span class="s1">&#39;Peak did not pass the SESAME validation tests.&#39;</span><span class="p">)</span>

    <span class="c1"># Update image source</span>
    <span class="c1"># Save the plot to a BytesIO object</span>
    <span class="c1"># Default to matplotlib object</span>
    <span class="n">plotEngine</span> <span class="o">=</span> <span class="s1">&#39;matplotlib&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;get_report&#39;</span> <span class="ow">in</span> <span class="n">hvsr_results</span><span class="o">.</span><span class="n">processing_parameters</span><span class="p">:</span>
        <span class="n">plotEngine</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="o">.</span><span class="n">processing_parameters</span><span class="p">[</span><span class="s1">&#39;get_report&#39;</span><span class="p">][</span><span class="s1">&#39;plot_engine&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">plotEngine</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;plotly&#39;</span><span class="p">,</span> <span class="s1">&#39;plty&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">]:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;Plot_Report&#39;</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mf">8.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
        <span class="c1">#fig.set_size_inches(4.25, 3)</span>
        <span class="c1"># Create a byte stream from the image</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>
        <span class="n">buf</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Encode the image to base64</span>
        <span class="n">hvplot_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="c1"># Embed the image in the html document</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;./output.png&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;data:image/png;base64,</span><span class="si">{</span><span class="n">hvplot_base64</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#htmlstring = plotly.io.to_html(hvsr_results.Plot_Report, include_plotlyjs=False)</span>
        <span class="c1">#print(type(htmlstring))</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="o">.</span><span class="n">Plot_Report</span><span class="o">.</span><span class="n">to_image</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;kaleido&#39;</span><span class="p">)</span>
        <span class="n">hvplot_base64</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

        <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;./output.png&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;data:image/png;base64,</span><span class="si">{</span><span class="n">hvplot_base64</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># Update formatting for print report for html</span>
    <span class="n">html_print_report</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="o">.</span><span class="n">Print_Report</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;br&gt;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span><span class="p">)</span>
    <span class="n">html_print_report</span> <span class="o">=</span> <span class="n">html_print_report</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&lt;br&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">#Remove the first two breaks</span>
    <span class="n">html_print_report</span> <span class="o">=</span> <span class="n">html_print_report</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;✔&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;#10004;&#39;</span><span class="p">)</span>
    <span class="n">html_print_report</span> <span class="o">=</span> <span class="n">html_print_report</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;✘&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;cross;&#39;</span><span class="p">)</span>

    <span class="n">majorSepLine</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\u2014</span><span class="s2">&quot;</span><span class="o">*</span><span class="mi">99</span>
    <span class="n">majorSepLine</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\u2014</span><span class="s2">&quot;</span><span class="o">*</span><span class="mi">99</span>
    <span class="n">minorSepLine</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;</span><span class="se">\u2012</span><span class="s2">&quot;</span><span class="o">*</span><span class="mi">95</span>
    <span class="n">majorSepLineHTML</span> <span class="o">=</span> <span class="s1">&#39;&amp;mdash;&#39;</span><span class="o">*</span><span class="mi">40</span>
    <span class="n">minorSepLineHTML</span> <span class="o">=</span> <span class="s1">&#39;&amp;mdash;&amp;nbsp;&#39;</span><span class="o">*</span><span class="mi">25</span>

    <span class="n">startInd</span> <span class="o">=</span> <span class="n">html_print_report</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;Site Name:&#39;</span><span class="p">)</span>
    <span class="n">html_print_report</span> <span class="o">=</span> <span class="s2">&quot;&lt;br&gt;&lt;br&gt;&quot;</span> <span class="o">+</span> <span class="n">html_print_report</span><span class="p">[</span><span class="n">startInd</span><span class="p">:]</span>
    <span class="n">lastInd</span> <span class="o">=</span> <span class="n">html_print_report</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">majorSepLine</span><span class="p">)</span>
    <span class="n">html_print_report</span> <span class="o">=</span> <span class="n">html_print_report</span><span class="p">[:</span><span class="n">lastInd</span><span class="p">]</span>
    
    <span class="n">html_print_report</span> <span class="o">=</span> <span class="n">html_print_report</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">majorSepLine</span><span class="p">,</span> <span class="s1">&#39;majorSepLineHTML&#39;</span><span class="p">)</span> <span class="c1"># Replace the major separator lines</span>
    <span class="n">html_print_report</span> <span class="o">=</span> <span class="n">html_print_report</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">minorSepLine</span><span class="p">,</span> <span class="n">minorSepLineHTML</span><span class="p">)</span> <span class="c1"># Replace the minor separator lines</span>
    <span class="n">html_print_report</span> <span class="o">=</span> <span class="n">html_print_report</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1"># Get rid of =</span>

    <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;HVSR_PRINT_REPORT&#39;</span><span class="p">,</span> <span class="n">html_print_report</span><span class="p">)</span>

    <span class="c1"># Update table</span>
    <span class="n">htmlTable</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="o">.</span><span class="n">Table_Report</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">htmlTable</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
        <span class="n">tableHeader</span> <span class="o">=</span> <span class="n">htmlTable</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1">#html = html.replace(f&quot;TableHeader_{str(i).zfill(2)}&quot;, tableHeader)</span>
        
        <span class="n">tableValue</span> <span class="o">=</span> <span class="n">htmlTable</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TableData_</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">tableValue</span><span class="p">))</span>

    <span class="n">coord0Dir</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;output_crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">direction</span>

    <span class="c1"># Figure out which coordinate axis is which (some CRS do Y, X)</span>
    <span class="k">if</span> <span class="n">coord0Dir</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;north&#39;</span><span class="p">,</span> <span class="s1">&#39;south&#39;</span><span class="p">]:</span>
        <span class="n">xaxisinfo</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;output_crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">yaxisinfo</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;output_crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xaxisinfo</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;output_crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">yaxisinfo</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;output_crs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">axis_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Get the axis name</span>
    <span class="n">xaxis_name</span> <span class="o">=</span> <span class="n">xaxisinfo</span><span class="o">.</span><span class="n">name</span>
    <span class="n">yaxis_name</span> <span class="o">=</span> <span class="n">yaxisinfo</span><span class="o">.</span><span class="n">name</span>
    
    <span class="c1"># Simplify the axis name</span>
    <span class="k">if</span> <span class="s1">&#39;longitude&#39;</span> <span class="ow">in</span> <span class="n">xaxis_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">xaxis_name</span> <span class="o">=</span> <span class="s1">&#39;Longitude&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;latitude&#39;</span> <span class="ow">in</span> <span class="n">yaxis_name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="n">yaxis_name</span> <span class="o">=</span> <span class="s1">&#39;Latitude&#39;</span>
        
    
    <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;X_Coordinate&quot;</span><span class="p">,</span> <span class="n">xaxis_name</span><span class="p">)</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Y_Coordinate&quot;</span><span class="p">,</span> <span class="n">yaxis_name</span><span class="p">)</span>

    <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Deg_E&quot;</span><span class="p">,</span> <span class="n">xaxisinfo</span><span class="o">.</span><span class="n">unit_name</span><span class="p">)</span>
    <span class="n">html</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Deg_N&quot;</span><span class="p">,</span> <span class="n">yaxisinfo</span><span class="o">.</span><span class="n">unit_name</span><span class="p">)</span>

    <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;HTML_Report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">html</span>
    <span class="c1"># View in browser, if indicated to</span>
    <span class="k">if</span> <span class="n">show_html_report</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_display_html_report</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">HTML Report could not be displayed, but has been saved to the .HTML_Report attribute&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">hvsr_results</span>


<span class="c1"># Private/Helper function to generate pdf report</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_generate_pdf_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">pdf_report_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">show_pdf_report</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_html_report</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_pdf_path</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Private/helper function to generate pdf report from HTML report, intended to be used by get_report() function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_results : HVSRData or HVSRBatch</span>
<span class="sd">        Input dataset with all processing already carried out</span>
<span class="sd">    show_pdf_report : bool, optional</span>
<span class="sd">        EXPERIMENTAL: Whether to open the report after generating it, by default False</span>
<span class="sd">    show_html_report : bool, optional</span>
<span class="sd">        Whether to open the html report that the pdf report is based on, by default False</span>
<span class="sd">    verbose : bool, optional</span>
<span class="sd">        Whether to print verbose description of what the function is doing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">xhtml2pdf</span><span class="w"> </span><span class="kn">import</span> <span class="n">pisa</span>

    <span class="c1"># Generate HTML Report if not already (this will be converted to pdf using xhtml2pdf)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="s2">&quot;HTML_Report&quot;</span><span class="p">):</span>
        <span class="n">hvsr_results</span> <span class="o">=</span> <span class="n">_generate_html_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">,</span> <span class="n">show_html_report</span><span class="o">=</span><span class="n">show_html_report</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">No HTML Report previously generated, attempting now.&#39;</span><span class="p">)</span>
        <span class="c1"># try Code to generate HTML report from template</span>

    <span class="n">htmlReport</span> <span class="o">=</span> <span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;HTML_Report&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">pdf_report_filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1"> pdf_report_filepath not specified, saving to temporary file.&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.pdf&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
            <span class="n">pdf_export_path</span> <span class="o">=</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># Get the name of the temporary file</span>

        <span class="c1"># Now, open the file again for writing</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdf_export_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
            <span class="n">pisa_status</span> <span class="o">=</span> <span class="n">pisa</span><span class="o">.</span><span class="n">CreatePDF</span><span class="p">(</span><span class="n">htmlReport</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">temp_file</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">pdf_report_filepath</span><span class="p">)</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;site&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_REPORT_</span><span class="si">{</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;hvsr_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="si">}</span><span class="s2">.pdf&quot;</span>
            <span class="n">pdf_report_filepath</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">pdf_report_filepath</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>        
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdf_report_filepath</span><span class="p">,</span> <span class="s2">&quot;w+b&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">export_file</span><span class="p">:</span>
                <span class="n">pisa_status</span> <span class="o">=</span> <span class="n">pisa</span><span class="o">.</span><span class="n">CreatePDF</span><span class="p">(</span><span class="n">htmlReport</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">export_file</span><span class="p">)</span>
            <span class="n">pdf_export_path</span> <span class="o">=</span> <span class="n">pdf_report_filepath</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PDF report saved to </span><span class="si">{</span><span class="n">pdf_export_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;PDF could not be saved to </span><span class="si">{</span><span class="n">pdf_report_filepath</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.pdf&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
                <span class="n">pdf_export_path</span> <span class="o">=</span> <span class="n">temp_file</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># Get the name of the temporary file</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Saving pdf to temporary file instead: </span><span class="si">{</span><span class="n">temp_file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># Now, open the file again for writing</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">pdf_export_path</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_file</span><span class="p">:</span>
                <span class="n">pisa_status</span> <span class="o">=</span> <span class="n">pisa</span><span class="o">.</span><span class="n">CreatePDF</span><span class="p">(</span><span class="n">htmlReport</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="n">temp_file</span><span class="p">)</span>

        
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">pisa_status</span><span class="o">.</span><span class="n">err</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">pisa_status</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_html_report</span><span class="p">:</span>
        <span class="n">_display_html_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;HTML_Report&#39;</span><span class="p">])</span>
        
    <span class="k">if</span> <span class="n">show_pdf_report</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Attempting to open pdf at </span><span class="si">{</span><span class="n">pdf_export_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">pdf_report_shown</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">&#39;startfile&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">startfile</span><span class="p">(</span><span class="n">pdf_export_path</span><span class="p">)</span>
                <span class="n">pdf_report_shown</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Error opening pdf report: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pdf_report_shown</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">webbrowser</span>
                <span class="n">webbrowser</span><span class="o">.</span><span class="n">open_new</span><span class="p">(</span><span class="n">pdf_export_path</span><span class="p">)</span>
                <span class="n">pdf_report_shown</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Opening pdf via webbrowser did not work, Error opening pdf report: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pdf_report_shown</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Attempting os.open()&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">pdf_export_path</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">O_RDWR</span><span class="p">)</span>
                <span class="n">pdf_report_shown</span> <span class="o">=</span> <span class="kc">True</span>            
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Error opening pdf report: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pdf_report_shown</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Attempting os.system&quot;</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">pdf_export_path</span><span class="p">)</span>
                <span class="n">pdf_report_shown</span> <span class="o">=</span> <span class="kc">True</span>                
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Error opening pdf report: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pdf_report_shown</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">SpRIT cannot open your pdf report, but it has been saved to </span><span class="si">{</span><span class="n">pdf_export_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Attempting to open HTML version of report&#39;</span><span class="p">)</span>
        
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Opening via pdf did not work, opening HTML&#39;</span><span class="p">)</span>
                <span class="n">_display_html_report</span><span class="p">(</span><span class="n">hvsr_results</span><span class="p">[</span><span class="s1">&#39;HTML_Report&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">HTML Report could not be displayed, but has been saved to the .HTML_Report attribute&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_pdf_path</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pdf_export_path</span>

    <span class="k">return</span> <span class="n">hvsr_results</span>


<span class="c1"># Plot hvsr curve, private supporting function for plot_hvsr</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_plot_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">plot_type</span><span class="p">,</span> <span class="n">xtype</span><span class="o">=</span><span class="s1">&#39;frequency&#39;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="s1">&#39;HV&#39;</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">show_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Private function for plotting hvsr curve (or curves with components)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Get kwargs all straightened out</span>
    <span class="k">if</span> <span class="s1">&#39;kwargs&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="k">if</span> <span class="s1">&#39;xlim&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xlim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;xlim&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="s1">&#39;ylim&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">plotymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsrp2</span><span class="p">[</span><span class="s1">&#39;HV&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsrp2</span><span class="p">[</span><span class="s1">&#39;HV&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_curve</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">plotymax</span> <span class="o">&gt;</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">BestPeak</span><span class="p">[</span><span class="s1">&#39;HV&#39;</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">:</span>
            <span class="n">plotymax</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">BestPeak</span><span class="p">[</span><span class="s1">&#39;HV&#39;</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.5</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">plotymax</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ylim&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="s1">&#39;grid&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

    <span class="c1"># Get x y data (for main hvsr plot esp.)</span>
    <span class="n">hvsrDF</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_windows_df</span>

    <span class="n">freqList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">,</span> <span class="s1">&#39;freqs&#39;</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="s1">&#39;hz&#39;</span><span class="p">,</span> <span class="s1">&#39;f&#39;</span><span class="p">,</span> <span class="s1">&#39;frequency&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">xtype</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">freqList</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Frequency [Hz]&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xlabel</span> <span class="o">=</span> <span class="s1">&#39;Period [s]&#39;</span>

    <span class="k">if</span> <span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">anyKey</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="n">xtype</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="n">xtype</span><span class="p">][</span><span class="n">anyKey</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">]</span>
    
    <span class="c1"># Set up plot viz and export</span>
    <span class="n">plotSuff</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">legendLoc</span> <span class="o">=</span> <span class="s1">&#39;upper left&#39;</span>
    
    <span class="c1"># Plot HVSR curve first</span>
    <span class="n">plotHVSR</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">==</span><span class="s1">&#39;hvsr&#39;</span><span class="p">:</span>
            <span class="n">plotHVSR</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;H/V Ratio&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
            <span class="n">plotSuff</span> <span class="o">=</span> <span class="s1">&#39;HVSRCurve_&#39;</span>
            <span class="k">if</span> <span class="s1">&#39;-s&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsrm2&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">],</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsrp2&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;StDev&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">997</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsrm2&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">998</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsrp2&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">999</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plotSuff</span> <span class="o">=</span> <span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;noStdDev_&#39;</span>
            <span class="k">break</span>
    
    <span class="c1"># Plot parameters</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;H/V Ratio&#39;</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">[&#39;</span><span class="o">+</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;horizontal_method&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="s1">&#39;processing_parameters&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="s1">&#39;generate_psds&#39;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;processing_parameters&#39;</span><span class="p">][</span><span class="s1">&#39;generate_psds&#39;</span><span class="p">][</span><span class="s1">&#39;obspy_ppsds&#39;</span><span class="p">]:</span>
            <span class="n">compLabel</span> <span class="o">=</span> <span class="s1">&#39;COMPONENTS</span><span class="se">\n</span><span class="s1">Amplitude</span><span class="se">\n</span><span class="s1">[m2/s4/Hz] [dB]&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">compLabel</span> <span class="o">=</span> <span class="s1">&#39;COMPONENTS</span><span class="se">\n</span><span class="s1"> PSDs&#39;</span>

    <span class="c1"># Get peak parameters (if exist, otherwise, get dummy ones)</span>
    <span class="k">if</span> <span class="s2">&quot;BestPeak&quot;</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span>
        <span class="n">a0</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f0</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">f0_div4</span> <span class="o">=</span> <span class="n">f0</span><span class="o">/</span><span class="mi">4</span>
    <span class="n">f0_mult4</span> <span class="o">=</span> <span class="n">f0</span><span class="o">*</span><span class="mi">4</span>
    <span class="n">a0_div2</span> <span class="o">=</span> <span class="n">a0</span><span class="o">/</span><span class="mi">2</span>

    <span class="c1"># Predefine so only need to set True if True</span>
    <span class="n">peakAmpAnn</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">peakPoint</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">peakLine</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">used</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">notused</span> <span class="o">=</span> <span class="o">~</span><span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>     
    
    <span class="c1"># Go through each &quot;token&quot; in plot_type str and plot as specified</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">:</span>
        <span class="c1"># Show peak(s)</span>
        <span class="c1"># Show f0 peak (and annotate if indicated)</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="s1">&#39;p&#39;</span> <span class="ow">and</span> <span class="s1">&#39;all&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">:</span>
            <span class="n">plotSuff</span><span class="o">=</span><span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;BestPeak_&#39;</span>
            
            <span class="n">bestPeakScore</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;PeakReport&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bestPeakScore</span><span class="p">:</span>
                    <span class="n">bestPeakScore</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span>
                    <span class="n">bestPeak</span> <span class="o">=</span> <span class="n">p</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">bestPeak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peak&#39;</span><span class="p">)</span>          
            
            <span class="c1"># Annotate primary peak</span>
            <span class="k">if</span> <span class="s1">&#39;ann&#39;</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">:</span>
                <span class="n">xLoc</span> <span class="o">=</span> <span class="n">bestPeak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span>
                <span class="n">yLoc</span> <span class="o">=</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.008</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xLoc</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yLoc</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="s2">&quot;Peak at &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">bestPeak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;Hz&#39;</span><span class="p">,</span>
                            <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;xx-small&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> 
                            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
                <span class="n">plotSuff</span> <span class="o">=</span> <span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;ann_&#39;</span>  
        <span class="c1">#Show all peaks in h/v curve</span>
        <span class="k">elif</span> <span class="n">k</span><span class="o">==</span><span class="s1">&#39;p&#39;</span>  <span class="ow">and</span> <span class="s1">&#39;all&#39;</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">:</span>
            <span class="n">plotSuff</span> <span class="o">=</span> <span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;allPeaks_&#39;</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_freqs&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Peak&#39;</span><span class="p">)</span>          

            <span class="c1"># Annotate all peaks</span>
            <span class="k">if</span> <span class="s1">&#39;ann&#39;</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_freqs&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">]):</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_curve&#39;</span><span class="p">][</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_indices&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="n">i</span><span class="p">]]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;Peak at &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;Hz&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> 
                                    <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> 
                                    <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
                <span class="n">plotSuff</span><span class="o">=</span><span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;ann_&#39;</span>

        <span class="c1"># Show primary peak amplitude (and annotate if indicated)</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="s1">&#39;pa&#39;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="n">a0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f0</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">f0</span><span class="p">],</span> <span class="p">[</span><span class="n">a0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="n">peakPoint</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">peakLine</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="c1"># Annotate primary peak amplitude</span>
            <span class="k">if</span> <span class="s1">&#39;ann&#39;</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Peak Amp.: </span><span class="si">{</span><span class="n">a0</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">f0</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="n">f0</span><span class="p">,</span> <span class="n">a0</span><span class="p">])</span>
                <span class="n">peakAmpAnn</span> <span class="o">=</span> <span class="kc">True</span>                

        <span class="c1"># Show the curves and/or peaks at each time window</span>
        <span class="k">if</span> <span class="s1">&#39;t&#39;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">and</span> <span class="s1">&#39;test&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">plotSuff</span> <span class="o">=</span> <span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;allTWinCurves_&#39;</span>

            <span class="c1"># If this is a component subplot</span>
            <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;subplot&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;comp&#39;</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;tp&#39;</span><span class="p">:</span>
                    <span class="k">pass</span>  <span class="c1"># This is not calculated for individual components</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
                    <span class="n">azKeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">]</span>
                    <span class="n">azKeys</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_az</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                    <span class="n">azColors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">:</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span><span class="s1">&#39;r&#39;</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">az</span> <span class="ow">in</span> <span class="n">azKeys</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">az</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">azColors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">col</span> <span class="o">=</span> <span class="n">azColors</span><span class="p">[</span><span class="n">az</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">col</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span>

                        <span class="k">for</span> <span class="n">pv</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="n">used</span><span class="p">][</span><span class="s1">&#39;psd_values_&#39;</span><span class="o">+</span><span class="n">az</span><span class="p">])):</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># For the main H/V plot</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Show all peaks at all times (semitransparent red bars)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;tp&#39;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="n">used</span><span class="p">][</span><span class="s1">&#39;CurvesPeakIndices_&#39;</span><span class="o">+</span><span class="n">azimuth</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
                            <span class="n">v</span><span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mi">16</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">16</span>
                            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">ylim</span><span class="p">,</span><span class="n">v</span><span class="o">-</span><span class="n">width</span><span class="p">,</span><span class="n">v</span><span class="o">+</span><span class="n">width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Individual H/V Peaks&#39;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">ylim</span><span class="p">,</span><span class="n">v</span><span class="o">-</span><span class="n">width</span><span class="p">,</span><span class="n">v</span><span class="o">+</span><span class="n">width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
                <span class="c1"># Show curves at all time windows</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s1">&#39;t&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">used</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="n">used</span><span class="p">][</span><span class="s1">&#39;HV_Curves&#39;</span><span class="p">]):</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">notused</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="n">notused</span><span class="p">][</span><span class="s1">&#39;HV_Curves&#39;</span><span class="p">]):</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orangered&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.666</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Plot SESAME test results and thresholds on HVSR plot</span>
        <span class="k">if</span> <span class="s1">&#39;test&#39;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;subplot&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hvsr&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">==</span><span class="s1">&#39;tests&#39;</span> <span class="ow">or</span> <span class="s1">&#39;all&#39;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="c1"># Change k to pass all test plot conditions</span>
                <span class="n">k</span><span class="o">=</span><span class="s1">&#39;test123456c&#39;</span>

            <span class="k">if</span> <span class="s1">&#39;1&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="c1"># Peak is higher than 2x lowest point in f0/4-f0</span>
                <span class="c1"># Plot the line threshold that the curve needs to cross</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">f0_div4</span><span class="p">,</span> <span class="n">f0</span><span class="p">],</span> <span class="p">[</span><span class="n">a0_div2</span><span class="p">,</span> <span class="n">a0_div2</span><span class="p">],</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
                
                <span class="c1"># Get minimum of curve in desired range</span>
                <span class="n">indexList</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">fList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">x_freqs</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">f0_div4</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="n">f0</span><span class="p">:</span>
                        <span class="n">indexList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">fList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

                <span class="n">newCurveList</span><span class="o">=</span> <span class="p">[]</span>
                <span class="n">newFreqList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indexList</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_curve</span><span class="p">):</span>
                        <span class="n">newFreqList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">x_freqs</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">])</span>
                        <span class="n">newCurveList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_curve</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                <span class="n">curveTestList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">newFreqList</span><span class="p">)</span> <span class="o">*</span> <span class="n">a0_div2</span><span class="p">)</span>


                <span class="c1"># Plot line showing where test succeeds or not</span>
                <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f-)&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">():</span>
                    <span class="n">lowf2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f-)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">hif2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f-)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">ym</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f-)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">yp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newCurveList</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">ym</span><span class="p">,</span> <span class="n">yp</span><span class="p">],</span> <span class="n">x1</span><span class="o">=</span><span class="n">lowf2</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="n">hif2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#fpass = float(hvsr_data[&#39;BestPeak&#39;][azimuth][&#39;Report&#39;][&#39;A(f-)&#39;].replace(&#39;Hz&#39;, &#39;&#39;).replace(&#39;-&#39;, &#39;&#39;).split()[3])</span>
                    <span class="c1">#fpassAmp = float(hvsr_data[&#39;BestPeak&#39;][azimuth][&#39;Report&#39;][&#39;A(f-)&#39;].replace(&#39;Hz&#39;, &#39;&#39;).replace(&#39;-&#39;, &#39;&#39;).split()[5])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">newFreqList</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="n">newCurveList</span><span class="p">,</span> <span class="n">y2</span><span class="o">=</span><span class="n">curveTestList</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newCurveList</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">a0_div2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="n">minF</span> <span class="o">=</span> <span class="n">newFreqList</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">newCurveList</span><span class="p">)]</span>
                    <span class="n">minA</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newCurveList</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">minF</span><span class="p">,</span> <span class="n">minF</span><span class="p">,</span> <span class="n">minF</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">minA</span><span class="p">,</span> <span class="n">a0_div2</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>

                <span class="c1"># Plot the Peak Point if not already</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">peakPoint</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">f0</span><span class="p">],</span> <span class="p">[</span><span class="n">a0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                    <span class="n">peakPoint</span><span class="o">=</span><span class="kc">True</span>

                <span class="c1"># Annotate the Peak Amplitude if not already</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">peakAmpAnn</span> <span class="ow">and</span> <span class="s1">&#39;ann&#39;</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Peak Amp.: </span><span class="si">{</span><span class="n">a0</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">f0</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="n">f0</span><span class="p">,</span> <span class="n">a0</span><span class="p">])</span>
                    <span class="n">peakAmpAnn</span><span class="o">=</span><span class="kc">True</span>

                <span class="c1"># Add peak line</span>
                <span class="k">if</span> <span class="s1">&#39;pa&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_type</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">peakLine</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="n">a0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f0</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
                    <span class="n">peakLine</span> <span class="o">=</span> <span class="kc">True</span>  
            <span class="k">if</span> <span class="s1">&#39;2&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="c1"># Peak is higher than 2x lowest point in f0-f0*4</span>

                <span class="c1"># Plot the line threshold that the curve needs to cross</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">f0</span><span class="p">,</span> <span class="n">f0_mult4</span><span class="p">],</span> <span class="p">[</span><span class="n">a0_div2</span><span class="p">,</span> <span class="n">a0_div2</span><span class="p">],</span>  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>

                
                <span class="c1"># Get minimum of curve in desired range</span>
                <span class="n">indexList</span><span class="o">=</span><span class="p">[]</span>
                <span class="n">fList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">x_freqs</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">f0</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="n">f0_mult4</span><span class="p">:</span>
                        <span class="n">indexList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">fList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

                <span class="n">newCurveList</span><span class="o">=</span> <span class="p">[]</span>
                <span class="n">newFreqList</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">indexList</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ind</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_curve</span><span class="p">):</span>
                        <span class="n">newFreqList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">x_freqs</span><span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">][</span><span class="n">ind</span><span class="p">])</span>
                        <span class="n">newCurveList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_curve</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
                <span class="n">curveTestList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">newFreqList</span><span class="p">)</span> <span class="o">*</span> <span class="n">a0_div2</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f+)&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">():</span>
                    <span class="n">lowf2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f+)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">hif2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f+)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">ym</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f+)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
                    <span class="n">yp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newCurveList</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">ym</span><span class="p">,</span> <span class="n">yp</span><span class="p">],</span> <span class="n">x1</span><span class="o">=</span><span class="n">lowf2</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="n">hif2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#fpass = float(hvsr_data[&#39;BestPeak&#39;][azimuth][&#39;Report&#39;][&#39;A(f+)&#39;].replace(&#39;Hz&#39;, &#39;&#39;).replace(&#39;-&#39;, &#39;&#39;).split()[3])</span>
                    <span class="c1">#fpassAmp = float(hvsr_data[&#39;BestPeak&#39;][azimuth][&#39;Report&#39;][&#39;A(f+)&#39;].replace(&#39;Hz&#39;, &#39;&#39;).replace(&#39;-&#39;, &#39;&#39;).split()[5])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">newFreqList</span><span class="p">,</span> <span class="n">y1</span><span class="o">=</span><span class="n">newCurveList</span><span class="p">,</span> <span class="n">y2</span><span class="o">=</span><span class="n">curveTestList</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newCurveList</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">a0_div2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="n">minF</span> <span class="o">=</span> <span class="n">newFreqList</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">newCurveList</span><span class="p">)]</span>
                    <span class="n">minA</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">newCurveList</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">minF</span><span class="p">,</span> <span class="n">minF</span><span class="p">,</span> <span class="n">minF</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">minA</span><span class="p">,</span> <span class="n">a0_div2</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">)</span>

                <span class="c1"># Plot the Peak Point if not already</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">peakPoint</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">f0</span><span class="p">],</span> <span class="p">[</span><span class="n">a0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                    <span class="n">peakPoint</span><span class="o">=</span><span class="kc">True</span>
                
                <span class="c1"># Annotate the amplitude of peak point if not already</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">peakAmpAnn</span> <span class="ow">and</span> <span class="s1">&#39;ann&#39;</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Peak Amp.: </span><span class="si">{</span><span class="n">a0</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">f0</span><span class="o">+</span><span class="mf">0.1</span><span class="o">*</span><span class="n">f0</span><span class="p">,</span> <span class="n">a0</span><span class="p">])</span>
                    <span class="n">peakAmpAnn</span><span class="o">=</span><span class="kc">True</span>
                
                <span class="k">if</span> <span class="s1">&#39;pa&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_type</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">peakLine</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="n">a0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f0</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
                    <span class="n">peakLine</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;3&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                    <span class="c1">#Plot curve test3</span>
                    <span class="n">lowfc3</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;σ_A(f)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">hifc3</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;σ_A(f)&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Hz&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">pass</span> <span class="c1"># May not even finish this</span>
                
                <span class="n">lcolor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span>
                <span class="k">if</span> <span class="n">f0</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">lcolor</span><span class="o">=</span><span class="s1">&#39;g&#39;</span>

                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="n">num</span> <span class="ow">in</span> <span class="n">k</span> <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">]):</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="mi">2</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">f0</span><span class="p">,</span> <span class="n">f0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">a0</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">lcolor</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;pa&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">([</span><span class="n">a0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f0</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">f0</span><span class="p">],</span> <span class="p">[</span><span class="n">a0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                        <span class="n">peakPoint</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">peakLine</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;4&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">lowf4</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P-&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">hif4</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">m2Max</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">x_freqs</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsrm2</span><span class="p">)]</span><span class="c1">#, np.max(hvsr_data.hvsrm2))</span>
                <span class="n">p2Max</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">x_freqs</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsrp2</span><span class="p">)]</span><span class="c1">#, np.max(hvsr_data.hvsrp2))</span>

                <span class="c1"># ax.vlines([f0*0.95, f0*1.05], [0,0], [ax.get_xlim()[1],ax.get_xlim()[1]])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">x1</span><span class="o">=</span><span class="n">f0</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">x2</span><span class="o">=</span><span class="n">f0</span><span class="o">*</span><span class="mf">1.05</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
                
                <span class="n">mcolor</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
                <span class="n">pcolor</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
                <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P-&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">():</span>
                    <span class="n">mcolor</span><span class="o">=</span><span class="s1">&#39;g&#39;</span>
                <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">():</span>
                    <span class="n">pcolor</span><span class="o">=</span><span class="s1">&#39;g&#39;</span>

                <span class="nb">print</span><span class="p">(</span><span class="n">lowf4</span><span class="p">,</span> <span class="n">hif4</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">lowf4</span><span class="p">,</span> <span class="n">hif4</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsrm2</span><span class="p">[</span><span class="n">azimuth</span><span class="p">]),</span>  <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsrp2</span><span class="p">[</span><span class="n">azimuth</span><span class="p">])],</span> <span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="n">mcolor</span><span class="p">,</span> <span class="n">pcolor</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">peakPoint</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">f0</span><span class="p">],</span> <span class="p">[</span><span class="n">a0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                    <span class="n">peakPoint</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;5&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">sf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;()&#39;</span><span class="p">))</span>
                <span class="n">sfp</span> <span class="o">=</span> <span class="n">f0</span><span class="o">+</span><span class="n">sf</span>
                <span class="n">sfm</span> <span class="o">=</span> <span class="n">f0</span><span class="o">-</span><span class="n">sf</span>

                <span class="n">sfLim</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">sfLimp</span> <span class="o">=</span> <span class="n">f0</span><span class="o">+</span><span class="n">sfLim</span>
                <span class="n">sfLimm</span> <span class="o">=</span> <span class="n">f0</span><span class="o">-</span><span class="n">sfLim</span>

                <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">():</span>
                    <span class="n">xColor</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xColor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">sfLimm</span><span class="p">,</span> <span class="n">sfLimp</span><span class="p">],</span> <span class="p">[</span><span class="n">a0</span><span class="p">,</span> <span class="n">a0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">sfm</span><span class="p">,</span> <span class="n">sfp</span><span class="p">],</span> <span class="p">[</span><span class="n">a0</span><span class="p">,</span> <span class="n">a0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">xColor</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">sfLimm</span><span class="p">,</span> <span class="n">sfLimp</span><span class="p">],</span> <span class="p">[</span><span class="n">a0</span><span class="p">,</span> <span class="n">a0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">peakPoint</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">f0</span><span class="p">],</span> <span class="p">[</span><span class="n">a0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                    <span class="n">peakPoint</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;6&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
                <span class="n">sa</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;()&#39;</span><span class="p">))</span>
                <span class="n">sap</span> <span class="o">=</span> <span class="n">a0</span><span class="o">+</span><span class="n">sa</span>
                <span class="n">sam</span> <span class="o">=</span> <span class="n">a0</span><span class="o">-</span><span class="n">sa</span>

                <span class="n">saLim</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">saLimp</span> <span class="o">=</span> <span class="n">a0</span><span class="o">+</span><span class="n">saLim</span>
                <span class="n">saLimm</span> <span class="o">=</span> <span class="n">a0</span><span class="o">-</span><span class="n">saLim</span>

                <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">():</span>
                    <span class="n">xColor</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xColor</span><span class="o">=</span><span class="s1">&#39;r&#39;</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">f0</span><span class="p">,</span> <span class="n">f0</span><span class="p">],</span> <span class="p">[</span><span class="n">saLimm</span><span class="p">,</span> <span class="n">saLimp</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">f0</span><span class="p">,</span> <span class="n">f0</span><span class="p">],[</span><span class="n">sam</span><span class="p">,</span> <span class="n">sap</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">xColor</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">f0</span><span class="p">,</span> <span class="n">f0</span><span class="p">],[</span><span class="n">saLimm</span><span class="p">,</span> <span class="n">saLimp</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:blue&#39;</span><span class="p">)</span>                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">peakPoint</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">([</span><span class="n">f0</span><span class="p">],</span> <span class="p">[</span><span class="n">a0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
                    <span class="n">peakPoint</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Plot frequency search range bars</span>
        <span class="k">if</span> <span class="s1">&#39;fr&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span>
            <span class="n">lowPeakSearchThresh</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">peak_freq_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">hiPeakSearchThresh</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">peak_freq_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="n">frStyleDict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;linestyle&#39;</span><span class="p">:</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="s1">&#39;facecolors&#39;</span><span class="p">:</span><span class="s1">&#39;#1B060544&#39;</span><span class="p">,</span> <span class="s1">&#39;edgecolors&#39;</span><span class="p">:</span><span class="s1">&#39;#000000&#39;</span><span class="p">}</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">ylim</span><span class="p">,</span> <span class="p">[</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="n">lowPeakSearchThresh</span><span class="p">,</span><span class="n">lowPeakSearchThresh</span><span class="p">],</span> <span class="o">**</span><span class="n">frStyleDict</span><span class="p">)</span>          
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">ylim</span><span class="p">,</span> <span class="p">[</span><span class="n">hiPeakSearchThresh</span><span class="p">,</span> <span class="n">hiPeakSearchThresh</span><span class="p">],[</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="o">**</span><span class="n">frStyleDict</span><span class="p">)</span>          

        <span class="c1"># Plot individual components</span>
        <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">in</span> <span class="n">k</span> <span class="ow">and</span> <span class="s1">&#39;test&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span> <span class="c1">#Spectrogram uses a different function, so c is unique to the component plot flag</span>
            <span class="n">plotSuff</span> <span class="o">=</span> <span class="n">plotSuff</span><span class="o">+</span><span class="s1">&#39;IndComponents_&#39;</span>
            
            <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1">#This section is if comps plotted in hvsr axis</span>
                
                <span class="n">compAxis</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">compAxis</span><span class="p">)</span>
                <span class="c1">#axis2 = plt.gca()</span>
                <span class="c1">#fig = plt.gcf()</span>
                <span class="n">compAxis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">compLabel</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">270</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="c1">#plt.sca(compAxis)</span>
                <span class="c1">#plt.ylabel(compLabel, rotate=180)</span>
                <span class="n">compAxis</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">legendLoc2</span> <span class="o">=</span> <span class="s1">&#39;upper right&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># This section is for if they are plotted on different plots</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="c1">#Remove title</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">sharex</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;axes&#39;</span><span class="p">][</span><span class="s1">&#39;hvsr&#39;</span><span class="p">])</span>
                <span class="n">compAxis</span> <span class="o">=</span> <span class="n">ax</span>
                <span class="n">legendLoc2</span> <span class="o">=</span> <span class="s1">&#39;upper right&#39;</span>
                <span class="n">compAxis</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">compLabel</span><span class="p">)</span>
                
            <span class="n">minY</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">maxY</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">keyList</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">az</span> <span class="ow">in</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_az</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">keyList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">az</span><span class="p">)</span>
            <span class="n">keyList</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">hvsrDF</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">hvsr_windows_df</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keyList</span><span class="p">:</span>
                <span class="c1">#hvsr_data[&#39;ppsds&#39;][key][&#39;psd_values&#39;]                </span>
                <span class="n">minY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsd_std_vals_m&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                <span class="n">maxY</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsd_std_vals_p&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="c1">#minY.append(np.min(np.stack(hvsrDF[&#39;psd_values_&#39;+key][hvsrDF[&#39;Use&#39;]])))</span>
                <span class="c1">#maxY.append(np.max(np.stack(hvsrDF[&#39;psd_values_&#39;+key][hvsrDF[&#39;Use&#39;]])))</span>
            <span class="n">minY</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">minY</span><span class="p">)</span>
            <span class="n">maxY</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">maxY</span><span class="p">)</span>
            <span class="c1">#if maxY &gt; 20:</span>
            <span class="c1">#    maxY = max(hvsr_data[&#39;hvsr_curve&#39;]) * 1.15</span>
            <span class="n">rng</span> <span class="o">=</span> <span class="n">maxY</span><span class="o">-</span><span class="n">minY</span>
            <span class="n">pad</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">rng</span> <span class="o">*</span> <span class="mf">0.15</span><span class="p">)</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">minY</span><span class="o">-</span><span class="n">pad</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">maxY</span><span class="o">+</span><span class="n">pad</span><span class="o">+</span><span class="n">pad</span><span class="p">)]</span>

            <span class="n">compAxis</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
            <span class="n">yLoc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.05</span>
            <span class="n">xlab</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">yLoc</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> 
                        <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-small&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> 
                        <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
            <span class="n">xlab</span><span class="o">.</span><span class="n">set_in_layout</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1">#Modify based on whether there are multiple charts</span>
            <span class="k">if</span> <span class="n">plotHVSR</span><span class="p">:</span>
                <span class="n">linalpha</span> <span class="o">=</span> <span class="mf">0.2</span>
                <span class="n">stdalpha</span> <span class="o">=</span> <span class="mf">0.05</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">linalpha</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">stdalpha</span><span class="o">=</span><span class="mf">0.2</span>
            
            <span class="c1">#Plot individual components</span>
            <span class="n">azsLabeled</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">y</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">psdKeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;psd_values_tavg&#39;</span><span class="p">])</span>
            <span class="n">psdKeys</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># Put Z last so it plots on top</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">psdKeys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span>
                    <span class="n">pltColor</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
                <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span><span class="s1">&#39;E&#39;</span><span class="p">:</span>
                    <span class="n">pltColor</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span>
                <span class="k">elif</span> <span class="n">key</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
                    <span class="n">pltColor</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pltColor</span> <span class="o">=</span> <span class="s1">&#39;g&#39;</span>

                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keyList</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="n">azimuth</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">hvsr_data</span><span class="o">.</span><span class="n">horizontal_method</span> <span class="o">==</span> <span class="s1">&#39;Single Azimuth&#39;</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">]:</span>
                        <span class="k">pass</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">y</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;psd_values_tavg&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># Make sure azimuth only shows up in legend once</span>
                        <span class="k">if</span> <span class="n">pltColor</span> <span class="o">==</span> <span class="s1">&#39;g&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">azsLabeled</span><span class="p">:</span>
                                <span class="n">leglabel</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">leglabel</span> <span class="o">=</span> <span class="s1">&#39;Azimuths&#39;</span>    
                            <span class="n">azsLabeled</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">leglabel</span> <span class="o">=</span> <span class="n">key</span>

                        <span class="n">compAxis</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">pltColor</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">leglabel</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">linalpha</span><span class="p">)</span>
                        <span class="k">if</span> <span class="s1">&#39;-s&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">:</span>
                            <span class="n">compAxis</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsd_std_vals_m&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsd_std_vals_p&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">pltColor</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">stdalpha</span><span class="p">)</span>

                <span class="k">if</span> <span class="s1">&#39;c&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;show_legend&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">compAxis</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">legendLoc2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">legendLoc</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">psdKeys</span><span class="p">),</span> 
                        <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">columnspacing</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">markerfirst</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">borderpad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">yLoc</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span> <span class="o">-</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.05</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">yLoc</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-small&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> 
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
    
    <span class="n">bbox</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_window_extent</span><span class="p">()</span>
    <span class="n">bboxStart</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;Bbox(&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">50</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span>
    <span class="n">bboxStr</span> <span class="o">=</span> <span class="n">bbox</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()[</span><span class="n">bboxStart</span><span class="p">:]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)[:</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">axisbox</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">bboxStr</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;)&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">axisbox</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;show_legend&#39;</span><span class="p">]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">legendLoc</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.05</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">__plot_current_fig</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">save_dir</span><span class="p">,</span> 
                        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span> 
                        <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                        <span class="n">plot_suffix</span><span class="o">=</span><span class="n">plotSuff</span><span class="p">,</span> 
                        <span class="n">user_suffix</span><span class="o">=</span><span class="n">save_suffix</span><span class="p">,</span> 
                        <span class="n">show_plot</span><span class="o">=</span><span class="n">show_plot</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>


<span class="c1"># Private function to help for when to show and format and save plots</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__plot_current_fig</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">plot_suffix</span><span class="p">,</span> <span class="n">user_suffix</span><span class="p">,</span> <span class="n">show_plot</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Private function to support plot_hvsr, for plotting and showing plots&quot;&quot;&quot;</span>
    <span class="c1">#plt.gca()</span>
    <span class="c1">#plt.gcf()</span>
    <span class="c1">#fig.tight_layout() #May need to uncomment this</span>

    <span class="c1">#plt.subplots_adjust(top = 1, bottom = 0, right = 1, left = 0, hspace = 0, wspace = 0)</span>

    <span class="k">if</span> <span class="n">save_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outFile</span> <span class="o">=</span> <span class="n">save_dir</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">plot_suffix</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">user_suffix</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outFile</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show_plot</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span><span class="c1">#.show()</span>
        <span class="c1">#fig.tight_layout()</span>
        <span class="c1">#plt.ion()</span>
    <span class="k">return</span>


<span class="c1"># Plot specgtrogram, private supporting function for plot_hvsr</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_plot_specgram_hvsr</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=</span><span class="s1">&#39;HV&#39;</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_suffix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Private function for plotting average spectrogram of all three channels from ppsds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get all input parameters</span>
    <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>    

    <span class="k">if</span> <span class="s1">&#39;kwargs&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;kwargs&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;spec&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;spec&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s1">&#39;p&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">peak_plot</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">peak_plot</span><span class="o">=</span><span class="kc">False</span>

    <span class="k">if</span> <span class="s1">&#39;ann&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">annotate</span><span class="o">=</span><span class="kc">True</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ann&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">annotate</span><span class="o">=</span><span class="kc">False</span>

    <span class="k">if</span> <span class="s1">&#39;all&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">show_all_peaks</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">show_all_peaks</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="s1">&#39;tp&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">show_all_time_peaks</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;tp&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">show_all_time_peaks</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="s1">&#39;grid&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;grid&#39;</span><span class="p">]</span>
        
    <span class="k">if</span> <span class="s1">&#39;ytype&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ytype&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;freq&#39;</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Frequency [Hz]&#39;</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ytype&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Period [s]&#39;</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ytype&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Frequency [Hz]&#39;</span>
        
    <span class="k">if</span> <span class="s1">&#39;detrend&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">detrend</span><span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;detrend&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;detrend&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">detrend</span><span class="o">=</span><span class="kc">True</span>

    <span class="k">if</span> <span class="s1">&#39;colorbar&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;colorbar&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;colorbar&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span>

    <span class="k">if</span> <span class="s1">&#39;cmap&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;cmap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;turbo&#39;</span>

    <span class="n">hvsrDF</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span>
    <span class="n">used</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">notused</span> <span class="o">=</span> <span class="o">~</span><span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>     

    <span class="c1"># Setup</span>
    <span class="n">ppsds</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">]</span><span class="c1">#[k][&#39;current_times_used&#39;]</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.dates</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mdates</span>
    <span class="n">anyKey</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ppsds</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># Get data</span>
    <span class="n">hvCurveColumn</span> <span class="o">=</span> <span class="s1">&#39;HV_Curves&#39;</span>
    <span class="k">if</span> <span class="n">azimuth</span> <span class="o">!=</span> <span class="s1">&#39;HV&#39;</span><span class="p">:</span>
        <span class="n">hvCurveColumn</span> <span class="o">+=</span> <span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">azimuth</span>
    
    <span class="n">psdArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="n">hvCurveColumn</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">))</span>
    <span class="n">useArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;Use&#39;</span><span class="p">])</span>
    <span class="n">useArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">useArr</span><span class="p">,</span> <span class="p">(</span><span class="n">psdArr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">useArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">useArr</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Get times</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_MPL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="p">[</span><span class="s1">&#39;TimesProcessed_MPL&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1">#Format times</span>
    <span class="n">tTicks</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">MinuteLocator</span><span class="p">(</span><span class="n">byminute</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">60</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">tTicks</span><span class="p">)</span>
    <span class="n">tTicks_minor</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">SecondLocator</span><span class="p">(</span><span class="n">bysecond</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">tTicks_minor</span><span class="p">)</span>

    <span class="n">tLabels</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">tLabels</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="s1">&#39;x-small&#39;</span><span class="p">)</span>

    <span class="c1">#Get day label for bottom of chart</span>
    <span class="k">if</span> <span class="n">hvsrDF</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">!=</span> <span class="n">hvsrDF</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">():</span>
        <span class="n">day</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39; - &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">day</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_windows_df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>

    <span class="c1">#Get extents</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">freqticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="n">anyKey</span><span class="p">])</span>
    <span class="n">yminind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ymin</span><span class="o">-</span><span class="n">freqticks</span><span class="p">))</span>
    <span class="n">ymaxind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">freqticks</span><span class="p">))</span>
    <span class="n">freqticks</span> <span class="o">=</span> <span class="n">freqticks</span><span class="p">[</span><span class="n">yminind</span><span class="p">:</span><span class="n">ymaxind</span><span class="p">]</span>
    <span class="n">freqticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">freqticks</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">freqticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">num</span><span class="o">=</span><span class="n">psdArr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">extList</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">]</span>
    <span class="c1">#Set up axes</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#Create black background for transparency to look darker</span>

    <span class="c1"># Interpolate into linear</span>
    <span class="n">new_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">freqticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">freqticks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">freqticks</span><span class="p">))</span>
    <span class="n">linList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">psdArr</span><span class="p">:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float16</span><span class="p">)</span>
        <span class="n">linList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">new_indices</span><span class="p">,</span> <span class="n">freqticks</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
    <span class="n">linear_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">linList</span><span class="p">)</span>

    <span class="c1"># Create chart</span>
    <span class="k">if</span> <span class="s1">&#39;subplot&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;subplot&#39;</span><span class="p">]</span>
    
    <span class="c1"># Get min and max of colormap normalization from array that is used</span>
    <span class="k">if</span> <span class="s1">&#39;vmin&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="n">used</span><span class="p">][</span><span class="s1">&#39;HV_Curves&#39;</span><span class="p">]))</span>
    <span class="k">if</span> <span class="s1">&#39;vmax&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;vmax&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="n">used</span><span class="p">][</span><span class="s1">&#39;HV_Curves&#39;</span><span class="p">]))</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">linear_arr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extList</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">useArr</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">peak_plot</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>  <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">annotate</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">boxYPerc</span> <span class="o">=</span> <span class="mf">0.998</span>
            <span class="n">vertAlign</span> <span class="o">=</span> <span class="s1">&#39;top&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">boxYPerc</span> <span class="o">=</span> <span class="mf">0.002</span>
            <span class="n">vertAlign</span> <span class="o">=</span> <span class="s1">&#39;bottom&#39;</span>
        <span class="n">xLocation</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">xmin</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">xmax</span><span class="p">)</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">xmin</span><span class="p">))</span><span class="o">*</span><span class="mf">0.99</span>
        <span class="n">yLocation</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;input_params&#39;</span><span class="p">][</span><span class="s1">&#39;hvsr_band&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">boxYPerc</span><span class="p">)</span>
        <span class="n">ann</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xLocation</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yLocation</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-small&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Peak at </span><span class="si">{</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;BestPeak&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="n">vertAlign</span><span class="p">,</span> 
                      <span class="n">bbox</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="mf">0.8</span><span class="p">,</span> <span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;fc&#39;</span><span class="p">:</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;pad&#39;</span><span class="p">:</span><span class="mf">0.3</span><span class="p">})</span>

    <span class="k">if</span> <span class="n">show_all_time_peaks</span><span class="p">:</span>
        <span class="n">timeVals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">peakFreqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tIndex</span><span class="p">,</span> <span class="n">pFreqs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsrDF</span><span class="p">[</span><span class="n">used</span><span class="p">][</span><span class="s1">&#39;CurvesPeakFreqs_&#39;</span><span class="o">+</span><span class="n">azimuth</span><span class="p">]):</span>
            <span class="n">endWindow</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">tIndex</span><span class="p">][</span><span class="s1">&#39;TimesProcessed_MPLEnd&#39;</span><span class="p">]</span>
            <span class="n">startWindow</span> <span class="o">=</span> <span class="n">hvsrDF</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">tIndex</span><span class="p">][</span><span class="s1">&#39;TimesProcessed_MPL&#39;</span><span class="p">]</span>
            <span class="n">midTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">endWindow</span> <span class="o">+</span> <span class="n">startWindow</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">pFreqs</span><span class="p">:</span>
                <span class="n">timeVals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">midTime</span><span class="p">)</span>
                <span class="n">peakFreqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">timeVals</span><span class="p">,</span> <span class="n">peakFreqs</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;^&quot;</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;#00000000&#39;</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;#00000088&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show_all_peaks</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_peak_freqs&#39;</span><span class="p">][</span><span class="n">azimuth</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.666</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;dotted&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">999</span><span class="p">)</span>

    <span class="n">xLoc</span> <span class="o">=</span> <span class="n">xmin</span> <span class="o">+</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.001</span>
    <span class="n">yLoc</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">+</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.97</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xLoc</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yLoc</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">day</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;small&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> 
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">colorbar</span><span class="p">:</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">mappable</span><span class="o">=</span><span class="n">im</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;H/V Ratio&#39;</span><span class="p">)</span>

    <span class="c1">#Set x and y labels</span>
    <span class="n">yLoc</span> <span class="o">=</span> <span class="n">ymin</span> <span class="o">-</span> <span class="p">(</span><span class="n">ymin</span> <span class="o">*</span> <span class="mf">2.5e-1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">xmin</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">yLoc</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="s2">&quot;UTC Time&quot;</span><span class="p">,</span> 
                <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-small&#39;</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> 
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;x-small&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

    <span class="c1">#plt.sca(ax)</span>
    <span class="c1">#plt.rcParams[&#39;figure.dpi&#39;] = 500</span>
    <span class="c1">#plt.rcParams[&#39;figure.figsize&#39;] = (12,4)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>


<span class="c1"># HELPER functions for checking peaks</span>
<span class="c1"># Initialize peaks</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__init_peaks</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_index_list</span><span class="p">,</span> <span class="n">_hvsr_band</span><span class="p">,</span> <span class="n">peak_freq_range</span><span class="o">=</span><span class="n">DEFAULT_BAND</span><span class="p">,</span> <span class="n">_min_peak_amp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Initialize peaks.</span>
<span class="sd">        </span>
<span class="sd">        Creates dictionary with relevant information and removes peaks in hvsr curve that are not relevant for data analysis (outside HVSR_band)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : list-like obj </span>
<span class="sd">            List with x-values (frequency or period values)</span>
<span class="sd">        y : list-like obj </span>
<span class="sd">            List with hvsr curve values</span>
<span class="sd">        index_list : list or array_like </span>
<span class="sd">            List with indices of peaks</span>
<span class="sd">        _hvsr_band : list</span>
<span class="sd">            Two-item list with low and high frequency to limit frequency range of data analysis extent</span>
<span class="sd">        peak_freq_range : list</span>
<span class="sd">            Two-item list with low and high frequency to limit frequency range for checking for peaks</span>
<span class="sd">        _min_peak_amp : float</span>
<span class="sd">            Minimum amplitude to be used for peak selection (to limit number of meaningless peaks found)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _peak               : list </span>
<span class="sd">            List of dictionaries, one for each input peak</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_peak</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">_index_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">_hvsr_band</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">_x</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">_hvsr_band</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">peak_freq_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">_x</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">peak_freq_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">_y</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">_min_peak_amp</span><span class="p">):</span>
            <span class="n">_peak</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;f0&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">_x</span><span class="p">[</span><span class="n">_i</span><span class="p">]),</span> <span class="s1">&#39;A0&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">_y</span><span class="p">[</span><span class="n">_i</span><span class="p">]),</span> 
                          <span class="s1">&#39;f-&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;f+&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Sf&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Sa&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="s1">&#39;Score&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
                          <span class="s1">&#39;Report&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;Lw&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;Nc&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;σ_A(f)&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;A(f-)&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;A(f+)&#39;</span><span class="p">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;A0&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;P+&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;P-&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;Sf&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;Sa&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">},</span>
                          <span class="s1">&#39;PassList&#39;</span><span class="p">:{},</span>
                          <span class="s1">&#39;PeakPasses&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">_peak</span>


<span class="c1"># Check reliability of HVSR of curve</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__check_curve_reliability</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">,</span> <span class="n">_peak</span><span class="p">,</span> <span class="n">col_id</span><span class="o">=</span><span class="s1">&#39;HV&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests to check for reliable H/V curve</span>

<span class="sd">    Tests include:</span>
<span class="sd">        1) Peak frequency is greater than 10 / window length (f0 &gt; 10 / Lw)</span>
<span class="sd">            f0 = peak frequency [Hz]</span>
<span class="sd">            Lw = window length [seconds]</span>
<span class="sd">        2) Number of significant cycles (Nc) is greater than 200 (Nc(f0) &gt; 200)</span>
<span class="sd">                Nc = Lw * Nw * f0</span>
<span class="sd">                Lw = window length [sec]</span>
<span class="sd">                Nw = Number of windows used in analysis</span>
<span class="sd">                f0 = peak frequency [Hz]</span>
<span class="sd">        3) StDev of amplitude of H/V curve is less than 2 at all frequencies between 0.5f0 and 2f0</span>
<span class="sd">            (less than 3 if f0 is less than 0.5 Hz)</span>
<span class="sd">            f0 = peak frequency [Hz]</span>
<span class="sd">            StDev is a measure of the variation of all the H/V curves generated for each time window</span>
<span class="sd">                Our main H/V curve is the median of these</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hvsr_data   : dict</span>
<span class="sd">        Dictionary containing all important information generated about HVSR curve</span>
<span class="sd">    _peak       : list</span>
<span class="sd">        A list of dictionaries, with each dictionary containing information about each peak</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _peak   : list</span>
<span class="sd">        List of dictionaries, same as above, except with information about curve reliability tests added</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">anyKey</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="c1">#Doesn&#39;t matter which channel we use as key</span>

    <span class="n">delta</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">anyKey</span><span class="p">][</span><span class="s1">&#39;delta&#39;</span><span class="p">]</span>
    <span class="n">window_len</span> <span class="o">=</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;ppsds&#39;</span><span class="p">][</span><span class="n">anyKey</span><span class="p">][</span><span class="s1">&#39;ppsd_length&#39;</span><span class="p">]</span> <span class="c1">#Window length in seconds</span>
    <span class="n">window_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;psd_raw&#39;</span><span class="p">][</span><span class="n">anyKey</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>
        <span class="c1"># Test 1</span>
        <span class="n">peakFreq</span><span class="o">=</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span>
        <span class="n">test1</span> <span class="o">=</span> <span class="n">peakFreq</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">/</span><span class="n">window_len</span>

        <span class="n">nc</span> <span class="o">=</span> <span class="n">window_len</span> <span class="o">*</span> <span class="n">window_num</span> <span class="o">*</span> <span class="n">peakFreq</span>
        <span class="n">test2</span> <span class="o">=</span> <span class="n">nc</span> <span class="o">&gt;</span> <span class="mi">200</span>

        <span class="n">halfF0</span> <span class="o">=</span> <span class="n">peakFreq</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">doublef0</span> <span class="o">=</span> <span class="n">peakFreq</span><span class="o">*</span><span class="mi">2</span>
        

        <span class="n">test3</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">failCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;x_freqs&#39;</span><span class="p">][</span><span class="n">anyKey</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&gt;=</span> <span class="n">halfF0</span> <span class="ow">and</span> <span class="n">freq</span> <span class="o">&lt;</span><span class="n">doublef0</span><span class="p">:</span>
                <span class="n">compVal</span> <span class="o">=</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">peakFreq</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_log_std&#39;</span><span class="p">][</span><span class="n">col_id</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">compVal</span><span class="p">:</span>
                        <span class="n">test3</span><span class="o">=</span><span class="kc">False</span>
                        <span class="n">failCount</span> <span class="o">+=</span><span class="mi">1</span>

                <span class="k">else</span><span class="p">:</span> <span class="c1">#if peak freq is less than 0.5</span>
                    <span class="n">compVal</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="k">if</span> <span class="n">hvsr_data</span><span class="p">[</span><span class="s1">&#39;hvsr_log_std&#39;</span><span class="p">][</span><span class="n">col_id</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">compVal</span><span class="p">:</span>
                        <span class="n">test3</span><span class="o">=</span><span class="kc">False</span>
                        <span class="n">failCount</span> <span class="o">+=</span><span class="mi">1</span>

        <span class="k">if</span> <span class="n">test1</span><span class="p">:</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Lw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">peakFreq</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1"> &gt; </span><span class="si">{</span><span class="mi">10</span><span class="o">/</span><span class="nb">int</span><span class="p">(</span><span class="n">window_len</span><span class="p">)</span><span class="si">:</span><span class="s1">0.3</span><span class="si">}</span><span class="s1"> (10 / </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">window_len</span><span class="p">)</span><span class="si">}</span><span class="s1">)  </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Lw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">peakFreq</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s1"> &gt; </span><span class="si">{</span><span class="mi">10</span><span class="o">/</span><span class="nb">int</span><span class="p">(</span><span class="n">window_len</span><span class="p">)</span><span class="si">:</span><span class="s1">0.3</span><span class="si">}</span><span class="s1"> (10 / </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">window_len</span><span class="p">)</span><span class="si">}</span><span class="s1">)  </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">test2</span><span class="p">:</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Nc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span><span class="si">}</span><span class="s1"> &gt; 200  </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Nc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span><span class="si">}</span><span class="s1"> &gt; 200  </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">if</span> <span class="n">test3</span><span class="p">:</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;σ_A(f)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;H/V Amp. St.Dev. for </span><span class="si">{</span><span class="n">peakFreq</span><span class="o">*</span><span class="mf">0.5</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">peakFreq</span><span class="o">*</span><span class="mi">2</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">Hz &lt; </span><span class="si">{</span><span class="n">compVal</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;σ_A(f)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;H/V Amp. St.Dev. for </span><span class="si">{</span><span class="n">peakFreq</span><span class="o">*</span><span class="mf">0.5</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">peakFreq</span><span class="o">*</span><span class="mi">2</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">Hz &lt; </span><span class="si">{</span><span class="n">compVal</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;WinLen&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test1</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;SigCycles&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test2</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowCurveStD&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test3</span>
    <span class="k">return</span> <span class="n">_peak</span>


<span class="c1"># Check clarity of peaks</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__check_clarity</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_peak</span><span class="p">,</span> <span class="n">do_rank</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check clarity of peak amplitude(s)</span>

<span class="sd">       Test peaks for satisfying amplitude clarity conditions as outlined by SESAME 2004:</span>
<span class="sd">           - there exist one frequency f-, lying between f0/4 and f0, such that A0 / A(f-) &gt; 2</span>
<span class="sd">           - there exist one frequency f+, lying between f0 and 4*f0, such that A0 / A(f+) &gt; 2</span>
<span class="sd">           - A0 &gt; 2</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : list-like obj </span>
<span class="sd">            List with x-values (frequency or period values)</span>
<span class="sd">        y : list-like obj </span>
<span class="sd">            List with hvsr curve values</span>
<span class="sd">        _peak : list</span>
<span class="sd">            List with dictionaries for each peak, containing info about that peak</span>
<span class="sd">        do_rank : bool, default=False</span>
<span class="sd">            Include Rank in output</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _peak : list</span>
<span class="sd">            List of dictionaries, each containing the clarity test information for the different peaks that were read in</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">max_rank</span>

    <span class="c1"># Test each _peak for clarity.</span>
    <span class="k">if</span> <span class="n">do_rank</span><span class="p">:</span>
        <span class="n">max_rank</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="n">jstart</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_y</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">jstart</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">_y</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>

    
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>
        <span class="c1">#Initialize as False</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f-&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f-)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;H/V curve &gt; </span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> for all </span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">4</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz-</span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> Hz </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;ProminenceLow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1">#Start with assumption that it is False until we find an instance where it is True</span>
        <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">jstart</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># There exist one frequency f-, lying between f0/4 and f0, such that A0 / A(f-) &gt; 2.</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">4.0</span> <span class="o">&lt;=</span> <span class="n">_x</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]))</span> <span class="ow">and</span> <span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">_y</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f-&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%10.3f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_x</span><span class="p">[</span><span class="n">_j</span><span class="p">],</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">())</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f-)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Amp. of H/V Curve @</span><span class="si">{</span><span class="n">_x</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">Hz (</span><span class="si">{</span><span class="n">_y</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;ProminenceLow&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>
    
    <span class="k">if</span> <span class="n">do_rank</span><span class="p">:</span>
        <span class="n">max_rank</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>
        <span class="c1">#Initialize as False</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f+)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;H/V curve &gt; </span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> for all </span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz-</span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> Hz </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;ProminenceHi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>

            <span class="c1"># There exist one frequency f+, lying between f0 and 4*f0, such that A0 / A(f+) &gt; 2.</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mf">4.0</span> <span class="o">&gt;=</span> <span class="n">_x</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span> <span class="ow">and</span> \
                    <span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">_y</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">2.0</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_x</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A(f+)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;H/V Curve at </span><span class="si">{</span><span class="n">_x</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz: </span><span class="si">{</span><span class="n">_y</span><span class="p">[</span><span class="n">_j</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> (f0/2) </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;ProminenceHi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="c1"># Amplitude Clarity test</span>
    <span class="c1"># Only peaks with A0 &gt; 2 pass</span>
    <span class="k">if</span> <span class="n">do_rank</span><span class="p">:</span>
        <span class="n">max_rank</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">_a0</span> <span class="o">=</span> <span class="mf">2.0</span>
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>

        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">_a0</span><span class="p">:</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Amplitude of peak (</span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">) &gt; </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">_a0</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;AmpClarity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%0.2f</span><span class="s1"> &gt; </span><span class="si">%0.1f</span><span class="s1"> </span><span class="si">%1s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;A0&#39;</span><span class="p">],</span> <span class="n">_a0</span><span class="p">,</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">())</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;AmpClarity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">_peak</span>


<span class="c1"># Check the stability of the frequency peak</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__check_freq_stability</span><span class="p">(</span><span class="n">_peak</span><span class="p">,</span> <span class="n">_peakm</span><span class="p">,</span> <span class="n">_peakp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test peaks for satisfying stability conditions</span>

<span class="sd">    Test as outlined by SESAME 2004:</span>
<span class="sd">        - the _peak should appear at the same frequency (within a percentage ± 5%) on the H/V</span>
<span class="sd">            curves corresponding to mean + and - one standard deviation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _peak : list</span>
<span class="sd">        List of dictionaries containing input information about peak, without freq stability test</span>
<span class="sd">    _peakm : list</span>
<span class="sd">        List of dictionaries containing input information about peakm (peak minus one StDev in freq)</span>
<span class="sd">    _peakp : list</span>
<span class="sd">        List of dictionaries containing input information about peak (peak plus one StDev in freq)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _peak : list</span>
<span class="sd">        List of dictionaries containing output information about peak test</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">max_rank</span>

    <span class="c1"># check σf and σA</span>
    <span class="n">max_rank</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># First check below</span>
    <span class="c1"># Initialize list</span>
    <span class="n">_found_m</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>
        <span class="n">_dx</span> <span class="o">=</span> <span class="mf">1000000.</span>
        <span class="c1"># Initialize test as not passing for this frequency</span>
        <span class="n">_found_m</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P-&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span>
        <span class="c1"># Iterate through all time windows</span>
        <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peakm</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_peakm</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">_dx</span><span class="p">:</span>
                <span class="n">_index</span> <span class="o">=</span> <span class="n">_j</span>
                <span class="n">_dx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_peakm</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span> <span class="c1">#_dx is difference between peak frequencies for each time window and main peak</span>
            <span class="k">if</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.95</span> <span class="o">&lt;=</span> <span class="n">_peakm</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P-&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_peakm</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz within ±5% of </span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_found_m</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        
        <span class="k">if</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P-&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">():</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P-&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_peakm</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz within ±5% of </span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Then Check above</span>
    <span class="n">_found_p</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>
        <span class="n">_dx</span> <span class="o">=</span> <span class="mf">1000000.</span>
        <span class="n">_found_p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peakp</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_peakp</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">_dx</span><span class="p">:</span>

                <span class="n">_dx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">_peakp</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.95</span> <span class="o">&lt;=</span> <span class="n">_peakp</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">_found_m</span><span class="p">[</span><span class="n">_i</span><span class="p">]:</span>
                    <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_peakp</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz within ±5% of </span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;FreqStability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_peakp</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz within ±5% of </span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;FreqStability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_peakp</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz within ±5% of </span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;FreqStability&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>                
        <span class="k">if</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">_peakp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;P+&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_peakp</span><span class="p">[</span><span class="n">_j</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz within ±5% of </span><span class="si">{</span><span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> Hz </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">_peak</span>


<span class="c1"># Check stability</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__check_stability</span><span class="p">(</span><span class="n">_stdf</span><span class="p">,</span> <span class="n">_peak</span><span class="p">,</span> <span class="n">_hvsr_log_std</span><span class="p">,</span> <span class="n">rank</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test peaks for satisfying stability conditions as outlined by SESAME 2004</span>
<span class="sd">    This includes:</span>
<span class="sd">       - σf lower than a frequency dependent threshold ε(f)</span>
<span class="sd">       - σA (f0) lower than a frequency dependent threshold θ(f),</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    _stdf : list</span>
<span class="sd">        List with dictionaries containint frequency standard deviation for each peak</span>
<span class="sd">    _peak : list</span>
<span class="sd">        List of dictionaries containing input information about peak, without freq stability test</span>
<span class="sd">    _hvsr_log_std : list</span>
<span class="sd">        List of dictionaries containing log standard deviation along curve</span>
<span class="sd">    rank : int</span>
<span class="sd">        Integer value, higher value is &quot;higher-ranked&quot; peak, helps determine which peak is actual hvsr peak</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    _peak : list</span>
<span class="sd">        List of dictionaries containing output information about peak test</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">max_rank</span>

    <span class="c1">#</span>
    <span class="c1"># check σf and σA</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="n">rank</span><span class="p">:</span>
        <span class="n">max_rank</span> <span class="o">+=</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_peak</span><span class="p">)):</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span>
        <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span>
        <span class="n">_this_peak</span> <span class="o">=</span> <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">_e</span> <span class="o">=</span> <span class="mf">0.25</span>
            <span class="k">if</span> <span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_e</span> <span class="o">*</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Freq. (</span><span class="si">{</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="p">(</span><span class="n">_e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Freq. (</span><span class="si">{</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="p">(</span><span class="n">_e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">_t</span> <span class="o">=</span> <span class="mf">0.48</span>
            <span class="k">if</span> <span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_t</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Amp. (</span><span class="si">{</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="n">_t</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Amp. (</span><span class="si">{</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="n">_t</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="mf">0.2</span> <span class="o">&lt;=</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">_e</span> <span class="o">=</span> <span class="mf">0.2</span>
            <span class="k">if</span> <span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_e</span> <span class="o">*</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Freq. (</span><span class="si">{</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="p">(</span><span class="n">_e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Freq. (</span><span class="si">{</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="p">(</span><span class="n">_e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">_t</span> <span class="o">=</span> <span class="mf">0.40</span>
            <span class="k">if</span> <span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_t</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Amp. (</span><span class="si">{</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="n">_t</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Amp. (</span><span class="si">{</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="n">_t</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="mf">0.5</span> <span class="o">&lt;=</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="n">_e</span> <span class="o">=</span> <span class="mf">0.15</span>
            <span class="k">if</span> <span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_e</span> <span class="o">*</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Freq. (</span><span class="si">{</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="p">(</span><span class="n">_e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Freq. (</span><span class="si">{</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="p">(</span><span class="n">_e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">_t</span> <span class="o">=</span> <span class="mf">0.3</span>
            <span class="k">if</span> <span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_t</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Amp. (</span><span class="si">{</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="n">_t</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Amp. (</span><span class="si">{</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="n">_t</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="mf">1.0</span> <span class="o">&lt;=</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mf">2.0</span><span class="p">:</span>
            <span class="n">_e</span> <span class="o">=</span> <span class="mf">0.1</span>
            <span class="k">if</span> <span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_e</span> <span class="o">*</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Freq. (</span><span class="si">{</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="p">(</span><span class="n">_e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Freq. (</span><span class="si">{</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="p">(</span><span class="n">_e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">_t</span> <span class="o">=</span> <span class="mf">0.25</span>
            <span class="k">if</span> <span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_t</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Amp. (</span><span class="si">{</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="n">_t</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Amp. (</span><span class="si">{</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="n">_t</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">:</span>
            <span class="n">_e</span> <span class="o">=</span> <span class="mf">0.05</span>
            <span class="k">if</span> <span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_e</span> <span class="o">*</span> <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">]:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Freq. (</span><span class="si">{</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="p">(</span><span class="n">_e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Freq. (</span><span class="si">{</span><span class="n">_stdf</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="p">(</span><span class="n">_e</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;f0&#39;</span><span class="p">])</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_x_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">_t</span> <span class="o">=</span> <span class="mf">0.2</span>
            <span class="k">if</span> <span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">_t</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Amp. (</span><span class="si">{</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="n">_t</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;Score&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Amp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_peak</span><span class="p">[</span><span class="n">_i</span><span class="p">][</span><span class="s1">&#39;Report&#39;</span><span class="p">][</span><span class="s1">&#39;Sa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;St.Dev. of Peak Amp. (</span><span class="si">{</span><span class="n">_hvsr_log_std</span><span class="p">[</span><span class="n">_i</span><span class="p">]</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">) &lt; </span><span class="si">{</span><span class="n">_t</span><span class="si">:</span><span class="s2">0.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sprit_utils</span><span class="o">.</span><span class="n">_check_mark</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">_this_peak</span><span class="p">[</span><span class="s1">&#39;PassList&#39;</span><span class="p">][</span><span class="s1">&#39;LowStDev_Freq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">_peak</span>


<span class="c1"># Get frequency standard deviation</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__get_stdf</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">indexList</span><span class="p">,</span> <span class="n">hvsrPeaks</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Private function to get frequency standard deviation of peak(s) of interest, from multiple time-step HVSR curves</span>
<span class="sd">    Paramaters</span>
<span class="sd">    ----------</span>
<span class="sd">        </span>
<span class="sd">        x_values : list or np.array</span>
<span class="sd">            Array of x_values of dataset (frequency or period, most often frequency)</span>
<span class="sd">        indexList : list</span>
<span class="sd">            List of index/indices of peak(s) of interest, (index is within the x_values list)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        stdf : list</span>
<span class="sd">            List of standard deviations of the peak </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stdf</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="c1"># Go through list containing all peak indices (often, just a single index of the main peak)</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexList</span><span class="p">:</span>
        <span class="n">point</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># Iterate to get index for all rows of pandas series, </span>
        <span class="c1">#   each row contains a list of peak indices for the H/V curve from that time window</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hvsrPeaks</span><span class="p">)):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="c1"># Iterate through each peak in each time window</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hvsrPeaks</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">hvsrPeaks</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Find frequency peak closest in the current time window to the (current) hvsr peak</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="n">hvsrPeaks</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">abs</span><span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="n">p</span><span class="p">):</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">hvsrPeaks</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
                        <span class="c1"># p = hvsrPeaks[j][k]</span>
                        <span class="c1"># print(p=p1, p, p1)</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># It should never be None, this is just a double check</span>
                <span class="c1"># Append the index of interest for that time window</span>
                <span class="n">point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="c1"># Append the last index</span>
        <span class="n">point</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        
        <span class="c1"># Get all the actual frequencies (go through each index and extract the frequency from x_values)</span>
        <span class="k">for</span> <span class="n">pl</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">point</span><span class="p">)):</span>
            <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_values</span><span class="p">[</span><span class="n">point</span><span class="p">[</span><span class="n">pl</span><span class="p">]])</span>
        
        <span class="c1"># stdf is a list in case there are multiple peaks to check. </span>
        <span class="c1"># Most of the time this is only a 1-item list</span>
        <span class="c1"># Contains std of frequencies of the peaks from each time window H/V curve that are closest to the main H/V peak</span>
        <span class="n">stdf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">stdf</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Author.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>